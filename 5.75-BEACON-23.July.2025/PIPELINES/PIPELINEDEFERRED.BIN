<!-- High Dynamic Range (HDR) utf-8Shading Pipeline -->
<Pipeline>
  <Setup>
    <ScaleInfo resScalingDefault="true" />

    <!-- Pipeline Variables -->
    <PipelineVariable id="SSRProbesAvailable" defaultValue="0" />
    <PipelineVariable id="SSRGeometryDrawCount" />

    <PipelineVariable id="SSR_MipIdxSrc" />
    <PipelineVariable id="SSR_MipIdxDst" />
    
    <PipelineVariable id="HizSrcMipIndex" />
    <PipelineVariable id="HizDstMipIndex" />

    <PipelineVariable id="GroupCountX" />
    <PipelineVariable id="GroupCountY" />

    <!-- enum:eWaterState - in code! -->
    <PipelineVariable id="WaterState"                     defaultValue="0" />
    <PipelineVariable id="WaterState_NoWater"             defaultValue="0" />
    <PipelineVariable id="WaterState_AboveWater"          defaultValue="1" />
    <PipelineVariable id="WaterState_BelowWater"          defaultValue="2" />
    <PipelineVariable id="WaterState_NearWaterSurface"    defaultValue="3" />

    <!-- enum:eWaterRenderer - in code! -->
    <PipelineVariable id="WaterRenderer"                  defaultValue="0" />
    <PipelineVariable id="WaterRenderer_RayTraced"        defaultValue="0" />
    <PipelineVariable id="WaterRenderer_MeshedDeferred"   defaultValue="1" />
    <PipelineVariable id="WaterRenderer_MeshedForward"    defaultValue="2" />
    <PipelineVariable id="WaterRenderer_MeshedWireframe"  defaultValue="3" />

    <!-- enum:eWaterReflections - in code! -->
    <PipelineVariable id="WaterReflections"               defaultValue="0" />
    <PipelineVariable id="WaterReflections_Disabled"      defaultValue="0" />
    <PipelineVariable id="WaterReflections_PlanarSSR"     defaultValue="1" />
    <PipelineVariable id="WaterReflections_FullSSR"       defaultValue="2" />

    <!-- True if not 0 -->
    <PipelineVariable id="WaterDebugOverlayEnabled"       defaultValue="0" />
    <PipelineVariable id="WaterDebugProxyMeshes"          defaultValue="0" />
    <PipelineVariable id="WaterGodRaysEnabled"            defaultValue="0" />

    <!-- True if not 0 -->
    <PipelineVariable id="LightShaftsEnabled"             defaultValue="0" />
    <PipelineVariable id="LightShaftsBlurEnabled"         defaultValue="0" />
    <PipelineVariable id="RefractionsEnabled"             defaultValue="0" />

    <!-- enum: eCloudQuality - in code! -->
    <PipelineVariable id="CloudQuality"                   defaultValue="2" />
    <PipelineVariable id="CloudQuality_Low"               defaultValue="0" />
    <PipelineVariable id="CloudQuality_Mid"               defaultValue="1" />
    <PipelineVariable id="CloudQuality_High"              defaultValue="2" />

    <!-- True if not 0 -->
    <PipelineVariable id="GTAO_BentNormals"               defaultValue="0" />

    <!-- True if not 0 -->
    <PipelineVariable id="EnableGgx"                      defaultValue="0" />
      
    <!-- True if not 0 -->
    <PipelineVariable id="EnableMomentTransparency"       defaultValue="0" />

    <!--Shadow Targets-->
    <RenderTarget id="SHADOWBUF"          depthBuf="true"         numColBufs="0"  format="RGBA8"  depthFormat="DEPTH16" scale="1.0" width="5760" height="1920" shadow="true" hasMips="false" numUniformBuffers="3" crossPipeShareId="SHADOW_SHARED" />
    <RenderTarget id="SHADOWBUF_DS"       depthBuf="true"         numColBufs="0"  format="RED16F" depthFormat="DEPTH16" scale="1.0" width="2880" height="960"  shadow="true" hasMips="false" numUniformBuffers="1" esramPageDepthBuf="424" />

    <!--GBuffer Targets-->
    <RenderTarget id="GBUFFER"            depthBuf="false"        numColBufs="5"  format0="RGBA8" format1="RG16F" format2="RGB10A2" format3="RGBA8" format4="RG8_Snorm"                  scale="1.0" applyDrs="true" pointSampleColBuf1="true" pointSampleColBuf2="true" pointSampleColBuf3="true" shareTarget2="NORMALS"  shareTarget3="MATERIAL" shareTarget4="BENT" esramPageColBuf0="308" esramPageColBuf1="250" />

    <!--Geometry Targets-->
    <RenderTarget id="MAT_BENT"                                       depthBuf="false"  numColBufs="2"  scale="1.0"     applyDrs="true" format0="RGBA8"   format1="RG8_Snorm" shareTarget0="MATERIAL" shareTarget1="BENT" />
    <RenderTarget id="NORMALS"                                        depthBuf="false"  numColBufs="1"  scale="1.0"     applyDrs="true" format="RGB10A2"    shareTarget0="RGB10A2_BUF_0"  esramPageColBuf0="192" />
    <RenderTarget id="NORMALS_BACK"       platforms="NEXT|XB1X"       depthBuf="false"  numColBufs="1"  scale="1.0"     applyDrs="true" format="RGB10A2"    shareTarget0="RGB10A2_BUF_1" />
    <RenderTarget id="MATERIAL"                                       depthBuf="false"  numColBufs="1"  scale="1.0"     applyDrs="true" format="RGBA8"      shareTarget0="RGBA8_BUF_0"    esramPageColBuf0="134" />
    <RenderTarget id="MATERIAL_BACK"      platforms="NEXT|XB1X"       depthBuf="false"  numColBufs="1"  scale="1.0"     applyDrs="true" format="RGBA8"      shareTarget0="RGBA8_BUF_1"   />
    <RenderTarget id="GEO_NORMALS"        platforms="NEXT|XB1X"       depthBuf="false"  numColBufs="1"  scale="1.0"     applyDrs="true" format="RGB10A2"    shareTarget0="RGB10A2_BUF_2" />
    <RenderTarget id="GN_SWAP_DUMMY"      platforms="NEXT|XB1X"       depthBuf="false"  numColBufs="1"  scale="1.0"     applyDrs="true" format="RGB10A2"    shareTarget0="RGB10A2_BUF_3" />
    <RenderTarget id="BENT"                                           depthBuf="false"  numColBufs="1"  scale="1.0"     applyDrs="true" format="RG8_Snorm"  shareTarget0="RG8S_BUF_0" />

    <!--SSR Targets-->
    <RenderTarget id="SSR_HIT_DATA"       platforms="NEXT|XB1X"       hasMips="false"  autoGenMips="false" mipsSRVs="false" depthBuf="false" numColBufs="2"  scale="0.5"     applyDrs="true" format0="RGBA16F"  format1="R11FG11FB10F"  pointSampleColBuf0="true" shareTarget1="SSR_REFL_TMP" />
    <RenderTarget id="SSR_REFL"           platforms="NEXT|XB1X"       hasMips="false"  autoGenMips="false" mipsSRVs="false" depthBuf="false" numColBufs="1"  scale="0.5"     applyDrs="true" format="R11FG11FB10F"   />
    <RenderTarget id="SSR_REFL_TMP"       platforms="NEXT|XB1X"       hasMips="false"  autoGenMips="false" mipsSRVs="false" depthBuf="false" numColBufs="1"  scale="0.5"     applyDrs="true" format="R11FG11FB10F"   />
    <RenderTarget id="SSR_RESOLVE"        platforms="NEXT|XB1X"       hasMips="false"  autoGenMips="false" mipsSRVs="false" depthBuf="false" numColBufs="1"  scale="1.0"     applyDrs="true" format="R11FG11FB10F"   />
    <RenderTarget id="SSR_HIT_LENGTH"     platforms="NEXT|XB1X"       hasMips="false"  autoGenMips="false" mipsSRVs="false" depthBuf="false" numColBufs="1"  scale="0.5"     applyDrs="true" format="RED16F"         />
    <RenderTarget id="SSR_TEMPORAL_F"     platforms="NEXT|XB1X"       hasMips="false"  autoGenMips="false" mipsSRVs="false" depthBuf="false" numColBufs="2"  scale="1.0"     applyDrs="true" format0="R11FG11FB10F"  format1="RGB10A2" shareTarget0="HDRBUF_2"    shareTarget1="SSR_CONF_ACC_T_F" />
    <RenderTarget id="SSR_TEMPORAL_H"     platforms="NEXT|XB1X"       hasMips="false"  autoGenMips="false" mipsSRVs="false" depthBuf="false" numColBufs="2"  scale="1.0"     applyDrs="true" format0="R11FG11FB10F"  format1="RGB10A2" shareTarget0="HDRBUF_2"    shareTarget1="SSR_CONF_ACC_T_H" />
    <RenderTarget id="SSR_RADIANCE"       platforms="NEXT|XB1X"       hasMips="false"  autoGenMips="false" mipsSRVs="false" depthBuf="false" numColBufs="1"  scale="1.0"     applyDrs="true" format="R11FG11FB10F"   pointSampleColBuf0="false" />
    <RenderTarget id="SSR_CONF_ACC_T_F"   platforms="NEXT|XB1X"       hasMips="false"  autoGenMips="false" mipsSRVs="false" depthBuf="false" numColBufs="1"  scale="1.0"     applyDrs="true" format="RGB10A2"        pointSampleColBuf0="false" shareTarget0="RGB10A2_BUF_2" />
    <RenderTarget id="SSR_CONF_ACC_T_H"   platforms="NEXT|XB1X"       hasMips="false"  autoGenMips="false" mipsSRVs="false" depthBuf="false" numColBufs="1"  scale="1.0"     applyDrs="true" format="RGB10A2"        pointSampleColBuf0="false" shareTarget0="RGB10A2_BUF_3" />
    <RenderTarget id="SSR_DEPTH_DOWN"     platforms="NEXT|XB1X"       hasMips="false"  autoGenMips="false" mipsSRVs="false" depthBuf="false" numColBufs="2"  scale="0.5"     applyDrs="true" format0="RG16F"   format1="RED8I"  shareTarget0="DEPTH_HI_LOW_Z"   shareTarget1="SSR_SMP_IDX" />
    <RenderTarget id="SSR_PARAMS"         platforms="NEXT|XB1X"       hasMips="false"  autoGenMips="false" mipsSRVs="false" depthBuf="false" numColBufs="2"  scale="0.5"     applyDrs="true" format0="RGB10A2" format1="RED16F" shareTarget0="SSR_RAY_DIR"      shareTarget1="SSR_RAY_PDF" />
    <RenderTarget id="SSR_SMP_IDX"        platforms="NEXT|XB1X"       hasMips="false"  autoGenMips="false" mipsSRVs="false" depthBuf="false" numColBufs="1"  scale="0.5"     applyDrs="true" format="RED8I"   pointSampleColBuf0="true" />
    <RenderTarget id="SSR_RAY_DIR"        platforms="NEXT|XB1X"       hasMips="false"  autoGenMips="false" mipsSRVs="false" depthBuf="false" numColBufs="1"  scale="0.5"     applyDrs="true" format="RGB10A2" pointSampleColBuf0="true" />
    <RenderTarget id="SSR_RAY_PDF"        platforms="NEXT|XB1X"       hasMips="false"  autoGenMips="false" mipsSRVs="false" depthBuf="false" numColBufs="1"  scale="0.5"     applyDrs="true" format="RED16F"  pointSampleColBuf0="true" />

    <!--GTAO Targets-->
    <RenderTargetGroup id="GTAO">
    <RenderTarget id="GTAO_BUFF_0"        platforms="OLD|!OUNCE"  depthBuf="false"  numColBufs="1"  format="RED8UI"   scale="1.0" applyDrs="true" allowDcc="false" pointSampleColBuf="true" />
    <RenderTarget id="GTAO_BUFF_1"        platforms="OLD|!OUNCE"  depthBuf="false"  numColBufs="1"  format="RED8UI"   scale="1.0" applyDrs="true" allowDcc="false" pointSampleColBuf="true" />
    <RenderTarget id="GTAO_BUFF_2"        platforms="OLD|!OUNCE"  depthBuf="false"  numColBufs="1"  format="RED8UI"   scale="1.0" applyDrs="true" allowDcc="false" pointSampleColBuf="true" />
    <RenderTarget id="GTAO_BUFF_0"        platforms="NEXT|OUNCE"  depthBuf="false"  numColBufs="1"  format="RED32UI"  scale="1.0" applyDrs="true" allowDcc="false" pointSampleColBuf="true" />
    <RenderTarget id="GTAO_BUFF_1"        platforms="NEXT|OUNCE"  depthBuf="false"  numColBufs="1"  format="RED32UI"  scale="1.0" applyDrs="true" allowDcc="false" pointSampleColBuf="true" />
    <RenderTarget id="GTAO_BUFF_2"        platforms="NEXT|OUNCE"  depthBuf="false"  numColBufs="1"  format="RED32UI"  scale="1.0" applyDrs="true" allowDcc="false" pointSampleColBuf="true" />
    <RenderTarget id="GTAO_PACK"                                  depthBuf="false"  numColBufs="1"  format="RED32UI"  scale="1.0" applyDrs="true" allowDcc="false" pointSampleColBuf="true" shareTarget0="RED32UI_BUF_0" />
    <RenderTarget id="GTAO_MASK"                                  depthBuf="false"  numColBufs="1"  format="RED32UI"  scale="1.0" applyDrs="true" allowDcc="false" pointSampleColBuf="true" shareTarget0="RED32UI_BUF_0" />
    </RenderTargetGroup>

    <!--SSS Targets-->
    <RenderTargetGroup id="ScreenSpaceShadows">
    <RenderTarget id="SSS_TEMP_A"         depthBuf="false"  numColBufs="1"        format="RED8"                           scale="0.5" applyDrs="true"  allowDcc="NEXT" />
    <RenderTarget id="SSS_TEMP_B"         depthBuf="false"  numColBufs="1"        format="RED8"                           scale="0.5" applyDrs="true"  allowDcc="NEXT" />
    <RenderTarget id="SSS_FINAL"          depthBuf="false"  numColBufs="1"        format="RED8"                           scale="1.0" applyDrs="true"  allowDcc="NEXT" />
    <RenderTarget id="SSS_HISTORY"        depthBuf="false"  numColBufs="1"        format="RED8"                           scale="1.0" applyDrs="true"  allowDcc="NEXT" />
    <RenderTarget id="DEPTH_SSS_REV_Z"    depthBuf="false"  numColBufs="1"        format="RED16F"                         scale="0.5" applyDrs="true"  allowDcc="NEXT" pointSampleColBuf0="true" />      
    </RenderTargetGroup>
    
    <!--Moment Transparency Targets-->
    <RenderTargetGroup id="MBOIT" platforms="FALSE">
    <RenderTarget id="MBOIT_BUFFERS"              depthBuf="false" numColBufs="2" format0="RGBA32F" format1="RED32F" scale="0.5" shareTarget0="MBOIT_MOMENTS" shareTarget1="MBOIT_TOTAL_ABSORBANCE" applyDrs="true" />

    <RenderTarget id="MBOIT_ACCUM_REFRACT_HALF_BUFFERS" depthBuf="false" numColBufs="2" format0="RGBA16F" format1="RGBA16F" scale="0.5" shareTarget0="MBOIT_ACCUMULATED_HALF_RES" shareTarget1="MBOIT_DISTORTION_HALF_RES" applyDrs="true" />
    <RenderTarget id="MBOIT_ACCUM_REFRACT_FULL_BUFFERS" depthBuf="false" numColBufs="2" format0="RGBA16F" format1="RGBA16F" scale="1.0" shareTarget0="MBOIT_ACCUMULATED_FULL_RES" shareTarget1="MBOIT_DISTORTION_FULL_RES" applyDrs="true" />
      
    <RenderTarget id="MBOIT_MOMENTS"              depthBuf="false" numColBufs="1" format="RGBA32F"  scale="0.5" applyDrs="true" />
    <RenderTarget id="MBOIT_TOTAL_ABSORBANCE"     depthBuf="false" numColBufs="1" format="RED32F"   scale="0.5" applyDrs="true" />
    <RenderTarget id="MBOIT_ACCUMULATED_HALF_RES" depthBuf="false" numColBufs="1" format="RGBA16F"  scale="0.5" applyDrs="true" />
    <RenderTarget id="MBOIT_ACCUMULATED_FULL_RES" depthBuf="false" numColBufs="1" format="RGBA16F"  scale="1.0" applyDrs="true" />

    <!--Distortion render targets have a free blue channel, can use it to pack parameters to configure the distortion later. Like the brightness boost setting on particles.-->
    <RenderTarget id="MBOIT_DISTORTION_HALF_RES"  depthBuf="false" numColBufs="1" format="RGBA16F"  scale="0.5" applyDrs="true" />
    <RenderTarget id="MBOIT_DISTORTION_FULL_RES"  depthBuf="false" numColBufs="1" format="RGBA16F"  scale="1.0" applyDrs="true" />
    </RenderTargetGroup>
    
    <!--Misc Targets-->
    <RenderTarget id="SUNOUT_0"           depthBuf="false"                                            numColBufs="2"  format0="R11FG11FB10F" format1="R11FG11FB10F" scale="1.0" applyDrs="true"  shareTarget0="HDRBUF_0"  shareBuffer0="0"  shareTarget1="HDRBUF_1"   shareBuffer1="0" allowDcc0="true" allowDcc1="NEXT"  />
    <RenderTarget id="BLENDED_ABOVE"      depthBuf="false"                                            numColBufs="2"  format0="R11FG11FB10F" format1="RED8"         scale="1.0" applyDrs="true"  shareTarget0="HDRBUF_0"  shareBuffer0="0"  shareTarget1="LUT_MASK"   shareBuffer1="0" allowDcc0="true" allowDcc1="false" />
    <RenderTarget id="SCREEN"                                                 depthBuf="false"  numColBufs="1"  format="R11FG11FB10F"                         scale="1.0" applyDrs="true"  shareTarget0="HDRBUF_2"  shareBuffer0="0"  allowDcc="false" />
    <RenderTarget id="FINAL"              platforms="PC|NEXT|XBOX"            depthBuf="false"  numColBufs="2"  format0="R11FG11FB10F" format1="RED8"         scale="1.0" applyDrs="true"  shareTarget0="HDRBUF_1"  shareBuffer0="0"  allowDcc="NEXT" />
    <RenderTarget id="UPS_OUT_0"          platforms="PC|NEXT|XBOX|PS4|HHELD"  depthBuf="false"  numColBufs="1"  format="R11FG11FB10F"                         scale="1.0" applyDrs="false" postUpscale="true"   allowDcc="PS5BASE,SCARLETT" esramPageColBuf0="134" />
    <RenderTarget id="UPS_OUT_1"          platforms="PC|NEXT|XBOX|PS4|HHELD"  depthBuf="false"  numColBufs="1"  format="R11FG11FB10F"                         scale="1.0" applyDrs="false" postUpscale="true"   allowDcc="NEXT" esramPageColBuf0="366" />
    <RenderTarget id="UPS_OUT_0"          platforms="OUNCE"                   depthBuf="false"  numColBufs="1"  format="R11FG11FB10F"                         scale="1.0" applyDrs="false" midUpscale="true"   />
    <RenderTarget id="UPS_OUT_1"          platforms="OUNCE"                   depthBuf="false"  numColBufs="1"  format="R11FG11FB10F"                         scale="1.0" applyDrs="false" midUpscale="true"   />     

      <!--LUT Targets-->
    <RenderTarget id="LUT_MASK"           depthBuf="false"        numColBufs="1"  format="RED8" scale="1.0" applyDrs="true" shareTarget0="RED8_BUF_0" shareBuffer0="0"  allowDcc="false" />

    <!--Clouds Targets-->
    <RenderTarget id="CLOUDSHADOWS"       depthBuf="false"        numColBufs="1" format="RED8"   applyDrs="true" scale="0.5" allowDcc="false" />

    <!--Worlds Update's Clouds Targets-->
    <RenderTarget id="CLOUDS_MRT"         depthBuf="false"        numColBufs="2" format0="RGBA16F" format1="R32FG32F" scale="0.5" applyDrs="true" allowDcc="NEXT" shareTarget0="CLOUDS_COLOUR" shareTarget1="CLOUDS_DEPTH" />
    <RenderTarget id="CLOUDS_COLOUR"      depthBuf="false"        numColBufs="1" format="RGBA16F"   scale="0.5" applyDrs="true" allowDcc="NEXT" />
    <RenderTarget id="CLOUDS_DEPTH"       depthBuf="false"        numColBufs="1" format="R32FG32F"  scale="0.5" applyDrs="true" allowDcc="NEXT" />
    <RenderTarget id="CLOUDS_HISTORY"     depthBuf="false"        numColBufs="1" format="RGBA16F"   scale="0.5" applyDrs="true" allowDcc="NEXT" />
    <RenderTarget id="CLOUDS_FINAL"       depthBuf="false"        numColBufs="1" format="RGBA16F"   scale="0.5" applyDrs="true" allowDcc="NEXT" />

    <!--Volumetrics Targets-->
    <RenderTarget id="VOLUME"             depthBuf="false"        numColBufs="2"  format0="RGBA16F" format1="RED16F" scale="0.5" applyDrs="true" pointSampleColBuf0="false" pointSampleColBuf1="true" shareTarget0="SCATTER" shareTarget1="LIGHTSHAFT" />
    <RenderTarget id="SCATTER"            depthBuf="false"        numColBufs="1"  format="RGBA16F"  scale="0.5" applyDrs="true" pointSampleColBuf0="false" />
    <RenderTarget id="LIGHTSHAFT"         depthBuf="false"        numColBufs="1"  format="RED16F"   scale="0.5" applyDrs="true" pointSampleColBuf0="true"  />
    <RenderTarget id="BLUR1"              depthBuf="false"        numColBufs="1"  format="RGBA16F"  scale="0.5" applyDrs="true" pointSampleColBuf0="true"  esramPageColBuf0="424" />
    <RenderTarget id="BLUR1_REDONLY"      depthBuf="false"        numColBufs="1"  format="RED16F"   scale="0.5" applyDrs="true" pointSampleColBuf0="true"  allowDcc="false" />

    <RenderTarget id="SCATTERING_VOLUME"  depthBuf="false"        numColBufs="1"  format="RGBA16F"  width="16" height="16" depth="32" hasMips="false" crossPipeShareId="SCATTERING_VOLUME" />
    <RenderTarget id="SCATTERING_DUMMY"   depthBuf="false"        numColBufs="1"  format="RED8"     width="16" height="16"            hasMips="false" />
    <RenderTarget id="RINGS_BUFF"         depthBuf="false"        numColBufs="1"  format="RGBA16F"  scale="1.0" applyDrs="true" pointSampleColBuf0="false" />

    <!--Water Targets-->
    <!-- New -->
    <RenderTarget id="WATER_MASK"                                   depthBuf="false"  numColBufs="2" format0="RG8" format1="R32FG32F" scale="1.0" applyDrs="true" allowDcc="true" />
    <RenderTarget id="WATER_PROXY_DEPTH"                            depthBuf="false"  numColBufs="1" format="RED32F"                  scale="1.0" applyDrs="true" allowDcc="true" />
    <RenderTarget id="WATER_REFL"                                   depthBuf="false"  numColBufs="1" format="RED32UI"                 scale="1.0" applyDrs="true" pointSampleColBuf0="true" allowDcc="false" shareTarget0="RED32UI_BUF_1" />
    <RenderTarget id="WATER_REFL_FRONT"   platforms="PC|NEXT"       depthBuf="false"  numColBufs="1" format="RED32UI"                 scale="1.0" applyDrs="true" pointSampleColBuf0="true" allowDcc="false" shareTarget0="RED32UI_BUF_2" esramPageColBuf0="76" />
    <RenderTarget id="WATER_REFL_BACK"    platforms="PC|NEXT"       depthBuf="false"  numColBufs="1" format="RED32UI"                 scale="1.0" applyDrs="true" pointSampleColBuf0="true" allowDcc="false" />
    <RenderTarget id="WATER_PLANAR_REFL_COL"    platforms="!TRINITY|PC|NEXT|XBOX|PS4|OUNCE" depthBuf="false"  numColBufs="1" format="R11FG11FB10F" scaleX="0.25" scaleY="0.5"  applyDrs="true" allowDcc="true" crossPipeShareId="WATER_PLANAR_REFL_COL" /> 
    <RenderTarget id="WATER_PLANAR_REFL_COL"    platforms="TRINITY"                         depthBuf="false"  numColBufs="1" format="R11FG11FB10F" width="960"   height="1080" applyDrs="true" allowDcc="true" crossPipeShareId="WATER_PLANAR_REFL_COL" /> 
    <RenderTarget id="WATER_PLANAR_REFL_DEPTH"  platforms="!TRINITY|PC|NEXT|XBOX|PS4|OUNCE" depthBuf="true"   numColBufs="0"                       scaleX="0.25" scaleY="0.5"  applyDrs="true"                 crossPipeShareId="WATER_PLANAR_REFL_DEPTH" />
    <RenderTarget id="WATER_PLANAR_REFL_DEPTH"  platforms="TRINITY"                         depthBuf="true"   numColBufs="0"                       width="960"   height="1080" applyDrs="true"                 crossPipeShareId="WATER_PLANAR_REFL_DEPTH" />
    <RenderTarget id="WATER_SCATTER_ADD"        platforms="NEXT|XB1X"                       depthBuf="false"  numColBufs="1" format="R11FG11FB10F" scaleX="0.25" scaleY="0.125"  applyDrs="true" allowDcc="true" />
    <RenderTarget id="WATER_SCATTER_ADD_B"      platforms="NEXT|XB1X"                       depthBuf="false"  numColBufs="1" format="R11FG11FB10F" scaleX="0.25" scaleY="0.125"  applyDrs="true" allowDcc="true" />
    <RenderTarget id="WATER_SCATTER_DEPTH"      platforms="NEXT|XB1X"                       depthBuf="false"  numColBufs="1" format="RED32F"       scaleX="0.25" scaleY="0.125"  applyDrs="true" allowDcc="true" />

    <!--Particles Targets-->
    <RenderTarget id="PARTICLES"          depthBuf="false"        numColBufs="1" format="RGBA16F" bilinear="true" scale="0.5"   applyDrs="true" esramPageColBuf0="134" />

    <!--Tiled Lighting Targets-->
    <RenderTarget id="LIGHTS_DUMMY"       depthBuf="false"        numColBufs="1" format="RED8"   applyDrs="true" pointSampleColBuf="true" scale="0.0625" />
    <RenderTarget id="LIGHTS_TILEBUF"     depthBuf="false"        numColBufs="1" format="RED32I" applyDrs="true" pointSampleColBuf="true" scaleX="0.5" scaleY="1.0" allowDcc="false" esramPageColBuf0="76" />

    <!--DOF Targets-->
    <RenderTarget id="DOF_COC"            depthBuf="false"        numColBufs="1" format="RED8"  bilinear="true" scale="0.5" applyDrs="true" shareTarget0="DOF_DOWNSAMPLE" shareBuffer0="1" />
    <RenderTarget id="DOF_MAXBUF_H"       depthBuf="false"        numColBufs="1" format="RG8" bilinear="true" applyDrs="true" scaleX="0.0625" scaleY="0.5" allowDcc="false" />
    <RenderTarget id="DOF_MAXBUF"         depthBuf="false"        numColBufs="1" format="RG8" bilinear="true" applyDrs="true" scale="0.0625"               allowDcc="false" />
    <RenderTarget id="DOF_TONEMAP"        depthBuf="false"        numColBufs="1" format="R11FG11FB10F"  scale="1.0"      applyDrs="true" allowDcc="NEXT"   shareTarget0="HDRBUF_2" shareBuffer0="0" />
    <RenderTarget id="DOF_DOWNSAMPLE"     depthBuf="false"        numColBufs="2" format0="R11FG11FB10F" format1="RED8"   scale="0.5" applyDrs="true" allowDcc="false" shareTarget0="BLOOM_BLURBUF_2B" shareBuffer0="0" />
    <RenderTarget id="DOF_BLURBUF1"       depthBuf="false"        numColBufs="2" format0="R11FG11FB10F" format1="RED8"   scale="0.5" applyDrs="true" allowDcc="false" shareTarget0="BLOOM_BLURBUF_2A" shareBuffer0="0" />
      
    <RenderTarget id="DOF_BUFF_0"         depthBuf="false"        numColBufs="1" format="R11FG11FB10F"  scale="0.5" applyDrs="true"  allowDcc="false" shareTarget0="BLOOM_BLURBUF_2A" shareBuffer0="0" />
    <RenderTarget id="DOF_BUFF_1"         depthBuf="false"        numColBufs="1" format="R11FG11FB10F"  scale="0.5" applyDrs="true"  allowDcc="false" shareTarget0="BLOOM_BLURBUF_2B" shareBuffer0="0"  />
    <RenderTarget id="DOF_TEMP"           depthBuf="false"        numColBufs="1" format="R11FG11FB10F"  scale="0.5" applyDrs="false" allowDcc="false" />      

    <!--Exposure-->
    <RenderTargetGroup id="Exposure" platforms="PC">
    <RenderTarget id="EXPOSURE"           depthBuf="false"        numColBufs="1" format="RED16F"  scale="1.0" width="1"   height="1"    depth="0"   applyDrs="false" allowDcc="false" />
    <RenderTarget id="EXPOSURE_H"         depthBuf="false"        numColBufs="1" format="RED16F"  scale="1.0" width="1"   height="1"    depth="0"   applyDrs="false" allowDcc="false" />
    <RenderTarget id="EV_NORM"            depthBuf="false"        numColBufs="1" format="RED16F"  scale="1.0"                                       applyDrs="false" allowDcc="false" />
    <RenderTarget id="EV_HISTOGRAM"       depthBuf="false"        numColBufs="1" format="RED32UI" scale="1.0" width="64"  height="1"    depth="0"   applyDrs="false" allowDcc="false" />
    <RenderTarget id="EV_BIL_GRID"        depthBuf="false"        numColBufs="1" format="RG16F"   scale="1.0" width="128" height="64"   depth="64"  applyDrs="false" allowDcc="false" />
    <RenderTarget id="EV_BIL_GRID_TMP"    depthBuf="false"        numColBufs="1" format="RG16F"   scale="1.0" width="128" height="64"   depth="64"  applyDrs="false" allowDcc="false" />
    <RenderTarget id="EV_BLUR"            depthBuf="false"        numColBufs="1" format="RED16F"  scale="1.0" width="128" height="64"   depth="0"   applyDrs="false" allowDcc="false" />
    <RenderTarget id="EV_BLUR_TMP"        depthBuf="false"        numColBufs="1" format="RED16F"  scale="1.0" width="128" height="64"   depth="0"   applyDrs="false" allowDcc="false" />
    <RenderTarget id="EV_BLUR_UPS"        depthBuf="false"        numColBufs="1" format="RED16F"  scale="1.0" width="512" height="256"  depth="0"   applyDrs="false" allowDcc="false" />
    </RenderTargetGroup>
    
    <!--Motion Targets-->
    <RenderTarget id="MOTION_BUFFS"       platforms="PC,HHELD,OUNCE"                      depthBuf="false" numColBufs="2" format0="RG16F" format1="RG16F"   scale="1.0"                   applyDrs="true" shareTarget0="MOTIONRESOLVE" shareTarget1="MOTIONSCREEN" />
    <RenderTarget id="MOTION_BUFFS_BACK"  platforms="OUNCE"                               depthBuf="false" numColBufs="2" format0="RG16F" format1="RG16F"   scale="1.0"                   applyDrs="true" shareTarget0="MOTIONRESOLVE_BACK" shareTarget1="MOTIONSCREEN_BACK" />
      
    <RenderTarget id="MOTION_MAXBUF_H"    platforms="NEXT,XBOX,PC,PS4,HHELD,OUNCE"        depthBuf="false" numColBufs="1" format="RGBA16F"                  scaleX="0.125"  scaleY="1.0"  applyDrs="true" allowDcc="false"  />
    <RenderTarget id="MOTION_MAXBUF_0"    platforms="NEXT,XBOX,PC,PS4,HHELD,OUNCE"        depthBuf="false" numColBufs="1" format="RGBA16F"                  scale="0.125"                 applyDrs="true" allowDcc="false"  />
    <RenderTarget id="MOTION_MAXBUF_1"    platforms="NEXT,XBOX,PC,PS4,HHELD,OUNCE"        depthBuf="false" numColBufs="1" format="RGBA16F"                  scale="0.125"                 applyDrs="true" allowDcc="false"  />
    <RenderTarget id="MOTIONRESOLVE_BACK" platforms="PC"                                  depthBuf="false" numColBufs="1" format="RG16F"                    scale="1.0"                   applyDrs="true" shareTarget0="MOTIONRESOLVE" shareBuffer0="0" />
    <RenderTarget id="MOTIONRESOLVE_BACK" platforms="XB1S"                                depthBuf="false" numColBufs="1" format="RG16F"                    scale="1.0"                   applyDrs="true" shareTarget0="MOTIONRESOLVE" shareBuffer0="0" />
    <RenderTarget id="MOTIONRESOLVE_BACK" platforms="!PC,NEXT,XB1X,PS4,HHELD,OUNCE"       depthBuf="false" numColBufs="1" format="RG16F"                    scale="1.0"                   applyDrs="true" allowDcc="SCARLETT,PS5BASE,XB1X" />
    <RenderTarget id="MOTIONRESOLVE_PSSR" platforms="TRINITY"                             depthBuf="false" numColBufs="1" format="RG16F"                    scale="1.0"                   applyDrs="true" allowDcc="SCARLETT,PS5BASE,XB1X" />
    <RenderTarget id="MOTIONRESOLVE"      platforms="PC"                                  depthBuf="false" numColBufs="1" format="RG16F"                    scale="1.0"                   applyDrs="true" />
    <RenderTarget id="MOTIONRESOLVE"      platforms="!PC,NEXT,XB1X,XB1S,PS4,HHELD,OUNCE"  depthBuf="false" numColBufs="1" format="RG16F"                    scale="1.0"                   applyDrs="true" allowDcc="SCARLETT,PS5BASE,XB1X" />
    <RenderTarget id="MOTIONSCREEN"       platforms="PC,HHELD,OUNCE"                      depthBuf="false" numColBufs="1" format="RG16F"                    scale="1.0"                   applyDrs="true" />
    <RenderTarget id="MOTIONSCREEN_BACK"  platforms="OUNCE"                               depthBuf="false" numColBufs="1" format="RG16F"                    scale="1.0"                   applyDrs="true" />

    <!--Lens Flare Targets-->
    <RenderTarget id="LENS_BLURBUF"       depthBuf="false"        numColBufs="2" format0="R11FG11FB10F"  format1="R11FG11FB10F"  scale="0.25" allowDcc="false" shareTarget0="BLOOM_BLURBUF_4A" shareBuffer0="0" shareTarget1="LENS_ANASRCBUF" shareBuffer1="0"/>
    <RenderTarget id="LENS_FLAREBUF"      depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.25"      allowDcc="false" />
    <RenderTarget id="LENS_EFFECTS"       depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.125"     allowDcc="false" />
    <RenderTarget id="LENS_BRIGHTBUF"     depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.125"     allowDcc="false" shareTarget0="BLOOM_BLURBUF_8A" shareBuffer0="0" />
    <RenderTarget id="LENS_SUNBUF_A"      depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.125"     allowDcc="false" />
    <RenderTarget id="LENS_SUNBUF_B"      depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.125"     allowDcc="false" shareTarget0="BLOOM_BLURBUF_8B" shareBuffer0="0" />
    <RenderTarget id="LENS_ANASRCBUF"     depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.25"      allowDcc="false" shareTarget0="BLOOM_BLURBUF_4B" shareBuffer0="0" />
    <RenderTarget id="LENS_ANARESBUF"     depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.125"     allowDcc="false" shareTarget0="BLOOM_BLURBUF_8B" shareBuffer0="0" />
    <RenderTarget id="LENS_ANABUF_A"      depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.0625"    allowDcc="false" />    
    <RenderTarget id="LENS_ANABUF_B"      depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.0625"    allowDcc="false" />

    <!--Bloom Targets-->
    <RenderTarget id="BLOOM_BLURBUF_2A"   depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.5"      applyDrs="true" allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_2B"   depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.5"      applyDrs="true" allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_2T"   depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.5"      applyDrs="true" allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_4A"   depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.25"     applyDrs="false" allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_4B"   depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.25"     applyDrs="false" allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_8A"   depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.125"    applyDrs="false" allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_8B"   depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.125"    applyDrs="false" allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_16"   depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.0625"   applyDrs="false" allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_32"   depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.03125"  applyDrs="false" allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_64"   depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.015625" applyDrs="false" allowDcc="false" />
    <RenderTarget id="BLOOM_FINALBUF"     depthBuf="false"        numColBufs="1" format="R11FG11FB10F"   scale="0.25"     applyDrs="false" allowDcc="false" />

    <RenderTarget id="BLOOM_EXPBUF_A"     depthBuf="false"        numColBufs="1" format="RED8"           scale="1.0"      allowDcc="false" width="4" height="4" resScaling="false" />
    <RenderTarget id="BLOOM_EXPBUF_B"     depthBuf="false"        numColBufs="1" format="RED8"           scale="1.0"      allowDcc="false" width="4" height="4" resScaling="false" />

    <!--FSR2 Utility Targets-->
    <RenderTarget id="LUM_BUF_OP"         depthBuf="false"        numColBufs="1"  format="RED8"          scale="1.0" applyDrs="true" allowDcc="NEXT" />
    <RenderTarget id="LUM_BUF_TR"         depthBuf="false"        numColBufs="1"  format="RED8"          scale="1.0" applyDrs="true" allowDcc="NEXT" />

    <!--FSR2 Targets-->
    <RenderTargetGroup id="FSR2" platforms="PC|SCARLETT|PS5BASE|XBOX|PS4|OUNCE">
    <RenderTarget id="FSR2_PreparedInputColor"               depthBuf="false"       numColBufs="1"  format="RGBA16F"        scale="1.0" applyDrs="true"  allowDcc="false" esramPageColBuf0="308" />
    <RenderTarget id="FSR2_ReconstructedPrevNearestDepth"    depthBuf="false"       numColBufs="1"  format="RED32UI"        scale="1.0" applyDrs="true"  allowDcc="false" shareTarget0="RED32UI_BUF_2" esramPageColBuf0="76" pointSampleColBuf0="true" />
    <RenderTarget id="FSR2_DilatedVelocity"                  depthBuf="false"       numColBufs="1"  format="RG16F"          scale="1.0" applyDrs="true"  allowDcc="NEXT"  esramPageColBuf0="134" />
    <RenderTarget id="FSR2_DilatedDepth"                     depthBuf="false"       numColBufs="1"  format="RED16F"         scale="1.0" applyDrs="true"  allowDcc="false" />
    <RenderTarget id="FSR2_DepthClip"                        depthBuf="false"       numColBufs="1"  format="RED8"           scale="1.0" applyDrs="true"  allowDcc="false" />
    <RenderTarget id="FSR2_LockStatus1"                      depthBuf="false"       numColBufs="1"  format="R11FG11FB10F"   scale="1.0" applyDrs="false" allowDcc="NEXT"  postUpscale="true" />
    <RenderTarget id="FSR2_LockStatus2"                      depthBuf="false"       numColBufs="1"  format="R11FG11FB10F"   scale="1.0" applyDrs="false" allowDcc="NEXT"  postUpscale="true" />
    <RenderTarget id="FSR2_InternalUpscaled1"                depthBuf="false"       numColBufs="1"  format="RGBA16F"        scale="1.0" applyDrs="false" allowDcc="false" postUpscale="true" />
    <RenderTarget id="FSR2_InternalUpscaled2"                depthBuf="false"       numColBufs="1"  format="RGBA16F"        scale="1.0" applyDrs="false" allowDcc="false" postUpscale="true" />
    <RenderTarget id="FSR2_ExposureMips"                     depthBuf="false"       numColBufs="1"  format="RED16F"         scale="0.5" applyDrs="true"  allowDcc="false" hasMips="true"  autoGenMips="false" mipsSRVs="true" />
    <RenderTarget id="FSR2_LumaHistory1"                     depthBuf="false"       numColBufs="1"  format="RGBA8"          scale="1.0" applyDrs="true"  allowDcc="NEXT"  />
    <RenderTarget id="FSR2_LumaHistory2"                     depthBuf="false"       numColBufs="1"  format="RGBA8"          scale="1.0" applyDrs="true"  allowDcc="NEXT"  />
    <RenderTarget id="FSR2_ReactiveMaskMax"                  depthBuf="false"       numColBufs="1"  format="RG8"            scale="1.0" applyDrs="true"  allowDcc="NEXT"  />
    <RenderTarget id="FSR2_DefaultTrasparencyMask"           depthBuf="false"       numColBufs="1"  format="RED8"           scale="1.0" applyDrs="false" allowDcc="false" width="1"   height="1"  resScaling="false" />
    <RenderTarget id="RED8_BUF_REACT"                        depthBuf="false"       numColBufs="1"  format="RED8"           scale="1.0" applyDrs="true" allowDcc="false" />
        
    </RenderTargetGroup>

    <!--Refraction Targets-->
    <RenderTarget id="REFR_DIST_BUF"      depthBuf="false"        numColBufs="3" format0="R11FG11FB10F" format1="R11FG11FB10F" format2="RED8"          scale="1.0"       applyDrs="true" allowDcc="false"          shareTarget0="REFR_COLOUR"  shareBuffer0="0"  shareTarget1="REFR_MAP"   shareBuffer1="0" shareTarget2="REFR_BLEND"   shareBuffer2="0" />
    <RenderTarget id="REFR_MAP"           depthBuf="false"        numColBufs="1" format="R11FG11FB10F"  scale="1.0"     applyDrs="true" allowDcc="NEXT"    pointSampleColBuf0="true"   shareTarget0="HDRBUF_1"     shareBuffer0="0" />
    <RenderTarget id="REFR_BLEND"         depthBuf="false"        numColBufs="1" format="RED8"          scale="1.0"     applyDrs="true" allowDcc="false"   pointSampleColBuf0="false"  shareTarget0="RED8_BUF_1"   shareBuffer0="0" />

    <RenderTarget id="REFR_BUF"                                   depthBuf="false"        numColBufs="6" format0="R11FG11FB10F" format1="RED8"         format2="R11FG11FB10F"  format3="RED8"    format4="R11FG11FB10F"  format5="RED16F"    pointSampleColBuf4="true" pointSampleColBuf5="true" scale="1.0"  applyDrs="true" allowDcc="false" allowDcc0="false" allowDcc5="true"  shareTarget0="REFR_COLOUR" shareBuffer0="0"  shareTarget1="REFR_ALPHA" shareBuffer1="0"    shareTarget2="REFR_COLOUR_B" shareBuffer2="0" shareTarget3="REFR_ALPHA_B" shareBuffer3="0"  shareTarget4="REFR_DIR"       shareBuffer4="0"  shareTarget5="REFR_DEPTH_REV_Z" shareBuffer5="0" />
    <RenderTarget id="REFR_COLOUR"                                depthBuf="false"        numColBufs="1" format="R11FG11FB10F"  scale="1.0"     applyDrs="true" allowDcc="false"   pointSampleColBuf0="false"  shareTarget0="HDRBUF_2"     shareBuffer0="0" />
    <RenderTarget id="REFR_ALPHA"                                 depthBuf="false"        numColBufs="1" format="RED8"          scale="1.0"     applyDrs="true" allowDcc="false"   pointSampleColBuf0="false"  shareTarget0="RED8_BUF_0"   shareBuffer0="0" />
    <RenderTarget id="REFR_COLOUR_B"                              depthBuf="false"        numColBufs="1" format="R11FG11FB10F"  scale="1.0"     applyDrs="true" allowDcc="NEXT"    pointSampleColBuf0="false"  shareTarget0="HDRBUF_1"     shareBuffer0="0" />
    <RenderTarget id="REFR_ALPHA_B"                               depthBuf="false"        numColBufs="1" format="RED8"          scale="1.0"     applyDrs="true" allowDcc="false"   pointSampleColBuf0="false"  shareTarget0="RED8_BUF_1"   shareBuffer0="0" />
    <RenderTarget id="REFR_DIR"                                   depthBuf="false"        numColBufs="1" format="R11FG11FB10F"  scale="1.0"     applyDrs="true" allowDcc="false"   pointSampleColBuf0="true"   shareTarget0="HDRBUF_3"     shareBuffer0="0" />
    <RenderTarget id="REFR_DEPTH_REV_Z"                           depthBuf="false"        numColBufs="1" format="RED16F"        scale="1.0"     applyDrs="true" allowDcc="true"    pointSampleColBuf0="true"   />
    <RenderTarget id="REFR_LIGHTSHAFT"                            depthBuf="false"        numColBufs="1" format="R11FG11FB10F"  scale="1.0"     applyDrs="true" allowDcc="false"   pointSampleColBuf0="false"  shareTarget0="HDRBUF_3"     shareBuffer0="0" />

    <!--Depth Targets-->
    <RenderTarget id="DEPTH_BACK"        platforms="NEXT,XBOX,PC,PS4,HHELD"    depthBuf="true"   depthBufUsesBB="false"  numColBufs="0"  format="RGBA8"  scale="1.0" applyDrs="true" stencilBuf="true" />
    <RenderTarget id="DEPTH_PSSR"        platforms="TRINITY"                   depthBuf="true"   depthBufUsesBB="false"  numColBufs="0"  format="RGBA8"  scale="1.0" applyDrs="true" stencilBuf="true" esramPageDepthBuf="0" />     
    <RenderTarget id="DEPTH"             platforms="NEXT,XBOX,PC,PS4,HHELD"    depthBuf="true"   depthBufUsesBB="false"  numColBufs="0"  format="RGBA8"  scale="1.0" applyDrs="true" stencilBuf="true" esramPageDepthBuf="0" crossPipeShareId="DEPTH_SHARED" />
    <RenderTarget id="DEPTH_WATER"       platforms="NEXT,XBOX,PC,PS4,HHELD"    depthBuf="true"   depthBufUsesBB="false"  numColBufs="0"  format="RGBA8"  scale="1.0" applyDrs="true" stencilBuf="true" />
    <RenderTarget id="DEPTH_DOWN_REV_Z"  platforms="NEXT,XBOX,PC,PS4,HHELD"    depthBuf="true"   depthBufUsesBB="false"  numColBufs="0"  format="RGBA8"  scale="0.5" applyDrs="true" stencilBuf="true" pointSampleColBuf0="true"   />
    <RenderTarget id="DEPTH_OCCLUSION"   platforms="PC"                     titles="future" depthBuf="true" depthBufUsesBB="false"  numColBufs="0"  format="RGBA8"  scale="1.0" applyDrs="true" stencilBuf="true" esramPageDepthBuf="0" />
    <RenderTarget id="DEPTH_BACK"        platforms="OUNCE"              depthBuf="true"   depthBufUsesBB="false"  numColBufs="0"  format="RGBA8"  scale="1.0" applyDrs="true" stencilBuf="true" depthFormat="DEPTH24" />
    <RenderTarget id="DEPTH"             platforms="OUNCE"              depthBuf="true"   depthBufUsesBB="false"  numColBufs="0"  format="RGBA8"  scale="1.0" applyDrs="true" stencilBuf="true" depthFormat="DEPTH24" crossPipeShareId="DEPTH_SHARED" />
    <RenderTarget id="DEPTH_WATER"       platforms="OUNCE"              depthBuf="true"   depthBufUsesBB="false"  numColBufs="0"  format="RGBA8"  scale="1.0" applyDrs="true" stencilBuf="true" depthFormat="DEPTH24" />
    <RenderTarget id="DEPTH_DOWN_REV_Z"  platforms="OUNCE"              depthBuf="true"   depthBufUsesBB="false"  numColBufs="0"  format="RGBA8"  scale="0.5" applyDrs="true" stencilBuf="true" depthFormat="DEPTH24" pointSampleColBuf0="true"   />

    <RenderTarget id="DEPTH_DOWN"                                                           depthBuf="false"                        numColBufs="1"  format="RED32F" scale="0.5" applyDrs="true" pointSampleColBuf0="true"  allowDcc="false"   esramPageColBuf0="250" crossPipeShareId="DEPTHD_SHARED" />	  
    <RenderTarget id="DEPTH_PART"                                       depthBuf="false"                          numColBufs="1"  format="RED32F" scale="0.5" applyDrs="true" pointSampleColBuf0="true"   />
    <RenderTarget id="DEPTH_LINEAR"                                     depthBuf="false"                          numColBufs="1"  format="RED32F" scale="1.0" applyDrs="true" pointSampleColBuf0="true"  esramPageColBuf0="76"  crossPipeShareId="DEPTH_LINEAR_SHARED" />
    <RenderTarget id="DEPTH_WATER_LINEAR"                               depthBuf="false"                          numColBufs="1"  format="RED32F" scale="1.0" applyDrs="true" pointSampleColBuf0="true"  />
    <RenderTarget id="DEPTH_WATER_DOWN"                                 depthBuf="false"                          numColBufs="1"  format="RED32F" scale="0.5" applyDrs="true" pointSampleColBuf0="true"  allowDcc="false" />
    <RenderTarget id="DEPTH_ASYNC"                                      depthBuf="false"                          numColBufs="1"  format="RED32F" scale="1.0" applyDrs="true" pointSampleColBuf0="true"  esramPageColBuf0="76"  />
    <RenderTarget id="DEPTH_HI_LOW_Z"     platforms="NEXT|XB1X|OUNCE"   depthBuf="false"                          numColBufs="1"  format="RG16F"  scale="0.5" applyDrs="true" pointSampleColBuf0="true"  allowDcc="true"   hasMips="true" autoGenMips="false" mipsSRVs="true" />

    <!-- Depth Reprojection Targets -->
    <RenderTarget id="DEPTH_REPRJ_U"                                    depthBuf="false"  numColBufs="1"  format="RED32UI"    scale="1.0"  applyDrs="true" pointSampleColBuf0="true" shareTarget0="RED32UI_BUF_1" />
    <RenderTarget id="DEPTH_REPRJ_U_H"                                  depthBuf="false"  numColBufs="1"  format="RED32UI"    scale="0.5"  applyDrs="true" pointSampleColBuf0="true" />
    <RenderTarget id="DEPTH_REPRJ_F"                                    depthBuf="false"  numColBufs="1"  format="RED32F"     scale="0.25" applyDrs="true" pointSampleColBuf0="true" hasMips="true" autoGenMips="false" mipsSRVs="true" />

    <!-- Depth Masks -->
    <RenderTarget id="DEPTH_MASK_BUFF"                                  depthBuf="false"  numColBufs="1"  format="RED32UI"    scale="1.0"  applyDrs="true" pointSampleColBuf0="true" shareTarget0="RED32UI_BUF_0" />
    <RenderTarget id="DEPTH_MASK_LITE_BUFF"                             depthBuf="false"  numColBufs="1"  format="RED8UI"     scale="1.0"  applyDrs="true" pointSampleColBuf0="true" shareTarget0="RED8UI_BUF_0"  />

    <!--HDR Targets-->
    <RenderTarget id="HDRBUF_0"                                         depthBuf="false"  numColBufs="1"  format="R11FG11FB10F"  scale="1.0" applyDrs="true" allowDcc="false"  esramPageColBuf0="366" />
    <RenderTarget id="HDRBUF_1"                                         depthBuf="false"  numColBufs="1"  format="R11FG11FB10F"  scale="1.0" applyDrs="true" allowDcc="false"  esramPageColBuf0="424" />
    <RenderTarget id="HDRBUF_2"                                         depthBuf="false"  numColBufs="1"  format="R11FG11FB10F"  scale="1.0" applyDrs="true" allowDcc="NEXT" />
    <RenderTarget id="HDRBUF_3"                                         depthBuf="false"  numColBufs="1"  format="R11FG11FB10F"  scale="1.0" applyDrs="true" allowDcc="PS5BASE,SCARLETT"   esramPageColBuf0="250" />

    <!--RED8 Targets-->
    <RenderTarget id="RED8_BUF_0"                                       depthBuf="false"  numColBufs="1"  format="RED8"          scale="1.0" applyDrs="true" allowDcc="false" />
    <RenderTarget id="RED8_BUF_1"                                       depthBuf="false"  numColBufs="1"  format="RED8"          scale="1.0" applyDrs="true" allowDcc="false" />
    
    <!--RED8UI Targets-->
    <RenderTarget id="RED8UI_BUF_0"                                     depthBuf="false"  numColBufs="1"  format="RED8UI"        scale="1.0" applyDrs="true" allowDcc="false" />

    <!--RED32UI Targets-->
    <RenderTarget id="RED32UI_BUF_0"                                    depthBuf="false"  numColBufs="1"  format="RED32UI"       scale="1.0" applyDrs="true" pointSampleColBuf0="true" allowDcc="false" />
    <RenderTarget id="RED32UI_BUF_1"                                    depthBuf="false"  numColBufs="1"  format="RED32UI"       scale="1.0" applyDrs="true" pointSampleColBuf0="true" allowDcc="false" />
    <RenderTarget id="RED32UI_BUF_2"                                    depthBuf="false"  numColBufs="1"  format="RED32UI"       scale="1.0" applyDrs="true" pointSampleColBuf0="true" allowDcc="false" esramPageColBuf0="76" />

    <!--RG8 Snorm Targets-->
    <RenderTarget id="RG8S_BUF_0"                                       depthBuf="false"  numColBufs="1"  format="RG8_Snorm"     scale="1.0" applyDrs="true" allowDcc="true" />

    <!--RGBA8 Targets-->
    <RenderTarget id="RGBA8_BUF_0"                                      depthBuf="false"  numColBufs="1"  format="RGBA8"         scale="1.0" applyDrs="true" allowDcc="false" esramPageColBuf0="134" />
    <RenderTarget id="RGBA8_BUF_1"                                      depthBuf="false"  numColBufs="1"  format="RGBA8"         scale="1.0" applyDrs="true" allowDcc="true"  />

    <!--RGB10A2 Targets-->
    <RenderTarget id="RGB10A2_BUF_0"                                    depthBuf="false"  numColBufs="1"  format="RGB10A2"       scale="1.0" applyDrs="true" allowDcc="false" esramPageColBuf0="192" />
    <RenderTarget id="RGB10A2_BUF_1"      platforms="NEXT|XB1X"         depthBuf="false"  numColBufs="1"  format="RGB10A2"       scale="1.0" applyDrs="true" allowDcc="true"  />
    <RenderTarget id="RGB10A2_BUF_2"      platforms="NEXT|XB1X"         depthBuf="false"  numColBufs="1"  format="RGB10A2"       scale="1.0" applyDrs="true" allowDcc="true"  />
    <RenderTarget id="RGB10A2_BUF_3"      platforms="NEXT|XB1X"         depthBuf="false"  numColBufs="1"  format="RGB10A2"       scale="1.0" applyDrs="true" allowDcc="true"  />
  </Setup>

  <!-- Scene rendering -->
  <CommandQueue>
      
    <Stage id="StartAsyncNext">
        <!-- <StartPrevFrameAsync /> -->
        <AllowWaitForSafeRendering />
    </Stage>      

    <Stage id="DepthReproject" enabled="false">
      <BeginTarget target="DEPTH_REPRJ_U" frameIdx="prev" />
      <ClearTarget type="uint" colBuf0="true"   col_R="4294967295"/>
      <EndTarget flushCB="true" flushDB="false" flushForCompute="true" />
      <BeginTarget target="RED32UI_BUF_0"  depthTarget="DEPTH_BACK"  readOnlyDepth="true" />
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gBufferMap"      sourceRT="DEPTH_BACK"     bufIndex="32" frameIdx="prev" />
      <BindBuffer sampler="gDepthReprjFrwd" sourceRT="DEPTH_REPRJ_U"  bufIndex="0"  frameIdx="prev" bindAsRwImage="true" />
      <SetContext zwrite="false" colourWrite="false" cullMode="none" blendMode="replace" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_REPRJ_FRWD" />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" flushForCompute="true" />

      <BeginTarget target="DEPTH_REPRJ_U" frameIdx="prev" />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_REPRJ_U_H" frameIdx="prev" />
      <ColourMask channels="R" />
      <BindBuffer sampler="gBuffer0uMap" sourceRT="DEPTH_REPRJ_U" bufIndex="0" frameIdx="prev" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_U_DOWN" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_REPRJ_F" mipLevel="0" frameIdx="prev" />
      <ColourMask channels="R" />
      <BindBuffer sampler="gBuffer0uMap" sourceRT="DEPTH_REPRJ_U_H" bufIndex="0" frameIdx="prev" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_I2F" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <UpdateVariable id="HizSrcMipIndex" operation="set" value="0" />
      <UpdateVariable id="HizDstMipIndex" operation="set" value="1" />
      <PushMarker id="Generate HiZ" />
      <While conditionType="variable" id="HizDstMipIndex" test="less" sourceType="rtMipCount" source="DEPTH_REPRJ_F"/>

        <BeginTarget target="DEPTH_REPRJ_F" mipLevelFromVar="HizDstMipIndex" frameIdx="prev" />
        <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_REPRJ_F" bufIndex="0" mipLevelFromVar="HizSrcMipIndex" frameIdx="prev" />
        <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
        <DrawQuad material="materials/PostProcess.material.mbin" context="LOW_Z" />
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />

        <UpdateVariable id="HizSrcMipIndex" operation="add" value="1" />
        <UpdateVariable id="HizDstMipIndex" operation="add" value="1" />
      <EndWhile />
      <PopMarker />
    </Stage>

    <Stage id="InstanceCulling">
      <PrepareInstanceCulling />
      <BindBuffer sampler="gOcclusionTexture" sourceRT="DEPTH_REPRJ_F" bufIndex="0" addressMode="clampToEdge" frameIdx="prev" />
      <IssueInstanceCulling viewCount="4" />
    </Stage>
      
    <Stage id="MeshWaterComputeDispatch">
      <If>
        <Conditions operation="and">
          <Condition type="variable" id="WaterRenderer" test="notEqual" sourceType="variable" source="WaterRenderer_RayTraced" />
          <Condition type="variable" id="WaterState"    test="notEqual" sourceType="variable" source="WaterState_NoWater" />
        </Conditions>
      </If>
        <SyncGraphicsToCompute compute="async" />
        <DoForwardLightLoop type="Water" class="MeshWater" context="CASCADE_WAVE_GERSTNER" order="" />
      <EndIf />
    </Stage>      

    <Stage id="AttributesNG" enabled="false">
      <BeginTarget target="GBUFFER" depthTarget="DEPTH" />

      <ColourMask channels="RGBA"/>
      <!-- Clear targets, colbuf1 is cleared separately to max depth -->
      <ClearTarget colBuf0="false"  colBuf1="false" colBuf2="false"  colBuf3="false" colBuf4="false" depthBuf="true"   stencilBuf="true" />
      <DiscardTargetContents colBuf0="true"  colBuf1="true" colBuf2="true"  colBuf3="true" colBuf4="true" />
      <ColourMask channels="RGBA"/>
      <!--Enable all attached RTs, since ClearTarget only (re-)enables RT0 on PS4-->

      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF"  bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />

      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1" />
      <DrawGeometry type="Mesh"         class="Opaque"          context="DEPTHONLY_FRWRD"             order="STATECHANGES" />

      <!-- Z Pre-Pass for Cutout (grass etc) -->
      <If conditionType="legacy" enabled="true" />
        <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1" />
        <DrawGeometry type="InstanceMesh" class="DoubleSided"    context="DEPTHONLY_DEFER_INSTANCE"    order="MESH" />
      <EndIf />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1" />
      <DrawGeometry type="InstanceMesh" class="Cutout"         context="DEPTHONLY_DEFER_INSTANCE"    order="MESH" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite"  stencilRef="9" />
      <DrawGeometry type="Terrain"      class="LOD0"           context="DEPTHONLY_DEFER"             order="" />
      <DrawGeometry type="Terrain"      class="LOD1"           context="DEPTHONLY_DEFER"             order="" />
      <DrawGeometry type="Terrain"      class="LOD2"           context="DEPTHONLY_DEFER"             order="" />
      <!-- Opaques-->

      <ColourMask channels="RGBA"/>
      <!--Enable all attached RTs, since ClearTarget only (re-)enables RT0 on PS4-->
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1" />
      <DrawGeometry type="Mesh"         class="Highlight"         context="LIT_DEFER"             order="STATECHANGES" />
      <If conditionType="legacy" enabled="false" />
        <DrawGeometry type="Mesh"         class="HighlightOverlay"  context="LIT_DEFER"             order="STATECHANGES" />
      <EndIf />
      <DrawGeometry type="Mesh"         class="HighlightOccluded" context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="Cutout"            context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="OpaqueBeforeUI"    context="LIT_DEFER"             order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="65" />
      <DrawGeometry type="Mesh"         class="ScreenSpaceReflections"          context="LIT_DEFER"             order="STATECHANGES"    drawCountVariable="SSRGeometryDrawCount" />

      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1" />
      <DrawGeometry type="Mesh"         class="DoubleSided"             context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="HighlightDoubleSided"    context="LIT_DEFER"             order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskWrite"  stencilRef="9" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DF_CACHE_FB"       order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_TESS_FB"           order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_CACHE"       order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_TESS"        order="FRONT_TO_BACK" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1" />
      <DrawGeometry type="InstanceMesh" class="Opaque"    context="LIT_DEFER_INSTANCE"    order="MESH" />

      <DrawGeometry type="Mesh"         class="Glow"      context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="InstanceMesh" class="Glow"      context="LIT_DEFER_INSTANCE"    order="MESH" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="equal" />

      <If conditionType="legacy" enabled="true" />
        <SetShaderControl psWaveLimit="0" />

        <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_STC_T_SPLIT"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_DEFER_STC_T_SPLIT"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD2"      context="LIT_DEFER_STC_T_SPLIT"    order="FRONT_TO_BACK" />

        <SetShaderControl psWaveLimit="7" />

        <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_N_FACING"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_DEFER_N_FACING"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD2"      context="LIT_DEFER_N_FACING"    order="FRONT_TO_BACK" />

        <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="9" />
        <SetShaderControl vsLateAllocMax="22" psWaveLimit="0" />

        <DrawGeometry type="Terrain"      class="LOD3"      context="LIT_DEF_F_STC_T_SPLIT" order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD3"      context="LIT_DEFER"             order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="PLANET"    context="LIT_DEFER_LOW"         order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="ASTEROID"  context="LIT_DEFER_ASTEROID"    order="STATECHANGES" />
      <Else />
        <SetShaderControl />
    
        <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_Z_FACING"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_X_FACING"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_Y_FACING"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_N_FACING"    order="FRONT_TO_BACK" />
    
        <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_DEFER_Z_FACING"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_DEFER_X_FACING"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_DEFER_Y_FACING"    order="FRONT_TO_BACK" />
        <SetShaderControl vsLateAllocMax="0" />
        <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_DEFER_N_FACING"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD2"      context="LIT_DEFER_N_FACING"    order="FRONT_TO_BACK" />
    
        <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="9" />
        <SetShaderControl vsLateAllocMax="22" />
    
        <DrawGeometry type="Terrain"      class="LOD3"      context="LIT_DEFER"             order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="PLANET"    context="LIT_DEFER_LOW"         order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="ASTEROID"  context="LIT_DEFER_ASTEROID"    order="STATECHANGES" />
      <EndIf />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="equal" />
      <DrawGeometry type="Mesh"         class="Opaque"          context="LIT_DEFER"             order="STATECHANGES" />
      
      <If conditionType="variable" id="WaterDebugProxyMeshes" />
        <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1" />
        <DrawGeometry type="Mesh" class="WaterVolumeProxy" context="LIT_DEFER" order="" />
        <DrawGeometry type="Mesh" class="WaterVolumeProxyInternal" context="LIT_DEFER" order="" />
      <EndIf />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="equal" />
      <DrawGeometry type="InstanceMesh" class="Cutout"      context="LIT_DEFER_ZE_INSTANCE" order="MESH" />
      <If conditionType="legacy" enabled="true" />
        <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="equal" stencilMode="maskWrite" stencilRef="1" />
        <DrawGeometry type="InstanceMesh" class="DoubleSided" context="LIT_DEFER_ZE_INSTANCE" order="MESH" />
      <Else />
        <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1" />
        <DrawGeometry type="InstanceMesh" class="DoubleSided" context="LIT_DEFER_INSTANCE" order="MESH" />
      <EndIf />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskReadWriteInvert" stencilRef="0" stencilMaskRead="1" stencilMaskWrite="9"/>
      <DrawGeometry type="Mesh"         class="AtmosphereNear" context="PLANET_NEAR"      order="STATECHANGES"  />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="9"/>
      <DrawGeometry type="Mesh"         class="Atmosphere"          context="PLANET"           order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="AtmosphereGasGiant"  context="PLANET_GASGIANT"  order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="always" />
      <DrawGeometry type="Mesh"         class="GunOpaque"    context="DEPTHONLY_FRWRD"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="GunGlow"      context="DEPTHONLY_FRWRD"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="GunDecal"     context="DEPTHONLY_FRWRD"             order="STATECHANGES"  />
      <!-- These aren't real decals, they are just meshes with 2 UV sets which is why they are still rendered here. -->

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="3"/>
      <DrawGeometry type="Mesh"         class="GunOpaque"    context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="GunGlow"      context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="GunDecal"     context="LIT_DEFER"             order="STATECHANGES"  />

      <UnbindBuffers />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" stencilMode="maskRead" stencilRef="0" depthTest="always" />
      <DoForwardLightLoop type="Mesh" class="Sky" context="CLEAR" order="BACK_TO_FRONT" />

      <EndTarget flushCB="true" flushDB="true" />
    </Stage>
    
    
    <Stage id="Attributes">
      <BeginTarget target="GBUFFER" depthTarget="DEPTH" />

      <ColourMask channels="RGBA"/>
      <!-- Clear targets, colbuf1 is cleared separately to max depth -->
      <If conditionType="platform" id="XB1S" />        
      <ClearTarget colBuf0="true"  colBuf1="true" colBuf2="true"  colBuf3="false" colBuf4="false" depthBuf="true"   stencilBuf="true" />
      <Else />
      <ClearTarget colBuf0="false" colBuf1="false" colBuf2="false" colBuf3="false" colBuf4="false" colBuf5="false" depthBuf="true"   stencilBuf="true" />
      <EndIf />        
        
      <DiscardTargetContents colBuf0="true"  colBuf1="true" colBuf2="true"  colBuf3="true" colBuf4="true" />
      <ColourMask channels="RGBA"/> <!--Enable all attached RTs, since ClearTarget only (re-)enables RT0 on PS4-->

      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF"  bufIndex="32" />      
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />

      <!-- Z Pre-Pass for Cutout (grass etc) -->
      <If conditionType="legacy" enabled="true" />
        <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1" />
        <DrawGeometry type="InstanceMesh" class="DoubleSided"    context="DEPTHONLY_DEFER_INSTANCE"    order="MESH" />
      <EndIf />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="less" />
      <DrawGeometry type="InstanceMesh" class="Cutout"         context="DEPTHONLY_DEFER_INSTANCE"    order="MESH" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite"  stencilRef="9" />
      <DrawGeometry type="Terrain"      class="LOD0"           context="DEPTHONLY_DEFER"             order="" />
      <DrawGeometry type="Terrain"      class="LOD1"           context="DEPTHONLY_DEFER"             order="" />
      <DrawGeometry type="Terrain"      class="LOD2"           context="DEPTHONLY_DEFER"             order="" />      
      <!-- Opaques-->

      <ColourMask channels="RGBA"/> <!--Enable all attached RTs, since ClearTarget only (re-)enables RT0 on PS4-->
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1" />
      <DrawGeometry type="Mesh"         class="Opaque"            context="LIT_DEFER"             order="STATECHANGES" />

      <DrawGeometry type="Mesh"         class="Highlight"         context="LIT_DEFER"             order="STATECHANGES" />
      <If conditionType="legacy" enabled="false" />
        <DrawGeometry type="Mesh"         class="HighlightOverlay"  context="LIT_DEFER"             order="STATECHANGES" />
      <EndIf />
      <DrawGeometry type="Mesh"         class="HighlightOccluded" context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="Cutout"            context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="OpaqueBeforeUI"    context="LIT_DEFER"             order="STATECHANGES" />

      <If conditionType="variable" id="WaterDebugProxyMeshes" />
        <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1" />
        <DrawGeometry type="Mesh" class="WaterVolumeProxy" context="LIT_DEFER" order="" />
        <DrawGeometry type="Mesh" class="WaterVolumeProxyInternal" context="LIT_DEFER" order="" />
      <EndIf />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="65" />
      <DrawGeometry type="Mesh"         class="ScreenSpaceReflections"          context="LIT_DEFER"             order="STATECHANGES"    drawCountVariable="SSRGeometryDrawCount" />
 
      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1" />
      <DrawGeometry type="Mesh"         class="DoubleSided"             context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="HighlightDoubleSided"    context="LIT_DEFER"             order="STATECHANGES" />
     
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskWrite"  stencilRef="9" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DF_CACHE_FB"       order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_TESS_FB"           order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_CACHE"       order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_TESS"        order="FRONT_TO_BACK" />
        
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1" />
      <DrawGeometry type="InstanceMesh" class="Opaque"    context="LIT_DEFER_INSTANCE"    order="MESH" />
      
      <DrawGeometry type="Mesh"         class="Glow"      context="LIT_DEFER"             order="STATECHANGES" />    
      <DrawGeometry type="InstanceMesh" class="Glow"      context="LIT_DEFER_INSTANCE"    order="MESH" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="equal" />

     <If conditionType="legacy" enabled="true" />
        <SetShaderControl psWaveLimit="0" />
    
        <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_STC_T_SPLIT"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_DEFER_STC_T_SPLIT"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD2"      context="LIT_DEFER_STC_T_SPLIT"    order="FRONT_TO_BACK" />
    
        <SetShaderControl psWaveLimit="7" />
    
        <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_N_FACING"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_DEFER_N_FACING"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD2"      context="LIT_DEFER_N_FACING"    order="FRONT_TO_BACK" />
    
        <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="9"/>
        <SetShaderControl vsLateAllocMax="22" psWaveLimit="0" />
    
        <DrawGeometry type="Terrain"      class="LOD3"      context="LIT_DEF_F_STC_T_SPLIT"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD3"      context="LIT_DEFER"             order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="PLANET"    context="LIT_DEFER_LOW"         order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="ASTEROID"  context="LIT_DEFER_ASTEROID"    order="STATECHANGES" />
      <Else />
        <SetShaderControl />
    
        <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_Z_FACING"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_X_FACING"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_Y_FACING"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_DEFER_N_FACING"    order="FRONT_TO_BACK" />
    
        <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_DEFER_Z_FACING"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_DEFER_X_FACING"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_DEFER_Y_FACING"    order="FRONT_TO_BACK" />
        <SetShaderControl vsLateAllocMax="0" />
        <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_DEFER_N_FACING"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD2"      context="LIT_DEFER_N_FACING"    order="FRONT_TO_BACK" />
    
        <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="9"/>
        <SetShaderControl vsLateAllocMax="22" />
    
        <DrawGeometry type="Terrain"      class="LOD3"      context="LIT_DEFER"             order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="PLANET"    context="LIT_DEFER_LOW"         order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="ASTEROID"  context="LIT_DEFER_ASTEROID"    order="STATECHANGES" />
    <EndIf />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="equal" stencilMode="maskWrite" stencilRef="1" />
      <DrawGeometry type="InstanceMesh" class="Cutout"      context="LIT_DEFER_ZE_INSTANCE" order="MESH" />

      <If conditionType="legacy" enabled="true" />
        <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="equal" stencilMode="maskWrite" stencilRef="1" />
        <DrawGeometry type="InstanceMesh" class="DoubleSided" context="LIT_DEFER_ZE_INSTANCE" order="MESH" />
      <Else />
        <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1" />
        <DrawGeometry type="InstanceMesh" class="DoubleSided" context="LIT_DEFER_INSTANCE" order="MESH" />
      <EndIf />
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskReadWriteInvert" stencilRef="0" stencilMaskRead="1" stencilMaskWrite="9"/>
      <DrawGeometry type="Mesh"         class="AtmosphereNear" context="PLANET_NEAR"      order="STATECHANGES"  />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="25"/>
      <DrawGeometry type="Mesh"         class="Atmosphere"          context="PLANET"            order="BACK_TO_FRONT" />
      <DrawGeometry type="Mesh"         class="AtmosphereGasGiant"  context="PLANET_GASGIANT"   order="BACK_TO_FRONT" />

      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="always" />
      <DrawGeometry type="Mesh"         class="GunOpaque"    context="DEPTHONLY_FRWRD"       order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="GunGlow"      context="DEPTHONLY_FRWRD"       order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="GunDecal"     context="DEPTHONLY_FRWRD"       order="STATECHANGES"  />
      <!-- These aren't real decals, they are just meshes with 2 UV sets which is why they are still rendered here. -->

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="3"/>
      <DrawGeometry type="Mesh"         class="GunOpaque"    context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="GunGlow"      context="LIT_DEFER"             order="STATECHANGES" />
      <DrawGeometry type="Mesh"         class="GunDecal"     context="LIT_DEFER"             order="STATECHANGES"  />

      <UnbindBuffers />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" stencilMode="maskRead" stencilRef="0" depthTest="always" />
      <DoForwardLightLoop type="Mesh" class="Sky" context="CLEAR" order="BACK_TO_FRONT" />

      <EndTarget flushCB="true" flushDB="true" />
    </Stage>

    <Stage id="PlanetsLinearDepth" enabled="true">
      <If conditionType="platform" id="OUNCE" />
      <BeginTarget target="DEPTH_LINEAR" depthTarget="DEPTH" readOnlyDepth="true" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="25" stencilMask="25" />
      <DrawGeometry type="Mesh"         class="Atmosphere"          context="PLANET_LINDEP"     order="BACK_TO_FRONT" />
      <DrawGeometry type="Mesh"         class="AtmosphereGasGiant"  context="PLANET_GAS_LDEP"   order="BACK_TO_FRONT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />
      <EndIf />
    </Stage>

    <Stage id="ShowProbes" enabled="false">
      <BeginTarget target="GBUFFER" depthTarget="DEPTH" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gShadowMap"        sourceRT="SHADOWBUF"      bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"   sourceRT="CLOUDSHADOWS"   bufIndex="0" addressMode="wrap" />
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1" />
      <DrawGeometry type="Mesh"         class="ReflectionProbe" context="LIT_DEFER"             order="STATECHANGES" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />
    </Stage>

    <Stage id="MeshWaterMask">
        <If conditionType="variable" id="WaterRenderer" test="equal"  sourceType="variable" source="WaterRenderer_MeshedDeferred" />
        <If conditionType="variable" id="WaterState"  test="notEqual" sourceType="variable" source="WaterState_NoWater" />
          <!-- Wait for Water compute to complete -->
          <SyncComputeToGraphics compute="async" />
          <BeginTarget target="DEPTH_WATER" />
          <ClearTarget depthBuf="true" colBuf0="false" stencilBuf="true" col_R="0.0" col_G="0.0" col_B="0.0" />
          <!-- non-depth-tested water external exclusion meshes (always closed surfaces), let's us know if we are inside our outside of a proxy mesh (can only be 1 if inside, due to them all being closed surfaces) -->
          <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="false" stencilMode="maskReadWriteInvertAlways" stencilMaskRead="0" stencilMaskWrite="4" stencilRef="0" />
          <DoForwardLightLoop type="Mesh" class="WaterVolumeProxy" context="DEPTHONLY_FRWRD" order="" />

          <!-- non-depth-tested water internal exclusion meshes (always closed surfaces), let's us know if we are inside our outside of a proxy mesh (can only be 1 if inside, due to them all being closed surfaces) -->
          <SetContext zwrite="false" colourWrite="false" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskReadWriteInvertAlways" stencilMaskRead="0" stencilMaskWrite="4" stencilRef="0" />
          <DoForwardLightLoop type="Mesh" class="WaterVolumeProxyInternal" context="DEPTHONLY_FRWRD" order="" />

          <EndTarget flushCB="false" flushDB="true" />

          <BeginTarget target="WATER_PROXY_DEPTH" depthTarget="DEPTH_WATER" readOnlyDepth="true" />
          <ColourMask channels="RGBA" />
          <ClearTarget depthBuf="false" colBuf0="true" stencilBuf="false" col_R="0.0" col_G="0.0" col_B="0.0" />

          <!-- ON PLAYSTATION OUR COLOUR CLEAR TARGET DOESN'T WORK PROPERLY :( )-->
          <If conditionType="platform" id="ORBIS" />  
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" />
          <DrawQuad material="materials/PostProcess.material.mbin" context="CLEAR_ZERO" />
          <EndIf />

          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"  stencilMode="maskRead" stencilMask="4" stencilRef="4" />          
          <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_WATER" bufIndex="32" />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_REV2LIN" />
          <UnbindBuffers />


          <EndTarget flushCB="true" flushDB="false" />

          <BeginTarget target="WATER_MASK" depthTarget="DEPTH_WATER" />
          <ClearTarget depthBuf="true" colBuf0="true" colBuf1="true"  stencilBuf="false" col_R="0.0" col_G="0.0" col_B="0.0" />
          <ColourMask channels="RGBA" />

          <BindBuffer sampler="gDepthMap" sourceRT="WATER_PROXY_DEPTH" bufIndex="0" />
          <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="false" stencilMode="maskWrite" stencilMask="3" stencilRefFront="1" stencilRefBack="2" />
          <DoForwardLightLoop type="Water" class="MeshWater" context="MESH_WATER_MASK" order="" />
          <UnbindBuffers />

          <!-- depth-tested water exclusion meshes (always closed surfaces), let's us know the number of boundaries we pass-through before we "hit" the water surface -->
          <SetContext zwrite="false" colourWrite="false" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="false"  stencilMode="maskReadWriteInvert" stencilMaskRead="0" stencilMaskWrite="8" stencilRef="0" />
          <DoForwardLightLoop type="Mesh" class="WaterVolumeProxy" context="DEPTHONLY_FRWRD" order="" />
          <DoForwardLightLoop type="Mesh" class="WaterVolumeProxyInternal" context="DEPTHONLY_FRWRD" order="" />

          <ColourMask channels="R" />

          <!-- don't draw water where we are outside of a proxy mesh, but have an odd number of depth-tested "hits" -->
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" alphaToCoverage="false" stencilMode="maskRead" stencilMask="12" stencilRef="8" />
          <DrawQuadMT material="materials/MeshWater.material.mbin" context="MESH_WATER_ERASE" />

          <!-- don't draw water where we are inside of a proxy mesh, but have an even number of depth-tested "hits" -->
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" alphaToCoverage="false" stencilMode="maskRead" stencilMask="12" stencilRef="4" />
          <DrawQuadMT material="materials/MeshWater.material.mbin" context="MESH_WATER_ERASE" />

          <EndTarget flushCB="true" flushDB="true" />
        <Else/>
          <BeginTarget target="WATER_MASK" depthTarget="DEPTH_WATER" />
          <ClearTarget depthBuf="true" colBuf0="true" colBuf1="true"  stencilBuf="false" col_R="0.0" col_G="0.0" col_B="0.0" />
          <EndTarget flushCB="true" flushDB="true" />
        <EndIf />
      <EndIf />
    </Stage>

    <Stage id="CopyDepth">
      <BeginTarget target="DEPTH_LINEAR" depthTarget="DEPTH" readOnlyDepth="true" />
      <ColourMask channels="RGBA"/>
      <If conditionType="platform" id="OUNCE" negate="true" />		
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <Else />		
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskRead" stencilRef="0"  stencilMask="16"  />
      <EndIf />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH" bufIndex="32" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_REV2LIN" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>                     

    <Stage id="MeshWaterDepthCopyFrontForVolumetrics">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_MeshedDeferred" />
      <If>
        <Conditions operation="or">
          <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_AboveWater" />
          <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_NearWaterSurface" />
        </Conditions>
      </If>
        <BeginTarget target="DEPTH_WATER_LINEAR" />
        <ColourMask channels="RGBA"/>
        <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
          <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_LINEAR" bufIndex="0" />
        <BindBuffer sampler="gBuffer1Map" sourceRT="WATER_MASK"  bufIndex="0" />
        <BindBuffer sampler="gBuffer2Map"  sourceRT="DEPTH_WATER" bufIndex="32" />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_LIN_WLESS" />
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />
        <Else />
      <If conditionType="variable" id="WaterState"  test="equal" sourceType="variable" source="WaterState_NoWater" />
        <BeginTarget target="DEPTH_WATER_LINEAR" depthTarget="DEPTH_WATER" />
        <ColourMask channels="RGBA"/>
          <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskwritealways" stencilRef="0" stencilMask="255" />
          <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_LINEAR"  bufIndex="0" />
            <DrawQuadMT material="materials/PostProcess.material.mbin" context="DPTH_LN_CPY_WRT_DPTH" />
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="true" />
      <Else />
        <BeginTarget target="DEPTH_WATER_LINEAR" />
        <ColourMask channels="RGBA"/>
        <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
        <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_LINEAR"  bufIndex="0" />
        <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY_R_TO_ARGB" />
        <UnbindBuffers />
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
      <EndIf />

      <BeginTarget target="DEPTH_WATER_DOWN" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_WATER_LINEAR"    bufIndex="0" />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" depthTest="always" />
        <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE_GBUFFERDEPTH" />
      <UnbindBuffers />
      <EndTarget flushCB="true" />
      <EndIf />
    </Stage>      

     <Stage id="MOTIONRESOLVE">
      <!-- wait until async next compute is done with MOTIONRESOLVE -->
      <SyncComputeToGraphics compute="async_next" markerIndex="1" />
      <If>
        <Conditions operation="or">
          <Condition type="stage" id="DLSS_APPLY"   enabled="true" />
          <Condition type="stage" id="XESS_APPLY"   enabled="true" />
          <Condition type="stage" id="FFXSR2_APPLY" enabled="true" />
        </Conditions>
      </If>
        <BeginTarget target="MOTION_BUFFS" />
        <DiscardTargetContents colBuf0="true" colBuf1="true" />
        <ColourMask channels="RGBA"/>
        <BindBuffer sampler="gBufferMap"  sourceRT="GBUFFER"  bufIndex="1"  />
        <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH"    bufIndex="32" />
        <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
        <DrawQuadMT material="materials/PostProcess.material.mbin" context="MOTIONRES_S_SCREEN" />
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />
       <Else/>
        <BeginTarget target="MOTIONRESOLVE" />
      <DiscardTargetContents colBuf0="true" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="GBUFFER"      bufIndex="1" />
        <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH"    bufIndex="32" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
        <DrawQuadMT material="materials/PostProcess.material.mbin" context="MOTIONRES_SIMPLE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
       <EndIf/>
    </Stage>

    <Stage id="MOTIONDILATE">       
      <SyncGraphicsToCompute compute="async" />
      <BeginTarget target="MOTION_MAXBUF_H" />
      <DiscardTargetContents colBuf0="true" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="MOTIONRESOLVE"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR"   bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MOTIONDILATE_H" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <SwapTargets targetA="MOTION_MAXBUF_0" targetB="MOTION_MAXBUF_1" />

      <BeginTarget target="MOTION_MAXBUF_0" />
      <DiscardTargetContents colBuf0="true" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="MOTION_MAXBUF_H"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR"     bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MOTIONDILATE_V" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="DepthDown">
      <BeginTarget target="DEPTH_DOWN" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_LINEAR"    bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE_GBUFFERDEPTH" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />    
    </Stage>

    <!-- This should only be used when no cloud shadow stage will be present, to avoid the scene being completely dark -->
    <Stage id="ClearCloudShadowsBuffer" enabled="false">
      <BeginTarget target="CLOUDSHADOWS" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="CLEAR_ONE" />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="NewCloudsShadows" enabled="false">
      <BeginTarget target="CLOUDSHADOWS" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBuffer1Map"  sourceRT="DEPTH_DOWN"    bufIndex="0"  />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="Materials/NewCloud.material.mbin" context="CLOUD_SHADOWS" width ="1.0" height="1.0" compute="async"  />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
      
    <Stage id="CloudsForWorldsAsync" enabled="false">
      <BeginTarget target="CLOUDS_MRT" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <If conditionType="variable" id="CloudQuality" test="equal" sourceType="variable" source="CloudQuality_Low" />
        <DrawQuad material="Materials/NewCloud.material.mbin" context="LOW_QUALITY_CLOUDS"  width ="1.0" height="1.0" compute="async" />
      <Else />
      <If conditionType="variable" id="CloudQuality" test="equal" sourceType="variable" source="CloudQuality_Mid" />
        <DrawQuad material="Materials/NewCloud.material.mbin" context="MID_QUALITY_CLOUDS"  width ="1.0" height="1.0" compute="async" />
      <Else />
        <DrawQuad material="Materials/NewCloud.material.mbin" context="HIGH_QUALITY_CLOUDS" width ="1.0" height="1.0" compute="async" />
      <EndIf />
      <EndIf />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <SwapTargets targetA="CLOUDS_FINAL"     targetB="CLOUDS_HISTORY"  />

      <BeginTarget target="CLOUDS_FINAL" />
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gBufferMap"  sourceRT="CLOUDS_COLOUR"    bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" />
      <DrawQuad material="Materials/NewCloud.material.mbin" context="CLOUDS_BLUR_H" width ="1.0" height="1.0" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="CLOUDS_COLOUR" />
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gBufferMap"  sourceRT="CLOUDS_FINAL"     bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" />
      <DrawQuad material="Materials/NewCloud.material.mbin" context="CLOUDS_BLUR_V" width ="1.0" height="1.0" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="CLOUDS_FINAL" />
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gBufferMap"  sourceRT="CLOUDS_DEPTH"     bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="CLOUDS_COLOUR"    bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="CLOUDS_HISTORY"   bufIndex="0"  frameIdx="prev" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" />
      <DrawQuad material="Materials/NewCloud.material.mbin" context="CLOUDS_TEMPORAL" width ="1.0" height="1.0" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="GTAOPack" enabled="false">
      <BeginTarget target="GTAO_PACK" />
      <ColourMask channels="R" />
      <BindBuffer sampler="gBuffer0Map"   sourceRT="DEPTH"    bufIndex="32" />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="GBUFFER"  bufIndex="3" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" />
      <DrawQuad material="materials/AO.material.mbin" context="GTAO_PACK_PARAMS" compute="async_exceptPS4" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="GTAOGen" enabled="false">
      <If conditionType="platform" id="NEXT|OUNCE" />
        <UpdateVariable id="GTAO_BentNormals" operation="set" value="1" />
      <EndIf/>

      <BeginTarget target="GTAO_BUFF_2" />
      <ColourMask channels="R"/>
      <BindBuffer sampler="gBuffer0uMap" sourceRT="GTAO_PACK" bufIndex="0" />
      <BindBuffer sampler="gBuffer0Map"  sourceRT="GBUFFER"   bufIndex="2" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" />
      <If conditionType="variable" id="GTAO_BentNormals" test="equal" value="0" />
        <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Low" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_GEN_LOW"       compute="async_exceptPS4" />
        <EndIf/>
        <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Medium" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_GEN_MEDIUM"    compute="async_exceptPS4" />
        <EndIf/>
        <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="High" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_GEN_HIGH"      compute="async_exceptPS4" />
        <EndIf/>
        <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Ultra" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_GEN_ULTRA"     compute="async_exceptPS4" />
        <EndIf/>
      <Else/>
        <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Low" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_GEN_LOW"    compute="async_exceptPS4" />
        <EndIf/>
        <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Medium" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_GEN_MEDIUM" compute="async_exceptPS4" />
        <EndIf/>
        <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="High" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_GEN_HIGH"   compute="async_exceptPS4" />
        <EndIf/>
        <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Ultra" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_GEN_ULTRA"  compute="async_exceptPS4" />
        <EndIf/>
      <EndIf/>
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="GTAOSpatial" enabled="false">
      <BeginTarget target="GTAO_BUFF_1" />
      <ColourMask channels="R" />
      <BindBuffer sampler="gBuffer0uMap"  sourceRT="GTAO_BUFF_2"  bufIndex="0" />
      <BindBuffer sampler="gBuffer0Map"   sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" />
      <If conditionType="variable" id="GTAO_BentNormals" test="equal" value="0" />
        <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Low" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_SPTLL_H_DENOISE"      compute="async_exceptPS4" />
        <Else/>
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_SPATIAL_H_DENOISE"    compute="async_exceptPS4" />
        <EndIf/>
      <Else/>
        <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Low" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_SPTLL_H_DENOISE"   compute="async_exceptPS4" />
        <Else/>
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_SPTL_H_DENOISE"    compute="async_exceptPS4" />
        <EndIf/>
      <EndIf/>
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="GTAO_BUFF_2" />
      <ColourMask channels="R" />
      <BindBuffer sampler="gBuffer0uMap"  sourceRT="GTAO_BUFF_1"  bufIndex="0" />
      <BindBuffer sampler="gBuffer0Map"   sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" />
      <If conditionType="variable" id="GTAO_BentNormals" test="equal" value="0" />
        <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Low" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_SPTLL_V_DENOISE"      compute="async_exceptPS4" />
        <Else/>
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_SPATIAL_V_DENOISE"    compute="async_exceptPS4" />
        <EndIf/>
      <Else/>
        <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Low" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_SPTLL_V_DENOISE"   compute="async_exceptPS4" />
        <Else/>
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_SPTL_V_DENOISE"    compute="async_exceptPS4" />
        <EndIf/>
      <EndIf/>
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="DepthRevZDown" enabled="false" >
      <BeginTarget target="DEPTH_SSS_REV_Z" mipLevel="0" />
      <ColourMask channels="R"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH" bufIndex="32" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="0"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_Z" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="ScreenSpaceShadows" enabled="false">
      <PushMarker id="SSS_March"/>
      <BeginTarget target="SSS_TEMP_A"/>
      <ColourMask channels="R"/>
      <BindBuffer sampler="gBufferMap"        sourceRT="DEPTH_SSS_REV_Z"   bufIndex="0"  />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always"/>
      <ClearTarget colBuf0="true" depthBuf="false" col_R="0.0" />
      <DrawQuadMT material="materials/Light.material.mbin" context="SSS_MARCH_HIGH" compute="async" />
      <EndTarget flushCB="true" flushDB="false" />
      <PopMarker/>

      <PushMarker id="SSS_Spatial_Filter"/>
      <BeginTarget target="SSS_TEMP_B" />
      <ColourMask channels="R"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SSS_TEMP_A"   bufIndex="0"   />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN"   bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWALT_H_GUASS"  compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="SSS_TEMP_A" />
      <ColourMask channels="R"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SSS_TEMP_B"   bufIndex="0"   />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN"   bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWALT_V_GUASS"  compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <PopMarker/>
    </Stage>                               
      
    <Stage id="Shadow_All_Clear">
      <BeginTarget target="SHADOWBUF" />
      <SetShadowMap index="-1" />
      <ColourMask channels="RGBA"/>
      <ClearTarget depthBuf="true" colBuf0="false" col_R="0.0" col_G="0.0" col_B="0.0" col_A="0.0" />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>
    
    <Stage id="Decals">

      <BeginTarget target="GBUFFER" depthTarget="DEPTH" readOnlyDepth="true" />
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_LINEAR"    bufIndex="0"   />

      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less"/>
      <DrawGeometry type="InstanceMesh" class="Decal"           context="LIT_DEFER_INSTANCE"    order="MESH" />
      <DrawGeometry type="Mesh"         class="Decal"           context="LIT_DEFER"             order="STATECHANGES" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" stencilMode="maskRead" stencilRef="8" stencilMask="8" />
      <DrawGeometry type="InstanceMesh" class="DecalTerrain"    context="LIT_DEFER_INSTANCE"    order="MESH" />
      <DrawGeometry type="Mesh"         class="DecalTerrain"    context="LIT_DEFER"             order="STATECHANGES" />

      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />      
    </Stage>

    <Stage id="TerrainCleanup" >
      <BeginTarget target="DEPTH" onlyStencil="true" />
      <SetContext zwrite="false" colourWrite="false" blendMode="replace" depthTest="always" stencilMode="maskReadWriteNotEqual" stencilRef="0" stencilMaskRead="8" stencilMaskWrite="8" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="CLEAR_ZERO" />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="Shadow_0_Clear" enabled="false">
      <BeginTarget target="SHADOWBUF" />
      <ColourMask channels="RGBA"/>
      <SetShadowMap index="0" />
      <ClearTarget depthBuf="true" colBuf0="false" depthViewportOnly="true" col_R="0.0" col_G="0.0" col_B="0.0" col_A="0.0" />
    </Stage>

    <Stage id="Shadow_0">
      
      <BeginTarget target="SHADOWBUF" />

      <UpdateShadowMap />

      <ColourMask channels="RGBA"/>
      <!--PS4: default setting after ClearTarget equals RT0-RGBA, so no need to call ColourMask again-->
      
      <!--PS4: we're using HTile but not allowing compression, to save decompressing the very large shadowmap target at the end -->
      

      <SetShadowMap index="0" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Mesh"         class="Glow"              context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Opaque"            context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="OpaqueBeforeUI"    context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Cutout"            context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Highlight"         context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="HighlightOccluded" context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="ShadowOnly"        context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="InstanceMesh" class="Opaque"            context="SHADOW_INSTANCE_FADE"   order="MESH"/>
      <DrawShadowGeometry type="InstanceMesh" class="Cutout"            context="SHADOW_INSTANCE_FADE"   order="MESH"/>
      <DrawShadowGeometry type="InstanceMesh" class="Glow"              context="SHADOW_INSTANCE_FADE"   order="MESH"/>

      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Mesh"         class="DoubleSided"             context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="InstanceMesh" class="DoubleSided"             context="SHADOW_INSTANCE_FADE"   order="MESH"/>
      <DrawShadowGeometry type="Mesh"         class="HighlightDoubleSided"    context="SHADOW_FADE"            order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Terrain"      class="LOD0"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Terrain"      class="LOD1"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Terrain"      class="LOD2"           context="SHADOW_FADE"            order="STATECHANGES"/>

      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="Shadow_1_Clear" enabled="false">
      <BeginTarget target="SHADOWBUF" />
      <ColourMask channels="RGBA"/>
      <SetShadowMap index="1" />
      <ClearTarget depthBuf="true" colBuf0="false" depthViewportOnly="true" col_R="0.0" col_G="0.0" col_B="0.0" col_A="0.0" />
    </Stage>

    <Stage id="Shadow_1">
      
      <BeginTarget target="SHADOWBUF" />

      <UpdateShadowMap />

      <ColourMask channels="RGBA"/>
      <!--PS4: default setting after ClearTarget equals RT0-RGBA, so no need to call ColourMask again-->
      
      <!--PS4: we're using HTile but not allowing compression, to save decompressing the very large shadowmap target at the end -->
      

      <SetShadowMap index="1" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="1" />
      <DrawShadowGeometry type="Mesh"         class="Glow"              context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Opaque"            context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="OpaqueBeforeUI"    context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="Cutout"            context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="Highlight"         context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="HighlightOccluded" context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="ShadowOnly"        context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="InstanceMesh" class="Opaque"            context="SHADOW_INSTANCE_FADE"   order="MESH" />
      <DrawShadowGeometry type="InstanceMesh" class="Cutout"            context="SHADOW_INSTANCE_FADE"   order="MESH" />
      <DrawShadowGeometry type="InstanceMesh" class="Glow"              context="SHADOW_INSTANCE_FADE"   order="MESH" />

      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="1" />
      <DrawShadowGeometry type="Mesh"         class="DoubleSided"             context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="InstanceMesh" class="DoubleSided"             context="SHADOW_INSTANCE_FADE"   order="MESH" />
      <DrawShadowGeometry type="Mesh"         class="HighlightDoubleSided"    context="SHADOW_FADE"            order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="1" />
      <DrawShadowGeometry type="Terrain"      class="LOD0"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Terrain"      class="LOD1"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Terrain"      class="LOD2"           context="SHADOW_FADE"            order="STATECHANGES"/>

      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="Shadow_2_Clear" enabled="false">
      <BeginTarget target="SHADOWBUF" />
      <ColourMask channels="RGBA"/>
      <SetShadowMap index="2" />
      <ClearTarget depthBuf="true" colBuf0="false" depthViewportOnly="true" col_R="0.0" col_G="0.0" col_B="0.0" col_A="0.0" />
    </Stage>

    <Stage id="Shadow_2">
      
      <BeginTarget target="SHADOWBUF" />

      <UpdateShadowMap />

      <ColourMask channels="RGBA"/>
      <!--PS4: default setting after ClearTarget equals RT0-RGBA, so no need to call ColourMask again-->
      
      <!--PS4: we're using HTile but not allowing compression, to save decompressing the very large shadowmap target at the end -->      
      <SetShadowMap index="2" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="2" />
      <DrawShadowGeometry type="Mesh"         class="Glow"              context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Opaque"            context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="OpaqueBeforeUI"    context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="Cutout"            context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="Highlight"         context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="HighlightOccluded" context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="ShadowOnly"        context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="InstanceMesh" class="Opaque"            context="SHADOW_INSTANCE_FADE"   order="MESH" />
      <DrawShadowGeometry type="InstanceMesh" class="Cutout"            context="SHADOW_INSTANCE_FADE"   order="MESH" />
      <DrawShadowGeometry type="InstanceMesh" class="Glow"              context="SHADOW_INSTANCE_FADE"   order="MESH" />

      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="2"  />
      <DrawShadowGeometry type="Mesh"         class="DoubleSided"             context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="InstanceMesh" class="DoubleSided"             context="SHADOW_INSTANCE_FADE"   order="MESH" />
      <DrawShadowGeometry type="Mesh"         class="HighlightDoubleSided"    context="SHADOW_FADE"            order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="2" />      
      <DrawShadowGeometry type="Terrain"      class="LOD0"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Terrain"      class="LOD1"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Terrain"      class="LOD2"           context="SHADOW_FADE"            order="STATECHANGES"/>

      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="Shadow_End">
      <BeginTarget target="SHADOWBUF" />
      <SetShadowMap index="-1" />

      <SetDepthBufferControl allowCompression="true" />    
      <EndTarget flushCB="false" flushDB="true" />
    </Stage>
      
    <Stage id="SpotlightsTiled" enabled="false">
      <BeginTarget target="LIGHTS_TILEBUF" />
      <DiscardTargetContents colBuf0="true" />
      <ColourMask channels="RGBA"/>
      <ClearTarget depthBuf="false" colBuf0="true" col_R="0.0" col_G="0.0" col_B="0.0" />
      <EndTarget flushCB="true" flushDB="false" flushForCompute="true" />

      <BeginTarget target="LIGHTS_DUMMY" />

      <BindBuffer sampler="gLightCluster" sourceRT="LIGHTS_TILEBUF" bufIndex="0" bindAsRwImage="true" />
      <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="replace"    depthTest="always" />
      <DoDeferredLightLoop context="SPOT_INNER_LIST" inner="true"/> 

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace"    depthTest="always" />
      <DoDeferredLightLoop context="SPOT_OUTER_LIST" inner="false"/> 
      
      <UnbindBuffers />      
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Shadow_DS">
      <If conditionType="variable" id="LightShaftsBlurEnabled" />
      <If conditionType="platform" id="OUNCE" negate="true" />		        
      <BeginTarget target="SHADOWBUF_DS" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SHADOWBUF" bufIndex="32" shadowCompare="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY_DEPTH" />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="true" />
      <EndIf/>        
      <EndIf/>
    </Stage>
      
    <Stage id="AsyncSync">      
      <!-- wait for depth/ clouds / gtao -->
      <SyncComputeToGraphics compute="async" />    
    </Stage>

    <Stage id="GTAOTemporal" enabled="false">
      <BeginTarget target="GTAO_MASK" depthTarget="DEPTH" readOnlyDepth="true" onlyStencil="true" />
      <ColourMask channels="R"/>
      <BindBuffer sampler="gBuffer0Map"  sourceRT="MOTIONRESOLVE"   bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="NORMALS"         bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map"  sourceRT="DEPTH"           bufIndex="32" />
      <BindBuffer sampler="gBuffer3Map"  sourceRT="DEPTH_BACK"      bufIndex="32" frameIdx="prev" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="1" stencilMask="1" />
      <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Low" />
      <DrawQuad material="materials/AO.material.mbin" context="GTAO_TMP_LITE_MASK" />
      <Else/>
      <DrawQuad material="materials/AO.material.mbin" context="GTAO_TEMPORAL_MASK" />
      <EndIf/>
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="GTAO_BUFF_1" depthTarget="DEPTH" readOnlyDepth="true" onlyStencil="true" />
      <ColourMask channels="R" />
      <BindBuffer sampler="gBuffer0uMap"  sourceRT="GTAO_BUFF_2"      bufIndex="0" />
      <BindBuffer sampler="gBuffer1uMap"  sourceRT="GTAO_BUFF_0"      bufIndex="0" frameIdx="prev" />
      <BindBuffer sampler="gBuffer2uMap"  sourceRT="GTAO_MASK"        bufIndex="0" />
      <BindBuffer sampler="gBuffer0Map"   sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="1" stencilMask="1" />
      <If conditionType="variable" id="GTAO_BentNormals" test="equal" value="0" />
        <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Low" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_TMP_LITE_FILTER" />
        <Else/>
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_TEMPORAL_FILTER" />
        <EndIf/>
      <Else/>
        <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Low" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_TMP_LITE_FILTER" />
        <Else/>
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_TEMPORAL_FILTER" />
        <EndIf/>
      <EndIf/>
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="GTAOCopy" enabled="false">
      <BeginTarget target="GTAO_BUFF_2" depthTarget="DEPTH" readOnlyDepth="true" onlyStencil="true" />
      <ColourMask channels="R" />
      <BindBuffer sampler="gBuffer0Map" sourceRT="MATERIAL" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="BENT"     bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" />
      <If conditionType="variable" id="GTAO_BentNormals" test="equal" value="0" stencilMode="maskRead" stencilRef="1" stencilMask="1" />
      <DrawQuad material="materials/AO.material.mbin" context="GTAO_COPY_IN" />
      <Else/>
      <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_COPY_IN" />
      <EndIf/>
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="MAT_BENT" depthTarget="DEPTH" readOnlyDepth="true" onlyStencil="true" />
      <ColourMask channels0="R" channels1="RG" />
      <BindBuffer sampler="gBuffer0uMap" sourceRT="GTAO_BUFF_1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1uMap" sourceRT="GTAO_BUFF_2" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" />
      <If conditionType="variable" id="GTAO_BentNormals" test="equal" value="0" stencilMode="maskRead" stencilRef="1" stencilMask="1" />
      <DrawQuad material="materials/AO.material.mbin" context="GTAO_COPY_OUT" />
      <Else/>
      <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_COPY_OUT" />
      <EndIf/>
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <SwapTargets targetA="GTAO_BUFF_0" targetB="GTAO_BUFF_1" />
    </Stage>

    <Stage id="GTAOOff" enabled="false">
    </Stage>
      
    <Stage id="VolumetricPlanetRings">
      <BeginTarget target="RINGS_BUFF" depthTarget="DEPTH" onlyStencil="true"  />
      <ColourMask channels="RGBA" />
      <ClearTarget depthBuf="false" colBuf0="true" col_R="0.0" col_G="0.0" col_B="0.0" col_A="0.0" />
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_WATER_LINEAR" bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="front" depthTest="lessEqual" blendMode="add" />
      <DoForwardLightLoop type="Mesh" class="Atmosphere" context="SCATTERING" order="FRONT_TO_BACK" />        
        
      <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="blend" depthTest="less"   />
      <DoForwardLightLoop type="Mesh"    class="RingsBelow"         context="RINGS_BELOW"  order="BACK_TO_FRONT" />
      <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="blend" depthTest="always" />
      <DoForwardLightLoop type="Mesh"    class="RingsAmid"          context="RINGS_AMID"   order="BACK_TO_FRONT" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="blend" depthTest="always"   />
      <DoForwardLightLoop type="Mesh"    class="RingsAbove"         context="RINGS_ABOVE"  order="BACK_TO_FRONT" />

      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>      

    <Stage id="VolumetricsForWorlds">

      <BeginTarget target="VOLUME" />
      <ColourMask channels="RGBA" colBuf1="false" />
      <ClearTarget depthBuf="false" colBuf0="true" colBuf1="true" col_R="0.0" col_G="0.0" col_B="0.0" />

      <BindBuffer sampler="gBufferMap"      sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="front" depthTest="always" blendMode="add" />
      <DoForwardLightLoop type="Mesh" class="AtmosphereNear" context="SCATTER_MASK" order="FRONT_TO_BACK" />
      <UnbindBuffers />

      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="VOLUME" />

      <ColourMask channels="RGBA"/>

      <BindBuffer sampler="gBufferMap"     sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />
      <If conditionType="platform" id="OUNCE" negate="true" />		          
      <BindBuffer sampler="gShadowMap"     sourceRT="SHADOWBUF_DS"  bufIndex="32" />
      <Else />
      <BindBuffer sampler="gShadowMap"     sourceRT="SHADOWBUF"  bufIndex="32" />
      <EndIf />           
      <SetContext zwrite="false" colourWrite="true" depthTest="always" blendMode="add" />
      <If conditionType="variable" id="LightShaftsBlurEnabled" />              
      <DrawQuadMT material="materials/Light.material.mbin" context="SCATTERING"  />
      <Else />
      <DrawQuadMT material="materials/Light.material.mbin" context="SCATTERING_NOGR" />        
      <EndIf />        
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLUR1" />
      <BindBuffer sampler="gBufferMap"  sourceRT="VOLUME" bufIndex="0"   />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN"  bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_H_GUASS" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="VOLUME" />
      <ColourMask channels="RGBA" colBuf1="false" />
      <BindBuffer sampler="gBufferMap"  sourceRT="BLUR1"   bufIndex="0"   />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN"  bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_V_GUASS" />

      <BindBuffer sampler="gBufferMap" sourceRT="RINGS_BUFF" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="Blend_PostMultAlpha" depthTest="always" />
      <DrawQuad material="Materials/PostProcess.material.mbin" context="DOWN_8TAP_W" width ="1.0" height="1.0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="SCATTERING_VOLUME" />
      <EndTarget flushCB="true" flushDB="false" flushForCompute="true" />
      <BeginTarget target="SCATTERING_DUMMY" />
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" bindAsRwImage="true" />
      <SetContext zwrite="false" colourWrite="false" blendMode="replace" depthTest="always" />
      <DrawQuadMT material="materials/Light.material.mbin" context="SCATTERING_VOLUME"  />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>      
      
    <Stage id="AsyncNextSync">
      <SyncComputeToGraphics compute="async_next" />
    </Stage>

    <Stage id="SkyScratchPad" enabled="false" >
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH"/>
      <ColourMask channels="RGB" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="0" />
      <BindBuffer sampler="gBufferMap"   sourceRT="GBUFFER"    bufIndex="2"   />
      <DoForwardLightLoop type="Mesh" class="Sky" context="SCRATCHPAD" order="BACK_TO_FRONT" />

      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="SkyClear" enabled="false">
       <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" readOnlyDepth="true" />
       <ColourMask channels="RGBA" />
       <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="0.0" />
       <SetContext zwrite="false" colourWrite="true" blendMode="replace" depthTest="always" />
       <DrawQuad material="materials/PostProcess.material.mbin" context="CLEAR" />
       <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Sky">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="0.0" />
      <SetContext zwrite="false" colourWrite="true" blendMode="replace" depthTest="always" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="CLEAR" />

      <!-- Space/Night Sky -->      
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="0" />
      <BindBuffer sampler="gBufferMap"   sourceRT="GBUFFER"    bufIndex="2"   />
      <DoForwardLightLoop type="Mesh" class="Sky" context="LIGHTING" order="BACK_TO_FRONT" />
      <UnbindBuffers />

      <!-- Starfield -->
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" stencilMode="maskRead" stencilRef="0" />
      <DrawGeometry type="PStream" class="Opaque"    context="PSTREAM_SYSTEM"    order="STATECHANGES" />

      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="PSSR_APPLY" enabled="false">
        <ApplyQueuedPSSR />
    </Stage>                
      
    <Stage id="ScreenEffect_Upscaled_Async" enabled="false">
      <ColourMask channels="RGBA"/>
      <BeginTarget target="UPS_OUT_1"/>
      <DiscardTargetContents colBuf0="true" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap" sourceRT="UPS_OUT_0" bufIndex="0" />
      <DrawQuadMT material="Materials/UI.material.mbin" context="SCREENEFFECT" width="1.0" height="1.0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>      
          
    <Stage id="Combine_Upscaled_Async"  enabled="false">
      <BeginTarget target="" readOnlyDepth="true" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="UPS_OUT_1"    bufIndex="0"  />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>            
      
    <Stage id="LensSun">

      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskReadInvert" stencilRef="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="PARTICLE_CLEAR" />      
      <EndTarget flushCB="true" flushDB="false" />

      <SyncComputeToGraphics compute="async" />
      <BeginTarget target="LENS_SUNBUF_A" />
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <BindBuffer sampler="gBufferMap"   sourceRT="HDRBUF_0"       bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="CLOUDS_FINAL" bufIndex="0" />
      <DrawQuadMT material="materials/LensFlare.material.mbin" context="BRIGHT_SUN" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_SUNBUF_B" />
      <BindBuffer sampler="gBufferMap" sourceRT="LENS_SUNBUF_A" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="2.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_SUNBUF_A" />
      <BindBuffer sampler="gBufferMap" sourceRT="LENS_SUNBUF_B" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="2.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="LENS_SUNBUF_B" />
      <BindBuffer sampler="gBufferMap" sourceRT="LENS_SUNBUF_A" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="2.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_SUNBUF_A" />
      <BindBuffer sampler="gBufferMap" sourceRT="LENS_SUNBUF_B" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="2.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="Sunlight" >
      <BeginTarget target="SUNOUT_0" depthTarget="DEPTH" onlyStencil="true" />

      <ColourMask channels="RGB"  />
      <BindBuffer sampler="gBufferMap"      sourceRT="GBUFFER"        bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"     sourceRT="DEPTH_LINEAR"   bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map"     sourceRT="GBUFFER"        bufIndex="2"  />
      <BindBuffer sampler="gBuffer3Map"     sourceRT="GBUFFER"        bufIndex="3"  />
      <BindBuffer sampler="gBuffer4Map"     sourceRT="GBUFFER"        bufIndex="4"  />
      <BindBuffer sampler="gShadowMap"      sourceRT="SHADOWBUF"      bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap" sourceRT="CLOUDSHADOWS"   bufIndex="0" addressMode="wrap"  />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskReadInvert" stencilMask="1" stencilRef="0"/>

      <If conditionType="variable" id="EnableGgx" />
        <If conditionType="uniform" material="materials/Light.material.mbin" id="gScanParamsCfg1Vec4" index="3" test="equal" value="0" />
        <DrawQuadMT material="materials/Light.material.mbin" context="SUN_SPLIT_GGX" />
        <Else/>
        <DrawQuadMT material="materials/Light.material.mbin" context="SUN_SPLT_SCAN_GGX" />
        <EndIf/>
      <Else />
        <If conditionType="uniform" material="materials/Light.material.mbin" id="gScanParamsCfg1Vec4" index="3" test="equal" value="0" />
        <DrawQuadMT material="materials/Light.material.mbin" context="SUNLIGHT_SPLIT" />
        <Else/>
        <DrawQuadMT material="materials/Light.material.mbin" context="SUNLIGHT_SPLT_SCAN" />
        <EndIf/>
      <EndIf />

      <UnbindBuffers />
      <If conditionType="stage" id="DepthRevZDown" enabled="false"/>
      <EndTarget flushCB="true" flushDB="false" />
      <Else/>
      <EndTarget flushCB="true" flushDB="true" />
      <EndIf/>
    </Stage>

    <Stage id="DepthMasks" enabled="false" >
      <If conditionType="engineSetting" id="ShadowQuality" test="lessEqual" value="Medium" />
      <BeginTarget target="DEPTH_MASK_LITE_BUFF" />
      <Else/>
      <BeginTarget target="DEPTH_MASK_BUFF" />
      <EndIf/>
      <ColourMask channels="R"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="MOTIONRESOLVE"   bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="NORMALS"         bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map"  sourceRT="DEPTH"           bufIndex="32" />
      <BindBuffer sampler="gBuffer3Map"  sourceRT="DEPTH_DOWN"      bufIndex="0"  />
      <BindBuffer sampler="gBuffer4Map"  sourceRT="DEPTH_BACK"      bufIndex="32" frameIdx="prev" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" />
      <If conditionType="engineSetting" id="ShadowQuality" test="lessEqual" value="Medium" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="DEPTH_MASK_LITE" />
      <Else/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="DEPTH_MASK" />
      <EndIf/>
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="ScreenSpaceShadowsTemporal" enabled="false">
      <SwapTargets targetA="SSS_HISTORY" targetB="SSS_FINAL" />
      <PushMarker id="SSS_Temporal_Filter"/>
      <BeginTarget target="SSS_FINAL" depthTarget="DEPTH" onlyStencil="true" />
      <ClearTarget colBuf0="true" />
      <ColourMask channels="R"/>
      <BindBuffer sampler="gBufferMap"    sourceRT="SSS_TEMP_A"           bufIndex="0"   />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="SSS_HISTORY"          bufIndex="0" frameIdx="prev"  />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="MOTIONRESOLVE"        bufIndex="0"   />
      <If conditionType="engineSetting" id="ShadowQuality" test="lessEqual" value="Medium" />
      <BindBuffer sampler="gBuffer0uMap"  sourceRT="DEPTH_MASK_LITE_BUFF" bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="maskReadInvert" depthTest="always" stencilRef="0" />
      <DrawQuadMT material="materials/Light.material.mbin" context="SSS_TEMPORAL_LITE" />
      <Else/>
      <BindBuffer sampler="gBuffer0uMap"  sourceRT="DEPTH_MASK_BUFF"      bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="maskReadInvert" depthTest="always" stencilRef="0" />
      <DrawQuadMT material="materials/Light.material.mbin" context="SSS_TEMPORAL" />
      <EndIf/>
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <PopMarker/>
    </Stage>

    <Stage id="ShadowApply" >

      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" onlyStencil="true" />

      <ColourMask channels="RGB"  colBuf1="false"  colBuf2="false"  />
      <BindBuffer sampler="gBufferMap"        sourceRT="SUNOUT_0"       bufIndex="1"  />
      <BindBuffer sampler="gBuffer1Map"       sourceRT="DEPTH_LINEAR"   bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map"       sourceRT="GBUFFER"        bufIndex="2"  />
      <BindBuffer sampler="gBuffer3Map"       sourceRT="GBUFFER"        bufIndex="0"  />
      <BindBuffer sampler="gBuffer4Map"       sourceRT="MATERIAL"       bufIndex="0"  />
      <BindBuffer sampler="gBuffer5Map"       sourceRT="NORMALS"        bufIndex="0"  />
      <BindBuffer sampler="gShadowMap"        sourceRT="SHADOWBUF"      bufIndex="32" />
      <If conditionType="stage" id="ScreenSpaceShadows" enabled="true"/>
      <BindBuffer sampler="gBuffer6Map"       sourceRT="SSS_FINAL"      bufIndex="0"  />
      <EndIf/>
      <BindBuffer sampler="gCloudShadowMap"   sourceRT="CLOUDSHADOWS"   bufIndex="0" addressMode="clamp" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="always" stencilMode="maskReadInvert" stencilMask="1" stencilRef="0"/>

      <If conditionType="variable" id="EnableGgx" />
        <If conditionType="stage" id="ScreenSpaceShadows" enabled="true"/>
          <DrawQuadMT material="materials/Light.material.mbin" context="SH_APPLY_SSS_GGX" />
        <Else/>
          <DrawQuadMT material="materials/Light.material.mbin" context="SH_APPLY_GGX"/>
        <EndIf/>
      <Else/>
        <If conditionType="stage" id="ScreenSpaceShadows" enabled="true"/>
          <DrawQuadMT material="materials/Light.material.mbin" context="SHADOW_APPLY_SSS" />
        <Else/>
          <DrawQuadMT material="materials/Light.material.mbin" context="SHADOW_APPLY"/>
        <EndIf/>
      <EndIf/>

      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="true" />
    </Stage>

    <Stage id="SpotlightsTiledFS" enabled="false">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />
      <ColourMask channels="RGB"  colBuf1="false"  colBuf2="false" />
      <BindBuffer sampler="gBufferMap"      sourceRT="GBUFFER"          bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"     sourceRT="DEPTH_LINEAR"     bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map"     sourceRT="GBUFFER"          bufIndex="2"  />
      <BindBuffer sampler="gBuffer3Map"     sourceRT="GBUFFER"          bufIndex="3"  />
      <BindBuffer sampler="gBuffer4Map"     sourceRT="GBUFFER"          bufIndex="4"  />
      <BindBuffer sampler="gLightCluster"   sourceRT="LIGHTS_TILEBUF"   bufIndex="0" bindAsRwImage="true" />
      <BindBuffer sampler="gShadowMap"      sourceRT="SHADOWBUF"        bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap" sourceRT="CLOUDSHADOWS"     bufIndex="0" addressMode="clamp" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add"    depthTest="always" />
      <If conditionType="variable" id="EnableGgx" />
        <DoDeferredLightLoopMulti context="SPOT_MULTI_GGX"  inner="true"/>
      <Else />
        <DoDeferredLightLoopMulti context="SPOT_MULTI"      inner="true"/>
      <EndIf />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="Spotlights">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" onlyStencil="true" />
      <ColourMask channels="RGB"  colBuf1="false"  colBuf2="false" />
      <BindBuffer sampler="gBufferMap"      sourceRT="GBUFFER"        bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"     sourceRT="DEPTH_LINEAR"   bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map"     sourceRT="GBUFFER"        bufIndex="2"  />
      <BindBuffer sampler="gBuffer3Map"     sourceRT="GBUFFER"        bufIndex="3"  />
      <BindBuffer sampler="gBuffer4Map"     sourceRT="GBUFFER"        bufIndex="4"  />
      <BindBuffer sampler="gShadowMap"      sourceRT="SHADOWBUF"      bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap" sourceRT="CLOUDSHADOWS"   bufIndex="0" addressMode="clamp"  />

      <If conditionType="variable" id="EnableGgx" />
        <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="add" stencilMode="maskReadInvert" stencilRef="0" depthTest="greaterEqual" depthBounds="true" />
        <DoDeferredLightLoop context="SPOT_INNER_GGX"  inner="true"/>
        <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="add" stencilMode="maskReadInvert" stencilRef="0" depthTest="less"         depthBounds="true" />
        <DoDeferredLightLoop context="SPOT_OUTER_GGX"  inner="false"/>
      <Else />
        <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="add" stencilMode="maskReadInvert" stencilRef="0" depthTest="greaterEqual" depthBounds="true" />
        <DoDeferredLightLoop context="SPOTLIGHT_INNER" inner="true"/>
        <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="add" stencilMode="maskReadInvert" stencilRef="0" depthTest="less"         depthBounds="true" />
        <DoDeferredLightLoop context="SPOTLIGHT_OUTER" inner="false"/>
      <EndIf />
      <SetContext />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="SpotlightsVisualise" enabled="false">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />
      <ColourMask channels="RGB"  colBuf1="false"  colBuf2="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="blend"       depthTest="greaterEqual" depthBounds="false" fillMode="wireframe" />
      <SetUniform material="materials/Light.material.mbin" uniform="gDebugLightColourVec4" a="1.0" b="1.0" c="1.0" d="0.03" resetMaterial="true" />
      <DoDeferredLightLoop context="SPOTLIGHT_SHAPE" inner="true"/>

      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="blend"       depthTest="less"         depthBounds="false" fillMode="wireframe" />
      <SetUniform material="materials/Light.material.mbin" uniform="gDebugLightColourVec4" a="1.0" b="0.0" c="1.0" d="0.15" resetMaterial="true" />
      <DoDeferredLightLoop context="SPOTLIGHT_SHAPE" inner="true"/>

      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="blend"       depthTest="greaterEqual" depthBounds="false" fillMode="wireframe" />
      <SetUniform material="materials/Light.material.mbin" uniform="gDebugLightColourVec4" a="1.0" b="1.0" c="1.0" d="0.03" resetMaterial="true" />
      <DoDeferredLightLoop context="SPOTLIGHT_SHAPE" inner="false"/>

      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="blend"       depthTest="less"         depthBounds="false" fillMode="wireframe" />
      <SetUniform material="materials/Light.material.mbin" uniform="gDebugLightColourVec4" a="1.0" b="1.0" c="0.0" d="0.10" resetMaterial="true" />
      <DoDeferredLightLoop context="SPOTLIGHT_SHAPE" inner="false"/>

      <SetContext fillMode="solid" />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="TileVisualise" enabled="false">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />

      <ColourMask channels="RGB"  colBuf1="false"  colBuf2="false" />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="DEPTH_LINEAR"   bufIndex="0"  />
      <BindBuffer sampler="gLightCluster" sourceRT="LIGHTS_TILEBUF" bufIndex="0" bindAsRwImage="true" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add"    stencilMode="maskReadInvert" stencilRef="0" depthTest="always" />
      <DoDeferredLightLoopMulti context="SPOT_TILE_VIS" inner="true"/>

      <SetContext />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>
    
    <Stage id="WaterFromAbove"  >
    </Stage>

    <Stage id="MeshWaterWireframe">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_MeshedWireframe" />
        <If conditionType="variable" id="WaterState"  test="notEqual" sourceType="variable" source="WaterState_NoWater" />
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="false" fillMode="wireframe"/>

      <DoForwardLightLoop type="Water" class="MeshWater" context="MESH_WATER" order="BACK_TO_FRONT" />

      <UnbindBuffers />
      
      <EndTarget flushCB="true" flushDB="false" />
        <EndIf />
      <EndIf />
    </Stage>

    <Stage id="PlanetCloud">
      
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" onlyStencil="true" />
      <ColourMask channels="RGBA" />

        <!--Cloud sphere around planets--> 
      <If conditionType="platform" id="OUNCE" negate="true" />		        
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" />     
      <Else />
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_LINEAR"  bufIndex="0" />              
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="lessEqual" />        
      <EndIf />		        
      <DoForwardLightLoop type="Mesh" class="Atmosphere"         context="CLOUDSHADOW"    order="BACK_TO_FRONT" />      
      <ColourMask channels="RGB" />
      <If conditionType="platform" id="OUNCE" negate="true" />		        
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" />
      <Else />
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_LINEAR"  bufIndex="0" />                      
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="lessEqual" />        
      <EndIf />		
      <DoForwardLightLoop type="Mesh" class="Atmosphere" context="CLOUD" order="BACK_TO_FRONT" />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
      
    </Stage>

    <Stage id="CloudsForWorlds" enabled="false">
      <BeginTarget target="SCATTER" />

      <ColourMask channels="RGBA" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="Blend_PostMultAlpha" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />
      <DrawQuad material="Materials/NewCloud.material.mbin"   context="CIRRUS_CLOUDS" />

      <BindBuffer sampler="gBufferMap" sourceRT="CLOUDS_FINAL" bufIndex="0" />
      <DrawQuad material="Materials/NewCloud.material.mbin"   context="CLOUDS_COPY" />

      <ColourMask channels="A" />
      <BindBuffer sampler="gBufferMap" sourceRT="CLOUDS_FINAL" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="max" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/NewCloud.material.mbin" context="CLOUDS_COPY" />

      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />
      <BindBuffer sampler="gBufferMap"       sourceRT="DEPTH_WATER_DOWN"    bufIndex="0" />
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="Blend_PostMultAlpha" depthTest="always" />
      <DoForwardLightLoop type="Mesh"     class="Rainbow"     context="RAINBOW"     order="BACK_TO_FRONT" />
      <UnbindBuffers />

      <EndTarget flushCB="true" flushDB="false" />

    </Stage>

    <Stage id="BlackHole">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH"/>
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="blend" depthTest="less" />
      <DoForwardLightLoop type="Mesh"     class="BlackHoleBack"       context="LIT_FORWARD"    order="STATECHANGES" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

    </Stage>

    <Stage id="TerrainEdits" enabled="false">
      <BeginTarget target="BLENDED_ABOVE" depthTarget="DEPTH" onlyStencil="true" />
      <ColourMask channels="RGBA" colBuf1="false" />
      <!-- Terrain Edits -->
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="4" stencilMask="4"/>
      <DrawGeometry type="Terrain"      class="LOD0"      context="EDITS"           order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="EDITS_CACHE_FB"  order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="EDITS_TESS_FB"   order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="EDITS_CACHE"     order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="EDITS_TESS"      order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD1"      context="EDITS"           order="FRONT_TO_BACK" />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="FFXSR2_LUMAOP" enabled="false">
      <BeginTarget target="LUM_BUF_OP" />
      <ColourMask channels="R" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_0" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY_RGB2LUM_LINEAR" />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="MeshWaterStencil">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_MeshedDeferred" />
        <If conditionType="variable" id="WaterState"  test="notEqual" sourceType="variable" source="WaterState_NoWater" />
            <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" onlyStencil="true" />
            <ColourMask channels="RGBA" />
            <BindBuffer sampler="gDepthMap"       sourceRT="DEPTH_LINEAR"   bufIndex="0"  />
            <BindBuffer sampler="gWaterDepth"     sourceRT="DEPTH_WATER"    bufIndex="32"  />
            <BindBuffer sampler="gWaterMask"      sourceRT="WATER_MASK"     bufIndex="0"  />

            <!-- exists to prevent volumetrics from being applied until after we have rendered water -->
            <If>
              <Conditions operation="or">
                <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_AboveWater" />
                <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_NearWaterSurface" />
              </Conditions>
            </If>
              <SetContext zwrite="false" colourWrite="false" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskWrite" stencilMask="1" stencilRef="1" />
              <DrawQuadMT material="materials/MeshWater.material.mbin" context="MESH_WATER_ST_FRONT" />
            <EndIf />

            <!-- exists to prevent refractive transparencies from being applied where we have an underwater mesh... a bit of a gross hack, ideally we replace this with a unified WATER & MAIN DEPTH depth target , and volumetrics being delayed for opaques-->
            <If>
              <Conditions operation="or">
                <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_BelowWater" />
                <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_NearWaterSurface" />
              </Conditions>
            </If>
              <SetContext zwrite="false" colourWrite="false" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskWrite" stencilMask="21" stencilRef="0" />
              <DrawQuadMT material="materials/MeshWater.material.mbin" context="MESH_WATER_ST_BACK" />
            <EndIf />

            <EndTarget flushCB="true" flushDB="false" />
        <EndIf />
      <EndIf />
    </Stage>

    <Stage id="LightShafts" >
      <If conditionType="variable" id="LightShaftsEnabled" />
      <BeginTarget target="LIGHTSHAFT" />
      <ColourMask channels="R"/>      
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_WATER_DOWN"    bufIndex="0" />    
      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF_DS"  bufIndex="32" />
      <SetContext zwrite="false" colourWrite="true" depthTest="always" blendMode="replace" />
      <DrawQuadMT material="materials/Light.material.mbin" context="RAYMARCH" />      
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>
    
    <Stage id="LightShaftsBlur" >
      <If conditionType="variable" id="LightShaftsBlurEnabled" />
      <BeginTarget target="BLUR1_REDONLY" />
      <DiscardTargetContents colBuf0="true" />
      <ColourMask channels="R"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="LIGHTSHAFT" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />    
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" depthTest="always" />     
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_H_REDONLY_GUASS" />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="VOLUME" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="BLUR1_REDONLY"    bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />
      <!-- This is a very weird one... lightshafts were originally additively blended in a bespoke pass onto the main scene *after* the
           the volumetrics had already been applied. However - as a performance saving it makes sense to write the light shafts directly into
           the volumetrics buffer and blend them both into the main scene together. However - the volumetrics were previously done through a normal
           alpha blend. To resolve this - when blending the light shafts into the volumetrics buffer, we pre-multiply the volumetrics colour values
           by their own alpha (whilst still preserving that alpha value) - we then additively blend the light shafts into the VOLUME target.
           When blending the VOLUME target into the main scene - we do an additive blend of the VOLUME into HDRBUF0, where the dst has (1 - srcAlpha)
           applied -->
      <SetContext zwrite="false" blendMode="Blend_AddPremulDst" colourWrite="true" depthTest="always" />     
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_VGAUSS_SHAFT_APPLY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="MeshWaterPostProcessAbove" >
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_MeshedDeferred" />
        <If>
          <Conditions operation="or">
            <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_AboveWater" />
            <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_NearWaterSurface" />
          </Conditions>
        </If>

          <If conditionType="variable" id="WaterReflections" test="notEqual" sourceType="variable" source="WaterReflections_Disabled" />
          <BeginTarget target="WATER_REFL" depthTarget="DEPTH_WATER" onlyStencil="true" readOnlyDepth="true" />
          <ClearTarget type="uint" colBuf0="true"  depthBuf="false" col_R="0" />
          <ColourMask channels="RGB"  />
          <BindBuffer sampler="gReflectionMap"        sourceRT="WATER_PLANAR_REFL_COL" bufIndex="0"/>
          <BindBuffer sampler="gReflectionDepthMap"   sourceRT="WATER_PLANAR_REFL_DEPTH" bufIndex="32"/>
          <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />
          <BindBuffer sampler="gDepthMap"             sourceRT="DEPTH_LINEAR"   bufIndex="0"  />
          <BindBuffer sampler="gWaterDepth"           sourceRT="DEPTH_WATER"    bufIndex="32" />
          <BindBuffer sampler="gBufferMap"            sourceRT="HDRBUF_0"       bufIndex="0" />
          <BindBuffer sampler="gWaterMask"            sourceRT="WATER_MASK"     bufIndex="0"  />
          <BindBuffer sampler="gWaterPlanePosition"   sourceRT="WATER_MASK"     bufIndex="1"  />
          <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="1" stencilMask="1" />
          <DrawQuadMT material="materials/MeshWater.material.mbin" context="M_WATER_REFL" />
          <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="false" />

          <If conditionType="variable" id="WaterReflections" test="equal" sourceType="variable" source="WaterReflections_FullSSR" />
          <BeginTarget target="WATER_REFL_FRONT" depthTarget="DEPTH_WATER" onlyStencil="true" readOnlyDepth="true" />
          <ClearTarget type="uint" colBuf0="true"  depthBuf="false" col_R="0" />
          <ColourMask channels="RGB" />
          <BindBuffer sampler="gReflBlendedMap"       sourceRT="WATER_REFL"       bufIndex="0"  />
          <BindBuffer sampler="gReflBlendedPrevMap"   sourceRT="WATER_REFL_BACK"  bufIndex="0"  frameIdx="prev" />
          <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />
          <BindBuffer sampler="gWaterDepth"           sourceRT="DEPTH_WATER"      bufIndex="32" />
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="1" stencilMask="1" />
          <DrawQuad material="materials/MeshWater.material.mbin" context="M_WATER_REFL_TEMP" />
          <EndTarget flushCB="true" flushDB="false" />

          <BeginTarget target="WATER_REFL_BACK" depthTarget="DEPTH_WATER" onlyStencil="true" readOnlyDepth="true" />
          <ClearTarget type="uint" colBuf0="true"  depthBuf="false" col_R="0" />
          <ColourMask channels="RGB" />
          <BindBuffer sampler="gReflBlendedMap"       sourceRT="WATER_REFL_FRONT" bufIndex="0"  />
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="1" stencilMask="1" />
          <DrawQuad material="materials/MeshWater.material.mbin" context="M_WATER_REFL_COPY" />
          <EndTarget flushCB="true" flushDB="false" />
          <EndIf />
          <EndIf />

          <BeginTarget target="HDRBUF_1" depthTarget="DEPTH_WATER" onlyStencil="true" readOnlyDepth="true" />
          <ColourMask channels="RGB"  />
          <BindBuffer sampler="gDepthMap"             sourceRT="DEPTH_LINEAR"     bufIndex="0"  />
          <BindBuffer sampler="gBufferMap"            sourceRT="HDRBUF_0"         bufIndex="0" />
          <BindBuffer sampler="gReflectionMap"        sourceRT="WATER_PLANAR_REFL_COL" bufIndex="0"/>
          <BindBuffer sampler="gReflectionDepthMap"   sourceRT="WATER_PLANAR_REFL_DEPTH" bufIndex="32"/>
            <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />
          <If conditionType="variable" id="WaterReflections" test="equal" sourceType="variable" source="WaterReflections_FullSSR" />
          <BindBuffer sampler="gReflBlendedMap"       sourceRT="WATER_REFL_FRONT" bufIndex="0" />
          <EndIf />
          <If conditionType="variable" id="WaterReflections" test="equal" sourceType="variable" source="WaterReflections_PlanarSSR" />
          <BindBuffer sampler="gReflBlendedMap"       sourceRT="WATER_REFL" bufIndex="0" />
          <EndIf />
          <If conditionType="variable" id="WaterReflections" test="equal" sourceType="variable" source="WaterReflections_Disabled" />
          <!-- We still need to bind a valid uint texture so the sampler has something statically bound, even though we won't actually use it in runtime -->
          <BindBuffer sampler="gReflBlendedMap"       sourceRT="RED32UI_BUF_1"    bufIndex="0" />
          <EndIf />
          <BindBuffer sampler="gShadowMap"            sourceRT="SHADOWBUF"        bufIndex="32" />
          <BindBuffer sampler="gCloudShadowMap"       sourceRT="CLOUDSHADOWS"     bufIndex="0" addressMode="clamp"  />
          <BindBuffer sampler="gWaterDepth"           sourceRT="DEPTH_WATER"      bufIndex="32"  />
          <BindBuffer sampler="gWaterMask"            sourceRT="WATER_MASK"       bufIndex="0"  />
          <BindBuffer sampler="gWaterPlanePosition"   sourceRT="WATER_MASK"       bufIndex="1"  />

          <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="1" stencilMask="1" />
          <DrawQuadMT material="materials/MeshWater.material.mbin" context="M_ABOVE_WATER" />

          <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="false" />

          <BeginTarget target="HDRBUF_0" depthTarget="DEPTH_WATER" onlyStencil="true" readOnlyDepth="true" />
          <ColourMask channels="RGBA" />
          <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_1" bufIndex="0" />
          <SetContext zwrite="false" blendMode="blend" colourWrite="true" depthTest="always" stencilMode="maskRead" stencilRef="1" stencilMask="1" />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY_NONZERO"  />
          <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="false" />
        <EndIf />
      <EndIf />
    </Stage>

    <Stage id="VolumetricsUPS">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" onlyStencil="true" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />
           
      <BindBuffer sampler="gBufferMap"  sourceRT="VOLUME"        bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN"    bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_WATER_LINEAR"  bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="WATER_MASK"          bufIndex="0" />
      <BindBuffer sampler="gBuffer4Map" sourceRT="DEPTH_WATER"    bufIndex="32"  />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.25" /> 
      <If>
        <Conditions operation="or">
            <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_BelowWater" />
            <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_NearWaterSurface" />
        </Conditions>
      </If>
        <!-- the difference between these is the blend mode - whether we do a normal blend or rely on the fact that if light shafts blur is enabled, we rely on that pre-mulitplying the volumetrics by its own alpha -->
        <If conditionType="variable" id="LightShaftsBlurEnabled" />
            <SetContext zwrite="false" blendMode="Blend_AddBlendDst" colourWrite="true" />
            <DrawQuad material="materials/PostProcess.material.mbin" context="WTR_BLTRL_DST_BLND_UPSMPL"  />
        <Else />
            <SetContext zwrite="false" blendMode="blend" colourWrite="true" />
            <DrawQuad material="materials/PostProcess.material.mbin" context="WTR_BLTRL_UPSMPL_BLND"  />
        <EndIf />
      <Else />
        <!-- the difference between these is the blend mode - whether we do a normal blend or rely on the fact that if light shafts blur is enabled, we rely on that pre-mulitplying the volumetrics by its own alpha -->
        <If conditionType="variable" id="LightShaftsBlurEnabled" />
            <SetContext zwrite="false" blendMode="Blend_AddBlendDst" colourWrite="true" />
            <DrawQuad material="materials/PostProcess.material.mbin" context="BLTRL_UPS_BL"  />
        <Else />
            <SetContext zwrite="false" blendMode="blend" colourWrite="true" />
            <DrawQuad material="materials/PostProcess.material.mbin" context="BILATERAL_BLEND_UPSAMPLE"  />
        <EndIf />
      <EndIf />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="MeshWaterPostProcessBelow" >
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_MeshedDeferred" />
         <If>
          <Conditions operation="or">
            <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_BelowWater" />
            <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_NearWaterSurface" />
          </Conditions>
        </If>


          <If conditionType="variable" id="WaterGodRaysEnabled" />
            <BeginTarget target="WATER_SCATTER_DEPTH" />
              <ColourMask channels="RGBA"/>
              <BindBuffer sampler="gBufferMap"    sourceRT="DEPTH"       bufIndex="32"   />
              <BindBuffer sampler="gBuffer1Map"   sourceRT="DEPTH_WATER" bufIndex="32"  />
              <SetContext zwrite="true" blendMode="replace" colourWrite="true" depthTest="always" />
              <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE_DPTH_WTR" />
              <UnbindBuffers />
            <EndTarget flushCB="true" />

            <BeginTarget target="WATER_SCATTER_ADD" />
              <ColourMask channels="RGB"  />
              <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always"  />
              <BindBuffer sampler="gWaterMask"            sourceRT="WATER_MASK"            bufIndex="0"  />
              <BindBuffer sampler="gReflectionDepthMap"   sourceRT="WATER_PROXY_DEPTH"     bufIndex="0" />
              <BindBuffer sampler="gDepthMap"             sourceRT="WATER_SCATTER_DEPTH"   bufIndex="0"  />
              <BindBuffer sampler="gShadowMap"            sourceRT="SHADOWBUF"             bufIndex="32" />
              <DrawQuadMT material="materials/MeshWater.material.mbin" context="M_GD_SCTTR_ADD" />
              <UnbindBuffers />
            <EndTarget flushCB="true" />


            <PushMarker id="WaterGodRaysSpatialFilter"/>
              <BeginTarget target="WATER_SCATTER_ADD_B" />
              <ColourMask channels="RGB"/>
              <BindBuffer sampler="gBufferMap"  sourceRT="WATER_SCATTER_ADD"   bufIndex="0"   />
              <BindBuffer sampler="gBuffer1Map" sourceRT="WATER_SCATTER_DEPTH"   bufIndex="0"   />
              <SetContext zwrite="false" blendMode="replace" colourWrite="true" depthTest="always" />
              <DrawQuadMT material="materials/PostProcess.material.mbin" context="DPTH_AWRE_H_GSS_INV" />
              <UnbindBuffers />
              <EndTarget flushCB="true" flushDB="false" />

              <BeginTarget target="WATER_SCATTER_ADD" />
              <ColourMask channels="RGB"/>
              <BindBuffer sampler="gBufferMap"  sourceRT="WATER_SCATTER_ADD_B"   bufIndex="0"   />
              <BindBuffer sampler="gBuffer1Map" sourceRT="WATER_SCATTER_DEPTH"   bufIndex="0"   />
              <SetContext zwrite="false" blendMode="replace" colourWrite="true" depthTest="always" />
              <DrawQuadMT material="materials/PostProcess.material.mbin" context="DPTH_AWRE_V_GSS_INV" />
              <UnbindBuffers />
              <EndTarget flushCB="true" flushDB="false" />
            <PopMarker/>
          <EndIf />

          <BeginTarget target="HDRBUF_1" />
          <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_0"      bufIndex="0" />
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always"  />
          <ColourMask channels="RGB"  />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
          <EndTarget flushCB="true" flushDB="false" />

          <BeginTarget target="HDRBUF_0" depthTarget="DEPTH_WATER" onlyStencil="true" readOnlyDepth="true" />
          <ColourMask channels="RGB"  />
          <BindBuffer sampler="gDepthMap"       sourceRT="DEPTH_LINEAR"   bufIndex="0"  />
          <BindBuffer sampler="gReflectionMap"      sourceRT="WATER_PLANAR_REFL_COL" bufIndex="0"/>
          <BindBuffer sampler="gReflectionDepthMap" sourceRT="WATER_PROXY_DEPTH" bufIndex="0" />
          <BindBuffer sampler="gBufferMap"      sourceRT="HDRBUF_1"       bufIndex="0" />
          <BindBuffer sampler="gShadowMap"      sourceRT="SHADOWBUF"      bufIndex="32" />
          <BindBuffer sampler="gCloudShadowMap" sourceRT="CLOUDSHADOWS"   bufIndex="0" addressMode="clamp"  />
          <BindBuffer sampler="gWaterDepth"     sourceRT="DEPTH_WATER"    bufIndex="32"  />
          <BindBuffer sampler="gWaterMask"      sourceRT="WATER_MASK"     bufIndex="0"  />
          <BindBuffer sampler="gWaterPlanePosition"  sourceRT="WATER_MASK"     bufIndex="1"  />
          <BindBuffer sampler="gReflBlendedMap" sourceRT="WATER_REFL"     bufIndex="0"  />
          <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />
        
          <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="always" stencilMode="maskRead" stencilRef="2" stencilMask="2" />
          <If conditionType="variable" id="WaterGodRaysEnabled" />
            <BindBuffer sampler="gMeshWaterScatterAdd"      sourceRT="WATER_SCATTER_ADD" bufIndex="0" />
            <BindBuffer sampler="gMeshWaterScatterAddDepth" sourceRT="WATER_SCATTER_DEPTH" bufIndex="0" />        
            <DrawQuadMT material="materials/MeshWater.material.mbin" context="M_BLW_WTR_SMPL" />
          <Else />
            <DrawQuadMT material="materials/MeshWater.material.mbin" context="M_BELOW_WATER" />
          <EndIf />

          <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="always" stencilMode="maskRead" stencilRef="0" stencilMask="1" />
          <If conditionType="variable" id="WaterGodRaysEnabled" />
            <DrawQuadMT material="materials/MeshWater.material.mbin" context="M_SCTTR_SMPL" />
          <Else />
            <DrawQuadMT material="materials/MeshWater.material.mbin" context="M_SCATTER" />
          <EndIf />

          <UnbindBuffers />
          <EndTarget flushCB="false" flushDB="false" />

        <EndIf />
      <EndIf />
    </Stage>

    <Stage id="BlendedAbovePreRefractions">

      <BeginTarget target="BLENDED_ABOVE" depthTarget="DEPTH"/>

      <ColourMask channels="RGBA" colBuf1="false" />
      <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />

      <!-- Quads -->
      <SetContext zwrite="true" colourWrite="true" cullMode="front"  blendMode="blend" depthTest="less" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="QUAD"     class="Opaque"  context="LIGHTING"  order="STATECHANGES" />
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="blend" depthTest="less" stencilMode="maskWrite" stencilRef="4" stencilMask="4"/>
      <DoForwardLightLoop type="QUAD"     class="Opaque"  context="LIGHTING"  order="STATECHANGES" />

      <!-- Lines -->
      <ColourMask channels="RGB" colBuf1="false" />
      <!--a = alpha offset, b = noise threshold, c = is underground, d = alpha noise factor-->
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="add" depthTest="always" stencilMode="maskWrite" stencilRef="4" stencilMask="4"/>
      <DoForwardLightLoop type="LINE"     class="Opaque"  context="SUBSTANCES"  order="STATECHANGES" />

      <ColourMask channels="RGB" colBuf1="false" />
      <!-- player gun additive. has to be rendered before the laser so it can lay down the stencil.-->
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="less" stencilMode="maskWrite" stencilRef="7" stencilMask="7" />
      <DrawGeometry type="Mesh"         class="GunAdditive"    context="LIT_FORWARD"             order="STATECHANGES" />

      <!-- Transparent Objects -->
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="less"  stencilMode="maskWrite" stencilRef="4" stencilMask="4"/>
      <DoForwardLightLoop type="Mesh"     class="Additive"    context="LIT_FORWARD" order="BACK_TO_FRONT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />
    </Stage>

    <Stage id="TranslucentNormal" enabled="true" >
      <If conditionType="variable" id="EnableMomentTransparency" />
        <!-- Depth Downsample for particles - note we can't use the current down-sample, since Water may have written to the real Depth Buffer -->
        <BeginTarget target="DEPTH_PART" depthTarget="DEPTH_DOWN_REV_Z" />
          <ColourMask channels="RGBA"/>
          <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_WATER" bufIndex="32"   />
          <SetContext zwrite="true" blendMode="replace" colourWrite="true" depthTest="always" />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="DWN_DPT_MBOIT_0" />
          <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="true" />
      
        <!--Clear MBOIT buffers-->
        <BeginTarget target="MBOIT_MOMENTS" />
          <ColourMask channels0="RGBA"/>
          <ClearTarget depthBuf="false" colBuf0="true" stencilBuf="false" />
        <EndTarget flushCB="true" flushDB="false" />
        <BeginTarget target="MBOIT_TOTAL_ABSORBANCE" />
          <ColourMask channels0="R"/>
          <ClearTarget depthBuf="false" colBuf0="true" stencilBuf="false" />
        <EndTarget flushCB="true" flushDB="false" />
        <BeginTarget target="MBOIT_ACCUMULATED_HALF_RES" />
          <ColourMask channels0="RGBA"/>
          <ClearTarget depthBuf="false" colBuf0="true" stencilBuf="false" />
        <EndTarget flushCB="true" flushDB="false" />
        <BeginTarget target="MBOIT_ACCUMULATED_FULL_RES" />
          <ColourMask channels0="RGBA"/>
          <ClearTarget depthBuf="false" colBuf0="true" stencilBuf="false" />
        <EndTarget flushCB="true" flushDB="false" />

        <If conditionType="variable" id="RefractionsEnabled" />
          <BeginTarget target="MBOIT_DISTORTION_HALF_RES" />
            <ColourMask channels0="RGBA"/>
            <ClearTarget depthBuf="false" colBuf0="true" stencilBuf="false" />
          <EndTarget flushCB="true" flushDB="false" />
          <BeginTarget target="MBOIT_DISTORTION_FULL_RES" />
            <ColourMask channels0="RGBA"/>
            <ClearTarget depthBuf="false" colBuf0="true" stencilBuf="false" />
          <EndTarget flushCB="true" flushDB="false" />
        <EndIf />
        
        <!--Render MBOIT moments and total absorbance (pass 1)-->
        <BeginTarget target="MBOIT_BUFFERS" depthTarget="DEPTH_DOWN_REV_Z" />
          <ColourMask channels0="RGBA" channels1="R"/>
          <SetContext zwrite="false" blendMode="rgbaAdd" colourWrite="true" cullMode="none" depthTest="less" />
          <BindBuffer sampler="gDepthBuffer"        sourceRT="DEPTH_PART"         bufIndex="0" />
          <BindBuffer sampler="gBufferMap"          sourceRT="HDRBUF_0"           bufIndex="0"   />
          <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME"  bufIndex="0" />
          <DoForwardLightLoop  type="EMITTER"  class="Translucent" context="MBOIT_T_SFT"  order="STATECHANGES"/>
          <DoForwardLightLoop  type="HEAVYAIR" class="Translucent" context="MBOIT_HA_SFT" order="STATECHANGES"/>
          <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />
        <BeginTarget target="MBOIT_BUFFERS" depthTarget="DEPTH_DOWN_REV_Z" />
          <ColourMask channels0="RGBA" channels1="R"/>
          <SetContext zwrite="false" blendMode="rgbaAdd" colourWrite="true" cullMode="back" depthTest="less" />
          <BindBuffer sampler="gShadowMap"          sourceRT="SHADOWBUF"          bufIndex="32" />
          <BindBuffer sampler="gCloudShadowMap"     sourceRT="CLOUDSHADOWS"       bufIndex="0" addressMode="wrap" />
          <BindBuffer sampler="gDepthBuffer"        sourceRT="DEPTH_WATER_LINEAR" bufIndex="0" />
          <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME"  bufIndex="0" />
          <DoForwardLightLoop type="Mesh" class="Translucent" context="MBOIT_LIT_FWD" order="STATECHANGES" />
          <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />
      
        <!--Accumulate MBOIT transmittance and colour (pass 2)-->
        <BeginTarget target="MBOIT_ACCUM_REFRACT_HALF_BUFFERS" depthTarget="DEPTH_DOWN_REV_Z" />
          <ColourMask channels="RGBA"/>
          <SetContext zwrite="false" blendMode="rgbaAdd" colourWrite="true" cullMode="none" depthTest="less" />
          <BindBuffer sampler="gDepthBuffer"        sourceRT="DEPTH_PART"             bufIndex="0" />
          <BindBuffer sampler="gBufferMap"          sourceRT="HDRBUF_0"               bufIndex="0"   />
          <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME"      bufIndex="0" />
          <BindBuffer sampler="gBuffer1Map"         sourceRT="MBOIT_MOMENTS"          bufIndex="0" />
          <BindBuffer sampler="gBuffer2Map"         sourceRT="MBOIT_TOTAL_ABSORBANCE" bufIndex="0" />
          <DoForwardLightLoop  type="EMITTER"  class="Translucent" context="MBOIT_ACM_T_SFT"  order="STATECHANGES"/>
          <DoForwardLightLoop  type="HEAVYAIR" class="Translucent" context="MBOIT_ACM_HA_SFT" order="STATECHANGES"/>
          <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />
        <BeginTarget target="MBOIT_ACCUM_REFRACT_FULL_BUFFERS" depthTarget="DEPTH" />
          <ColourMask channels="RGBA"/>
          <SetContext zwrite="false" blendMode="rgbaAdd" colourWrite="true" cullMode="back" depthTest="less" />
          <BindBuffer sampler="gShadowMap"          sourceRT="SHADOWBUF"              bufIndex="32" />
          <BindBuffer sampler="gCloudShadowMap"     sourceRT="CLOUDSHADOWS"           bufIndex="0" addressMode="wrap" />
          <BindBuffer sampler="gDepthBuffer"        sourceRT="DEPTH_WATER_LINEAR"     bufIndex="0" />
          <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME"      bufIndex="0" />
          <BindBuffer sampler="gBuffer1Map"         sourceRT="MBOIT_MOMENTS"          bufIndex="0" />
          <BindBuffer sampler="gBuffer2Map"         sourceRT="MBOIT_TOTAL_ABSORBANCE" bufIndex="0" />
          <If conditionType="variable" id="RefractionsEnabled" />
            <DoForwardLightLoop type="Mesh" class="Translucent" context="MBOIT_ACM_FWD_R"   order="STATECHANGES" />
          <Else />
            <DoForwardLightLoop type="Mesh" class="Translucent" context="MBOIT_ACM_LIT_FWD" order="STATECHANGES" />
          <EndIf />
          <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />
      
        <If conditionType="variable" id="RefractionsEnabled" />
          <!--Take a copy of the colour buffer for refractions-->
          <BeginTarget target="HDRBUF_1" />
            <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_0" bufIndex="0" />
            <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always"  />
            <ColourMask channels="RGBA"  />
            <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
          <EndTarget flushCB="true" flushDB="false" />
          <!--Apply refractions by distorting the colour buffer before transparents are blended on-->
          <BeginTarget target="HDRBUF_0" />
            <ColourMask channels0="RGBA"/>
            <SetContext blendMode="replace"   colourWrite="true" />
            <BindBuffer sampler="gBufferMap"  sourceRT="MBOIT_DISTORTION_HALF_RES"  bufIndex="0" />
            <BindBuffer sampler="gBuffer1Map" sourceRT="MBOIT_DISTORTION_FULL_RES"  bufIndex="0" />
            <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_WATER"                bufIndex="32" />
            <BindBuffer sampler="gBuffer3Map" sourceRT="HDRBUF_1"                   bufIndex="0" />
            <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBOIT_REFRACT" />
            <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="false" />
        <EndIf />
      
        <!--Normalise and upscale accumulated transmittance and colour, then composite-->
        <BeginTarget target="HDRBUF_0" />
          <ColourMask channels0="RGBA"/>
          <SetContext blendMode="invSourceAlpha" colourWrite="true" />
          <BindBuffer sampler="gBufferMap"  sourceRT="MBOIT_ACCUMULATED_HALF_RES" bufIndex="0" />
          <BindBuffer sampler="gBuffer1Map" sourceRT="MBOIT_ACCUMULATED_FULL_RES" bufIndex="0" />
          <BindBuffer sampler="gBuffer2Map" sourceRT="MBOIT_TOTAL_ABSORBANCE"     bufIndex="0" />
          <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_PART"                 bufIndex="0" />
          <BindBuffer sampler="gBuffer4Map" sourceRT="DEPTH_LINEAR"               bufIndex="0" />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBOIT_COMPOSITE" />
          <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />
      
        <!--Render transparent additives by sampling transmittance at depth-->
        <BeginTarget target="HDRBUF_0" depthTarget="DEPTH_WATER" readOnlyDepth="true" />
          <BindBuffer sampler="gDepthBuffer"        sourceRT="DEPTH_WATER_LINEAR"     bufIndex="0" />
          <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME"      bufIndex="0" />
          <BindBuffer sampler="gBuffer1Map"         sourceRT="MBOIT_MOMENTS"          bufIndex="0" />
          <BindBuffer sampler="gBuffer2Map"         sourceRT="MBOIT_TOTAL_ABSORBANCE" bufIndex="0" />
          <ColourMask channels="RGB" />
          <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="less" />
          <DoForwardLightLoop  type="EMITTER"  class="Additive"             context="MBOIT_T_ADD"     order="STATECHANGES"/>
          <DoForwardLightLoop  type="HEAVYAIR" class="Additive"             context="MBOIT_HA_ADD"    order="STATECHANGES"/>
          <DoForwardLightLoop  type="EMITTER"  class="AdditiveHighQuality"  context="MBOIT_T_ADD"     order="STATECHANGES"/>
          <DoForwardLightLoop  type="HEAVYAIR" class="AdditiveHighQuality"  context="MBOIT_HA_ADD"    order="STATECHANGES"/>
          <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />
      <Else/>
        <If conditionType="variable" id="RefractionsEnabled" test="equal" source="0" />
          <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" onlyStencil="true" readOnlyDepth="true" />
            <ColourMask channels="RGBA" />
            <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />
            <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />
            <BindBuffer sampler="gDepthBuffer"     sourceRT="DEPTH_LINEAR" bufIndex="0" />
            <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />
          
            <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less"  stencilMode="maskWrite" stencilRef="4" stencilMask="4"/>
            <DoForwardLightLoop type="Mesh"     class="Translucent" context="LIT_FORWARD" order="BACK_TO_FRONT" />
                
            <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="false" />
        <EndIf />
      <EndIf />
    </Stage>

    <Stage id="RefractionsPrePass" >
      <If>
        <Conditions operation="and">
          <Condition type="variable" id="RefractionsEnabled"  />
          <Condition type="variable" id="EnableMomentTransparency" test="equal" source="0" />
        </Conditions>
      </If>
      <BeginTarget target="REFR_COLOUR_B" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="0.0"/>
      <SetContext zwrite="false" colourWrite="true" blendMode="replace" depthTest="always" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="CLEAR" />
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="REFR_BUF" depthTarget="DEPTH" onlyStencil="true" />
      <ColourMask channels="RGBA" />
      <ClearTarget colBuf0="true"  colBuf1="true" colBuf2="true"  colBuf3="true" colBuf4="true" colBuf5="true" depthBuf="false"   stencilBuf="false" />
      <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less"   stencilMode="maskWrite" stencilRef="20"  stencilMask="20"/>
      <DoForwardLightLoop type="Mesh"     class="Translucent" context="LIT_FRWD_REFR" order="BACK_TO_FRONT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="RefractionsBehind" >
      <If>
        <Conditions operation="and">
          <Condition type="variable" id="RefractionsEnabled"  />
          <Condition type="variable" id="EnableMomentTransparency" test="equal" source="0" />
        </Conditions>
      </If>
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" onlyStencil="true" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gBufferMap"  sourceRT="REFR_COLOUR"      bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map" sourceRT="REFR_ALPHA"       bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map" sourceRT="REFR_COLOUR_B"    bufIndex="0"  />
      <BindBuffer sampler="gBuffer3Map" sourceRT="REFR_ALPHA_B"     bufIndex="0"  />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="always"  stencilMode="maskRead" stencilRef="16"  stencilMask="16"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="REFRACT_BEHIND" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="RefractionsApply" >
      <If>
        <Conditions operation="and">
          <Condition type="variable" id="RefractionsEnabled"  />
          <Condition type="variable" id="EnableMomentTransparency" test="equal" source="0" />
        </Conditions>
      </If>
      <BeginTarget target="REFR_ALPHA" />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="REFR_DIST_BUF" depthTarget="DEPTH" onlyStencil="true" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_0"         bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map" sourceRT="REFR_ALPHA"       bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map" sourceRT="REFR_DIR"         bufIndex="0"  />
      <BindBuffer sampler="gBuffer3Map" sourceRT="REFR_DEPTH_REV_Z" bufIndex="0"  />
      <BindBuffer sampler="gBuffer4Map" sourceRT="DEPTH"            bufIndex="32" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="always"  stencilMode="maskRead" stencilRef="16"  stencilMask="16"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="REFRACT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>    

    <Stage id="TranslucentRefractive">
      <If>
        <Conditions operation="and">
          <Condition type="variable" id="RefractionsEnabled"  />
          <Condition type="variable" id="EnableMomentTransparency" test="equal" source="0" />
        </Conditions>
      </If>
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" onlyStencil="true"  />
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gBufferMap"  sourceRT="REFR_COLOUR"      bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always"  stencilMode="maskRead" stencilRef="16" stencilMask="16" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />
      <EndIf />
    </Stage>

    <Stage id="TAA_NONE" enabled="false">
      <SwapTargets targetA="HDRBUF_0" targetB="HDRBUF_1" />
    </Stage>

    <Stage id="TAA_APPLY" enabled="false">
    </Stage> 

    <Stage id="TAA_APPLY_CLIP" enabled="false">
    </Stage>

    <Stage id="TAA_APPLY_TEST" enabled="false">
    </Stage>

    <Stage id="TAA_SWAP" enabled="false">
    </Stage>

    <Stage id="GeometryNormals">
      <If conditionType="stage" id="SSR_Params" enabled="true" />
      <BeginTarget target="GEO_NORMALS"/>
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"    sourceRT="DEPTH"  bufIndex="32" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="NFD_EDGE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="SSR_Params" enabled="false">
      <BeginTarget target="SSR_DEPTH_DOWN"/>
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"    sourceRT="DEPTH"        bufIndex="32" />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="GEO_NORMALS"  bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="NORMALS"      bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always"/>
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_DEPTH_DOWN" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="SSR_PARAMS" depthTarget="DEPTH_DOWN_REV_Z" onlyStencil="true" />
      <ClearTarget colBuf0="true" colBuf1="true" colBuf2="true" stencilBuf="true" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBuffer0iMap"  sourceRT="SSR_SMP_IDX"    bufIndex="0" />
      <BindBuffer sampler="gBufferMap"    sourceRT="DEPTH_HI_LOW_Z" bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="GEO_NORMALS"    bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="NORMALS"        bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map"   sourceRT="MATERIAL"       bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskWrite" stencilRef="64"  stencilMask="64" />
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_PARAMS" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="SSR_HighZMips" enabled="false">
      <!-- <If conditionType="variable" id="SSRGeometryDrawCount" /> -->
      <If conditionType="true" />

      <!-- Replace with proper flush command -->
      <BeginTarget target="DEPTH_HI_LOW_Z" mipLevel="1" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_HI_LOW_Z" bufIndex="0" mipLevel="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_LOW_Z" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_HI_LOW_Z" mipLevel="2" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_HI_LOW_Z" bufIndex="0" mipLevel="1" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_LOW_Z" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_HI_LOW_Z" mipLevel="3" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_HI_LOW_Z" bufIndex="0" mipLevel="2" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_LOW_Z"/>
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_HI_LOW_Z" mipLevel="4" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_HI_LOW_Z" bufIndex="0" mipLevel="3" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_LOW_Z" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_HI_LOW_Z" mipLevel="5" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_HI_LOW_Z" bufIndex="0" mipLevel="4" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_LOW_Z" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_HI_LOW_Z" mipLevel="6" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_HI_LOW_Z" bufIndex="0" mipLevel="5" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_LOW_Z" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_HI_LOW_Z" mipLevel="7" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_HI_LOW_Z" bufIndex="0" mipLevel="6" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_LOW_Z" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>
    
    <Stage id="SSR_ColourMips" enabled="false">
      <!-- <If conditionType="variable" id="SSRGeometryDrawCount" /> -->
      <If conditionType="true" />
        <BeginTarget target="SSR_REFL"/>
        <ColourMask channels="RGB"/>
        <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" />
        <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_1"   bufIndex="0" />
        <DrawQuad material="materials/PostProcess.material.mbin" context="UPS_4TAP_BIC_DJ" />
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="true" />

        <BeginTarget target="SSR_REFL_TMP" />
        <BindBuffer sampler="gBufferMap"  sourceRT="SSR_REFL"    bufIndex="0" />
        <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN"  bufIndex="0" />
        <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
        <DrawQuad material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_V_GUASS" />
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />

        <BeginTarget target="SSR_REFL" />
        <BindBuffer sampler="gBufferMap"  sourceRT="SSR_REFL_TMP"  bufIndex="0" />
        <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN"    bufIndex="0" />
        <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
        <DrawQuad material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_H_GUASS" />
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="SSR_March" enabled="false">
      <!-- <If conditionType="variable" id="SSRGeometryDrawCount" /> -->
      <If conditionType="true" />
      <BeginTarget target="SSR_HIT_DATA" depthTarget="DEPTH_DOWN_REV_Z" onlyStencil="true" readOnlyDepth="true" />
      <ColourMask channels="RGBA"/>
      <ClearTarget colBuf0="true" colBuf1="false" />
      <BindBuffer sampler="gBuffer0iMap"  sourceRT="SSR_SMP_IDX"      bufIndex="0" />
      <BindBuffer sampler="gBufferMap"    sourceRT="DEPTH_HI_LOW_Z"   bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="SSR_RAY_DIR"      bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="SSR_RAY_PDF"      bufIndex="0"  />
      <BindBuffer sampler="gBuffer3Map"   sourceRT="SSR_REFL"         bufIndex="0"  />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="64" stencilMask="64"/>
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_MARCH" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="SSR_Resolve" enabled="false">
      <!-- <If conditionType="variable" id="SSRGeometryDrawCount" /> -->
      <BeginTarget target="SSR_RESOLVE" />
      <ClearTarget colBuf0="true" />
      <EndTarget flushCB="true" flushDB="false" flushForCompute="true" />

      <!--
      <FlushBuffer  flushFor="readWrite"  sourceRT="SSR_RESOLVE"  bufIndex="0" />
      -->
      <BeginTarget target="SSR_HIT_LENGTH" depthTarget="DEPTH_DOWN_REV_Z" onlyStencil="true" readOnlyDepth="true" />
      <ClearTarget colBuf0="true" />
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gBufferMap"    sourceRT="GBUFFER"          bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="GBUFFER"          bufIndex="2"  />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="GBUFFER"          bufIndex="3"  />
      <BindBuffer sampler="gBuffer3Map"   sourceRT="DEPTH"            bufIndex="32" />
      <BindBuffer sampler="gBuffer4Map"   sourceRT="SSR_RAY_PDF"      bufIndex="0"  />
      <BindBuffer sampler="gBuffer5Map"   sourceRT="SSR_HIT_DATA"     bufIndex="0"  />
      <BindBuffer sampler="gBuffer6Map"   sourceRT="SSR_HIT_DATA"     bufIndex="1"  />
      <BindBuffer sampler="gResolveOut"   sourceRT="SSR_RESOLVE"      bufIndex="0"  bindAsRwImage="true" />
      <SetContext zwrite="false" colourWrite="true"  cullMode="none" blendMode="add" depthTest="always" stencilMode="maskRead" stencilRef="64"   stencilMask="64" />
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_REUSE_0" />
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_REUSE_1" />
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_REUSE_2" />
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_REUSE_3" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <FlushBuffer  flushFor="read" sourceRT="SSR_RESOLVE"  bufIndex="0" />
    </Stage>

    <Stage id="SSR_Temporal" enabled="false">
      <!-- <If conditionType="variable" id="SSRGeometryDrawCount" /> -->
      <If conditionType="true" />

      <BeginTarget target="SSR_TEMPORAL_F" depthTarget="DEPTH" onlyStencil="true" readOnlyDepth="true" />
      <ColourMask channels="RGB" />
      <BindBuffer sampler="gBufferMap"    sourceRT="SSR_HIT_LENGTH"     bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="SSR_RESOLVE"        bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="SSR_RADIANCE"       bufIndex="0" frameIdx="prev" />
      <BindBuffer sampler="gBuffer3Map"   sourceRT="SSR_CONF_ACC_T_H"   bufIndex="0" frameIdx="prev" />
      <BindBuffer sampler="gBuffer4Map"   sourceRT="MATERIAL"           bufIndex="0" />
      <BindBuffer sampler="gBuffer5Map"   sourceRT="MATERIAL_BACK"      bufIndex="0" frameIdx="prev" />
      <BindBuffer sampler="gBuffer6Map"   sourceRT="NORMALS"            bufIndex="0" />
      <BindBuffer sampler="gBuffer7Map"   sourceRT="NORMALS_BACK"       bufIndex="0" frameIdx="prev" />
      <BindBuffer sampler="gBuffer8Map"   sourceRT="DEPTH"              bufIndex="32" />
      <BindBuffer sampler="gBuffer9Map"   sourceRT="DEPTH_BACK"         bufIndex="32" frameIdx="prev" />
      <BindBuffer sampler="gBuffer10Map"  sourceRT="MOTIONRESOLVE"      bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="64" stencilMask="64" />
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_TEMPORAL" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="0"  stencilMask="64" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="CLEAR_ZERO" />        
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="SSR_CONF_ACC_T_F" depthTarget="DEPTH" onlyStencil="true" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="0" stencilMask="64" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="CLEAR_ONE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="SSR_RADIANCE" depthTarget="DEPTH" onlyStencil="true" readOnlyDepth="true" />
      <ColourMask channels="RGB" />
      <BindBuffer sampler="gBufferMap"  sourceRT="SSR_TEMPORAL_F"     bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="64" stencilMask="64" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="RCRS" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="0"  stencilMask="64" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="CLEAR_ZERO" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="SSR_ParamsRefine" enabled="false">
    </Stage>

    <Stage id="SSR_Apply" enabled="false">
      <!-- <If conditionType="variable" id="SSRGeometryDrawCount" /> -->
      <If conditionType="true" />

      <!-- Copy it back into the scene -->
      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH" onlyStencil="true" readOnlyDepth="true" />
      <ColourMask channels="RGB" />
      <BindBuffer sampler="gBufferMap"    sourceRT="GBUFFER"          bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="NORMALS"          bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="MATERIAL"         bufIndex="0"  />
      <BindBuffer sampler="gBuffer3Map"   sourceRT="DEPTH"            bufIndex="32" />
      <BindBuffer sampler="gBuffer4Map"   sourceRT="SSR_RADIANCE"     bufIndex="0"  />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" stencilMode="maskRead" stencilRef="64" stencilMask="64" />
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_APPLY"  />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <SwapTargets targetA="SSR_TEMPORAL_F"     targetB="SSR_TEMPORAL_H"    />
      <SwapTargets targetA="SSR_CONF_ACC_T_F"   targetB="SSR_CONF_ACC_T_H"  />
      <EndIf />
      
      <EndTarget flushCB="true" flushDB="true" />
    </Stage>

    <Stage id="GeometryCopy">
      <!--need to replace these copies with a swap-->
      <If conditionType="stage" id="SSR_Params" enabled="true" />
      <BeginTarget target="NORMALS_BACK" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="NORMALS" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="MATERIAL_BACK" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="MATERIAL" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <SwapTargets targetA="GEO_NORMALS"     targetB="GN_SWAP_DUMMY"  />
      <EndIf/>
    </Stage>

    <Stage id="RefractionsCleanup" >
      <If conditionType="variable" id="RefractionsEnabled" />
      <BeginTarget target="REFR_ALPHA_B" depthTarget="DEPTH" onlyStencil="true" />
      <ColourMask channels="R" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="0.0"/>
      <SetContext zwrite="false" colourWrite="true" blendMode="replace" depthTest="always" stencilMode="maskReadWriteNotEqual" stencilRef="0" stencilMaskRead="16" stencilMaskWrite="16" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="CLEAR" />
      <EndTarget flushCB="true" flushDB="true" />
      <EndIf />
    </Stage>

    <Stage id="BlendedAbovePostRefractions">
      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH" />

      <!-- Transparent Objects -->
      <ColourMask channels="RGBA" colBuf1="false" />
      <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />
      <BindBuffer sampler="gBufferMap"       sourceRT="DEPTH_LINEAR"    bufIndex="0" />
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less"  stencilMode="maskWrite" stencilRef="4" stencilMask="4"/>
      <DoForwardLightLoop type="Mesh"     class="WarpInShip"  context="LIT_FORWARD" order="BACK_TO_FRONT" />

      <!-- PlaneSpotlight Object -->
      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="less"  stencilMode="maskWrite" stencilRef="4" stencilMask="4"/>
      <DoForwardLightLoop type="Mesh"     class="PlaneSpot"    context="LIT_FORWARD" contextVariant="1" order="BACK_TO_FRONT" />
      
      <!--<ClearTarget colBuf0="false" depthBuf="false" stencilBuf="true" />-->      
      <ColourMask channels="RGB" colBuf1="true" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite"  stencilRef="36"  stencilMask="36"/>
      <DoForwardLightLoop type="Mesh"     class="Highlight"            context="LIT_FORWARD_WITH_MASK" order="BACK_TO_FRONT" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite"  stencilRef="36"   stencilMask="36"/>
      <DoForwardLightLoop type="Mesh"     class="HighlightOccluded"    context="LIT_FORWARD_WITH_MASK" order="BACK_TO_FRONT" />
      
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite"  stencilRef="36"  stencilMask="36"/>
      <DoForwardLightLoop type="Mesh"     class="HighlightDoubleSided" context="LIT_FORWARD_WITH_MASK" order="BACK_TO_FRONT" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite"   stencilRef="36"  stencilMask="36"/>
      <DoForwardLightLoop type="Mesh"     class="HighlightTrans"            context="LIT_FORWARD_WITH_MASK" order="BACK_TO_FRONT" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite"   stencilRef="36"   stencilMask="36"/>
      <DoForwardLightLoop type="Mesh"     class="HighlightTransOccluded"    context="LIT_FORWARD_WITH_MASK"     order="BACK_TO_FRONT" />

      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite"  stencilRef="36"  stencilMask="36"/>
      <DoForwardLightLoop type="Mesh"     class="HighlightTransDoubleSided" context="LIT_FORWARD_WITH_MASK" order="BACK_TO_FRONT" />
      <If conditionType="legacy" enabled="false" />
        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="always" stencilMode="maskWrite"  stencilRef="4" stencilMask="4"/>
        <DoForwardLightLoop type="Mesh"     class="HighlightOverlay"            context="LIT_FORWARD_WITH_MASK" order="BACK_TO_FRONT" />
        <SetContext />

        <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="always" stencilMode="maskWrite"  stencilRef="4" stencilMask="4"/>
        <DoForwardLightLoop type="Mesh"     class="HighlightOverlayDoubleSided" context="LIT_FORWARD_WITH_MASK" order="BACK_TO_FRONT" />
        <SetContext />

        <ColourMask channels="RGB" colBuf1="false" />
      <EndIf />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="greater"    stencilMode="maskWrite"  stencilRef="36"   stencilMask="36"/>
      <DoForwardLightLoop type="Mesh"     class="HighlightOccluded"       context="LIT_FRWD_OCCLUDED" order="BACK_TO_FRONT" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="greater"    stencilMode="maskWrite"  stencilRef="36"   stencilMask="36"/>
      <DoForwardLightLoop type="Mesh"     class="HighlightTransOccluded"  context="LIT_FRWD_OCCLUDED" order="BACK_TO_FRONT" />

      <!-- Trails -->
      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="less"  stencilMode="maskWrite" stencilRef="4" stencilMask="4"/>
      <If conditionType="legacy" enabled="true" />
      <DoForwardLightLoop type="Trail" class="Translucent" context="LIGHTING" order="STATECHANGES" />
      <Else />
      <DoForwardLightLoop type="BezierTrail" class="Translucent" context="LIGHTING" order="STATECHANGES" />
      <EndIf />

      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add"   depthTest="less"  stencilMode="maskWrite" stencilRef="4" stencilMask="4"/>
      <If conditionType="legacy" enabled="true" />
      <DoForwardLightLoop type="Trail" class="Additive"    context="LIGHTING" order="STATECHANGES" />
      <Else />
      <DoForwardLightLoop type="BezierTrail" class="Additive"    context="LIGHTING" order="STATECHANGES" />
      <EndIf />

      <!--Single Lines-->
      <ColourMask channels="RGBA" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="blend" depthTest="less"  stencilMode="maskWrite" stencilRef="4" stencilMask="4" /> 
      <DoForwardLightLoop type="SingleLine" class="Opaque" context="LIGHTING" order="STATECHANGES" />

      <!--Single Lines-->
      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="less"  stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="SingleLine" class="Additive" context="LIGHTING" order="STATECHANGES" />

      <!-- Markers -->
      <ColourMask channels="RGBA" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less"  stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="Mesh" class="Map" context="SCREEN_MAP" order="BACK_TO_FRONT" />

      <!-- Glow Translucent RGB -->
      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less"  stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="Mesh"  class="GlowTranslucent" context="LIT_FORWARD" order="BACK_TO_FRONT" />
      
      <SetContext zwrite="false" colourWrite="false" cullMode="none" blendMode="add" depthTest="less" stencilMode="maskWrite" stencilRef="4" stencilMask="7" />

      <!-- render the player laser stencil-only, to mask it in the TAA -->
      <!-- results in some overzealous clipping in AA but should be hard to see, the gun moves a lot -->
      <DoForwardLightLoop type="SingleLine" class="PlayerGunLaser"     context="LIGHTING" order="STATECHANGES" />      
      <DoForwardLightLoop type="SingleLine" class="PlayerGunLaserCore" context="LIGHTING" order="STATECHANGES" />

      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="less" stencilMode="maskReadInvert" stencilRef="3" stencilMask="7" />

      <!-- player laser. actual colour rendering masked by the gun -->
      <DoForwardLightLoop type="SingleLine" class="PlayerGunLaser" context="LIGHTING" order="STATECHANGES" />      
      <DoForwardLightLoop type="SingleLine" class="PlayerGunLaserCore" context="LIGHTING" order="STATECHANGES" />        
        
      <ColourMask channels="RGBA" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="always"  stencilMode="maskWrite" stencilRef="4" stencilMask="4"/>
      <DoForwardLightLoop type="Mesh"     class="WarpOnFoot" context="LIT_FORWARD" order="BACK_TO_FRONT" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="invSourceAlpha" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="4" stencilMask="4"/>
      <DoForwardLightLoop type="Mesh"         class="UIScreen"         context="LIT_FORWARD"            order="BACK_TO_FRONT" />
      
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="true" />

      <!-- Glow Translucent Alpha -->
      <BeginTarget target="GBUFFER" depthTarget="DEPTH" onlyStencil="true"  />    
      <ColourMask channels="A" colBuf1="false" colBuf2="false" colBuf3="false" />
      <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />
      <BindBuffer sampler="gBufferMap"       sourceRT="DEPTH_LINEAR"    bufIndex="0" />
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="Blend_OutputAlpha" depthTest="less" />
      <DoForwardLightLoop type="Mesh"  class="GlowTranslucent" context="LIT_FORWARD"    order="BACK_TO_FRONT" />
      <If conditionType="legacy" enabled="true" />
      <DoForwardLightLoop type="Trail" class="Translucent"     context="LIGHTING_GLOW"  order="STATECHANGES"  />
      <DoForwardLightLoop type="Trail" class="Additive"        context="LIGHTING_GLOW"  order="BACK_TO_FRONT" />
      <Else />
      <DoForwardLightLoop type="BezierTrail" class="Translucent"     context="LIGHTING_GLOW"  order="STATECHANGES"  />
      <DoForwardLightLoop type="BezierTrail" class="Additive"        context="LIGHTING_GLOW"  order="BACK_TO_FRONT" />
      <EndIf />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

    </Stage>

    <Stage id="3dLines">
      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH" onlyStencil="true"  />
      <ColourMask channels="RGBA"  />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" />
      <DrawGeometry type="LINERENDERER"  class="Opaque"   context="LINE3D"            order="STATECHANGES" />
      <EndTarget flushCB="true" flushDB="true" />
    </Stage>

    <Stage id="LUTMaskClear">
      <BeginTarget target="LUT_MASK" depthTarget="DEPTH" onlyStencil="true" readOnlyDepth="true" />      
      <ColourMask channels="R" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskReadInvert" stencilRef="32" stencilMask="32" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="PARTICLE_CLEAR" />
      <EndTarget flushCB="true" flushDB="false" />      
    </Stage>

    <Stage id="FFXSR2_LUMATR" enabled="false">
      <BeginTarget target="LUM_BUF_TR" />
      <ColourMask channels="R" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_1" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY_RGB2LUM_LINEAR" />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="ProbeReflections" enabled="false">
      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH" onlyStencil="true" readOnlyDepth="true" />
      <ColourMask channels="RGB" />
      <BindBuffer sampler="gBufferMap"    sourceRT="DEPTH"    bufIndex="32" />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="GBUFFER"  bufIndex="2"  />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="GBUFFER"  bufIndex="3"  />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" stencilMode="maskRead" stencilRef="64" stencilMask="64" />
      <DrawQuad material="materials/SSR.material.mbin" context="PROBE_REFLECTIONS" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="MeshWaterDepthCopy">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_MeshedDeferred" />
        <If conditionType="variable" id="WaterState"  test="notEqual" sourceType="variable" source="WaterState_NoWater" />
          <BeginTarget target="DEPTH_LINEAR" depthTarget="DEPTH" />
          <ColourMask channels="RGBA"/>
          <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="false" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
          <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_WATER" bufIndex="32" />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_REV2LIN_LESS" />
          <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="true" />
        <EndIf />
      <EndIf />
    </Stage>

    <Stage id="Particles">
      
      <If conditionType="variable" id="EnableMomentTransparency" test="equal" source="0" />

      <!-- Depth Downsample for particles - note we can't use the current down-sample, since Water may have written to the real Depth Buffer -->

      <BeginTarget target="DEPTH_PART" depthTarget="DEPTH_DOWN_REV_Z" />
      
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH"    bufIndex="32"   />
      <SetContext zwrite="true" blendMode="replace" colourWrite="true" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSMP_DEPTH_NORM" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />

      <BeginTarget target="PARTICLES" depthTarget="DEPTH_DOWN_REV_Z" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="PARTICLE_CLEAR" />

      <!--PS4: default setting after ClearTarget equals RT0-RGBA, so no need to call ColourMask again-->
      <BindBuffer sampler="gDepthBuffer" sourceRT="DEPTH_PART" bufIndex="0" />
      <BindBuffer sampler="gBufferMap"   sourceRT="HDRBUF_1"    bufIndex="0"   />
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="Blend_OutputOneMinusAlpha" depthTest="less" />

      <DoForwardLightLoop  type="EMITTER"  class="Translucent" context="TRANSLUCENT_SOFT" order="BACK_TO_FRONT"/>
      <DoForwardLightLoop  type="HEAVYAIR" class="Translucent" context="HEAVYAIR_SOFT" order="BACK_TO_FRONT"/>
      <UnbindBuffers />

      <!-- Uncomment this to simulate how particles behave on Switch (acommend out additive particles below!) -->
      <!-- <BindBuffer sampler="gDepthBuffer" sourceRT="DEPTH_PART" bufIndex="0" />
      <ColourMask channels="RGB" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="less"  />
      <DoForwardLightLoop  type="EMITTER"  class="Additive" context="TRNSLCNT_ADDITIVE" order="BACK_TO_FRONT" />
      <DoForwardLightLoop  type="HEAVYAIR" class="Additive" context="HVR_ADDITIVE" order="BACK_TO_FRONT"  />
      <UnbindBuffers /> -->

      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="HDRBUF_1"  depthTarget="DEPTH"/>
      <ColourMask channels="RGB" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="invSourceAlpha" depthTest="always" />

      <BindBuffer sampler="gBufferMap"  sourceRT="PARTICLES"    bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_PART"   bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_LINEAR" bufIndex="0" /> 
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="PART_UPSAMPLE" />
      <UnbindBuffers />

      <BindBuffer sampler="gDepthBuffer" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />
      <ColourMask channels="RGB" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="less" />
      <DoForwardLightLoop  type="EMITTER"  class="Additive"             context="TRNSLCNT_ADDITIVE" order="BACK_TO_FRONT"/>
      <DoForwardLightLoop  type="HEAVYAIR" class="Additive"             context="HVR_ADDITIVE"      order="BACK_TO_FRONT"/>
      <DoForwardLightLoop  type="EMITTER"  class="AdditiveHighQuality"  context="TRNSLCNT_ADDITIVE" order="BACK_TO_FRONT"/>
      <DoForwardLightLoop  type="HEAVYAIR" class="AdditiveHighQuality"  context="HVR_ADDITIVE"      order="BACK_TO_FRONT"/>

      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />

      <EndIf/>
    </Stage>

    <Stage id="SpeedLines">
      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH"/>
      <ColourMask channels="RGBA" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="Blend_OutputOneMinusAlpha" depthTest="less" />
      <DoForwardLightLoop type="SPEEDLINE" class="Opaque" context="LIGHTING" order="STATECHANGES" />
      <EndTarget flushCB="true" flushDB="true" />
    </Stage>

    <Stage id="CopyDepth2">

      <BeginTarget target="DEPTH_ASYNC" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH" bufIndex="32" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_REV2LIN" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

    </Stage>

    <Stage id="Exposure" enabled="false">

      <BeginTarget target="HDRBUF_0" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_1" bufIndex="0"  />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <If conditionType="true" />

      <BeginTarget target="EXPOSURE" />
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/Exposure.material.mbin" context="EXP_MANUAL" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="HDRBUF_1" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gColourHdrMap" sourceRT="HDRBUF_0" bufIndex="0" />
      <BindBuffer sampler="gExposureMap"  sourceRT="EXPOSURE" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/Exposure.material.mbin" context="EXP_APPLY_GLOBAL" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <Else/>

      <BeginTarget target="EV_HISTOGRAM" />
      <ClearTarget type="uint" colBuf0="true"   col_R="0" />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="EV_NORM" />
      <ColourMask channels="RGB"/>
      <BindBuffer   sampler="gColourHdrMap"   sourceRT="HDRBUF_0"       bufIndex="0"  />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/Exposure.material.mbin" context="EV_NORM_CAST" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <UpdateVariable id="GroupCountX"  operation="set" sourceType="rtWidth"  source="HDRBUF_0" />
      <UpdateVariable id="GroupCountY"  operation="set" sourceType="rtHeight" source="HDRBUF_0" />
      <UpdateVariable id="GroupCountX"  operation="add" value="31" />
      <UpdateVariable id="GroupCountY"  operation="add" value="31" />
      <UpdateVariable id="GroupCountX"  operation="div" value="32" />
      <UpdateVariable id="GroupCountY"  operation="div" value="32" />

      <FlushBuffer  flushFor="readWrite"            sourceRT="EV_BIL_GRID"    bufIndex="0" />
      <BindBuffer   sampler="gEvNormMap"            sourceRT="EV_NORM"        bufIndex="0" />
      <BindBuffer   sampler="gEvBilateralGridRwMap" sourceRT="EV_BIL_GRID"    bufIndex="0"  bindAsRwImage="true" />
      <DispatchPass material="materials/Exposure.material.mbin" context="EV_BIN_FAST" groupCountXFromVar="GroupCountX" groupCountYFromVar="GroupCountY" groupCountZ="1" />
      <UnbindBuffers />

      <FlushBuffer  flushFor="read"                 sourceRT="EV_BIL_GRID"    bufIndex="0" />
      <FlushBuffer  flushFor="readWrite"            sourceRT="EV_HISTOGRAM"   bufIndex="0" />
      <BindBuffer   sampler="gEvNormMap"            sourceRT="EV_NORM"        bufIndex="0" />
      <BindBuffer   sampler="gEvBilateralGridMap"   sourceRT="EV_BIL_GRID"    bufIndex="0" />
      <BindBuffer   sampler="gEvHistogramRwMap"     sourceRT="EV_HISTOGRAM"   bufIndex="0"  bindAsRwImage="true" />
      <DispatchPass material="materials/Exposure.material.mbin" context="EV_GRID_REDUCE" groupCountX="1" groupCountY="1" groupCountZ="64" />
      <UnbindBuffers />

      <FlushBuffer  flushFor="readWrite"            sourceRT="EV_BLUR"        bufIndex="0" />
      <BindBuffer   sampler="gEvBilateralGridMap"   sourceRT="EV_BIL_GRID"    bufIndex="0" />
      <BindBuffer   sampler="gEvBlurRwMap"          sourceRT="EV_BLUR"        bufIndex="0"  bindAsRwImage="true" />
      <DispatchPass material="materials/Exposure.material.mbin" context="EV_GRID_FLATTEN" groupCountXFromVar="GroupCountX" groupCountYFromVar="GroupCountY" groupCountZ="1" />
      <UnbindBuffers />

      <UpdateVariable id="GroupCountX"  operation="add" value="15" />
      <UpdateVariable id="GroupCountY"  operation="add" value="15" />
      <UpdateVariable id="GroupCountX"  operation="div" value="16" />
      <UpdateVariable id="GroupCountY"  operation="div" value="16" />
      
      <FlushBuffer  flushFor="read"                 sourceRT="EV_BLUR"        bufIndex="0" />
      <FlushBuffer  flushFor="readWrite"            sourceRT="EV_BLUR_TMP"    bufIndex="0" />
      <BindBuffer   sampler="gEvNormMap"            sourceRT="EV_NORM"        bufIndex="0" />
      <BindBuffer   sampler="gEvBlurMap"            sourceRT="EV_BLUR"        bufIndex="0" />
      <BindBuffer   sampler="gEvBlurRwMap"          sourceRT="EV_BLUR_TMP"    bufIndex="0"  bindAsRwImage="true" />
      <DispatchPass material="materials/Exposure.material.mbin" context="EV_BLUR_2D_H" groupCountXFromVar="GroupCountX" groupCountYFromVar="GroupCountY" groupCountZ="1" />
      <UnbindBuffers />

      <FlushBuffer  flushFor="read"                 sourceRT="EV_BLUR_TMP"    bufIndex="0" />
      <FlushBuffer  flushFor="readWrite"            sourceRT="EV_BLUR"        bufIndex="0" />
      <BindBuffer   sampler="gEvNormMap"            sourceRT="EV_NORM"        bufIndex="0" />
      <BindBuffer   sampler="gEvBlurMap"            sourceRT="EV_BLUR_TMP"    bufIndex="0" />
      <BindBuffer   sampler="gEvBlurRwMap"          sourceRT="EV_BLUR"        bufIndex="0"  bindAsRwImage="true" />
      <DispatchPass material="materials/Exposure.material.mbin" context="EV_BLUR_2D_V" groupCountXFromVar="GroupCountX" groupCountYFromVar="GroupCountY" groupCountZ="1" />
      <UnbindBuffers />

      <FlushBuffer  flushFor="read"                 sourceRT="EV_BIL_GRID"      bufIndex="0" />
      <FlushBuffer  flushFor="readWrite"            sourceRT="EV_BIL_GRID_TMP"  bufIndex="0" />
      <BindBuffer   sampler="gEvNormMap"            sourceRT="EV_NORM"          bufIndex="0" />
      <BindBuffer   sampler="gEvBilateralGridMap"   sourceRT="EV_BIL_GRID"      bufIndex="0" />
      <BindBuffer   sampler="gEvBilateralGridRwMap" sourceRT="EV_BIL_GRID_TMP"  bufIndex="0"  bindAsRwImage="true" />
      <DispatchPass material="materials/Exposure.material.mbin" context="EV_BLUR_3D_H" groupCountXFromVar="GroupCountX" groupCountYFromVar="GroupCountY" groupCountZ="64" />
      <UnbindBuffers />

      <FlushBuffer  flushFor="read"                 sourceRT="EV_BIL_GRID_TMP"  bufIndex="0" />
      <FlushBuffer  flushFor="readWrite"            sourceRT="EV_BLUR"          bufIndex="0" />
      <BindBuffer   sampler="gEvNormMap"            sourceRT="EV_NORM"          bufIndex="0" />
      <BindBuffer   sampler="gEvBilateralGridMap"   sourceRT="EV_BIL_GRID_TMP"  bufIndex="0" />
      <BindBuffer   sampler="gEvBilateralGridRwMap" sourceRT="EV_BIL_GRID"      bufIndex="0"  bindAsRwImage="true" />
      <DispatchPass material="materials/Exposure.material.mbin" context="EV_BLUR_3D_V" groupCountXFromVar="GroupCountX" groupCountYFromVar="GroupCountY" groupCountZ="64" />
      <UnbindBuffers />

      <UpdateVariable id="GroupCountX"  operation="mul" value="4" />
      <UpdateVariable id="GroupCountY"  operation="mul" value="4" />

      <FlushBuffer  flushFor="read"                 sourceRT="EV_BLUR"        bufIndex="0" />
      <FlushBuffer  flushFor="readWrite"            sourceRT="EV_BLUR_UPS"    bufIndex="0" />
      <BindBuffer   sampler="gEvNormMap"            sourceRT="EV_NORM"        bufIndex="0" />
      <BindBuffer   sampler="gEvBlurMap"            sourceRT="EV_BLUR"        bufIndex="0" />
      <BindBuffer   sampler="gEvBlurRwMap"          sourceRT="EV_BLUR_UPS"    bufIndex="0"  bindAsRwImage="true" />
      <DispatchPass material="materials/Exposure.material.mbin" context="EV_UPS_BSPLINE" groupCountXFromVar="GroupCountX" groupCountYFromVar="GroupCountY" groupCountZ="1" />
      <UnbindBuffers />
      <FlushBuffer  flushFor="read"                 sourceRT="EV_BLUR_UPS"    bufIndex="0" />

      <BeginTarget target="EXPOSURE" />
      <ColourMask channels="R"/>
      <FlushBuffer  flushFor="read"                 sourceRT="EV_HISTOGRAM"     bufIndex="0" />
      <BindBuffer   sampler="gColourHdrMap"         sourceRT="HDRBUF_0"         bufIndex="0"  />
      <BindBuffer   sampler="gExpHistoryMap"        sourceRT="EXPOSURE_H"       bufIndex="0"  />
      <BindBuffer   sampler="gEvHistogramMap"       sourceRT="EV_HISTOGRAM"     bufIndex="0"  />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/Exposure.material.mbin" context="EXP_AUTO" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="HDRBUF_1" />
      <ColourMask channels="RGB"/>
      <FlushBuffer  flushFor="read"                 sourceRT="EV_BIL_GRID"      bufIndex="0" />
      <FlushBuffer  flushFor="read"                 sourceRT="EV_BLUR_UPS"      bufIndex="0" />
      <BindBuffer   sampler="gColourHdrMap"         sourceRT="HDRBUF_0"         bufIndex="0" />
      <BindBuffer   sampler="gExposureMap"          sourceRT="EXPOSURE"         bufIndex="0" />
      <BindBuffer   sampler="gEvBlurMap"            sourceRT="EV_BLUR_UPS"      bufIndex="0" />
      <BindBuffer   sampler="gEvBilateralGridMap"   sourceRT="EV_BIL_GRID"      bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/Exposure.material.mbin" context="EXP_APPLY_LOCAL" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <SwapTargets targetA="EXPOSURE" targetB="EXPOSURE_H" />
      <EndIf/>
    </Stage>

    <Stage id="NewBloomBright" enabled="true">
      <BeginTarget target="BLOOM_BLURBUF_2B" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="HDRBUF_1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="GBUFFER"  bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="BRIGHTPASS_NEW" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_2A" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="BLOOM_BLURBUF_2B" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="BLOOM_BLURBUF_2T" bufIndex="0" frameIdx="prev" />
      <BindBuffer sampler="gBuffer2Map"  sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="BRIGHTPASS_TEMPORAL" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_2T" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="BLOOM_BLURBUF_2A" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Effects" enabled="true">
      <BeginTarget target="BLOOM_BLURBUF_2A" depthTarget="DEPTH_DOWN_REV_Z" readOnlyDepth="true" />
      <ColourMask channels="RGB"  />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="less" />
      <DoForwardLightLoop type="Mesh"     class="Bloom"              context="LIT_FORWARD" order="BACK_TO_FRONT" />
      <DoForwardLightLoop type="Mesh"     class="BloomAndLensFlare"  context="LIT_FORWARD" order="BACK_TO_FRONT" />
      <EndTarget flushCB="false" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_2B" depthTarget="DEPTH_DOWN_REV_Z" readOnlyDepth="true" />
      <ColourMask channels="RGB"  />
      <ClearTarget colBuf0="true"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="less" />
      <DoForwardLightLoop type="Mesh"     class="LensFlare"          context="LIT_FORWARD" order="BACK_TO_FRONT" />
      <DoForwardLightLoop type="Mesh"     class="BloomAndLensFlare"  context="LIT_FORWARD" order="BACK_TO_FRONT" />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_4A" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="BLOOM_BLURBUF_2B" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="3.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_EFFECTS" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="BLOOM_BLURBUF_4A" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="3.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="SpotlightsVolumetric" enabled="true">
      <BeginTarget target="BLOOM_BLURBUF_2A" depthTarget="DEPTH_DOWN_REV_Z" readOnlyDepth="true" />
      <ColourMask channels="RGB" />
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_DOWN_REV_Z" bufIndex="32" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="add" depthTest="less"   depthBounds="true" />
      <DoDeferredLightLoop context="SPOT_K_VOL_OUT"   volumetric="true" inner="false" spot="true"  constant="true"    />
      <DoDeferredLightLoop context="SPOT_L_VOL_OUT"   volumetric="true" inner="false" spot="true"  linear="true"      />
      <DoDeferredLightLoop context="SPOT_R_VOL_OUT"   volumetric="true" inner="false" spot="true"  linear_sqrt="true" />
      <DoDeferredLightLoop context="SPOT_Q_VOL_OUT"   volumetric="true" inner="false" spot="true"  quadratic="true"   />
      <DoDeferredLightLoop context="SPOT_C_VOL_OUT"   volumetric="true" inner="false" spot="true"  cubic="true"       />
      <DoDeferredLightLoop context="SPOT_E_VOL_OUT"   volumetric="true" inner="false" spot="true"  custom="true"      />
      
      <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="add" depthTest="always" depthBounds="true" />
      <DoDeferredLightLoop context="SPOT_K_VOL_IN"    volumetric="true" inner="true"  spot="true"  constant="true"    />
      <DoDeferredLightLoop context="SPOT_L_VOL_IN"    volumetric="true" inner="true"  spot="true"  linear="true"      />
      <DoDeferredLightLoop context="SPOT_R_VOL_IN"    volumetric="true" inner="true"  spot="true"  linear_sqrt="true" />
      <DoDeferredLightLoop context="SPOT_Q_VOL_IN"    volumetric="true" inner="true"  spot="true"  quadratic="true"   />
      <DoDeferredLightLoop context="SPOT_C_VOL_IN"    volumetric="true" inner="true"  spot="true"  cubic="true"       />
      <DoDeferredLightLoop context="SPOT_E_VOL_IN"    volumetric="true" inner="true"  spot="true"  custom="true"      />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="PointlightsVolumetric" enabled="true">
      <BeginTarget target="BLOOM_BLURBUF_2A" depthTarget="DEPTH_DOWN_REV_Z" readOnlyDepth="true" />
      <ColourMask channels="RGB" />
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_DOWN_REV_Z" bufIndex="32" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="add" depthTest="less"   depthBounds="true" />
      <DoDeferredLightLoop context="POINT_K_VOL_OUT"  volumetric="true" inner="false" point="true" constant="true"    />
      <DoDeferredLightLoop context="POINT_L_VOL_OUT"  volumetric="true" inner="false" point="true" linear="true"      />
      <DoDeferredLightLoop context="POINT_R_VOL_OUT"  volumetric="true" inner="false" point="true" linear_sqrt="true" />
      <DoDeferredLightLoop context="POINT_Q_VOL_OUT"  volumetric="true" inner="false" point="true" quadratic="true"   />
      <DoDeferredLightLoop context="POINT_C_VOL_OUT"  volumetric="true" inner="false" point="true" cubic="true"       />
      <DoDeferredLightLoop context="POINT_E_VOL_OUT"  volumetric="true" inner="false" point="true" custom="true"      />

      <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="add" depthTest="always" depthBounds="true" />
      <DoDeferredLightLoop context="POINT_K_VOL_IN"   volumetric="true" inner="true"  point="true" constant="true"    />
      <DoDeferredLightLoop context="POINT_L_VOL_IN"   volumetric="true" inner="true"  point="true" linear="true"      />
      <DoDeferredLightLoop context="POINT_R_VOL_IN"   volumetric="true" inner="true"  point="true" linear_sqrt="true" />
      <DoDeferredLightLoop context="POINT_Q_VOL_IN"   volumetric="true" inner="true"  point="true" quadratic="true"   />
      <DoDeferredLightLoop context="POINT_C_VOL_IN"   volumetric="true" inner="true"  point="true" cubic="true"       />
      <DoDeferredLightLoop context="POINT_E_VOL_IN"   volumetric="true" inner="true"  point="true" custom="true"      />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="NewBloomPre" enabled="true">
      <BeginTarget target="BLOOM_BLURBUF_2B" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_2A" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="5.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_HALF" compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_2A" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_2B" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="5.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_HALF" compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_4B" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="BLOOM_BLURBUF_2A" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="5.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9" compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="MotionblurNormal" enabled="false">
      <BeginTarget target="VOLUME" />
      <DiscardTargetContents colBuf0="true"  />
      <ColourMask channels="RGBA" colBuf1="false" />

      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_1"         bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_ASYNC"      bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_LOW" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="BLUR1" />
      <DiscardTargetContents colBuf0="true"  />
      <ColourMask channels="RGBA"/>
      
      <BindBuffer sampler="gBufferMap"  sourceRT="VOLUME"           bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_ASYNC"      bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_LOW_PASS2" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="HDRBUF_1" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap" sourceRT="BLUR1" bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="invSourceAlpha" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
    </Stage> 

    <Stage id="Motionblur" enabled="false">
      <BeginTarget target="HDRBUF_3" depthTarget="DEPTH" onlyStencil="true" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_1"          bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_ASYNC"      bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskWrite" stencilRef="16" stencilMask="16"/>
      <If conditionType="platform" id="XB1S" />                
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_HIGH"  compute="sync" />
      <Else />         
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_HIGH"  compute="async_next" />
      <EndIf />          
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH" onlyStencil="true" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_3"         bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_ASYNC"      bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskRead" stencilRef="16" stencilMask="16"/>
      <If conditionType="platform" id="XB1S" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_HIGH_PASS2" compute="sync"  />
      <Else />                 
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_HIGH_PASS2" compute="async_next"  />
      <EndIf />                    
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage> 

    <Stage id="MotionblurUltra" enabled="false">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" onlyStencil="true" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_1"         bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_ASYNC"      bufIndex="0" />
      
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskWrite" stencilRef="16" stencilMask="16"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_ULT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH" onlyStencil="true" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_0"         bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_ASYNC"      bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskRead" stencilRef="16" stencilMask="16"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_ULT_PASS2" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />   
    </Stage>
    
    <Stage id="ApplyPostTaa" enabled="true" >

      <!-- async is done with MOTIONRESOLVE / MOTION_MAXBUF_0 -->
      <SyncGraphicsToCompute compute="async_next" markerIndex="1" />

    </Stage>

    <Stage id="DepthOfFieldBokeh">
    </Stage>

    <Stage id="DepthOfFieldBokehNew">
      <BeginTarget target="DOF_COC" />
      <ColourMask channels="R"/>
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_ASYNC" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="COC" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <!--
      Re-enable this (and a corresponding shader section) for nicer bokeh
      <BeginTarget target="BLOOM_BLURBUF_4A" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DOF_DOWNSAMPLE" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_ASYNC" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>     
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />       
      -->          
      <BeginTarget target="DOF_MAXBUF_H" />
      <ColourMask channels="RG"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DOF_COC" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="DILATE_HOR"  compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DOF_MAXBUF" />
      <ColourMask channels="RG"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DOF_MAXBUF_H" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="DILATE_VER" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />      
                
      <BeginTarget target="DOF_BUFF_0" />
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gBufferMap"    sourceRT="HDRBUF_1"       bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <!--Despite the name, we're using the bspline resampler to downsample here-->
      <DrawQuad material="materials/PostProcess.material.mbin" context="UPS_4TAP_BIC_DJ" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />        
        
      <BeginTarget target="DOF_BUFF_1" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="DOF_BUFF_0"      bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="DOF_TEMP"        bufIndex="0" frameIdx="prev" />
      <BindBuffer sampler="gBuffer2Map"  sourceRT="MOTIONRESOLVE"   bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="DOF_TEMPORAL" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />        

      <BeginTarget target="DOF_BLURBUF1" />
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_BUFF_1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DOF_COC" bufIndex="0" />    
      <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_ASYNC" bufIndex="0" />    
      <BindBuffer sampler="gBuffer3Map" sourceRT="DOF_MAXBUF" bufIndex="0" />    
      <BindBuffer sampler="gBuffer4Map" sourceRT="BLOOM_BLURBUF_4A" bufIndex="0" />   
      <SetUniform material="materials/DepthOfField.material.mbin" uniform="gBlurParamsVec4" a="8.0" b="8.0" c="8.0" />
      <DrawQuad material="materials/DepthOfField.material.mbin" context="POISSON_NEW" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
     
      <BeginTarget target="HDRBUF_1" />
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_BLURBUF1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DOF_BLURBUF1" bufIndex="1" />        
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="invSourceAlpha" depthTest="always" alphaToCoverage="false"/>         
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="BLEND_INVSRCA" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
        
      <BeginTarget target="DOF_TEMP" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DOF_BUFF_1"   bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" compute="async_next"  />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />        
     
    </Stage>

    <Stage id="DepthOfFieldBlur_ToneMap">
      <ColourMask channels="RGBA"/>
      <BeginTarget target="DOF_TONEMAP" />
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_1" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="TONEMAP_DEPTH" compute="async_next" wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
   </Stage>
   
   <Stage id="DepthOfFieldBlur">
      <BeginTarget target="DOF_DOWNSAMPLE" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DOF_TONEMAP"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_ASYNC"  bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>     
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE"  compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />             
     
      <BeginTarget target="DOF_BLURBUF1" />
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_DOWNSAMPLE" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DOF_DOWNSAMPLE" bufIndex="1" />
      <SetUniform material="materials/DepthOfField.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="8.0" />
      <DrawQuad material="materials/DepthOfField.material.mbin" context="GUASS_DEPTH_9"  compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="DOF_DOWNSAMPLE" />
      <ColourMask channels="RGBA"  colBuf1="false"/>
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_BLURBUF1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DOF_DOWNSAMPLE" bufIndex="1" />    
      <SetUniform material="materials/DepthOfField.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="8.0" />
      <DrawQuad material="materials/DepthOfField.material.mbin" context="GUASS_DEPTH_9_DISCARD"  compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
      
      <BeginTarget target="DOF_BLURBUF1" />
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_DOWNSAMPLE" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DOF_DOWNSAMPLE" bufIndex="1" />        
      <SetUniform material="materials/DepthOfField.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="8.0" />
      <DrawQuad material="materials/DepthOfField.material.mbin" context="GUASS_DEPTH_9_DISCARD"  compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="DOF_DOWNSAMPLE" />
      <ColourMask channels="RGBA"  colBuf1="false"/>
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_BLURBUF1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DOF_DOWNSAMPLE" bufIndex="1" />        
      <SetUniform material="materials/DepthOfField.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.5" c="8.0" />
      <DrawQuad material="materials/DepthOfField.material.mbin" context="GUASS_DEPTH_9_DISCARD"  compute="async_next" />
      <UnbindBuffers />    
      <EndTarget flushCB="true" flushDB="false" />       
     
      <BeginTarget target="DOF_TONEMAP" />
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_DOWNSAMPLE" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DOF_DOWNSAMPLE" bufIndex="1" />        
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="always" alphaToCoverage="false"/>         
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="BLEND"  compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
     
    </Stage>
        
    <Stage id="NewBloomPost" enabled="true">            
      <BeginTarget target="BLOOM_BLURBUF_4A" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_4B" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="5.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_HALF"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="BLOOM_BLURBUF_8B" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="BLOOM_BLURBUF_4A" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="5.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_8A" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_8B" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="5.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_HALF"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />      

      <BeginTarget target="BLOOM_BLURBUF_16" />
      <BindBuffer sampler="gBufferMap"  sourceRT="BLOOM_BLURBUF_8A" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="3.0" d="1.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_7_SQR"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />      

      <BeginTarget target="BLOOM_BLURBUF_32" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_16" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="2.0" d="1.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_SQR"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />           

      <BeginTarget target="BLOOM_BLURBUF_64" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_32" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="2.0" d="1.0"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_SQR"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_32" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_64" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="1.0" c="1.5" d="4.0"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_SQR_ADD"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_16" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_32" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="1.0" c="1.5" d="2.0"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_SQR_ADD"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="NewBloomResolve" enabled="true">
      <BeginTarget target="BLOOM_FINALBUF" />
      <BindBuffer sampler="gBufferMap"  sourceRT="BLOOM_BLURBUF_4A" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="BLOOM_BLURBUF_8A" bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="BLOOM_BLURBUF_16" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="11.0" b="9.0" c="7.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="BLOOM_RESOLVE"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    
      <BeginTarget target="BLOOM_BLURBUF_4B" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_FINALBUF" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="1.0" c="2.5" d="1.0"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_FINALBUF" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_4B" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="1.0" c="2.5" d="1.0"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="NewBloomExposure" enabled="true">
      <BeginTarget target="BLOOM_EXPBUF_B" />
      <BindBuffer sampler="gBufferMap"   sourceRT="BLOOM_BLURBUF_64"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="BLOOM_EXPBUF_A"    bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="BLOOM_EXPOSURE"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <SwapTargets targetA="BLOOM_EXPBUF_A" targetB="BLOOM_EXPBUF_B" />
    </Stage>

    <!-- Enable this stage when you disable bloom stages, to clear the bloom buffers -->
    <Stage id="NoBloom" enabled="false">
      <BeginTarget target="BLOOM_BLURBUF_2B" />
      <ClearTarget colBuf0="true"/>
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="BLOOM_BLURBUF_4A" />
      <ClearTarget colBuf0="true"/>
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_8A" />
      <ClearTarget colBuf0="true"/>
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="BLOOM_BLURBUF_8B" />
      <ClearTarget colBuf0="true"/>
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_16" />
      <ClearTarget colBuf0="true"/>
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_32" />
      <ClearTarget colBuf0="true"/>
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_64" />
      <ClearTarget colBuf0="true"/>
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_FINALBUF" />
      <ClearTarget colBuf0="true"/>
      <EndTarget flushCB="true" flushDB="false" />      
    
      <BeginTarget target="BLOOM_EXPBUF_A" />
      <ClearTarget colBuf0="true"/>
      <EndTarget flushCB="true" flushDB="false" /> 
    </Stage>

    
    <Stage id="LensFlare">
      <BeginTarget target="LENS_BLURBUF" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="LENS_BRIGHTBUF" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="LENS_SUNBUF_A"  bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/LensFlare.material.mbin" context="BRIGHT" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_BLURBUF" />
      <ColourMask channels="RGB" colBuf1="false" />
      <BindBuffer sampler="gBufferMap"  sourceRT="LENS_EFFECTS" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY_ADD" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_ANASRCBUF" />
      <ColourMask channels="RGB" />
      <BindBuffer sampler="gBufferMap"  sourceRT="LENS_EFFECTS" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="1.0" c="1.0" d="1.0"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_SQR_ADD"  compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
     
      <BeginTarget target="LENS_FLAREBUF" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap" sourceRT="LENS_BLURBUF" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/LensFlare.material.mbin" context="FEATURE" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />      
    </Stage>


    <Stage id="LensFlareAnamorphic">
      <BeginTarget target="LENS_ANABUF_A"/>
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" />
      <BindBuffer sampler="gBufferMap"   sourceRT="LENS_ANASRCBUF"  bufIndex="0" />
      <DrawQuadMT material="materials/LensFlare.material.mbin" context="ANAMORPH" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="LENS_ANABUF_B"/>
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" />
      <BindBuffer sampler="gBufferMap"   sourceRT="LENS_ANABUF_A"        bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="5.0" d="1.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_HALF" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_ANABUF_A"/>
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" />
      <BindBuffer sampler="gBufferMap"   sourceRT="LENS_ANABUF_B"        bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="5.0" d="1.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_HALF" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_ANABUF_B"/>
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" />
      <BindBuffer sampler="gBufferMap"   sourceRT="LENS_ANABUF_A"        bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="1.0" d="1.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_ANARESBUF"/>
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" />
      <BindBuffer sampler="gBufferMap"    sourceRT="LENS_ANABUF_B"         bufIndex="0" />
      <DrawQuadMT material="materials/LensFlare.material.mbin" context="ANAMORPH_RESOLVE" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_FLAREBUF"/>
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="add" depthTest="always" />
      <BindBuffer sampler="gBufferMap"   sourceRT="LENS_ANARESBUF"        bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="5.0" d="0.0"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_ADD" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="PostProcessResolve">
      <BeginTarget target="HDRBUF_3"/>
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DOF_TONEMAP"          bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="BLOOM_FINALBUF"       bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="LENS_FLAREBUF"        bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_ASYNC"          bufIndex="0" />
      <BindBuffer sampler="gBuffer4Map" sourceRT="LUT_MASK"             bufIndex="0" />
      <BindBuffer sampler="gBuffer5Map" sourceRT="BLOOM_EXPBUF_A"       bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="FX_COMBINE" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
	  
    <Stage id="DLSS_APPLY" enabled="false">
      <FlushBuffer flushFor="readWrite" sourceRT="UPS_OUT_0" bufIndex="0" />
      <ApplyDLSS inputRT="HDRBUF_3" outputRT="UPS_OUT_0" depthRT="DEPTH" motionRT="MOTIONSCREEN" hudlessRT="UPS_OUT_0" />
      <If conditionType="platform" id="OUNCE" />
      <SwapTargets targetA="MOTIONRESOLVE"          targetB="MOTIONRESOLVE_BACK" />	
      <SwapTargets targetA="MOTIONSCREEN"           targetB="MOTIONSCREEN_BACK" />
      <SwapTargets targetA="MOTION_BUFFS"           targetB="MOTION_BUFFS_BACK" />	 
      <EndIf />     				
    </Stage>
      
    <Stage id="PSSR_QUEUE" enabled="false">
      <BeginTarget target="RED8_BUF_0" />
      <ColourMask channels="R" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <BindBuffer sampler="gBufferMap"   sourceRT="PARTICLES"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="LUM_BUF_OP" bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map"  sourceRT="LUM_BUF_TR" bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map"  sourceRT="GBUFFER"    bufIndex="2" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="PSSR_GENREACT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
      <!-- <SwapTargets targetA="MOTIONRESOLVE" targetB="MOTIONRESOLVE_PSSR" />
           <SwapTargets targetA="DEPTH"         targetB="DEPTH_PSSR" />
      -->

      <BeginTarget target="DEPTH_PSSR" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH" bufIndex="32" shadowCompare="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY_DEPTH" />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="true" />        

      <BeginTarget target="MOTIONRESOLVE_PSSR" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="MOTIONRESOLVE" bufIndex="0" shadowCompare="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />        
              
      <QueuePSSR inputRT="HDRBUF_3" outputRT="UPS_OUT_0" depthRT="DEPTH_PSSR" depthPrevRT="DEPTH_BACK" motionRT="MOTIONRESOLVE_PSSR" motionPrevRT="MOTIONRESOLVE_BACK" reactivityRT="RED8_BUF_0" />
      <SwapTargets targetA="MOTIONRESOLVE"          targetB="MOTIONRESOLVE_BACK" />
    </Stage>                
      
    <Stage id="XESS_APPLY" enabled="false">
      <ApplyXESS inputRT="HDRBUF_3" outputRT="UPS_OUT_1" depthRT="DEPTH"  motionRT="MOTIONSCREEN" reactivityRT="RED8_BUF_0" />
      <BeginTarget target="UPS_OUT_0" />
      <DiscardTargetContents colBuf0="true" />
      <BindBuffer sampler="gBufferMap"  sourceRT="UPS_OUT_1" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="FFX_RCASHARPEN" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
	</Stage>           

    <Stage id="FFXSR2_APPLY" enabled="false">
      <BeginTarget target="RED8_BUF_0" />
      <ColourMask channels="R" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <BindBuffer sampler="gBufferMap"   sourceRT="PARTICLES"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="LUM_BUF_OP" bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map"  sourceRT="LUM_BUF_TR" bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map"  sourceRT="GBUFFER"    bufIndex="2" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="FSR2_GENREACT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <ApplyFFXSR2 inputRT="HDRBUF_3" outputRT="UPS_OUT_1" depthRT="DEPTH" motionRT="MOTIONSCREEN" reactivityRT="RED8_BUF_0" />

      <BeginTarget target="UPS_OUT_0" />
      <DiscardTargetContents colBuf0="true" />
      <BindBuffer sampler="gBufferMap"  sourceRT="UPS_OUT_1" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="FFX_RCASHARPEN" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
	</Stage>

    <Stage id="FFXSR2CUSTOM_APPLY" enabled="false">
      <!--Bind and flush depth to make sure it's ready for binding in subsequent passes, even if this pass doesn't actually use it-->
      <BeginTarget target="RED8_BUF_REACT" depthTarget="DEPTH" />
      <ColourMask channels="R" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <BindBuffer sampler="gBufferMap"   sourceRT="PARTICLES"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="LUM_BUF_OP" bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map"  sourceRT="LUM_BUF_TR" bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map"  sourceRT="GBUFFER"    bufIndex="2" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="FSR2_GENREACT" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />

      <FfxFsr2UpdateShaderConsts/>

      <FlushBuffer  flushFor="readWrite"                              sourceRT="FSR2_ExposureMips"                  bufIndex="0" />
      <BindBuffer   sampler="r_input_color_jittered"                  sourceRT="HDRBUF_3"                           bufIndex="0" />
      <BindBuffer   sampler="rw_img_mip_shading_change"               sourceRT="FSR2_ExposureMips"                  bufIndex="0" bindAsRwImage="true"  mipLevel="4" />

      <FfxFsr2Pass material="materials/FSR212.material.mbin" context="FSR2_ComputeLuminancePyramid"   fullRes="false" groupAdd="1" groupPad="0" groupDiv="64" compute="async_next" />
      <UnbindBuffers />

      <FlushBuffer  flushFor="read"                                   sourceRT="FSR2_ExposureMips"                  bufIndex="0" />
      <FlushBuffer  flushFor="readWrite"                              sourceRT="FSR2_ReconstructedPrevNearestDepth" bufIndex="0" />
      <FlushBuffer  flushFor="readWrite"                              sourceRT="FSR2_PreparedInputColor"            bufIndex="0" />
      <BindBuffer   sampler="r_input_color_jittered"                  sourceRT="HDRBUF_3"                           bufIndex="0" />
      <BindBuffer   sampler="rw_reconstructed_previous_nearest_depth" sourceRT="FSR2_ReconstructedPrevNearestDepth" bufIndex="0" bindAsRwImage="true" />
      <BindBuffer   sampler="rw_prepared_input_color"                 sourceRT="FSR2_PreparedInputColor"            bufIndex="0" bindAsRwImage="true" />

      <FfxFsr2Pass material="materials/FSR212.material.mbin" context="FSR2_PrepareInputColor"         fullRes="false" groupAdd="0" groupPad="8" groupDiv="8"  compute="async_next" />
      <UnbindBuffers />

      <FlushBuffer  flushFor="read"                                   sourceRT="FSR2_PreparedInputColor"            bufIndex="0" />
      <FlushBuffer  flushFor="readWrite"                              sourceRT="FSR2_DilatedVelocity"               bufIndex="0" />
      <FlushBuffer  flushFor="readWrite"                              sourceRT="FSR2_DilatedDepth"                  bufIndex="0" />
      <FlushBuffer  flushFor="readWrite"                              sourceRT="FSR2_ReactiveMaskMax"               bufIndex="0" />
      <BindBuffer   sampler="r_motion_vectors"                        sourceRT="MOTIONRESOLVE"                      bufIndex="0"  />
      <BindBuffer   sampler="r_depth"                                 sourceRT="DEPTH"                              bufIndex="32" />
      <BindBuffer   sampler="r_reactive_mask"                         sourceRT="RED8_BUF_REACT"                     bufIndex="0" />
      <BindBuffer   sampler="r_transparency_and_composition_mask"     sourceRT="FSR2_DefaultTrasparencyMask"        bufIndex="0" />
      <BindBuffer   sampler="r_prepared_input_color"                  sourceRT="FSR2_PreparedInputColor"            bufIndex="0" />
      <BindBuffer   sampler="rw_reconstructed_previous_nearest_depth" sourceRT="FSR2_ReconstructedPrevNearestDepth" bufIndex="0" bindAsRwImage="true" />
      <BindBuffer   sampler="rw_dilated_motion_vectors"               sourceRT="FSR2_DilatedVelocity"               bufIndex="0" bindAsRwImage="true" />
      <BindBuffer   sampler="rw_dilatedDepth"                         sourceRT="FSR2_DilatedDepth"                  bufIndex="0" bindAsRwImage="true" />
      <BindBuffer   sampler="rw_dilated_reactive_masks"               sourceRT="FSR2_ReactiveMaskMax"               bufIndex="0" bindAsRwImage="true" />

      <FfxFsr2Pass material="materials/FSR212.material.mbin" context="FSR2_ReconstructPreviousDepth"  fullRes="false" groupAdd="0" groupPad="8" groupDiv="8"  compute="async_next" />
      <UnbindBuffers />

      <FlushBuffer  flushFor="read"                                   sourceRT="FSR2_ReconstructedPrevNearestDepth" bufIndex="0" />
      <FlushBuffer  flushFor="read"                                   sourceRT="FSR2_DilatedVelocity"               bufIndex="0" />
      <FlushBuffer  flushFor="read"                                   sourceRT="FSR2_DilatedDepth"                  bufIndex="0" />
      <FlushBuffer  flushFor="read"                                   sourceRT="FSR2_ReactiveMaskMax"               bufIndex="0" />
      <FlushBuffer  flushFor="readWrite"                              sourceRT="FSR2_DepthClip"                     bufIndex="0" />
      <BindBuffer   sampler="r_reconstructed_previous_nearest_depth"  sourceRT="FSR2_ReconstructedPrevNearestDepth" bufIndex="0" />
      <BindBuffer   sampler="r_dilated_motion_vectors"                sourceRT="FSR2_DilatedVelocity"               bufIndex="0" />
      <BindBuffer   sampler="r_dilatedDepth"                          sourceRT="FSR2_DilatedDepth"                  bufIndex="0" />
      <BindBuffer   sampler="rw_depth_clip"                           sourceRT="FSR2_DepthClip"                     bufIndex="0" bindAsRwImage="true" />

      <FfxFsr2Pass material="materials/FSR212.material.mbin" context="FSR2_DepthClip"                 fullRes="false" groupAdd="0" groupPad="8" groupDiv="8"  compute="async_next" />
      <UnbindBuffers />

      <FlushBuffer  flushFor="read"                                   sourceRT="FSR2_DepthClip"                     bufIndex="0" />
      <FlushBuffer  flushFor="readWrite"                              sourceRT="FSR2_LockStatus1"                   bufIndex="0" />
      <BindBuffer   sampler="r_lock_status"                           sourceRT="FSR2_LockStatus2"                   bufIndex="0" frameIdx="prev" />
      <BindBuffer   sampler="r_prepared_input_color"                  sourceRT="FSR2_PreparedInputColor"            bufIndex="0" />
      <BindBuffer   sampler="rw_lock_status"                          sourceRT="FSR2_LockStatus1"                   bufIndex="0" bindAsRwImage="true" />

      <FfxFsr2Pass material="materials/FSR212.material.mbin" context="FSR2_Lock"                      fullRes="false" groupAdd="0" groupPad="8" groupDiv="8"  compute="async_next" />
      <UnbindBuffers />

      <FlushBuffer  flushFor="readWrite"                              sourceRT="FSR2_LumaHistory1"                  bufIndex="0" />
      <BindBuffer   sampler="r_prepared_input_color"                  sourceRT="HDRBUF_3"                           bufIndex="0" />
      <BindBuffer   sampler="r_dilated_motion_vectors"                sourceRT="FSR2_DilatedVelocity"               bufIndex="0" />
      <BindBuffer   sampler="r_depth_clip"                            sourceRT="FSR2_DepthClip"                     bufIndex="0" />
      <BindBuffer   sampler="r_luma_history"                          sourceRT="FSR2_LumaHistory2"                  bufIndex="0" frameIdx="prev"  />
      <BindBuffer   sampler="rw_luma_history"                         sourceRT="FSR2_LumaHistory1"                  bufIndex="0" bindAsRwImage="true" />

      <FfxFsr2Pass material="materials/FSR212.material.mbin" context="FSR2_Stability"                 fullRes="false" groupAdd="0" groupPad="8" groupDiv="8"  compute="async_next" />
      <UnbindBuffers />

      <FlushBuffer  flushFor="read"                                   sourceRT="FSR2_LumaHistory1"                  bufIndex="0" />
      <FlushBuffer  flushFor="readWrite"                              sourceRT="FSR2_InternalUpscaled1"             bufIndex="0" />
      <BindBuffer   sampler="r_dilated_motion_vectors"                sourceRT="FSR2_DilatedVelocity"               bufIndex="0" />
      <BindBuffer   sampler="r_internal_upscaled_color"               sourceRT="FSR2_InternalUpscaled2"             bufIndex="0" frameIdx="prev" />
      <BindBuffer   sampler="r_lock_status"                           sourceRT="FSR2_LockStatus2"                   bufIndex="0" frameIdx="prev" />
      <BindBuffer   sampler="r_depth_clip"                            sourceRT="FSR2_DepthClip"                     bufIndex="0" />
      <BindBuffer   sampler="r_prepared_input_color"                  sourceRT="FSR2_PreparedInputColor"            bufIndex="0" />
      <BindBuffer   sampler="r_luma_history"                          sourceRT="FSR2_LumaHistory1"                  bufIndex="0" />
      <BindBuffer   sampler="r_dilated_reactive_masks"                sourceRT="FSR2_ReactiveMaskMax"               bufIndex="0" />
      <BindBuffer   sampler="r_imgMips"                               sourceRT="FSR2_ExposureMips"                  bufIndex="0" />
      <BindBuffer   sampler="rw_internal_upscaled_color"              sourceRT="FSR2_InternalUpscaled1"             bufIndex="0" bindAsRwImage="true" />
      <BindBuffer   sampler="rw_lock_status"                          sourceRT="FSR2_LockStatus1"                   bufIndex="0" bindAsRwImage="true" />

      <If conditionType="platform" id="XB1S,XB1X,ORBIS" />        
 
      <FlushBuffer  flushFor="readWrite"                              sourceRT="UPS_OUT_1"                          bufIndex="0" />                        
      <BindBuffer   sampler="rw_upscaled_output"                      sourceRT="UPS_OUT_1"                          bufIndex="0" bindAsRwImage="true" />
      <FfxFsr2Pass material="materials/FSR212.material.mbin" context="FSR2_Accumulate"                fullRes="true"  groupAdd="0" groupPad="8" groupDiv="8"  compute="async_next" />        
      <UnbindBuffers />        
      <FlushBuffer  flushFor="read"                                   sourceRT="UPS_OUT_1"                          bufIndex="0" />
        
      <BeginTarget target="UPS_OUT_0" />
      <ColourMask channels="RGBA" />        
      <DiscardTargetContents colBuf0="true" />
      <BindBuffer sampler="gBufferMap"  sourceRT="UPS_OUT_1"     bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <If conditionType="platform" id="XB1S,XB1X" />
       <DrawQuadMT material="materials/PostProcess.material.mbin" context="FFX_RCASHARPEN" compute="async_next" />
      <Else /> 
       <DrawQuadMT material="materials/PostProcess.material.mbin" context="CAS32" compute="async_next" />
      <EndIf />        
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
      <Else />
        
      <FfxFsr2Pass material="materials/FSR212.material.mbin" context="FSR2_AccumulSharp"              fullRes="true"  groupAdd="0" groupPad="8" groupDiv="8"  compute="async_next" />
      <UnbindBuffers />

      <FlushBuffer  flushFor="read"                                   sourceRT="FSR2_InternalUpscaled1"             bufIndex="0" />
      <FlushBuffer  flushFor="read"                                   sourceRT="FSR2_LockStatus1"                   bufIndex="0" />
      <FlushBuffer  flushFor="readWrite"                              sourceRT="UPS_OUT_0"                          bufIndex="0" />
      <BindBuffer   sampler="r_rcas_input"                            sourceRT="FSR2_InternalUpscaled1"             bufIndex="0" />
      <BindBuffer   sampler="rw_upscaled_output"                      sourceRT="UPS_OUT_0"                          bufIndex="0" bindAsRwImage="true" />

      <FfxFsr2Pass material="materials/FSR212.material.mbin" context="FSR2_Rcas"                      fullRes="true"  groupAdd="0" groupPad="8" groupDiv="8"  compute="async_next" />
      <UnbindBuffers />
        
      <EndIf />
      <FlushBuffer  flushFor="read"                                   sourceRT="UPS_OUT_0"                          bufIndex="0" />

      <SwapTargets targetA="FSR2_InternalUpscaled1" targetB="FSR2_InternalUpscaled2" />
      <SwapTargets targetA="FSR2_LockStatus1"       targetB="FSR2_LockStatus2" />
      <SwapTargets targetA="FSR2_LumaHistory1"      targetB="FSR2_LumaHistory2" />
      <SwapTargets targetA="MOTIONRESOLVE"          targetB="MOTIONRESOLVE_BACK" />

    </Stage>

    <Stage id="FFX_SUPER_RES" enabled="false" >
      <BeginTarget target="UPS_OUT_1" />
      <DiscardTargetContents colBuf0="true" />
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_3" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="FFX_SUPER_RES" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="UPS_OUT_0" />
      <DiscardTargetContents colBuf0="true" />
      <BindBuffer sampler="gBufferMap"  sourceRT="UPS_OUT_1" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="FFX_RCASHARPEN" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
	</Stage>

    <Stage id="ScreenEffect">
      <ColourMask channels="RGBA"/>
      <BeginTarget target="SCREEN"/>
      <DiscardTargetContents colBuf0="true" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_3" bufIndex="0" />
      <DrawQuadMT material="Materials/UI.material.mbin" context="SCREENEFFECT" width="1.0" height="1.0" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="ScreenEffect_Upscaled" enabled="false">
      <ColourMask channels="RGBA"/>
      <BeginTarget target="UPS_OUT_1"/>
      <DiscardTargetContents colBuf0="true" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap" sourceRT="UPS_OUT_0" bufIndex="0" />
      <DrawQuadMT material="Materials/UI.material.mbin" context="SCREENEFFECT" width="1.0" height="1.0" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Combine">
      <BeginTarget target="FINAL" readOnlyDepth="true" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SCREEN"       bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Combine_Upscaled"  enabled="false">

      <If conditionType="platform" id="OUNCE" negate="true" />		
		
      <If conditionType="stage" id="DLSS_APPLY" enabled="true" />

      <BeginTarget target="UPS_OUT_0" readOnlyDepth="true" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="UPS_OUT_1"    bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINE_NO_LUM" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />        
        
      <BeginTarget target="" readOnlyDepth="true" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="UPS_OUT_0"    bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />               
                
      <Else />

      <BeginTarget target="" readOnlyDepth="true" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="UPS_OUT_1"    bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINE_NO_LUM" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <EndIf />

      <Else />

      <BeginTarget target="" readOnlyDepth="true" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="UPS_OUT_1"    bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINE_NO_LUM" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <EndIf />	

    </Stage>

    <Stage id="Combine_NoFXAA"  enabled="false">
      <BeginTarget target="" readOnlyDepth="true" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SCREEN"       bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINE_NO_LUM" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Combine_NoFXAA_HDR"  enabled="false">
      <BeginTarget target="" readOnlyDepth="true" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SCREEN"       bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINEHDR" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="FXAA" enabled="false">
      <ColourMask channels="RGBA"/>
      <BeginTarget target="" readOnlyDepth="true" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" />

      <BindBuffer sampler="gBufferMap"  sourceRT="FINAL"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="FINAL"  bufIndex="1" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH"  bufIndex="32" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="FXAA" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="CopyDepthToBB"  enabled="false">
      <If conditionType="platform" id="XB1S,OUNCE" negate="true" />
        <BeginTarget target="" />
        <ColourMask channels="RGBA"/>
        <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
        <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH" bufIndex="32" shadowCompare="false" />
        <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY_DEPTH" />
        <UnbindBuffers />
        <EndTarget flushCB="false" flushDB="true" />
      <EndIf />
    </Stage>

    <Stage id="InWorldUI"  enabled="true">
      <If conditionType="legacy" enabled="false" />
        <BeginTarget target="" readOnlyDepth="true" />
        <ColourMask channels="RGBA"/>
        <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_LINEAR" bufIndex="0" />
        <SetContext zwrite="false" colourWrite="true" cullMode="none"   blendMode="blend"   depthTest="always" alphaToCoverage="false" stencilMode="maskRead"      stencilRef="0"  stencilMask="128" />
        <DrawGeometry type="Mesh"         class="UISurface"         context="UI_FORWARD"             order="BACK_TO_FRONT" />
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="UI">
      <ColourMask channels="RGBA"/>
      <BeginTarget target=""/>

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="Materials/UI.material.mbin" context="BINOCS" />
      
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="sourceAlpha" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="Materials/UI.material.mbin" context="UI" width="1.0" height="1.0" />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="DepthSwap">
      <If conditionType="platform" id="XB1S" negate="true" />
        <SwapTargets targetA="DEPTH" targetB="DEPTH_BACK" />
      <Else/>
        <BeginTarget target="DEPTH_BACK" />
        <ColourMask channels="RGBA"/>
        <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
        <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH" bufIndex="32" />
        <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY_DEPTH" />
        <UnbindBuffers />
        <EndTarget flushCB="false" flushDB="true" />
      <EndIf/>
    </Stage>
      
    <Stage id="DebugCombine" enabled="false">
      <BeginTarget target="FINAL" readOnlyDepth="true" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SCREEN"       bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="DebugEncode" enabled="false">
      <BeginTarget target="ENCODE_TEST" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="GBUFFER"  bufIndex="2" />
      <DrawQuadMT material="materials/Debug.material.mbin" context="N_ENCODE_TEST" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DECODE_TEST" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="ENCODE_TEST"  bufIndex="0" />
      <DrawQuadMT material="materials/Debug.material.mbin" context="N_DECODE_TEST" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="NORM_TEST" />
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="GBUFFER"  bufIndex="2" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

    </Stage>
    
    <Stage id="DebugHex" enabled="false">
      <ColourMask channels="RGBA"/>
      <BeginTarget target=""/>

      <ClearTarget depthBuf="false" colBuf0="false" col_R="0.0" col_G="0.0" col_B="0.0" col_A="1.0" />      
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" />
      <BindBuffer sampler="gBufferMap"   sourceRT="CLOUDSHADOWS"        bufIndex="0" sRGBRead="0" />

      <BindBuffer sampler="gBuffer1Map"  sourceRT="MATERIAL"            bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer2Map"  sourceRT="MATERIAL"            bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer3Map"  sourceRT="MATERIAL"            bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer4Map"  sourceRT="MATERIAL"            bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer5Map"  sourceRT="MATERIAL"            bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer6Map"  sourceRT="MATERIAL"            bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer7Map"  sourceRT="MATERIAL"            bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer8Map"  sourceRT="MATERIAL"            bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer9Map"  sourceRT="CLOUDS_HIGH"         bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer10Map" sourceRT="CLOUDSHADOWS"        bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer11Map" sourceRT="LIGHTSHAFT"          bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer12Map" sourceRT="LIGHTSHAFT"          bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer13Map" sourceRT="MATERIAL"            bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer14Map" sourceRT="MATERIAL"            bufIndex="0" sRGBRead="0" />

      <DrawQuadMT material="materials/Debug.material.mbin" context="HEX_SPLIT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="DebugQuad" enabled="false">
      <ColourMask channels="RGBA"/>
      <BeginTarget target=""/>
      <ClearTarget depthBuf="false" colBuf0="false" col_R="0.0" col_G="0.0" col_B="0.0" col_A="1.0" />
      
      <!--a, b, c, d == 0.0             -> full    screen buffer       -->
      <!--a, b, c, d == 1.0             -> default main   quad   split -->
      <!--a          == 2.0             -> top     left   inner  split -->
      <!--b          == 2.0             -> top     right  inner  split -->
      <!--c          == 2.0             -> bottom  left   inner  split -->
      <!--d          == 2.0             -> bottom  right  inner  split -->
      <SetUniform material="materials/DebugQuadSplit.material.mbin" uniform="gDebugSplitVec4" a="0.0" b="1.0" c="1.0" d="1.0"/>
      
      <!--a                             -> zoom index                                   -->
      <!--a          == [0.0,   3.0]    -> zoom respective main buffer                  -->
      <!--a          == [0.000, 0.303]  -> zoom respective inner split buffer           -->
      <!--a          == 42.0            -> zoom all buffers                             -->
      <!--b                             -> zoom scale                                   -->
      <!--b          == [0.0, n)        -> zoom buffer with index 'a' by a factor of 'b'-->
      <!--c, d                          -> zoom offset                                  -->
      <!--c, d       == [0.0, 1.0]      -> offset uvs of buffer 'a' by vec2(c,d)        -->
      <SetUniform material="materials/DebugQuadSplit.material.mbin" uniform="gDebugZoomVec4"  a="0.0" b="1.0" c="0.0" d="0.0"/>

      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" />

      <!--MAIN SPLIT -->
      <BindBuffer sampler="gBuffer0Map"   sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer3Map"   sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />

      <!--A SPLIT - TOP LEFT -->
      <BindBuffer sampler="gBuffer000Map" sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer001Map" sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer002Map" sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer003Map" sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />
      <!--B SPLIT - TOP RIGHT -->
      <BindBuffer sampler="gBuffer100Map" sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer101Map" sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer102Map" sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer103Map" sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />
      <!--C SPLIT - BOTTOM LEFT -->
      <BindBuffer sampler="gBuffer200Map" sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer201Map" sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer202Map" sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer203Map" sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />
      <!--D SPLIT - BOTTOM RIGHT -->
      <BindBuffer sampler="gBuffer300Map" sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer301Map" sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer302Map" sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer303Map" sourceRT="MATERIAL"               bufIndex="0" sRGBRead="0" />

      <DrawQuadMT material="materials/DebugQuadSplit.material.mbin" context="QUAD_SPLIT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="DebugGbuffer" enabled="false">
      <ColourMask channels="RGBA"/>
      <BeginTarget target=""/>

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" />
      <BindBuffer sampler="gBufferMap" sourceRT="GBUFFER" bufIndex="0" />

      <DrawQuadMT material="materials/Debug.material.mbin" context="TEXTURED" width="1.0" height="1.0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="MeshWaterDebugOverlay">
      <If conditionType="variable" id="WaterDebugOverlayEnabled" />
      <ColourMask channels="RGBA"/>
      <BeginTarget target=""/>

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="Blend_OutputAlpha" depthTest="always" />
      <BindBuffer sampler="gBufferMap" sourceRT="GBUFFER" bufIndex="0" />

      <DrawQuadMT material="materials/DebugWater.material.mbin" context="MESH_WATER" width="1.0" height="1.0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

   <Stage id="TAA_NONE_RESET" enabled="false">
      <SwapTargets targetA="HDRBUF_0" targetB="HDRBUF_1" />
   </Stage> 

    <Stage id="Reset States">
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" />
      <ColourMask channels="RGBA"/>
    </Stage>

  </CommandQueue>



</Pipeline>
