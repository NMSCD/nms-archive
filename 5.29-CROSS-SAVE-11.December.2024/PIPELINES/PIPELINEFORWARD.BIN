<!-- High Dynamic Range (HDR) utf-8Shading Pipeline -->
<Pipeline>
  <Setup>
    <ScaleInfo resScalingDefault="true" />
    <PipelineInfo isForwardPipeline="true" />

    <!-- Pipeline Variables -->
    <!-- enum:eWaterState - in code! -->
    <PipelineVariable id="WaterState" defaultValue="0" />
    <PipelineVariable id="WaterState_NoWater"       defaultValue="0" />
    <PipelineVariable id="WaterState_AboveWater"    defaultValue="1" />
    <PipelineVariable id="WaterState_BelowWater"    defaultValue="2" />
    <PipelineVariable id="WaterState_NearWaterSurface"    defaultValue="3" />

    <!-- enum:eWaterRenderer - in code! -->
    <PipelineVariable id="WaterRenderer" defaultValue="0" />
    <PipelineVariable id="WaterRenderer_RayTraced"          defaultValue="0" />
    <PipelineVariable id="WaterRenderer_MeshedDeferred"     defaultValue="1" />
    <PipelineVariable id="WaterRenderer_MeshedForward"      defaultValue="2" />
    <PipelineVariable id="WaterRenderer_MeshedWireframe"    defaultValue="3" />

    <!-- True if not 0 -->
    <PipelineVariable id="WaterDebugOverlayEnabled" defaultValue="0" />
    <PipelineVariable id="WaterDebugProxyMeshes"    defaultValue="0" />

    <!-- True if not 0 -->
    <PipelineVariable id="LightShaftsEnabled" defaultValue="0" />
    <PipelineVariable id="LightShaftsBlurEnabled" defaultValue="0" />
    <PipelineVariable id="RefractionsEnabled" defaultValue="0" />   

    <!-- enum: eCloudQuality - in code! -->
    <PipelineVariable id="CloudQuality"                   defaultValue="2" />
    <PipelineVariable id="CloudQuality_Low"               defaultValue="0" />
    <PipelineVariable id="CloudQuality_Mid"               defaultValue="1" />
    <PipelineVariable id="CloudQuality_High"              defaultValue="2" />

    <!-- Shadow Targets -->
    <RenderTarget id="SHADOWBUF"              depthBuf="true"   numColBufs="0"  format="RGBA8" depthFormat="DEPTH16" scale="1.0" width="2880" height="960" maxSamples="0" shadow="true" hasMips="false" numUniformBuffers="3" crossPipeShareId="SHADOW_SHARED" />
    <RenderTarget id="SHADOWBUF_DS"           depthBuf="true"   numColBufs="0"  format="RGBA8" depthFormat="DEPTH16" scale="1.0" width="1140" height="480" maxSamples="0" shadow="true" hasMips="false" numUniformBuffers="1" esramPageDepthBuf="424" />

    <!--Clouds Targets-->
    <RenderTarget id="CLOUDS_MRT"             depthBuf="false"  numColBufs="2" format0="RGBA16F" format1="R32FG32F" scale="0.5" shareTarget0="CLOUDS_COLOUR" shareTarget1="CLOUDS_DEPTH" applyDrs="true" allowDcc="NEXT" />
    <RenderTarget id="CLOUDS_COLOUR"          depthBuf="false"  numColBufs="1" format="RGBA16F"   scale="0.5" applyDrs="true" allowDcc="NEXT" />
    <RenderTarget id="CLOUDS_DEPTH"           depthBuf="false"  numColBufs="1" format="R32FG32F"  scale="0.5" applyDrs="true" allowDcc="NEXT" />
    <RenderTarget id="CLOUDS_HISTORY"         depthBuf="false"  numColBufs="1" format="RGBA16F"   scale="0.5" applyDrs="true" allowDcc="NEXT" />
    <RenderTarget id="CLOUDS_FINAL"           depthBuf="false"  numColBufs="1" format="RGBA16F"   scale="0.5" applyDrs="true" allowDcc="NEXT" />

    <!-- Volumetrics -->
    <RenderTarget id="VOLUME"                 depthBuf="false"  numColBufs="2"  format0="RGBA16F" format1="R11FG11FB10F" scale="0.5"  shareTarget0="SCATTER" shareTarget1="LIGHTSHAFT" applyDrs="true" pointSampleColBuf0="false" pointSampleColBuf1="true"/>
    <RenderTarget id="SCATTER"                depthBuf="false"  numColBufs="1"  format="RGBA16F"        scale="0.5" applyDrs="true" pointSampleColBuf0="false" />
    <RenderTarget id="LIGHTSHAFT"             depthBuf="false"  numColBufs="1"  format="R11FG11FB10F"   scale="0.5" applyDrs="true" pointSampleColBuf0="true"  />
    <RenderTarget id="BLUR1"                  depthBuf="false"  numColBufs="1"  format="RGBA16F"        scale="0.5" pointSampleColBuf0="true" />
    <RenderTarget id="SCATTERING_VOLUME"      depthBuf="false"  numColBufs="1" format="RGBA16F" width="16" height="16" depth="32" hasMips="false" />
    <RenderTarget id="SCATTERING_DUMMY"       depthBuf="false"  numColBufs="1" format="RED8"    width="16" height="16"            hasMips="false" />

    <!-- Motion render targets -->
    <RenderTarget id="MOTION_MAXBUF_H"        depthBuf="false"  numColBufs="1" format="RGBA16F"         scaleX="0.125" scaleY="1.0" allowDcc="false" />
    <RenderTarget id="MOTION_MAXBUF_0"        depthBuf="false"  numColBufs="1" format="RGBA16F"         scale="0.125"  allowDcc="false"  />
    <RenderTarget id="MOTION_MAXBUF_1"        depthBuf="false"  numColBufs="1" format="RGBA16F"         scale="0.125"  allowDcc="false"  />

    <!-- Bloom render targets -->   
    <RenderTarget id="BLOOM_BLURBUF_2A"       depthBuf="false"  numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.5"      applyDrs="true"   allowDcc="false" shareTarget0="HDRBUF_HALF" shareBuffer0="0"  />
    <RenderTarget id="BLOOM_BLURBUF_2B"       depthBuf="false"  numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.5"      applyDrs="true"   allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_4A"       depthBuf="false"  numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.25"     applyDrs="false"  allowDcc="false" crossPipeShareId="HDRBUF_QUART"/>
    <RenderTarget id="BLOOM_BLURBUF_4B"       depthBuf="false"  numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.25"     applyDrs="false"  allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_8A"       depthBuf="false"  numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.125"    applyDrs="false"  allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_8B"       depthBuf="false"  numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.125"    applyDrs="false"  allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_16"       depthBuf="false"  numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.0625"   applyDrs="false"  allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_32"       depthBuf="false"  numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.03125"  applyDrs="false"  allowDcc="false" />
    <RenderTarget id="BLOOM_BLURBUF_64"       depthBuf="false"  numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.015625" applyDrs="false"  allowDcc="false" />
    <RenderTarget id="BLOOM_FINALBUF"         depthBuf="false"  numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.25"     applyDrs="false"  allowDcc="false" />

    <RenderTarget id="BLOOM_EXPBUF_A"         depthBuf="false"  numColBufs="1" format="RED8"         bilinear="true" scale="1.0"       allowDcc="false" width="4" height="4" />
    <RenderTarget id="BLOOM_EXPBUF_B"         depthBuf="false"  numColBufs="1" format="RED8"         bilinear="true" scale="1.0"       allowDcc="false" width="4" height="4" />

    <!--Particles Targets-->    
    <RenderTarget id="PARTICLES"              depthBuf="false"  numColBufs="1" format="RGBA16F"  applyDrs="true"    bilinear="true" scale="0.5"   esramPageColBuf0="124" />
    <RenderTarget id="DEPTH_DOWN_REV_Z"       depthBuf="true"   numColBufs="0" format="RGBA8"     applyDrs="true"   scale="0.5" maxSamples="0" pointSampleColBuf0="true" />

    <RenderTarget id="DOF_BUF"                depthBuf="false"  numColBufs="1" format="RGBA16F" scale="0.5" allowDcc="false" />
    <RenderTarget id="DOF_MAXBUF_H"           depthBuf="false"  numColBufs="1" format="RGBA8" scaleX="0.0625"  scaleY="1.0"   allowDcc="false" />
    <RenderTarget id="DOF_MAXBUF"             depthBuf="false"  numColBufs="1" format="RGBA8" scale="0.0625" applyDrs="true"   allowDcc="false" />

    <!-- Lens Flares -->
    <RenderTarget id="LENSFLARE_BUF"          depthBuf="false"  numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.125"  allowDcc="false" />
    <RenderTarget id="LENS_ANARESBUF"         depthBuf="false"  numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.125"  allowDcc="false" />
    <RenderTarget id="LENS_ANABUF_A"          depthBuf="false"  numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.0625" allowDcc="false" />
    <RenderTarget id="LENS_ANABUF_B"          depthBuf="false"  numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.0625" allowDcc="false" />

    <!--Water Targets-->
    <RenderTarget id="WATER_MASK"         depthBuf="false"                          numColBufs="2" format0="RG8" format1="R32FG32F" scale="1.0" applyDrs="true" allowDcc="false" />
    <RenderTarget id="WATER_PROXY_DEPTH"  depthBuf="false"                          numColBufs="1" format="RED32F"                  scale="1.0" applyDrs="true" allowDcc="false" />
    <RenderTarget id="DEPTH_WATER"        depthBuf="true" depthBufUsesBB="false"    numColBufs="0" format="RGBA8"   maxSamples="0"  scale="1.0" applyDrs="true" stencilBuf="true" />
    <RenderTarget id="DEPTH_WATER_LINEAR" depthBuf="false"                          numColBufs="1" format="RED32F"  maxSamples="0"  scale="1.0" applyDrs="true" pointSampleColBuf0="true"  />
    <RenderTarget id="DEPTH_WATER_DOWN"   depthBuf="false"                          numColBufs="1" format="RED32F"  maxSamples="0"  scale="0.5" applyDrs="true" pointSampleColBuf0="true"  allowDcc="false" />

    <!-- Depth Targets -->    
    <RenderTarget id="FINAL"                  depthBuf="false"  numColBufs="1" format0="R11FG11FB10F" scale="1.0" allowDcc="false" />
    <RenderTarget id="UPSAMPLE"               depthBuf="false"  numColBufs="1" format="R11FG11FB10F"   scale="1.0"  postDlss="true"   allowDcc="false" />
    <RenderTarget id="DEPTH"                  depthBuf="true"   numColBufs="0" format="RGBA8" applyDrs="true"  scale="1.0" maxSamples="8" stencilBuf="true" esramPageDepthBuf="0" />
    <RenderTarget id="DEPTH_RESOLVED_LINEAR"  depthBuf="false"  numColBufs="1" format="RED32F" applyDrs="true" scale="1.0" maxSamples="0" pointSampleColBuf0="true"  esramPageColBuf0="124" />
    <RenderTarget id="DEPTH_RESOLVED_REV_Z"   depthBuf="true"   numColBufs="0" format="RGBA8" applyDrs="true" scale="1.0" maxSamples="0" stencilBuf="true" pointSampleColBuf0="true"   />

    <RenderTarget id="HDRBUF"                 depthBuf="false"  numColBufs="3" applyDrs="true" format0="R11FG11FB10F" format1="R11FG11FB10F" format2="RG16F" scale="1.0" allowDcc="false" maxSamples="8" />
    <RenderTarget id="HDRBUF_1"               depthBuf="false"  numColBufs="1" applyDrs="true" format0="R11FG11FB10F" scale="1.0"/>
    <RenderTarget id="HDRBUF_HALF"            depthBuf="false"  numColBufs="1" format="R11FG11FB10F" applyDrs="true"  scale="0.5" allowDcc="false" maxSamples="0" />
  </Setup>

  <!-- Scene rendering -->
  <CommandQueue>
    <Stage id="TileLights" deferrable="true">
      <!-- clear tiles light count buffer 
      <BeginTarget target="CLUSTER_LIGHTS_BUF" />
      <ColourMask channels="RGBA"/>
      <RenderPass ColorActions="DontCare/DontCare" ClearColor="0/0/0/0" DepthStencilActions="Clear/Store"/>

      <ClearTarget depthBuf="false" colBuf0="true" col_R="0.0" col_G="0.0" col_B="0.0" />
      <EndTarget flushCB="true" flushDB="false" flushForCompute="true" /> -->

      <!-- bind main target and cluster lights in coresponding tiles -->
      <BeginTarget target="DEPTH_RESOLVED_LINEAR" />
      <RenderPass ColorActions="DontCare/DontCare" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" stencilMode="disabled" depthTest="always" />
      <DoTiledLightLoop context="TILE_LIGHTS" tileWidth="16" tileHeight="16"/>
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Shadow_0" deferrable="true">
      <BeginTarget target="SHADOWBUF" />
      <RenderPass ColorActions="DontCare/DontCare" ClearColor="0/0/0/0" DepthStencilActions="Clear/Store"/>
      <SetShadowMap index="-1" />
      <ClearTarget depthBuf="true" colBuf0="false" col_R="0.0" col_G="0.0" col_B="0.0" col_A="0.0" />
      <UpdateShadowMap />
      
      <ColourMask channels="RGBA"/>

      <SetShadowMap index="0" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Mesh"         class="Glow"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Opaque"         context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="OpaqueBeforeUI" context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Cutout"         context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Highlight"      context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="ShadowOnly"     context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="InstanceMesh" class="Opaque"         context="SHADOW_INSTANCE_FADE"   order="BACK_TO_FRONT"/>
      <DrawShadowGeometry type="InstanceMesh" class="Cutout"         context="SHADOW_INSTANCE_FADE"   order="BACK_TO_FRONT"/>
      <DrawShadowGeometry type="InstanceMesh" class="Glow"           context="SHADOW_INSTANCE_FADE"   order="BACK_TO_FRONT"/>

      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Mesh"         class="DoubleSided"             context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="InstanceMesh" class="DoubleSided"             context="SHADOW_INSTANCE_FADE"   order="BACK_TO_FRONT"/>
      <DrawShadowGeometry type="Mesh"         class="HighlightDoubleSided"    context="SHADOW_FADE"            order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Terrain"      class="LOD0"           context="SHADOW_FADE"            order="BACK_TO_FRONT"/>
      <DrawShadowGeometry type="Terrain"      class="LOD1"           context="SHADOW_FADE"            order="BACK_TO_FRONT"/>
      <DrawShadowGeometry type="Terrain"      class="LOD2"           context="SHADOW_FADE"            order="BACK_TO_FRONT"/>
      
      <SetShadowMap index="1" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Mesh"         class="Glow"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Opaque"         context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="OpaqueBeforeUI" context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Cutout"         context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Highlight"      context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="ShadowOnly"     context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="InstanceMesh" class="Opaque"         context="SHADOW_INSTANCE_FADE"   order="BACK_TO_FRONT"/>
      <DrawShadowGeometry type="InstanceMesh" class="Cutout"         context="SHADOW_INSTANCE_FADE"   order="BACK_TO_FRONT"/>
      <DrawShadowGeometry type="InstanceMesh" class="Glow"           context="SHADOW_INSTANCE_FADE"   order="BACK_TO_FRONT"/>

      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Mesh"         class="DoubleSided"             context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="InstanceMesh" class="DoubleSided"             context="SHADOW_INSTANCE_FADE"   order="BACK_TO_FRONT"/>
      <DrawShadowGeometry type="Mesh"         class="HighlightDoubleSided"    context="SHADOW_FADE"            order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Terrain"      class="LOD0"           context="SHADOW_FADE"            order="FRONT_TO_BACK"/>
      <DrawShadowGeometry type="Terrain"      class="LOD1"           context="SHADOW_FADE"            order="FRONT_TO_BACK"/>
      <DrawShadowGeometry type="Terrain"      class="LOD2"           context="SHADOW_FADE"            order="FRONT_TO_BACK"/>

      <SetShadowMap index="2" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Mesh"         class="Glow"           context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Opaque"         context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="OpaqueBeforeUI" context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Cutout"         context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Highlight"      context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="ShadowOnly"     context="SHADOW_FADE"            order="STATECHANGES"/>
      <DrawShadowGeometry type="InstanceMesh" class="Opaque"         context="SHADOW_INSTANCE_FADE"   order="BACK_TO_FRONT"/>
      <DrawShadowGeometry type="InstanceMesh" class="Cutout"         context="SHADOW_INSTANCE_FADE"   order="BACK_TO_FRONT"/>
      <DrawShadowGeometry type="InstanceMesh" class="Glow"           context="SHADOW_INSTANCE_FADE"   order="BACK_TO_FRONT"/>

      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Mesh"         class="DoubleSided"             context="SHADOW_FADE"            order="STATECHANGES" />
      <DrawShadowGeometry type="InstanceMesh" class="DoubleSided"             context="SHADOW_INSTANCE_FADE"   order="BACK_TO_FRONT"/>
      <DrawShadowGeometry type="Mesh"         class="HighlightDoubleSided"    context="SHADOW_FADE"            order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Terrain"      class="LOD0"           context="SHADOW_FADE"            order="FRONT_TO_BACK"/>
      <DrawShadowGeometry type="Terrain"      class="LOD1"           context="SHADOW_FADE"            order="FRONT_TO_BACK"/>
      <DrawShadowGeometry type="Terrain"      class="LOD2"           context="SHADOW_FADE"            order="FRONT_TO_BACK"/>
      
      <!-- END -->
      <SetShadowMap index="-1" />

      <SetDepthBufferControl allowCompression="true" />    
      <EndTarget flushCB="false" flushDB="true" />

    </Stage>
    
    <Stage id="Shadow_DS">
      <BeginTarget target="SHADOWBUF_DS" />
      <ColourMask channels="RGBA"/>          
      <RenderPass ColorActions="Clear/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>
      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SHADOWBUF" bufIndex="32" shadowCompare="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY_DEPTH" />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="true" />
    </Stage>  

    <Stage id="Attributes" deferrable="true">
      <StartPrevFrameAsync />
      <BeginTarget target="HDRBUF" depthTarget="DEPTH" enableMotionVectors="true" enableLocalLights="true"/>

      <ColourMask channels="RGBA"/>
      <ClearTarget colBuf0="true"  colBuf1="true" colBuf2="true"  colBuf3="true" colBuf4="true" depthBuf="true" stencilBuf="true" />

      <RenderPass ColorActions="Clear/Resolve" ClearColor="0/0/0/0" DepthStencilActions="Clear/Store" splitEncoder="true"/>

      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF"  bufIndex="32" />     

       <!-- Z Pre-Pass - Optional to enable this to measure performance influence - (set LOD 0|1|2 draws depthTest to "equal")
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite"  stencilRef="8" />
      <DrawGeometry type="Terrain"      class="LOD0"           context="DEPTHO_FW"             order="" />
      <DrawGeometry type="Terrain"      class="LOD1"           context="DEPTHO_FW"             order="" />
      <DrawGeometry type="Terrain"      class="LOD2"           context="DEPTHO_FW"             order="" />  
      -->
      <!-- Opaques -->
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less"  stencilMode="maskWrite" stencilRef="8"/>

      <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_FW_STC_T_S"    order="FRONT_TO_BACK" deferrable="false"/>
      <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_FW_STC_T_S"    order="FRONT_TO_BACK" deferrable="false"/>
      <DrawGeometry type="Terrain"      class="LOD2"      context="LIT_FW_STC_T_S"    order="FRONT_TO_BACK" deferrable="false"/>

      <If conditionType="platform" id="MACOS" />
        <!-- use semi-stochastic terrain contexts -->
        <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_FW_N_FACING"        order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_FW_N_FACING"        order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD2"      context="LIT_FW_N_FACING"        order="FRONT_TO_BACK" deferrable="false"/>

        <DrawGeometry type="Terrain"      class="LOD3"      context="LIT_FW_STC_T_SF"        order="FRONT_TO_BACK" deferrable="false"/>
        <DrawGeometry type="Terrain"      class="LOD3"      context="LIT_FW_TIL"             order="FRONT_TO_BACK" deferrable="false"/>
      <Else/>
        <!-- use full-stochastic terrain contexts -->
        <DrawGeometry type="Terrain"      class="LOD0"      context="LIT_FW_STC_N_FF"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD1"      context="LIT_FW_STC_N_FF"    order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain"      class="LOD2"      context="LIT_FW_STC_N_FF"    order="FRONT_TO_BACK" deferrable="false"/>

        <DrawGeometry type="Terrain"      class="LOD3"      context="LIT_FW_STC_T_SF"        order="FRONT_TO_BACK" deferrable="false"/>
        <DrawGeometry type="Terrain"      class="LOD3"      context="LIT_FW_STC_N_FF"        order="FRONT_TO_BACK" deferrable="false"/>
      <EndIf/>

      <DoForwardLightLoop type="Terrain"      class="PLANET"    context="LIT_FW_TIL_L"         order="FRONT_TO_BACK" deferrable="false"/>
      <DoForwardLightLoop type="Terrain"      class="ASTEROID"  context="LIT_FW_TIL_A"    order="FRONT_TO_BACK" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite"/>
      <DoForwardLightLoop type="Mesh"         class="Opaque"          context="LIT_FW_TIL"             order="STATECHANGES" />
      <DoForwardLightLoop type="Mesh"         class="Highlight"       context="LIT_FW_TIL"             order="STATECHANGES" />
      <DoForwardLightLoop type="Mesh"         class="OpaqueBeforeUI"  context="LIT_FW_TIL"             order="STATECHANGES" />      

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="65" />
      <DoForwardLightLoop type="Mesh"         class="ScreenSpaceReflections"          context="LIT_FW_TIL"             order="STATECHANGES" />

      <!-- These are not real decals, they are just meshes with 2 UV sets which is why they are still rendered here. -->
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="3"/>
      <DoForwardLightLoop type="Mesh"         class="GunOpaque"    context="LIT_FW_TIL"             order="STATECHANGES" />
      <DoForwardLightLoop type="Mesh"         class="GunGlow"      context="LIT_FW_TIL"             order="STATECHANGES" />
      <DoForwardLightLoop type="Mesh"         class="GunDecal"     context="LIT_FW_TIL"             order="STATECHANGES"  />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite"/>
      <DoForwardLightLoop type="InstanceMesh" class="Opaque"    context="LIT_FW_INST"    order="FRONT_TO_BACK" />
      
      <DoForwardLightLoop type="Mesh"         class="Glow"      context="LIT_FW_TIL"       order="STATECHANGES" />    
      <DoForwardLightLoop type="InstanceMesh" class="Glow"      context="LIT_FW_INST"    order="FRONT_TO_BACK" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite"/>
      <DoForwardLightLoop type="InstanceMesh" class="Cutout"               context="LIT_FW_INST" order="FRONT_TO_BACK" />
      <DoForwardLightLoop type="Mesh"         class="Cutout"               context="LIT_FW_TIL"    order="FRONT_TO_BACK" />

      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" stencilMode="maskWrite" />
      <DoForwardLightLoop type="InstanceMesh" class="DoubleSided"          context="LIT_FW_INST" order="FRONT_TO_BACK" />
      <DoForwardLightLoop type="Mesh"         class="DoubleSided"          context="LIT_FW_TIL"    order="FRONT_TO_BACK" />
      <DoForwardLightLoop type="Mesh"         class="HighlightDoubleSided" context="LIT_FW_TIL"    order="FRONT_TO_BACK" />
      <DoForwardLightLoop type="Mesh"         class="HighlightOccluded"    context="LIT_FW_TIL"   order="FRONT_TO_BACK" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskReadWriteInvert" stencilRef="0" stencilMaskRead="9" stencilMaskWrite="8"/>
      <DoForwardLightLoop type="Mesh"         class="AtmosphereNear" context="PLANET_NEAR_FRWD"      order="STATECHANGES"  />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="8"/>
      <DoForwardLightLoop type="Mesh"         class="Atmosphere"     context="PLANET_FRWD"           order="STATECHANGES" />
      
      <UnbindBuffers /> 

      <EndTarget flushCB="true" flushDB="true" />
    </Stage>

    <Stage id="Sky" deferrable="false">      
      <BeginTarget target="HDRBUF" depthTarget="DEPTH"/>
      <ColourMask channels="RGBA" />
      <!-- Space/Night Sky -->      
      <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="replace" depthTest="less" stencilMode="maskReadWriteInvert" stencilRef="0" stencilMaskRead="9" stencilMaskWrite="10"/>
      <DoForwardLightLoop type="Mesh" class="Sky" context="CUBE" order="BACK_TO_FRONT" />
      <!-- Starfield -->      
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" stencilMode="maskRead" stencilRef="10" stencilMask="10"/>
      <DoForwardLightLoop type="PStream" class="Opaque"    context="PSTREAM_SYSTEM"    order="STATECHANGES" />
      <EndTarget flushCB="true" flushDB="false" />  
    </Stage>
    
    <Stage id="BlackHole" deferrable="true">
      <BeginTarget target="HDRBUF" depthTarget="DEPTH"/>
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="blend" depthTest="less" />
      <DoForwardLightLoop type="Mesh"     class="BlackHoleBack"       context="LIT_FW_TIL"    order="STATECHANGES" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />
    </Stage>

    <Stage id="MSAAResolveDepth" enabled="false"  deferrable="false">
      <BeginTarget target="DEPTH_RESOLVED_LINEAR" depthTarget="DEPTH_RESOLVED_REV_Z" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="Clear/Store"/>
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskWrite" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH" bufIndex="32" />
      <BindBuffer sampler="gStencilBuffer"  sourceRT="DEPTH" bufIndex="33" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MSAA_RESOLVE_DEPTH" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />
    </Stage>

    <Stage id="NoMSAAResolveDepth" enabled="false"  deferrable="false">
      <BeginTarget target="DEPTH_RESOLVED_LINEAR"  depthTarget="DEPTH_RESOLVED_REV_Z" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="Clear/Store"/>
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskWrite" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH" bufIndex="32" />
      <BindBuffer sampler="gStencilBuffer"  sourceRT="DEPTH" bufIndex="33" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="NO_MSAA_RESOLVE_DEPTH" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />
    </Stage>

    <Stage id="Decals" deferrable="true">
      <BeginTarget target="HDRBUF" depthTarget="DEPTH_RESOLVED_REV_Z" enableMotionVectors="true" enableLocalLights="true" />
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_RESOLVED_LINEAR"    bufIndex="0"   />
      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF"  bufIndex="32" />

      <ColourMask channels="RGB" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" stencilMode="disabled"/>
      <DoForwardLightLoop type="InstanceMesh" class="Decal"           context="LIT_FW_INST"    order="BACK_TO_FRONT" />
      <DoForwardLightLoop type="Mesh"         class="Decal"           context="LIT_FW_TIL"       order="STATECHANGES" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" stencilMode="maskRead" stencilRef="8" stencilMask="8" />
      <DoForwardLightLoop type="InstanceMesh" class="DecalTerrain"    context="LIT_FW_INST"    order="BACK_TO_FRONT" />
      <DoForwardLightLoop type="Mesh"         class="DecalTerrain"    context="LIT_FW_TIL"       order="STATECHANGES" />

      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
    </Stage>

    <Stage id="TerrainCleanup" >
      <BeginTarget target="DEPTH" onlyStencil="true" />
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store" />
      <SetContext zwrite="false" colourWrite="false" blendMode="replace" depthTest="always" stencilMode="maskReadWriteNotEqual" stencilRef="0" stencilMaskRead="8" stencilMaskWrite="8" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="CLEAR_ZERO" />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="MeshWaterComputeDispatch">
      <If>
        <Conditions operation="and">
          <Condition type="variable" id="WaterRenderer" test="notEqual" sourceType="variable" source="WaterRenderer_RayTraced" />
          <Condition type="variable" id="WaterState"    test="notEqual" sourceType="variable" source="WaterState_NoWater" />
        </Conditions>
      </If>
        <DoForwardLightLoop type="Water" class="MeshWater" context="CASCADE_WAVE_GERSTNER" order="" />
      <EndIf />
    </Stage>

    <Stage id="MeshWaterMask">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_MeshedDeferred" />
        <If conditionType="variable" id="WaterState"  test="notEqual" sourceType="variable" source="WaterState_NoWater" />
          <BeginTarget target="DEPTH_WATER" />
          <ClearTarget depthBuf="true" colBuf0="false" stencilBuf="true" col_R="0.0" col_G="0.0" col_B="0.0" />
          <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="Clear/Store"/>
          <!-- <ClearTarget depthBuf="true" colBuf0="false" stencilBuf="true" col_R="0.0" col_G="0.0" col_B="0.0" /> -->
          <!-- non-depth-tested water external exclusion meshes (always closed surfaces), let's us know if we are inside our outside of a proxy mesh (can only be 1 if inside, due to them all being closed surfaces) -->
          <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="false" stencilMode="maskReadWriteInvertAlways" stencilMaskRead="0" stencilMaskWrite="4" stencilRef="0" />
          <DoForwardLightLoop type="Mesh" class="WaterVolumeProxy" context="DEPTHONLY_FRWRD" order="" />

          <!-- non-depth-tested water internal exclusion meshes (always closed surfaces), let's us know if we are inside our outside of a proxy mesh (can only be 1 if inside, due to them all being closed surfaces) -->
          <SetContext zwrite="false" colourWrite="false" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskReadWriteInvertAlways" stencilMaskRead="0" stencilMaskWrite="4" stencilRef="0" />
          <DoForwardLightLoop type="Mesh" class="WaterVolumeProxyInternal" context="DEPTHONLY_FRWRD" order="" />

          <EndTarget flushCB="false" flushDB="true" />

          <BeginTarget target="WATER_PROXY_DEPTH" depthTarget="DEPTH_WATER" readOnlyDepth="true" />
          <RenderPass ColorActions="Clear/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>
          <ColourMask channels="RGBA" />
          <ClearTarget depthBuf="false" colBuf0="true" stencilBuf="false" col_R="0.0" col_G="0.0" col_B="0.0" />
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"  stencilMode="maskRead" stencilMask="4" stencilRef="4" />
          <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_WATER" bufIndex="32" />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_REV2LIN" />
          <UnbindBuffers />


          <EndTarget flushCB="true" flushDB="false" />


          <BeginTarget target="WATER_MASK" depthTarget="DEPTH_WATER" />
          <RenderPass ColorActions="Clear/Store" ClearColor="0/0/0/0" DepthStencilActions="Clear/Store"/>
          <ClearTarget depthBuf="true" colBuf0="true" colBuf1="true"  stencilBuf="false" col_R="0.0" col_G="0.0" col_B="0.0" />
          <ColourMask channels="RGBA" />

          <!-- TODO: Copy main scene depth to water depth -->

          <BindBuffer sampler="gDepthMap" sourceRT="WATER_PROXY_DEPTH" bufIndex="0" />
          <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="false" stencilMode="maskWrite" stencilMask="3" stencilRefFront="1" stencilRefBack="2" />
          <DoForwardLightLoop type="Water" class="MeshWater" context="MESH_WATER_MASK" order="" />
          <UnbindBuffers />

          <!-- depth-tested water exclusion meshes (always closed surfaces), let's us know the number of boundaries we pass-through before we "hit" the water surface -->
          <SetContext zwrite="false" colourWrite="false" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="false"  stencilMode="maskReadWriteInvert" stencilMaskRead="0" stencilMaskWrite="8" stencilRef="0" />
          <DoForwardLightLoop type="Mesh" class="WaterVolumeProxy" context="DEPTHONLY_FRWRD" order="" />
          <DoForwardLightLoop type="Mesh" class="WaterVolumeProxyInternal" context="DEPTHONLY_FRWRD" order="" />

          <ColourMask channels="R" />

          <!-- don't draw water where we are outside of a proxy mesh, but have an odd number of depth-tested "hits" -->
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" alphaToCoverage="false" stencilMode="maskRead" stencilMask="12" stencilRef="8" />
          <DrawQuadMT material="materials/MeshWater.material.mbin" context="MESH_WATER_ERASE" />

          <!-- don't draw water where we are inside of a proxy mesh, but have an even number of depth-tested "hits" -->
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" alphaToCoverage="false" stencilMode="maskRead" stencilMask="12" stencilRef="4" />
          <DrawQuadMT material="materials/MeshWater.material.mbin" context="MESH_WATER_ERASE" />

          <EndTarget flushCB="true" flushDB="true" />
        <Else/>
          <BeginTarget target="WATER_MASK" depthTarget="DEPTH_WATER" />
          <RenderPass ColorActions="Clear/Store" ClearColor="0/0/0/0" DepthStencilActions="Clear/Store"/>
          <EndTarget flushCB="true" flushDB="true" />
        <EndIf />   
      <EndIf />
    </Stage>

    <Stage id="MeshWaterDepthCopyFrontForVolumetrics_NO_MSAA">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_MeshedDeferred" />
      <If>
        <Conditions operation="or">
          <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_AboveWater" />
          <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_NearWaterSurface" />
        </Conditions>
      </If>
          <BeginTarget target="DEPTH_WATER_LINEAR" />
          <RenderPass ColorActions="Clear/Store" ClearColor="0/0/0/0" DepthStencilActions="Clear/Store"/>
          <ColourMask channels="RGBA"/>
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
          <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH"  bufIndex="32" />
          <BindBuffer sampler="gBuffer1Map" sourceRT="WATER_MASK"  bufIndex="0" />
          <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_WATER" bufIndex="32" />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_REV2LIN_WLESS" />
          <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="false" />
        <Else/>
          <BeginTarget target="DEPTH_WATER_LINEAR" />
          <RenderPass ColorActions="Clear/Store" ClearColor="0/0/0/0" DepthStencilActions="Clear/Store"/>
          <ColourMask channels="RGBA"/>
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
          <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH"  bufIndex="32" />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_REV2LIN" />
          <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="false" />
        <EndIf/>

        <BeginTarget target="DEPTH_WATER_DOWN" />
        <RenderPass ColorActions="Clear/Store" ClearColor="0/0/0/0" DepthStencilActions="Clear/Store"/>
        <ColourMask channels="RGBA"/>
        <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_WATER_LINEAR"    bufIndex="0" />
        <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />
        <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE_GBUFFERDEPTH" />
        <UnbindBuffers />
        <EndTarget flushCB="true" />
      <EndIf />
    </Stage>     

    <Stage id="MeshWaterDepthCopyFrontForVolumetrics_MSAA">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_MeshedDeferred" />
      <If>
        <Conditions operation="or">
          <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_AboveWater" />
          <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_NearWaterSurface" />
        </Conditions>
      </If>
          <BeginTarget target="DEPTH_WATER_LINEAR" />
          <RenderPass ColorActions="Clear/Store" ClearColor="0/0/0/0" DepthStencilActions="Clear/Store"/>
          <ColourMask channels="RGBA"/>
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
          <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH"  bufIndex="32" />
          <BindBuffer sampler="gBuffer1Map" sourceRT="WATER_MASK"  bufIndex="0" />
          <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_WATER" bufIndex="32" />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="MSAA_W_D_REV2LIN" />
          <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="false" />
        <Else/>
          <BeginTarget target="DEPTH_WATER_LINEAR" />
          <RenderPass ColorActions="Clear/Store" ClearColor="0/0/0/0" DepthStencilActions="Clear/Store"/>
          <ColourMask channels="RGBA"/>
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
          <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH"  bufIndex="32" />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="MSAA_D_REV2LIN" />
          <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="false" />
        <EndIf/>

        <BeginTarget target="DEPTH_WATER_DOWN" />
        <RenderPass ColorActions="Clear/Store" ClearColor="0/0/0/0" DepthStencilActions="Clear/Store"/>
        <ColourMask channels="RGBA"/>
        <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_WATER_LINEAR"    bufIndex="0" />
        <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />
        <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE_GBUFFERDEPTH" />
        <UnbindBuffers />
        <EndTarget flushCB="true" />
      <EndIf />
    </Stage>     

    <Stage id="WaterFromAbove" deferrable="true">   
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_RayTraced" />
        <If conditionType="variable" id="WaterState"  test="equal" sourceType="variable" source="WaterState_AboveWater" />
          <BeginTarget target="HDRBUF" depthTarget="DEPTH_RESOLVED_REV_Z"/>
          <ColourMask channels="RGB"/>      
          <RenderPass ColorActions="Load/Store" DepthStencilActions="Load/Store" />

          <BindBuffer sampler="gBuffer1Map"   sourceRT="DEPTH_RESOLVED_LINEAR"    bufIndex="0"  />
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="less" stencilMode="maskWrite" stencilRef="4"  stencilMask="4" />
          <!--SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="disabled" /-->
          <DrawQuadMT material="Models/Planets/Terrain/Water.material.mbin" context="WATER_ABOVE_NOREF"/>
          <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="false" /> 
        <EndIf />
      <EndIf />
    </Stage>
    
    <Stage id="MeshWaterWireframe">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_MeshedWireframe" />
        <If conditionType="variable" id="WaterState"  test="notEqual" sourceType="variable" source="WaterState_NoWater" />
          <BeginTarget target="HDRBUF" depthTarget="DEPTH_RESOLVED_REV_Z"/>
          <ColourMask channels="RGBA" />
          <RenderPass ColorActions="Load/Store" DepthStencilActions="Load/Store" />
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="false" fillMode="wireframe"/>
          <DoForwardLightLoop type="Water" class="MeshWater" context="MESH_WATER" order="BACK_TO_FRONT" />
          <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="false" />
        <EndIf />
      <EndIf />
    </Stage>
    
    <Stage id="CloudsHigh">
    </Stage>

    <Stage id="CloudsBlur">
    </Stage>

    <Stage id="CloudsShadows">
    </Stage>

   <Stage id="CloudsForWorldsAsync" enabled="false">
      <BeginTarget target="CLOUDS_MRT" />
      <RenderPass ColorActions="Clear/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <If conditionType="variable" id="CloudQuality" test="equal" sourceType="variable" source="CloudQuality_Low" />
        <DrawQuad material="Materials/NewCloud.material.mbin" context="LOW_QUALITY_CLOUDS"  width ="1.0" height="1.0" compute="async" />
      <Else />
      <If conditionType="variable" id="CloudQuality" test="equal" sourceType="variable" source="CloudQuality_Mid" />
        <DrawQuad material="Materials/NewCloud.material.mbin" context="MID_QUALITY_CLOUDS"  width ="1.0" height="1.0" compute="async" />
      <Else />
        <DrawQuad material="Materials/NewCloud.material.mbin" context="HIGH_QUALITY_CLOUDS" width ="1.0" height="1.0" compute="async" />
      <EndIf />
      <EndIf />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <SwapTargets targetA="CLOUDS_FINAL"     targetB="CLOUDS_HISTORY"  />
      

      <BeginTarget target="CLOUDS_HISTORY" frameIdx="prev"/>
      <ColourMask channels="RGBA" />
      <RenderPass ColorActions="Clear/Store" ClearColor="0/0/0/-1" LoadActionOnDRSChange="true" />
      <EndTarget flushCB="true" flushDB="true" />

      <BeginTarget target="CLOUDS_FINAL" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorActions="Load/Store" DepthStencilActions="Load/Store"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="CLOUDS_COLOUR"    bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="Materials/NewCloud.material.mbin" context="CLOUDS_BLUR_H" width ="1.0" height="1.0" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="CLOUDS_COLOUR" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorActions="Load/Store" DepthStencilActions="Load/Store"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="CLOUDS_FINAL"     bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="Materials/NewCloud.material.mbin" context="CLOUDS_BLUR_V" width ="1.0" height="1.0" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="CLOUDS_FINAL" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="CLOUDS_DEPTH"     bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="CLOUDS_COLOUR"    bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="CLOUDS_HISTORY"   bufIndex="0"  frameIdx="prev" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="Materials/NewCloud.material.mbin" context="CLOUDS_TEMPORAL" width ="1.0" height="1.0" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

    </Stage>
    
    <Stage id="MeshWaterPostProcessAbove">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_MeshedDeferred" />
        <If>
          <Conditions operation="or">
            <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_AboveWater" />
            <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_NearWaterSurface" />
          </Conditions>
        </If>
          <BeginTarget target="HDRBUF_1" depthTarget="DEPTH_WATER" onlyStencil="true" readOnlyDepth="true" />
          <RenderPass ColorActions="Clear/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>

          <ColourMask channels="RGB"  />
          <BindBuffer sampler="gDepthMap"            sourceRT="DEPTH_RESOLVED_LINEAR"   bufIndex="0"  />
          <BindBuffer sampler="gBufferMap"           sourceRT="HDRBUF"       bufIndex="0" />
          <BindBuffer sampler="gShadowMap"           sourceRT="SHADOWBUF"      bufIndex="32" />
          <BindBuffer sampler="gWaterDepth"          sourceRT="DEPTH_WATER"    bufIndex="32"  />
          <BindBuffer sampler="gWaterMask"           sourceRT="WATER_MASK"     bufIndex="0"  />
          <BindBuffer sampler="gWaterPlanePosition"  sourceRT="WATER_MASK"     bufIndex="1"  />

          <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="1" stencilMask="1" />
          <DrawQuadMT material="materials/MeshWater.material.mbin" context="M_ABOVE_WATER" />

          <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="false" />

          <BeginTarget target="HDRBUF" depthTarget="DEPTH_WATER" onlyStencil="true" readOnlyDepth="true" />
          <RenderPass ColorActions="Load/Store" DepthStencilActions="Load/Store"/>
          <ColourMask channels="RGBA" />
          <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_1" bufIndex="0" />
          <SetContext zwrite="false" blendMode="blend" colourWrite="true" depthTest="always" stencilMode="maskRead" stencilRef="1" stencilMask="1" />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY_NONZERO"  />
          <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="false" />
        <EndIf />
      <EndIf />
    </Stage>

    <Stage id="PlanetCloud" deferrable="false">       
      <BeginTarget target="HDRBUF" depthTarget="DEPTH_RESOLVED_REV_Z"/>
      <ColourMask channels="RGBA" />
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>   
      
       <!--Cloud sphere around planets--> 
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" />
      <DoForwardLightLoop type="Mesh" class="Atmosphere" context="CLOUDSHADOW" order="BACK_TO_FRONT" />
    
      <ColourMask channels="RGB" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" />
      <DoForwardLightLoop type="Mesh" class="Atmosphere" context="CLOUD" order="BACK_TO_FRONT" />
    
      <EndTarget flushCB="true" flushDB="false" />     
    </Stage>

    <Stage id="Volumetrics" deferrable="false">
      <BeginTarget target="VOLUME" />
      <ColourMask channels="RGBA" colBuf1="false" />
      <RenderPass ColorActions="Clear/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>   

      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />
      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF"  bufIndex="32" />

      <SetContext zwrite="false" colourWrite="true" cullMode="front" stencilMode="disabled" depthTest="always" blendMode="add" />
      <DoForwardLightLoop type="Mesh" class="AtmosphereNear" context="SCATTER_MASK" order="FRONT_TO_BACK" />

      <SetContext zwrite="false" colourWrite="true" stencilMode="disabled" depthTest="always" blendMode="add" />
      <DrawQuadMT material="materials/Light.material.mbin" context="SCATTERING"  />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLUR1" />
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>   
      <BindBuffer sampler="gBufferMap"  sourceRT="VOLUME" bufIndex="0"   />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN"  bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_H_GUASS" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="VOLUME" />
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>   
      <ColourMask channels="RGBA" colBuf1="false" />
      <BindBuffer sampler="gBufferMap"  sourceRT="BLUR1"   bufIndex="0"   />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN"  bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_V_GUASS" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <!-- <BeginTarget target="SCATTERING_VOLUME" />
      <EndTarget flushCB="true" flushDB="false" flushForCompute="true" /> -->
      <BeginTarget target="SCATTERING_DUMMY" />
      <RenderPass ColorActions="DontCare/DontCare" ClearColor="0/0/0/0"/>   
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" bindAsRwImage="true" />
      <SetContext zwrite="false" colourWrite="false" blendMode="replace" stencilMode="disabled" depthTest="always" />
      <DrawQuadMT material="materials/Light.material.mbin" context="SCATTERING_VOLUME"  />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="VolumetricsUPS" deferrable="true">
      <BeginTarget target="HDRBUF" depthTarget="DEPTH_RESOLVED_REV_Z"/>
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>   

      <!-- upsample Volumetrics -->
      <BindBuffer sampler="gBufferMap"  sourceRT="VOLUME"        bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN"    bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_WATER_LINEAR"  bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.25" /> 
      <SetContext zwrite="false" blendMode="blend" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="BILATERAL_BLEND_UPSAMPLE"  />
      <UnbindBuffers />

      <!-- Atmosphere scattering planet near -->
      <!-- <ColourMask channels="RGBA" />
      <SetContext zwrite="false" colourWrite="true" cullMode="front" depthTest="lessEqual" blendMode="Blend_OutputOneMinusAlpha" stencilMode="maskRead" stencilRef="10" stencilMask="10"/>
      <DoForwardLightLoop type="Mesh" class="AtmosphereNear" context="SCATTERING_FORWARD" order="FRONT_TO_BACK" /> -->

      <!-- Scattering near planet on non-sky areas -->
      <!-- <SetContext zwrite="false" colourWrite="true" stencilMode="disabled" depthTest="always" blendMode="blend" />
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_WATER_LINEAR"  bufIndex="0" />
      <DrawQuadMT material="materials/Light.material.mbin" context="SCATTERING"  /> -->

      <!-- Atmosphere scattering planets -->
      <SetContext zwrite="false" colourWrite="true" cullMode="front" depthTest="lessEqual" blendMode="add" /> 
      <DoForwardLightLoop type="Mesh" class="Atmosphere" context="SCATTERING_FORWARD" order="FRONT_TO_BACK" />
      
      <!-- Planet Rings -->
      <ColourMask channels="RGBA" />
      <SetContext zwrite="false" colourWrite="true" cullMode="front" stencilMode="disabled"  depthTest="always"  blendMode="blend"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_WATER_LINEAR"  bufIndex="0" />
      <DoForwardLightLoop type="Mesh"    class="Rings"     context="RINGS_FORWARD" order="BACK_TO_FRONT" />
      <UnbindBuffers />

      <EndTarget flushCB="true" flushDB="false" />  
    </Stage>
    

    <Stage id="VolumetricsForWorlds" enabled="false" deferrable="true">
      <BeginTarget target="VOLUME" />
      <ColourMask channels="RGBA" colBuf1="false" />
      <RenderPass ColorActions="Clear/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>   

      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />
      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF_DS"  bufIndex="32" />

      <SetContext zwrite="false" colourWrite="true" cullMode="front" stencilMode="disabled" depthTest="always" blendMode="add" />
      <DoForwardLightLoop type="Mesh" class="AtmosphereNear" context="SCATTER_MASK" order="FRONT_TO_BACK" />

      <SetContext zwrite="false" colourWrite="true" stencilMode="disabled" depthTest="always" blendMode="add" />
      <DrawQuadMT material="materials/Light.material.mbin" context="SCATTERING"  />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLUR1" />
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>   
      <BindBuffer sampler="gBufferMap"  sourceRT="VOLUME" bufIndex="0"   />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN"  bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_H_GUASS" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="VOLUME" />
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>   
      <ColourMask channels="RGBA" colBuf1="false" />
      <BindBuffer sampler="gBufferMap"  sourceRT="BLUR1"   bufIndex="0"   />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN"  bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_V_GUASS" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="SCATTERING_DUMMY" />
      <RenderPass ColorActions="DontCare/DontCare" ClearColor="0/0/0/0"/>   
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" bindAsRwImage="true" />
      <SetContext zwrite="false" colourWrite="false" blendMode="replace" stencilMode="disabled" depthTest="always" />
      <DrawQuadMT material="materials/Light.material.mbin" context="SCATTERING_VOLUME"  />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>
    

    <Stage id="CloudsForWorlds" enabled="false" deferrable="true">
      <BeginTarget target="SCATTER" />
      <ColourMask channels="RGBA"/>
      <RenderPass ColorActions="Load/Store"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="Blend_PostMultAlpha" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_WATER_LINEAR" bufIndex="0" />
      <DrawQuad material="Materials/NewCloud.material.mbin" context="CIRRUS_CLOUDS" />
      <BindBuffer sampler="gBufferMap" sourceRT="CLOUDS_FINAL" bufIndex="0" />
      <DrawQuad material="Materials/NewCloud.material.mbin" context="CLOUDS_COPY" />
      <UnbindBuffers />

      <ColourMask channels="A" colBuf1="false" />
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0"/>
      <BindBuffer sampler="gBufferMap" sourceRT="CLOUDS_FINAL" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="max" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/NewCloud.material.mbin" context="CLOUDS_COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="MeshWaterStencil">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_MeshedDeferred" />
        <If conditionType="variable" id="WaterState"  test="notEqual" sourceType="variable" source="WaterState_NoWater" />
            <BeginTarget target="HDRBUF" depthTarget="DEPTH_RESOLVED_REV_Z" onlyStencil="true" />
            <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>   
            <ColourMask channels="RGBA" />
            <BindBuffer sampler="gDepthMap"       sourceRT="DEPTH_RESOLVED_LINEAR"   bufIndex="0"  />
            <BindBuffer sampler="gWaterDepth"     sourceRT="DEPTH_WATER"    bufIndex="32"  />
            <BindBuffer sampler="gWaterMask"      sourceRT="WATER_MASK"     bufIndex="0"  />

            <!-- exists to prevent volumetrics from being applied until after we have rendered water -->
            <If>
              <Conditions operation="or">
                <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_AboveWater" />
                <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_NearWaterSurface" />
              </Conditions>
            </If>
              <SetContext zwrite="false" colourWrite="false" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskWrite" stencilMask="1" stencilRef="1" />
              <DrawQuadMT material="materials/MeshWater.material.mbin" context="MESH_WATER_ST_FRONT" />
            <EndIf />

            <!-- exists to prevent refractive transparencies from being applied where we have an underwater mesh... a bit of a gross hack, ideally we replace this with a unified WATER & MAIN DEPTH depth target , and volumetrics being delayed for opaques-->
            <If>
              <Conditions operation="or">
                <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_BelowWater" />
                <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_NearWaterSurface" />
              </Conditions>
            </If>
              <SetContext zwrite="false" colourWrite="false" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskWrite" stencilMask="21" stencilRef="0" />
              <DrawQuadMT material="materials/MeshWater.material.mbin" context="MESH_WATER_ST_BACK" />
            <EndIf />

            <EndTarget flushCB="false" flushDB="false" />
        <EndIf />
      <EndIf />
    </Stage>

    <Stage id="LightShafts" deferrable="true">
      <If conditionType="variable" id="LightShaftsEnabled" />
      <BeginTarget target="LIGHTSHAFT" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="R"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_WATER_DOWN"    bufIndex="0" />
      <BindBuffer sampler="gShadowMap"   sourceRT="SHADOWBUF_DS"  bufIndex="32" />
      
      <SetContext zwrite="false" colourWrite="true" stencilMode="disabled" depthTest="always" blendMode="replace" />
      <DrawQuadMT material="materials/Light.material.mbin" context="RAYMARCH" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>
    
    <Stage id="LightShaftsBlur" deferrable="true">
      <If conditionType="variable" id="LightShaftsBlurEnabled" /> 
      <BeginTarget target="BLOOM_BLURBUF_2B" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="R"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="LIGHTSHAFT" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />    
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />     
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_H_REDONLY_GUASS" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="VOLUME" />
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>

      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="BLOOM_BLURBUF_2B"    bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />
      <!-- This is a very weird one... lightshafts were originally additively blended in a bespoke pass onto the main scene *after* the
           the volumetrics had already been applied. However - as a performance saving it makes sense to write the light shafts directly into
           the volumetrics buffer and blend them both into the main scene together. However - the volumetrics were previously done through a normal
           alpha blend. To resolve this - when blending the light shafts into the volumetrics buffer, we pre-multiply the volumetrics colour values
           by their own alpha (whilst still preserving that alpha value) - we then additively blend the light shafts into the VOLUME target.
           When blending the VOLUME target into the main scene - we do an additive blend of the VOLUME into HDRBUF0, where the dst has (1 - srcAlpha)
           applied -->
      <SetContext zwrite="false" blendMode="Blend_AddPremulDst" colourWrite="true" stencilMode="disabled" depthTest="always" />     
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_VGAUSS_SHAFT_APPLY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>


    <Stage id="VolumetricsUPS_PreWater" enabled="false">
      
      <BeginTarget target="HDRBUF" depthTarget="DEPTH_RESOLVED_REV_Z"/>
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>   
      <ColourMask channels="RGBA"/>
      
      <SetContext zwrite="false" colourWrite="true" cullMode="front" depthTest="lessEqual" blendMode="add" /> 
      <DoForwardLightLoop type="Mesh" class="Atmosphere" context="SCATTERING_FORWARD" order="FRONT_TO_BACK" />
      
      <!-- Planet Rings -->
      <ColourMask channels="RGBA" />
      <SetContext zwrite="false" colourWrite="true" cullMode="front" stencilMode="disabled"  depthTest="always"  blendMode="blend"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_WATER_LINEAR"  bufIndex="0" />
      <DoForwardLightLoop type="Mesh"    class="Rings"     context="RINGS_FORWARD" order="BACK_TO_FRONT" />
      <UnbindBuffers />

      <!-- upsample Volumetrics -->
      <BindBuffer sampler="gBufferMap"  sourceRT="VOLUME"        bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN"    bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_WATER_LINEAR"  bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="WATER_MASK"          bufIndex="0" />
      <BindBuffer sampler="gBuffer4Map" sourceRT="DEPTH_WATER"    bufIndex="32"  />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.25" /> 
      <!-- <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="Blend_AddBlendDst" depthTest="always" alphaToCoverage="false"/> -->
      <!-- the difference between these is the blend mode - whether we do a normal blend or rely on the fact that if light shafts blur is enabled, we rely on that pre-mulitplying the volumetrics by its own alpha -->
      <If conditionType="variable" id="LightShaftsBlurEnabled" />
        <SetContext zwrite="false" blendMode="Blend_AddBlendDst" colourWrite="true" stencilMode="maskRead" stencilRef="0" stencilMask="1" depthTest="always" />
        <DrawQuad material="Materials/PostProcess.material.mbin" context="WTR_BLTRL_DST_BLND_UPSMPL" width ="1.0" height="1.0"/>
      <Else />
        <SetContext zwrite="false" blendMode="blend" colourWrite="true" stencilMode="maskRead" stencilRef="0" stencilMask="1" depthTest="always" />
        <DrawQuad material="Materials/PostProcess.material.mbin" context="WTR_BLTRL_UPSMPL_BLND" width ="1.0" height="1.0"/>
      <EndIf />
      <UnbindBuffers />

      <EndTarget flushCB="true" flushDB="false" />  

    </Stage>
    
    <Stage id="BlendedAbovePreRefractions" deferrable="true">
      <BeginTarget target="HDRBUF" depthTarget="DEPTH_RESOLVED_REV_Z"/>

      <ColourMask channels="RGBA" />
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>

      <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />

      <!-- Quads -->
      <SetContext zwrite="true" colourWrite="true" cullMode="front"  blendMode="blend" depthTest="less" stencilMode="maskWrite" stencilRef="4"  stencilMask="4" />
      <DoForwardLightLoop type="QUAD"     class="Opaque"  context="LIGHTING"  order="FRONT_TO_BACK" />
      <SetContext zwrite="true" colourWrite="true" cullMode="back"  blendMode="blend" depthTest="less" stencilMode="maskWrite" stencilRef="4"  stencilMask="4"/>
      <DoForwardLightLoop type="QUAD"     class="Opaque"  context="LIGHTING"  order="FRONT_TO_BACK" />

      <!-- Lines -->
      <ColourMask channels="RGB"/>
      <!--a = alpha offset, b = noise threshold, c = is underground, d = alpha noise factor-->
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="add" depthTest="always" stencilMode="maskWrite" stencilRef="4"  stencilMask="4"/>
      <DoForwardLightLoop type="LINE"     class="Opaque"  context="SUBSTANCES"  order="FRONT_TO_BACK" />

      <ColourMask channels="RGB"/>
      <!-- player gun additive. has to be rendered before the laser so it can lay down the stencil.-->      
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="less" stencilMode="maskWrite" stencilRef="7" stencilMask="7" />
      <DrawGeometry type="Mesh"         class="GunAdditive"    context="LIT_FW_NB"             order="STATECHANGES" />
      
      <!-- Transparent Objects -->
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="less"  stencilMode="maskWrite" stencilRef="4"  stencilMask="4"/>
      <DoForwardLightLoop type="Mesh"     class="Additive"    context="LIT_FW_NB" order="BACK_TO_FRONT" />
      <UnbindBuffers />
      
      <EndTarget flushCB="true" flushDB="true" />
    </Stage>


    <Stage id="CloudsCopy" deferrable="true">  
    </Stage>

    <Stage id="WaterFromBelow" deferrable="true">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_RayTraced" />
        <If conditionType="variable" id="WaterState"  test="equal" sourceType="variable" source="WaterState_BelowWater" />
          <BeginTarget target="HDRBUF" depthTarget="DEPTH_RESOLVED_REV_Z"/> 
          <ColourMask channels="RGB"/>
          <BindBuffer sampler="gBuffer1Map"     sourceRT="DEPTH_RESOLVED_LINEAR"   bufIndex="0"  />
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="less" stencilMode="maskWrite" stencilRef="4"  stencilMask="4" />
          <DrawQuadMT material="Models/Planets/Terrain/Water.material.mbin" context="WATER_BELOW_NOREF"/>
          <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="false" />
        <EndIf />
      <EndIf />
    </Stage>
    
    <Stage id="MeshWaterPostProcessBelow">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_MeshedDeferred" />
        <If>
          <Conditions operation="or">
            <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_BelowWater" />
            <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_NearWaterSurface" />
          </Conditions>
        </If>
          <BeginTarget target="HDRBUF_1" />
          <RenderPass ColorActions="Load/Store" DepthStencilActions="Load/Store"/>
          <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF"      bufIndex="0" />
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always"  stencilMode="disabled" />
          <ColourMask channels="RGB"  />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
          <EndTarget flushCB="true" flushDB="false" />


          <BeginTarget target="HDRBUF" depthTarget="DEPTH_WATER" onlyStencil="true" readOnlyDepth="true" />
          <RenderPass ColorActions="Load/Store" DepthStencilActions="Load/Store"/>

          <ColourMask channels="RGB"  />
          <BindBuffer sampler="gDepthMap"            sourceRT="DEPTH_RESOLVED_LINEAR"   bufIndex="0"  />
          <BindBuffer sampler="gReflectionDepthMap"  sourceRT="WATER_PROXY_DEPTH" bufIndex="0" />
          <BindBuffer sampler="gBufferMap"           sourceRT="HDRBUF_1"       bufIndex="0" />
          <BindBuffer sampler="gShadowMap"           sourceRT="SHADOWBUF"      bufIndex="32" />
          <BindBuffer sampler="gWaterDepth"          sourceRT="DEPTH_WATER"    bufIndex="32"  />
          <BindBuffer sampler="gWaterMask"           sourceRT="WATER_MASK"     bufIndex="0"  />
          <BindBuffer sampler="gWaterPlanePosition"  sourceRT="WATER_MASK"     bufIndex="1"  />

          <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="always" stencilMode="maskRead" stencilRef="2" stencilMask="2" />
          <DrawQuadMT material="materials/MeshWater.material.mbin" context="M_BELOW_WATER" />

          <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="always" stencilMode="maskRead" stencilMask="1" stencilRef="0" />
          <DrawQuadMT material="materials/MeshWater.material.mbin" context="MESH_WATER_SCATTER" />

          <UnbindBuffers />
          <EndTarget flushCB="false" flushDB="false" />

        <EndIf />
      <EndIf />
    </Stage>

    <Stage id="TerrainEdits" enabled="false" deferrable="true">
      <BeginTarget target="HDRBUF" depthTarget="DEPTH_RESOLVED_REV_Z"/>
      <ColourMask channels="RGBA" colBuf1="false" />
      <!-- Terrain Edits -->
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="4"  stencilMask="4"/>
      <DrawGeometry type="Terrain"      class="LOD0"      context="EDITS"           order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD1"      context="EDITS"           order="FRONT_TO_BACK" />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="VolumetricsUPS_PostWater" enabled="false">
      <BeginTarget target="HDRBUF" depthTarget="DEPTH_RESOLVED_REV_Z"/>
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>   
      <ColourMask channels="RGBA" />
           
      <BindBuffer sampler="gBufferMap"  sourceRT="VOLUME"        bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN"    bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_WATER_LINEAR"  bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="WATER_MASK"          bufIndex="0" />
      <BindBuffer sampler="gBuffer4Map" sourceRT="DEPTH_WATER"    bufIndex="32"  />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.25" /> 
      <!-- the difference between these is the blend mode - whether we do a normal blend or rely on the fact that if light shafts blur is enabled, we rely on that pre-mulitplying the volumetrics by its own alpha -->
      <If conditionType="variable" id="LightShaftsBlurEnabled" />
        <SetContext zwrite="false" blendMode="Blend_AddBlendDst" colourWrite="true" stencilMode="maskRead" stencilRef="1" stencilMask="1" depthTest="always" />
        <DrawQuad material="materials/PostProcess.material.mbin" context="WTR_BLTRL_DST_BLND_UPSMPL"  />
      <Else />
        <SetContext zwrite="false" blendMode="blend" colourWrite="true" stencilMode="maskRead" stencilRef="1" stencilMask="1" depthTest="always" />
        <DrawQuad material="materials/PostProcess.material.mbin" context="WTR_BLTRL_UPSMPL_BLND"  />
      <EndIf />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>


    <Stage id="TranslucentNormal" deferrable="true">
      <BeginTarget target="HDRBUF" depthTarget="DEPTH_RESOLVED_REV_Z"/>
      <ColourMask channels="RGBA" />
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0"/>   
      <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less"  stencilMode="maskWrite" stencilRef="4"  stencilMask="4"/>
      <DoForwardLightLoop type="Mesh"     class="Translucent" context="LIT_FW_TIL" order="BACK_TO_FRONT" />
      <UnbindBuffers />

      <EndTarget flushCB="true" flushDB="false" />      
    </Stage>

    <Stage id="BlendedAbovePostRefractions"  deferrable="true">
      <BeginTarget target="HDRBUF" depthTarget="DEPTH_RESOLVED_REV_Z"/>

      <!-- Transparent Objects -->
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less"  stencilMode="maskWrite" stencilRef="20"  stencilMask="20"/>
      <DoForwardLightLoop type="Mesh"     class="WarpInShip"  context="LIT_FORWARD" order="BACK_TO_FRONT" deferrable="false"/>
      <DoForwardLightLoop type="Mesh"     class="Rainbow"     context="RAINBOW"     order="BACK_TO_FRONT" deferrable="false"/>

      <!-- PlaneSpotlight Object -->
      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="less"  stencilMode="maskWrite" stencilRef="4"  stencilMask="4"/>
      <DoForwardLightLoop type="Mesh"     class="PlaneSpot"    context="LIT_FORWARD" contextVariant="1" order="BACK_TO_FRONT" deferrable="false"/>
         
      <ColourMask channels="RGB" colBuf1="true" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite"  stencilRef="36"  stencilMask="36"/>
      <DoForwardLightLoop type="Mesh"     class="Highlight"            context="LIT_FW_TIL" order="BACK_TO_FRONT" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite"  stencilRef="36"  stencilMask="36"/>
      <DoForwardLightLoop type="Mesh"     class="HighlightDoubleSided" context="LIT_FW_TIL" order="BACK_TO_FRONT" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite"   stencilRef="36"  stencilMask="36"/>
      <DoForwardLightLoop type="Mesh"     class="HighlightTrans"            context="LIT_FW_TIL" order="BACK_TO_FRONT" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite"   stencilRef="36"   stencilMask="36"/>
      <DoForwardLightLoop type="Mesh"     class="HighlightTransOccluded"    context="LIT_FW_TIL"     order="BACK_TO_FRONT" />

      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite"  stencilRef="36"  stencilMask="36"/>
      <DoForwardLightLoop type="Mesh"     class="HighlightTransDoubleSided" context="LIT_FW_TIL" order="BACK_TO_FRONT" />

      <!-- Trails -->
      <ColourMask channels="RGB" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="less"  stencilMode="maskWrite" stencilRef="20"  stencilMask="20"/>
      <DoForwardLightLoop type="Trail" class="Translucent" context="LIGHTING" order="BACK_TO_FRONT" deferrable="false"/>

      <ColourMask channels="RGB" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add"   depthTest="less"  stencilMode="maskWrite" stencilRef="20"  stencilMask="20"/>
      <DoForwardLightLoop type="Trail" class="Additive"    context="LIGHTING" order="BACK_TO_FRONT" deferrable="false"/>

      <!--Single Lines-->
      <ColourMask channels="RGBA" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="blend" depthTest="less"  stencilMode="maskWrite" stencilRef="20"  stencilMask="20" /> 
      <DoForwardLightLoop type="SingleLine" class="Opaque" context="LIGHTING" order="" deferrable="false"/>

      <!--Single Lines-->
      <ColourMask channels="RGB" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="less"  stencilMode="maskWrite" stencilRef="20"  stencilMask="20" />
      <DoForwardLightLoop type="SingleLine" class="Additive" context="LIGHTING" order="" deferrable="false"/>

      <!-- Markers -->
      <ColourMask channels="RGBA" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less"  stencilMode="maskWrite" stencilRef="20"  stencilMask="20" />
      <DoForwardLightLoop type="Mesh" class="Map" context="SCREEN_MAP" order="BACK_TO_FRONT" />

      <!-- Glow Translucent RGB -->
      <ColourMask channels="RGB" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less"  stencilMode="maskWrite" stencilRef="20"  stencilMask="20" />
      <DoForwardLightLoop type="Mesh"  class="GlowTranslucent" context="LIT_FW_TIL" order="BACK_TO_FRONT" />
      
      <SetContext zwrite="false" colourWrite="false" cullMode="none" blendMode="add" depthTest="less" stencilMode="maskWrite" stencilRef="4"  stencilMask="7" />

      <!-- render the player laser stencil-only, to mask it in the TAA -->
      <!-- results in some overzealous clipping in AA but should be hard to see, the gun moves a lot -->
      <DoForwardLightLoop type="SingleLine" class="PlayerGunLaser"     context="LIGHTING" order="" deferrable="false"/>      
      <DoForwardLightLoop type="SingleLine" class="PlayerGunLaserCore" context="LIGHTING" order="" deferrable="false"/>

      <ColourMask channels="RGB" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="less" stencilMode="maskReadInvert" stencilRef="3" stencilMask="7" />

      <!-- player laser. actual colour rendering masked by the gun -->
      <DoForwardLightLoop type="SingleLine" class="PlayerGunLaser" context="LIGHTING" order="" deferrable="false"/>
      <DoForwardLightLoop type="SingleLine" class="PlayerGunLaserCore" context="LIGHTING" order="" deferrable="false"/>

      <!-- Glow Translucent Alpha. -->
      <!-- Disabled because the result of this is only used by the 'NewBloomBright' stage, which doesn't exist in this pipeline atm. -->
      <!-- <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="Blend_OutputAlpha" depthTest="less" />  -->
      <!-- <DoForwardLightLoop type="Mesh"  class="GlowTranslucent" context="LIT_FW_TIL"    order="BACK_TO_FRONT" />        -->
      <!-- <DoForwardLightLoop type="Trail" class="Translucent"     context="LIGHTING_GLOW"  order="BACK_TO_FRONT"  />      -->
      <!-- <DoForwardLightLoop type="Trail" class="Additive"        context="LIGHTING_GLOW"  order="BACK_TO_FRONT" />       -->
        
      <ColourMask channels="RGBA" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="always"  stencilMode="maskWrite" stencilRef="20"  stencilMask="20"/>
      <DoForwardLightLoop type="Mesh"     class="WarpOnFoot" context="LIT_FW_TIL" order="BACK_TO_FRONT" deferrable="false"/>

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="invSourceAlpha" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="20"  stencilMask="20"/>
      <DoForwardLightLoop type="Mesh"         class="UIScreen"         context="LIT_FW_TIL"            order="BACK_TO_FRONT" deferrable="false"/>

      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />
    </Stage>

    <Stage id="3dLines" deferrable="true">
      <BeginTarget target="HDRBUF" depthTarget="DEPTH_RESOLVED_REV_Z"/>
      <ColourMask channels="RGBA"  />
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DrawGeometry type="LINERENDERER"  class="Opaque"   context="LINE3D"            order="" />
      <EndTarget flushCB="true" flushDB="true" />
    </Stage>

    <Stage id="SpeedLines" deferrable="false">
      <BeginTarget target="HDRBUF" depthTarget="DEPTH_RESOLVED_REV_Z"/>
      <ColourMask channels="RGBA" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="Blend_OutputOneMinusAlpha" depthTest="less" />
      <DoForwardLightLoop type="SPEEDLINE" class="Opaque" context="LIGHTING" order="BACK_TO_FRONT" />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="MeshWaterDepthCopy">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_MeshedDeferred" />
        <If conditionType="variable" id="WaterState"  test="notEqual" sourceType="variable" source="WaterState_NoWater" />
          <BeginTarget target="DEPTH_RESOLVED_LINEAR" depthTarget="DEPTH_RESOLVED_REV_Z" />
          <RenderPass ColorActions="Load/Store" DepthStencilActions="Load/Store"/>
          <ColourMask channels="RGBA"/>
          <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="false" stencilMode="maskWrite" stencilRef="4"  stencilMask="4" />
          <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_WATER" bufIndex="32" />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_REV2LIN_LESS" />
          <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="true" />
        <EndIf />
      <EndIf />
    </Stage>

<!-- Start postprocess -->
    <Stage id="SoftParticles" deferrable="true">  
    
      <BeginTarget target="DEPTH_DOWN_REV_Z" />
      <RenderPass ColorActions="DontCare/Store" DepthStencilActions="DontCare/Store"/>
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_RESOLVED_REV_Z"    bufIndex="32"   />
      <SetContext zwrite="true" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="DWNSMP_DEPTH_ONLY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />

      <BeginTarget target="PARTICLES" depthTarget="DEPTH_DOWN_REV_Z" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/DontCare"/>
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="disabled" depthTest="always" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="PARTICLE_CLEAR" />

      <BindBuffer sampler="gDepthBuffer" sourceRT="DEPTH_RESOLVED_LINEAR" bufIndex="0" />
      <BindBuffer sampler="gBufferMap"   sourceRT="HDRBUF"    bufIndex="0"   />
      <BindBuffer sampler="gStencilBuffer" sourceRT="DEPTH_RESOLVED_REV_Z" bufIndex="33" />
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="Blend_OutputOneMinusAlpha" depthTest="less" />

      <!-- Soft particles -->
      <DoForwardLightLoop  type="EMITTER"  class="Translucent" context="TRLCNT_SOFT_NOR" order="BACK_TO_FRONT"/>
      <DoForwardLightLoop  type="HEAVYAIR" class="Translucent" context="HVYAIR_SOFT_NOR" order="BACK_TO_FRONT"/>
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="SoftParticlesRefractiveApply" deferrable="true">
      <BeginTarget target="HDRBUF"/>
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGB" />
      
      <!-- <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="always" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="PARTICLES"    bufIndex="0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="PARTICLE_BLEND" /> -->
      
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="invSourceAlpha" depthTest="always" />

      <BindBuffer sampler="gBufferMap"  sourceRT="PARTICLES"    bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN"   bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_WATER_LINEAR" bufIndex="0" /> 
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="PART_UPSAMPLE" />

      <BindBuffer sampler="gDepthBuffer" sourceRT="DEPTH_RESOLVED_LINEAR" bufIndex="0" />
      <ColourMask channels="RGB" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="less" />
      <DoForwardLightLoop  type="EMITTER"  class="Additive" context="TRNSLCNT_ADDITIVE" order="BACK_TO_FRONT"/>
      <DoForwardLightLoop  type="HEAVYAIR" class="Additive" context="HVR_ADDITIVE" order="BACK_TO_FRONT"/>
      <DoForwardLightLoop  type="EMITTER"  class="AdditiveHighQuality"  context="TRNSLCNT_ADDITIVE" order="BACK_TO_FRONT"/>
      <DoForwardLightLoop  type="HEAVYAIR" class="AdditiveHighQuality"  context="HVR_ADDITIVE"      order="BACK_TO_FRONT"/>

      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="NewBloomPost" enabled="true" deferrable="true">
      <BeginTarget target="BLOOM_BLURBUF_2B" />
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGBA"/>

      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF" bufIndex="1" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="5.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_HALF_SB" compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      

      <BeginTarget target="BLOOM_BLURBUF_2B" depthTarget="DEPTH_DOWN_REV_Z" readOnlyDepth="true" />
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>
      <!-- <ColourMask channels="RGB"  /> -->
      <ColourMask channels="G"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" stencilMode="disabled" depthTest="less" />
      <DoForwardLightLoop type="Mesh"     class="Bloom"              context="LIT_FRWD_FX" order="BACK_TO_FRONT" />
      <DoForwardLightLoop type="Mesh"     class="BloomAndLensFlare"  context="LIT_FRWD_FX" order="BACK_TO_FRONT" />
      <EndTarget flushCB="false" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_2A" />
      <ColourMask channels="RGBA"/>
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_2B" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="5.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_HALF_SB" compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_4B" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="BLOOM_BLURBUF_2A" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="5.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_SB" compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_4A" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_4B" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="5.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_HALF_SB"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="BLOOM_BLURBUF_8B" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="BLOOM_BLURBUF_4A" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="5.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_SB"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_8A" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_8B" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="5.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_HALF_SB"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />      

      <BeginTarget target="BLOOM_BLURBUF_16" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="BLOOM_BLURBUF_8A" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="3.0" d="1.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_7_SQR_SB"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />      

      <BeginTarget target="BLOOM_BLURBUF_32" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_16" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="2.0" d="1.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_SQR_SB"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />           

      <BeginTarget target="BLOOM_BLURBUF_64" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_32" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="2.0" d="1.0"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_SQR_SB"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_32" />
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_64" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="1.0" c="1.5" d="4.0"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GAUSS_5_SQ_A_SB"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_16" />
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_32" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="1.0" c="1.5" d="2.0"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GAUSS_5_SQ_A_SB"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="NewBloomResolve" enabled="true" deferrable="true">
      <BeginTarget target="BLOOM_FINALBUF" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="BLOOM_BLURBUF_4A" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="BLOOM_BLURBUF_8A" bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="BLOOM_BLURBUF_16" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="11.0" b="9.0" c="7.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="BLOOM_RESOLVE"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    
      <BeginTarget target="BLOOM_BLURBUF_4B" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_FINALBUF" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="1.0" c="2.5" d="1.0"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF_SB"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_FINALBUF" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_4B" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="1.0" c="2.5" d="1.0"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF_SB"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="NewBloomExposure" enabled="true" deferrable="true">
      <BeginTarget target="BLOOM_EXPBUF_B" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <BindBuffer sampler="gBufferMap"   sourceRT="BLOOM_BLURBUF_64"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map"  sourceRT="BLOOM_EXPBUF_A"    bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="BLOOM_EXP_FRWD"  compute="async_next"  wavesPerSimd="0" threadGroupsPerCu="0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <SwapTargets targetA="BLOOM_EXPBUF_A" targetB="BLOOM_EXPBUF_B" />
    </Stage>
     <Stage id="LensFlare" deferrable="true">
      <BeginTarget target="LENSFLARE_BUF" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_4A" bufIndex="0"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/LensFlare.material.mbin" context="FEATURE_FRWD" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <!-- Currently no anamorph used-->
    </Stage>

    
    <Stage id="LensFlareAnamorphic" deferrable="true">
      <BeginTarget target="LENS_ANABUF_A"/>
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" stencilMode="disabled" />
      <BindBuffer sampler="gBufferMap"   sourceRT="BLOOM_BLURBUF_4A"  bufIndex="0" />
      <DrawQuadMT material="materials/LensFlare.material.mbin" context="ANAMORPH_BG" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
      <BeginTarget target="LENS_ANABUF_B"/>
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" stencilMode="disabled" />
      <BindBuffer sampler="gBufferMap"   sourceRT="LENS_ANABUF_A"        bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="5.0" d="1.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_HALF_BG" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_ANABUF_A"/>
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" stencilMode="disabled" />
      <BindBuffer sampler="gBufferMap"   sourceRT="LENS_ANABUF_B"        bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="5.0" d="1.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_HALF_BG" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_ANABUF_B"/>
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" stencilMode="disabled" />
      <BindBuffer sampler="gBufferMap"   sourceRT="LENS_ANABUF_A"        bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="1.0" d="1.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENS_ANARESBUF"/>
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGB"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" />
      <BindBuffer sampler="gBufferMap"    sourceRT="LENS_ANABUF_B"         bufIndex="0" />
      <DrawQuadMT material="materials/LensFlare.material.mbin" context="ANAMORPH_RESOLVE" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="LENSFLARE_BUF"/>
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="add" depthTest="always" stencilMode="disabled" />
      <BindBuffer sampler="gBufferMap"   sourceRT="LENS_ANARESBUF"        bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="5.0" d="0.0"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_9_ADD" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="MOTIONDILATE" enabled="false" deferrable="true">
      <SyncGraphicsToCompute compute="async" />
      <BeginTarget target="MOTION_MAXBUF_H" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF"  bufIndex="2" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_RESOLVED_LINEAR"   bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MOTIONDILATE_H" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <SwapTargets targetA="MOTION_MAXBUF_0" targetB="MOTION_MAXBUF_1" />

      <BeginTarget target="MOTION_MAXBUF_0" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="MOTION_MAXBUF_H"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_RESOLVED_LINEAR"     bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MOTIONDILATE_V" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="MotionblurNormal" enabled="false" deferrable="true">
      <BeginTarget target="VOLUME" />
      <RenderPass ColorActions="Clear/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGBA" colBuf1="false" />
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF"         bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="HDRBUF"    bufIndex="2" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_RESOLVED_LINEAR"      bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="disabled" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_LOW" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="BLUR1" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="VOLUME"           bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="HDRBUF"    bufIndex="2" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_RESOLVED_LINEAR"      bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="disabled" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_LOW_PASS2" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="HDRBUF" />
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="Load/Store"/>
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap" sourceRT="BLUR1" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="invSourceAlpha" depthTest="always" alphaToCoverage="false" stencilMode="disabled" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />   
    </Stage> 

    <Stage id="DepthOfFieldBokehNew" deferrable="true"> 
      <!-- downsample main target -->
      <BeginTarget target="HDRBUF_HALF" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE_DUAL_FILTER" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false"/>

      <BeginTarget target="DOF_MAXBUF_H" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>

      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_FINALBUF" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="DILATE_HOR_FRWD" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="DOF_MAXBUF" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DOF_MAXBUF_H" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="DILATE_VER" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="DOF_BUF" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_HALF" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="BLOOM_FINALBUF" bufIndex="0"/>    
      <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_RESOLVED_LINEAR" bufIndex="0" />    
      <BindBuffer sampler="gBuffer3Map" sourceRT="DOF_MAXBUF" bufIndex="0" />     
      <SetUniform material="materials/DepthOfField.material.mbin" uniform="gBlurParamsVec4" a="8.0" b="8.0" c="8.0" />
      <DrawQuad material="materials/DepthOfField.material.mbin" context="POISSON_NEW_FRWD" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
     
      <BeginTarget target="HDRBUF"  />
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>

      <BindBuffer sampler="gBufferMap" sourceRT="DOF_BUF" bufIndex="0" /> 
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="invSourceAlpha" depthTest="always" alphaToCoverage="false"/>         
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="BLEND_INVSRCA_FRWD" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />    
    </Stage>

   
    <Stage id="METALFX_SPATIAL_APPLY" enabled="false" deferrable="false">
        <BeginTarget target="UPSAMPLE" />
        <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
        <ApplyMetalFXSpatial inputRT="HDRBUF" outputRT="UPSAMPLE" />
        <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="METALFX_TEMPORAL_APPLY" enabled="false" deferrable="false">
        <BeginTarget target="UPSAMPLE" />
        <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
        <ApplyMetalFXTemporal inputRT="HDRBUF" inputRTIdx="0" outputRT="UPSAMPLE" depthRT="DEPTH" motionRT="HDRBUF" motionRTIdx="2" />
        <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="Combine" deferrable="false">
      <BeginTarget target="FINAL"/>
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF"           bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_RESOLVED_LINEAR"   bufIndex="0" />
      <BindBuffer sampler="gStencilBuffer" sourceRT="DEPTH_RESOLVED_REV_Z" bufIndex="33" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="BLOOM_FINALBUF"   bufIndex="0" />
      <BindBuffer sampler="gBuffer4Map" sourceRT="BLOOM_EXPBUF_B"   bufIndex="0" />
      <BindBuffer sampler="gBuffer5Map" sourceRT="LENSFLARE_BUF"    bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINE_FRWD" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Combine_Upscaled" enabled="false" deferrable="false">
      <BeginTarget target=""/>
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="UPSAMPLE"           bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_RESOLVED_LINEAR"   bufIndex="0" />
      <BindBuffer sampler="gStencilBuffer" sourceRT="DEPTH_RESOLVED_REV_Z" bufIndex="33" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="BLOOM_FINALBUF"   bufIndex="0" />
      <BindBuffer sampler="gBuffer4Map" sourceRT="BLOOM_EXPBUF_B"   bufIndex="0" />
      <BindBuffer sampler="gBuffer5Map" sourceRT="LENSFLARE_BUF"    bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINE_FRWD" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Combine_NoFFX" enabled="false" deferrable="false">
      <BeginTarget target=""/>
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF"           bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_RESOLVED_LINEAR"   bufIndex="0" />
      <BindBuffer sampler="gStencilBuffer" sourceRT="DEPTH_RESOLVED_REV_Z" bufIndex="33" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="BLOOM_FINALBUF"   bufIndex="0" />
      <BindBuffer sampler="gBuffer4Map" sourceRT="BLOOM_EXPBUF_B"   bufIndex="0" />
      <BindBuffer sampler="gBuffer5Map" sourceRT="LENSFLARE_BUF"    bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINE_FRWD" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>    

    <Stage id="FXAA" enabled="false" deferrable="false">
      <ColourMask channels="RGBA"/>
      <BeginTarget target="" readOnlyDepth="true" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" />

      <BindBuffer sampler="gBufferMap"  sourceRT="FINAL"  bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="FXAA" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="FFX_SUPER_RES" deferrable="false">
      <BeginTarget target="UPSAMPLE" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="disabled" />
      <BindBuffer sampler="gBufferMap"  sourceRT="FINAL" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="FFX_SUPER_RES" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="" />
      <RenderPass ColorActions="DontCare/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="disabled" />
      <BindBuffer sampler="gBufferMap"  sourceRT="UPSAMPLE" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="FFX_RCASHARPEN" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>


    <Stage id="TileLightsCountDebug" enabled="false" deferrable="true">
      <BeginTarget target=""/>
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGB" />
      <BindBuffer sampler="gLightCluster" sourceRT="CLUSTER_LIGHTS_BUF" bufIndex="0" bindAsRwImage="true" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" stencilMode="disabled" depthTest="always" />
      <DoTiledLightLoop context="TILE_LIGHTS_COUNT_DEBUG" tileWidth="16" tileHeight="16"/>

      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="TileLightsClusterDebug" enabled="false" deferrable="true">
      <BeginTarget target=""/>
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <ColourMask channels="RGB" />
      <BindBuffer sampler="gLightCluster" sourceRT="CLUSTER_LIGHTS_BUF" bufIndex="0" bindAsRwImage="true" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" stencilMode="disabled" depthTest="always" />
      <DoTiledLightLoop context="TILE_LIGHTS_CLUSTER_DEBUG" tileWidth="16" tileHeight="16"/>

      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <!--TF_END-->
      
    <Stage id="UI" deferrable="false">
      <ColourMask channels="RGBA"/>
      <BeginTarget target=""/>
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="Materials/UI.material.mbin" context="BINOCS" />
      
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="sourceAlpha" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="Materials/UI.material.mbin" context="UI" width="1.0" height="1.0" />      
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>


    <Stage id="MeshWaterDebugOverlay" deferrable="false">
      <If conditionType="variable" id="WaterDebugOverlayEnabled" />
      <ColourMask channels="RGBA"/>
      <BeginTarget target=""/>
      <RenderPass ColorActions="Load/Store" ClearColor="0/0/0/0" DepthStencilActions="DontCare/DontCare"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="Blend_OutputAlpha" depthTest="always" stencilMode="disabled" />
      <DrawQuadMT material="materials/Debug.material.mbin" context="MESH_WATER" width="1.0" height="1.0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="Reset States">
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="disabled" />
      <ColourMask channels="RGBA"/>
    </Stage>

  </CommandQueue>



</Pipeline>
