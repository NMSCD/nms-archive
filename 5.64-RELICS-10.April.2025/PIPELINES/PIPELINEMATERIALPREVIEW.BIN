<Pipeline>
  <Setup>
    <RenderTarget id="HDRBUF"         platforms="PROSPERO"  depthBuf="true"  depthBufUsesBB="true" stencilBuf="true"  numColBufs="1"  format="RGBA16F" scale="1.0" width="3840" height="2160" postDlss="true"  />
    <RenderTarget id="HDRBUF"         platforms="PC|SCARLETT|ORBIS|XBOX|MACOS"  depthBuf="true"  depthBufUsesBB="true" stencilBuf="true"  numColBufs="1"  format="RGBA16F" scale="1.0" esramPageColBuf0="134"  postDlss="true"  />
    <RenderTarget id="HDRBUF"         platforms="HHELD|IOS" depthFormat="DEPTH24"      colBufUsesST="true"  depthBuf="true"  depthBufUsesBB="true" stencilBuf="true"  numColBufs="1"  format="RGBA8"   scale="0.5" esramPageColBuf0="134"  postDlss="true"  />

    <!-- Dummy targets, not actually used -->
    <RenderTarget id="SHADOWBUF"    depthFormat="DEPTH16" depthBuf="true" numColBufs="0" format="RGBA8" scale="1.0" width="120" height="40" shadow="true" hasMips="false" numUniformBuffers="3" />
    <RenderTarget id="CLOUDSHADOWS" depthBuf="false" numColBufs="1" format="RGBA8" scale="1.0" width="32" height="32" />

  </Setup>

  <CommandQueue>

    <Stage id="Clear">
      <BeginTarget target="HDRBUF" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="1/0/0/1" DepthAction="Clear/DontCare" StencilAction="Clear/DontCare" ClearDepthStencil="0/0"/>

      <ColourMask channels="RGBA"/>
      <ClearTarget depthBuf="true" colBuf0="true" col_R="0.0" col_G="0.0" col_B="0.0" col_A="0.0" />
      <ColourMask channels="RGBA"/>

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>

      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="MaterialPreviewOpaque">
      <BeginTarget target="HDRBUF" />
      <ColourMask channels="RGBA"/>

      <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />

      <!--Opaques-->
      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="false"/>

      <!--Gun-->
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less"  />
      <DoForwardLightLoop type="Mesh"         class="GunOpaque"    context="MATERIAL_PREVIEW"             order="STATECHANGES" />
      <DoForwardLightLoop type="Mesh"         class="GunGlow"      context="MATERIAL_PREVIEW"             order="STATECHANGES" />
      <DoForwardLightLoop type="Mesh"         class="GunDecal"     context="MATERIAL_PREVIEW"             order="STATECHANGES" />

      <!--alpha test with alpha to coverage-->
      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="true"/>
      <DoForwardLightLoop type="Mesh"         class="Opaque"          context="MATERIAL_PREVIEW"          order="STATECHANGES" />
      <DoForwardLightLoop type="Mesh"         class="OpaqueBeforeUI"  context="MATERIAL_PREVIEW"          order="STATECHANGES" />
      <DoForwardLightLoop type="Mesh"         class="Cutout"          context="MATERIAL_PREVIEW"          order="STATECHANGES" />
      <DoForwardLightLoop type="Mesh"         class="Highlight"       context="MATERIAL_PREVIEW"          order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="true"/>
      <DoForwardLightLoop type="Mesh"         class="DoubleSided"     context="MATERIAL_PREVIEW"          order="STATECHANGES" />
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" alphaToCoverage="true"/>

      <!--Glow-->
      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="false"/>
      <DoForwardLightLoop type="Mesh"         class="Glow"            context="MATERIAL_PREVIEW"          order="STATECHANGES" />

      <EndTarget flushCB="false" flushDB="false" />

    </Stage>

    <Stage id="EnvironmentBackground">
      <BeginTarget target="HDRBUF" />
      <ColourMask channels="RGBA"/>

      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="equal" alphaToCoverage="false"/>

      <DrawQuad material="materials/PostProcess.material.mbin" context="DUALP_PROJECT" />
      <UnbindBuffers />

      <EndTarget flushCB="true" flushDB="true" />
    </Stage>

    <Stage id="MaterialPreviewTranslucent">
      <BeginTarget target="HDRBUF" />
      <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />

      <!--Transparent Objects--> 
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="less" alphaToCoverage="false"/>
      <DoForwardLightLoop type="Mesh"     class="Additive"    context="MATERIAL_PREVIEW" order="BACK_TO_FRONT" />
      <ColourMask channels="RGB"/>

      <!--Gun-->
      <DrawGeometry type="Mesh"         class="GunAdditive"    context="MATERIAL_PREVIEW"             order="STATECHANGES" />

      <!--Transparent Objects-->
      <ColourMask channels="RGBA"/>
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" alphaToCoverage="false"/>
      <DoForwardLightLoop type="Mesh"     class="Translucent" context="MATERIAL_PREVIEW" order="BACK_TO_FRONT" />
      <ColourMask channels="RGB"/>

      <ClearTarget colBuf0="false" depthBuf="false" />
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="1" />
      <DoForwardLightLoop type="Mesh"     class="Highlight" context="LIT_FORWARD" order="BACK_TO_FRONT" />
      <SetContext />

      <!--Glow Translucent--> 
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="less" alphaToCoverage="false"/>
      <ColourMask channels="RGBA"/>
      <DoForwardLightLoop type="Mesh"  class="GlowTranslucent" context="MATERIAL_PREVIEW" order="BACK_TO_FRONT" />

      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />

    </Stage>

    <Stage id="Combine">
      <ColourMask channels="RGBA"/>
      <BeginTarget target=""/>
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" DepthAction="DontCare/DontCare" StencilAction="DontCare/DontCare"/>

      <ColourMask channels="RGBA"/>

      <SetContext zwrite="false" colourWrite="true" cullMode="none"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF"  bufIndex="0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GAMMACORRECT_UI" />
      <UnbindBuffers />

      <EndTarget flushCB="true" flushDB="false" />

    </Stage>

    <Stage id="Reset States">
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <ColourMask channels="RGBA"/>
    </Stage>

  </CommandQueue>

</Pipeline>
