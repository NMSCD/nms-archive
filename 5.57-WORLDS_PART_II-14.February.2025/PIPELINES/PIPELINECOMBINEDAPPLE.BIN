<!-- High Dynamic Range (HDR) utf-8Shading Pipeline -->
<Pipeline>
  <Setup>
    <ScaleInfo resScalingDefault="true" />

    <!-- Pipeline Variables -->
    <PipelineVariable id="SSRProbesAvailable" defaultValue="0" />
    <PipelineVariable id="SSRGeometryDrawCount" />

    <PipelineVariable id="SSR_MipIdxSrc" />
    <PipelineVariable id="SSR_MipIdxDst" />

    <!-- true if not 0 -->
    <PipelineVariable id="RunningOnMac" defaultValue="0" />
    <PipelineVariable id="LowEnd" defaultValue="0" />

    <!-- enum:eWaterState - in code! -->
    <PipelineVariable id="WaterState" defaultValue="0" />
    <PipelineVariable id="WaterState_NoWater" defaultValue="0" />
    <PipelineVariable id="WaterState_AboveWater" defaultValue="1" />
    <PipelineVariable id="WaterState_BelowWater" defaultValue="2" />
    <PipelineVariable id="WaterState_NearWaterSurface" defaultValue="3" />

    <!-- enum:eWaterRenderer - in code! -->
    <PipelineVariable id="WaterRenderer" defaultValue="0" />
    <PipelineVariable id="WaterRenderer_RayTraced" defaultValue="0" />
    <PipelineVariable id="WaterRenderer_MeshedDeferred" defaultValue="1" />
    <PipelineVariable id="WaterRenderer_MeshedForward" defaultValue="2" />
    <PipelineVariable id="WaterRenderer_MeshedWireframe" defaultValue="3" />

    <!-- enum:eWaterReflections - in code! -->
    <PipelineVariable id="WaterReflections"               defaultValue="0" />
    <PipelineVariable id="WaterReflections_Disabled"      defaultValue="0" />
    <PipelineVariable id="WaterReflections_PlanarSSR"     defaultValue="1" />
    <PipelineVariable id="WaterReflections_FullSSR"       defaultValue="2" />

    <!-- True if not 0 -->
    <PipelineVariable id="WaterDebugOverlayEnabled" defaultValue="0" />
    <PipelineVariable id="WaterDebugProxyMeshes"    defaultValue="0" />
    <PipelineVariable id="WaterGodRaysEnabled"      defaultValue="0" />

    <!-- True if not 0 -->
    <PipelineVariable id="LightShaftsEnabled" defaultValue="0" />
    <PipelineVariable id="LightShaftsBlurEnabled" defaultValue="0" />
    <PipelineVariable id="RefractionsEnabled" defaultValue="0" />

    <!-- enum: eCloudQuality - in code! -->
    <PipelineVariable id="CloudQuality" defaultValue="2" />
    <PipelineVariable id="CloudQuality_Low" defaultValue="0" />
    <PipelineVariable id="CloudQuality_Mid" defaultValue="1" />
    <PipelineVariable id="CloudQuality_High" defaultValue="2" />

    <!-- True if not 0 -->
    <PipelineVariable id="GTAO_BentNormals"               defaultValue="0" />
    <!-- True if not 0 -->
    <PipelineVariable id="EnableGgx"                      defaultValue="0" />
    <!--
      Metal lets us use heaps, areas of memory that can be aliased and from which resources can be created. If two resources are aliased,
      the amount of memory that is used is the amount of memory required by the largest resource.
      
      Metal heaps let us implement render target sharing with no limitations on format or resolution. This is how render targets are
      distributed across heaps:

      *********************************************************
      Heap ID 0: SHADOWBUF, DOF_MAXBUF
      *********************************************************
      Heap ID 1: DEPTH_WATER_LINEAR, UPSCALE_OUT_A_0, MOTION_MAXBUF_H, LIGHTS_DUMMY
      *********************************************************
      Heap ID 2: DEPTH_WATER, UPS_OUT_B_0
      *********************************************************
      Heap ID 3: LIGHTS_TILEBUF, BLUR1_REDONLY, DOF_MAXBUF_H
      *********************************************************
      Heap ID 4: CLOUDS_DEPTH, LIGHTSHAFT
      *********************************************************
    -->

    <!--Shadow Targets-->
    <RenderTarget id="SHADOWBUF" depthBuf="true" numColBufs="0" format="RGBA8" depthFormat="DEPTH16"
      scale="1.0" width="2880" height="960" shadow="true" hasMips="false" numUniformBuffers="3"
      crossPipeShareId="SHADOW_SHARED" heapID="0" />
    <RenderTarget id="SHADOWBUF_DS" depthBuf="true" numColBufs="0" format="RED16F"
      depthFormat="DEPTH16" scale="1.0" width="1440" height="480" shadow="true" hasMips="false"
      numUniformBuffers="1" />

    <!--GBuffer Targets-->
    <RenderTarget id="GBUFFER" platforms="IOS" depthBuf="false" numColBufs="4" format0="RGBA8" format1="RG16F"
      format2="RGB10A2" format3="RGBA8" scale="1.0" applyDrs="true"
      pointSampleColBuf1="true" pointSampleColBuf2="true" pointSampleColBuf3="true"
      shareTarget0="RGBA8_BUF_T1_0" shareTarget1="R16G16_0" />
    
    <RenderTarget id="GBUFFER" platforms="MACOS" depthBuf="false" numColBufs="5" format0="RGBA8" format1="RG16F"
      format2="RGB10A2" format3="RGBA8" format4="RG8_Snorm" scale="1.0" applyDrs="true"
      pointSampleColBuf1="true" pointSampleColBuf2="true" pointSampleColBuf3="true"
      shareTarget0="RGBA8_BUF_T1_0" shareTarget2="NORMALS"  shareTarget3="MATERIAL" shareTarget4="BENT" />

    <!--Geometry Targets-->
    <RenderTarget id="MAT_BENT" platforms="MACOS" depthBuf="false"  numColBufs="2"  scale="1.0" applyDrs="true" format0="RGBA8" format1="RG8_Snorm" shareTarget0="MATERIAL" shareTarget1="BENT" />
    <RenderTarget id="NORMALS"  platforms="MACOS" depthBuf="false"  numColBufs="1"  scale="1.0" applyDrs="true" format="RGB10A2" shareTarget0="RGB10A2_BUF_0"  esramPageColBuf0="192" />
    <RenderTarget id="MATERIAL" platforms="MACOS" depthBuf="false"  numColBufs="1"  scale="1.0" applyDrs="true" format="RGBA8"      shareTarget0="RGBA8_BUF_0"    esramPageColBuf0="134" />
    <RenderTarget id="BENT" platforms="MACOS" depthBuf="false"  numColBufs="1"  scale="1.0"     applyDrs="true" format="RG8_Snorm"  shareTarget0="RG8S_BUF_0" />

    <!--Clouds Targets-->
    <RenderTarget id="CLOUDS_MRT" depthBuf="false" numColBufs="2" format0="RGBA16F" format1="R32FG32F" format2="RG8" scale="0.5" applyDrs="true" shareTarget0="CLOUDS_COLOUR" shareTarget1="CLOUDS_DEPTH"/>
    <RenderTarget id="CLOUDS_COLOUR" depthBuf="false" numColBufs="1" format="RGBA16F" scale="0.5" applyDrs="true" shareTarget0="HDRBUF_DOWN_16_0" />
    <RenderTarget id="CLOUDS_DEPTH" depthBuf="false" numColBufs="1" format="R32FG32F" scale="0.5" applyDrs="true" heapID="4" />
    <RenderTarget id="CLOUDS_HISTORY" depthBuf="false" numColBufs="1" format="RGBA16F" scale="0.5" applyDrs="true" />
    <RenderTarget id="CLOUDS_FINAL" depthBuf="false" numColBufs="1" format="RGBA16F" scale="0.5" applyDrs="true" />
    <RenderTarget id="CLOUDSHADOWS" depthBuf="false" numColBufs="1" format="RED8" scale="0.5" applyDrs="true" />

    <!--Volumetric Targets-->
    <RenderTarget id="VOLUME" depthBuf="false" numColBufs="2" format0="RGBA16F" format1="RED16F"
      scale="0.5" applyDrs="true" pointSampleColBuf0="true" pointSampleColBuf1="true"
      shareTarget0="SCATTER" shareTarget1="LIGHTSHAFT" />

    <RenderTarget id="BLUR1" depthBuf="false" numColBufs="2" format0="RGBA16F" format1="RED16F"
      scale="0.5" applyDrs="true" pointSampleColBuf0="true" pointSampleColBuf1="true"
      shareTarget0="HDRBUF_DOWN_16_1" />

    <RenderTarget id="SCATTER" depthBuf="false" numColBufs="1" format="RGBA16F" scale="0.5"
      applyDrs="true" pointSampleColBuf0="true" />

    <RenderTarget id="LIGHTSHAFT" platforms="MACOS" depthBuf="false" numColBufs="1" format="RED16F" scale="0.5"
      applyDrs="true" pointSampleColBuf0="true" />
    <RenderTarget id="BLUR1_REDONLY" platforms="MACOS" depthBuf="false" numColBufs="1" format="RED16F" scale="0.5"
      applyDrs="true" pointSampleColBuf0="true" allowDcc="false" heapID="3" />

    <RenderTarget id="SCATTERING_VOLUME" depthBuf="false" numColBufs="1" format="RGBA16F" width="8"
      height="8" depth="16" hasMips="false" unorderedAccess="true" />
    <RenderTarget id="SCATTERING_DUMMY" depthBuf="false" numColBufs="1" format="RED8" width="8"
      height="8" hasMips="false" />
    <RenderTarget id="RINGS_BUFF"         depthBuf="false"        numColBufs="1"  format="RGBA16F"  scale="1.0" applyDrs="true" pointSampleColBuf0="false" shareTarget0="HDRBUF_16_0"/>


    <!--Water Targets-->
    <RenderTarget id="WATER_MASK" depthBuf="false" numColBufs="2" format0="RG8" format1="R32FG32F"
      scale="1.0" applyDrs="true" />
    <RenderTarget id="WATER_PROXY_DEPTH" depthBuf="false" numColBufs="1" format="RED32F" scale="1.0"
      applyDrs="true" />
    <RenderTarget id="WATER_PLANAR_REFL_COL"   resScaling = "false" platforms="PC|NEXT|XBOX|PS4|MACOS|IOS" depthBuf="false" numColBufs="1" format="R11FG11FB10F" scaleX="0.25"  scaleY="0.5"  applyDrs="true" allowDcc="true" crossPipeShareId="WATER_PLANAR_REFL_COL" /> 
    <RenderTarget id="WATER_PLANAR_REFL_DEPTH" resScaling = "false" platforms="PC|NEXT|XBOX|PS4|MACOS|IOS" depthBuf="true"  numColBufs="0"                       scaleX="0.25"  scaleY="0.5"  applyDrs="true"                 crossPipeShareId="WATER_PLANAR_REFL_DEPTH" />
    <RenderTarget id="WATER_SCATTER_DEPTH"  platforms="MACOS" depthBuf="true" numColBufs="1" format="RED32F" scaleX="0.25" scaleY="0.125"  applyDrs="true" />
    <RenderTarget id="WATER_SCATTER_ADD"    platforms="MACOS" depthBuf="false" numColBufs="1" format="R11FG11FB10F" scaleX="0.25" scaleY="0.125"  applyDrs="true" />
    <RenderTarget id="WATER_SCATTER_ADD_B"  platforms="MACOS" depthBuf="false" numColBufs="1" format="R11FG11FB10F" scaleX="0.25" scaleY="0.125"  applyDrs="true" />
    <RenderTargetGroup id="WaterSSRTargets" platforms="MACOS">
      <RenderTarget id="WATER_REFL"       depthBuf="false" numColBufs="1" format="RED32UI" scale="1.0" applyDrs="true" pointSampleColBuf0="true" />
      <RenderTarget id="WATER_REFL_FRONT" depthBuf="false" numColBufs="1" format="RED32UI" scale="1.0" applyDrs="true" pointSampleColBuf0="true" />
      <RenderTarget id="WATER_REFL_BACK"  depthBuf="false" numColBufs="1" format="RED32UI" scale="1.0" applyDrs="true" pointSampleColBuf0="true" />
    </RenderTargetGroup>

    <!--Particles Targets-->
    <RenderTarget id="PARTICLES" depthBuf="false" numColBufs="1" format="RGBA16F" bilinear="true"
      scale="0.5" applyDrs="true" shareTarget0="HDRBUF_DOWN_16_0" />


    <RenderTarget id="DEPTH_WATER" depthBuf="true" depthFormat="DEPTH24" depthBufUsesBB="false"
      numColBufs="0" format="RGBA8" scale="1.0" applyDrs="true" stencilBuf="true" heapID="2" />
    <RenderTarget id="DEPTH_WATER_LINEAR" depthBuf="false" numColBufs="1" format="RED32F"
      scale="1.0" applyDrs="true" pointSampleColBuf0="true" heapID="1" />
    <RenderTarget id="DEPTH_WATER_DOWN" depthBuf="false" numColBufs="1" format="RED32F" scale="0.5"
      applyDrs="true" pointSampleColBuf0="true" />

    <!--Tiled Lighting Targets-->
    <RenderTarget id="LIGHTS_DUMMY" depthBuf="false" numColBufs="1" format="RED8"
      pointSampleColBuf="true" scale="0.0625" heapID="1" />
    <RenderTarget id="LIGHTS_TILEBUF" depthBuf="false" numColBufs="1" format="RED32I"
      pointSampleColBuf="true" scaleX="0.5" applyDrs="true" scaleY="1.0" colBufUsesST="true"
      unorderedAccess="true" heapID="3" />

    <!--DOF Targets-->
    <RenderTarget id="DOF_BLURBUF1" depthBuf="false" numColBufs="2" format0="R11FG11FB10F" format1="RED8" scale="0.5" applyDrs="true" shareTarget0="DOF_BUFF_0" />
    <RenderTarget id="DOF_BUFF_0" depthBuf="false" numColBufs="1" format="R11FG11FB10F" scale="0.5" applyDrs="true" shareTarget0="HDRBUF_DOWN_0" />
    <RenderTarget id="DOF_MAXBUF_H" depthBuf="false" numColBufs="1" format="RG8" bilinear="true" scaleX="0.0625" scaleY="0.5" heapID="3" />
    <RenderTarget id="DOF_MAXBUF" depthBuf="false" numColBufs="1" format="RG8" bilinear="true" scale="0.0625" heapID="0" />
    <RenderTarget id="DOF_DOWNSAMPLE" depthBuf="false" numColBufs="2" format0="R11FG11FB10F" format1="RED8" scale="0.5" applyDrs="true" allowDcc="false" />

    <RenderTarget id="MOTION_MAXBUF_H" depthBuf="false" platforms="MACOS" numColBufs="1" format="RGBA16F" scaleX="0.125" scaleY="1.0" applyDrs="true" heapID="1" />
    <RenderTarget id="MOTION_MAXBUF_0" depthBuf="false" platforms="MACOS" numColBufs="1" format="RGBA16F" scale="0.125"  applyDrs="true" />

    <!--Bloom Targets-->
    <RenderTarget id="BLOOM_BLURBUF_2T" depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.5" applyDrs="false" />
    <RenderTarget id="BLOOM_BLURBUF_2A" depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.5" applyDrs="false" />
    <RenderTarget id="BLOOM_BLURBUF_2B" depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.5" applyDrs="false" />
    <RenderTarget id="BLOOM_BLURBUF_4A" depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.25" applyDrs="false" />
    <RenderTarget id="BLOOM_BLURBUF_4B" depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.25" applyDrs="false" />
    <RenderTarget id="BLOOM_BLURBUF_8A" depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.125" applyDrs="false" />
    <RenderTarget id="BLOOM_BLURBUF_8B" depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.125" applyDrs="false" />

    <RenderTarget id="BLOOM_BLURBUF_2A_B" depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.5" applyDrs="false" />
    <RenderTarget id="BLOOM_BLURBUF_2B_B" depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.5" applyDrs="false" />
    <RenderTarget id="BLOOM_BLURBUF_4A_B" depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.25" applyDrs="false" />
    <RenderTarget id="BLOOM_BLURBUF_4B_B" depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.25" applyDrs="false" />
    <RenderTarget id="BLOOM_BLURBUF_8A_B" depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.125" applyDrs="false" />
    <RenderTarget id="BLOOM_BLURBUF_8B_B" depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.125" applyDrs="false" />
    <RenderTarget id="BLOOM_BLURBUF_16"   depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.0625" applyDrs="false" />
    <RenderTarget id="BLOOM_BLURBUF_32"   depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.03125" applyDrs="false" />
    <RenderTarget id="BLOOM_FINALBUF"     depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.25" applyDrs="false" />
    <RenderTarget id="BLOOM_FINALBUF_B"   depthBuf="false" numColBufs="1" format="R11FG11FB10F" bilinear="true" scale="0.25" applyDrs="false" />

    <RenderTarget id="BLOOM_EXPBUF_A" depthBuf="false" numColBufs="1" format="RED8" bilinear="true" scale="1.0" width="4" height="4" applyDrs="false" />
    <RenderTarget id="BLOOM_EXPBUF_B" depthBuf="false" numColBufs="1" format="RED8" bilinear="true" scale="1.0" width="4" height="4" applyDrs="false" />

    <!--Motion Targets-->
    <RenderTarget id="MOTIONRESOLVE" depthBuf="false" numColBufs="1" format="RG16F" scale="1.0" applyDrs="true" pointSampleColBuf0="true" shareTarget0="R16G16_0"/>
    
    <!--Fx Combine Targets-->
    <RenderTarget id="FX_COMBINE_OUT" depthBuf="false" numColBufs="1" format0="RGBA16F" scale="1.0" applyDrs="true" shareTarget0="HDRBUF_16_0" />
    <RenderTarget id="FINAL" depthBuf="false" numColBufs="2" format0="R11FG11FB10F" format1="RED8" scale="1.0" applyDrs="true" shareTarget0="HDRBUF_1" shareBuffer0="0" allowDcc="NEXT" />

    <!-- SSR Targets -->
    <RenderTargetGroup id="SSRTargets" platforms="MACOS">
      <RenderTarget id="SSR_HIT_DATA"     hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="2"  scale="0.5" applyDrs="true" format0="RGBA16F"  format1="R11FG11FB10F"  pointSampleColBuf0="true" shareTarget1="SSR_REFL_TMP" />
      <RenderTarget id="SSR_REFL"         hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  scale="0.5" applyDrs="true" format="R11FG11FB10F"   />
      <RenderTarget id="SSR_REFL_TMP"     hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  scale="0.5" applyDrs="true" format="R11FG11FB10F"   />
      <RenderTarget id="SSR_RESOLVE"      hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  scale="1.0" applyDrs="true" format="R11FG11FB10F" unorderedAccess="true" />
      <RenderTarget id="SSR_DUMMY"        hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  width="8" height="8" applyDrs="true" format="R11FG11FB10F" />
      <RenderTarget id="SSR_HIT_LENGTH"   hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  scale="0.5" applyDrs="true" format="RED16F"         />
      <RenderTarget id="SSR_TEMPORAL_F"   hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="2"  scale="1.0" applyDrs="true" format0="R11FG11FB10F"  format1="R11FG11FB10F" shareTarget1="SSR_CONF_ACC_T_F" />
      <RenderTarget id="SSR_TEMPORAL_H"   hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="2"  scale="1.0" applyDrs="true" format0="R11FG11FB10F"  format1="R11FG11FB10F" shareTarget1="SSR_CONF_ACC_T_H" />
      <RenderTarget id="SSR_RADIANCE"     hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  scale="1.0" applyDrs="true" format="R11FG11FB10F"   pointSampleColBuf0="false" />
      <RenderTarget id="SSR_CONF_ACC_T_F" hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  scale="1.0" applyDrs="true" format="R11FG11FB10F"   pointSampleColBuf0="false" />
      <RenderTarget id="SSR_CONF_ACC_T_H" hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  scale="1.0" applyDrs="true" format="R11FG11FB10F"   pointSampleColBuf0="false" />
      <RenderTarget id="SSR_DEPTH_DOWN"   hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="2"  scale="0.5" applyDrs="true" format0="RG16F"   format1="RED8I"  shareTarget0="DEPTH_HI_LOW_Z"   shareTarget1="SSR_SMP_IDX" />
      <RenderTarget id="SSR_PARAMS"       hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="2"  scale="0.5" applyDrs="true" format0="RG16F"  format1="RED16F" shareTarget0="SSR_RAY_DIR"      shareTarget1="SSR_RAY_PDF" />
      <RenderTarget id="SSR_SMP_IDX"      hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  scale="0.5" applyDrs="true" format="RED8I"   pointSampleColBuf0="true" />
      <RenderTarget id="SSR_RAY_DIR"      hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  scale="0.5" applyDrs="true" format="RG16F" pointSampleColBuf0="true" />
      <RenderTarget id="SSR_RAY_PDF"      hasMips="false"  autoGenMips="false" depthBuf="false" numColBufs="1"  scale="0.5" applyDrs="true" format="RED16F"  pointSampleColBuf0="true" />
      <RenderTarget id="DEPTH_HI_LOW_Z"   depthBuf="false" numColBufs="1"  format="RG16F"   scale="0.5" applyDrs="true" pointSampleColBuf0="true" hasMips="true" autoGenMips="false" mipsSRVs="true" />
      <RenderTarget id="GEO_NORMALS"      depthBuf="false" numColBufs="1"  format="RGB10A2" scale="1.0" applyDrs="true" shareTarget0="RGB10A2_BUF_2"/>
      <RenderTarget id="GN_SWAP_DUMMY"    depthBuf="false" numColBufs="1"  format="RGB10A2" scale="1.0" applyDrs="true" shareTarget0="RGB10A2_BUF_3" />
      <RenderTarget id="MATERIAL_BACK"    depthBuf="false" numColBufs="1"  format="RGBA8"   scale="1.0" applyDrs="true" />
      <RenderTarget id="NORMALS_BACK"     depthBuf="false" numColBufs="1"  format="RGB10A2" scale="1.0" applyDrs="true" />
      <RenderTarget id="RGB10A2_BUF_2"    depthBuf="false" numColBufs="1"  format="RGB10A2" scale="1.0" applyDrs="true" />
      <RenderTarget id="RGB10A2_BUF_3"    depthBuf="false" numColBufs="1"  format="RGB10A2" scale="1.0" applyDrs="true" />
    </RenderTargetGroup>
    
    <!-- GTAO Targets -->
    <RenderTargetGroup id="GTAOTargets" platforms="MACOS">
      <RenderTarget id="GTAO_BUFF_0"  depthBuf="false"  numColBufs="1"  format="RED32UI"  scale="1.0" applyDrs="true" allowDcc="false" pointSampleColBuf="true" />
      <RenderTarget id="GTAO_BUFF_1"  depthBuf="false"  numColBufs="1"  format="RED32UI"  scale="1.0" applyDrs="true" allowDcc="false" pointSampleColBuf="true" />
      <RenderTarget id="GTAO_BUFF_2"  depthBuf="false"  numColBufs="1"  format="RED32UI"  scale="1.0" applyDrs="true" allowDcc="false" pointSampleColBuf="true" />
      <RenderTarget id="GTAO_PACK"    depthBuf="false"  numColBufs="1"  format="RED32UI"  scale="1.0" applyDrs="true" allowDcc="false" pointSampleColBuf="true" shareTarget0="RED32UI_BUF_0" />
      <RenderTarget id="GTAO_MASK"    depthBuf="false"  numColBufs="1"  format="RED32UI"  scale="1.0" applyDrs="true" allowDcc="false" pointSampleColBuf="true" shareTarget0="RED32UI_BUF_0" />
    </RenderTargetGroup>
    <RenderTarget id="RED32UI_BUF_0" depthBuf="false"  numColBufs="1"  format="RED32UI" scale="1.0" applyDrs="true" pointSampleColBuf0="true" allowDcc="false" />

    <!--SSS Targets-->
    <RenderTargetGroup id="ScreenSpaceShadows" platforms="MACOS">
      <RenderTarget id="SSS_TEMP_A"      depthBuf="false"  numColBufs="1" format="RED8"   scale="0.5" applyDrs="true"  allowDcc="NEXT" />
      <RenderTarget id="SSS_TEMP_B"      depthBuf="false"  numColBufs="1" format="RED8"   scale="0.5" applyDrs="true"  allowDcc="NEXT" />
      <RenderTarget id="SSS_FINAL"       depthBuf="false"  numColBufs="1" format="RED8"   scale="1.0" applyDrs="true"  allowDcc="NEXT" />
      <RenderTarget id="SSS_HISTORY"     depthBuf="false"  numColBufs="1" format="RED8"   scale="1.0" applyDrs="true"  allowDcc="NEXT" />    
      <RenderTarget id="DEPTH_SSS_REV_Z" depthBuf="false"  numColBufs="1" format="RED16F" scale="0.5" applyDrs="true"  allowDcc="NEXT" pointSampleColBuf0="true" />
      <!-- Depth Masks -->
      <!--TODO: share with RED32UI_BUF_0 after GTAO is merged -->
      <RenderTarget id="DEPTH_MASK_BUFF"      depthBuf="false" numColBufs="1" format="RED32UI" scale="1.0" applyDrs="true" pointSampleColBuf0="true" />
      <RenderTarget id="DEPTH_MASK_LITE_BUFF" depthBuf="false" numColBufs="1" format="RED8UI"  scale="1.0" applyDrs="true" pointSampleColBuf0="true" />
    </RenderTargetGroup>

    <!-- Refraction Targets -->
    <RenderTargetGroup id="RefractionTargets" platforms="MACOS">
      <RenderTarget id="REFR_DIST_BUF"    depthBuf="false" numColBufs="3" format0="R11FG11FB10F" format1="R11FG11FB10F" format2="RED8" scale="1.0" applyDrs="true" shareTarget0="REFR_COLOUR"  shareBuffer0="0"  shareTarget1="REFR_MAP"   shareBuffer1="0" shareTarget2="REFR_BLEND"   shareBuffer2="0" />
      <RenderTarget id="REFR_MAP"         depthBuf="false" numColBufs="1" format="R11FG11FB10F"  scale="1.0"     applyDrs="true" pointSampleColBuf0="true"    shareBuffer0="0" />
      <RenderTarget id="REFR_BLEND"       depthBuf="false" numColBufs="1" format="RED8"          scale="1.0"     applyDrs="true" pointSampleColBuf0="false"  shareTarget0="RED8_BUF_1"   shareBuffer0="0" />
      <RenderTarget id="REFR_BUF"  depthBuf="false" numColBufs="6" format0="R11FG11FB10F" format1="RED8" format2="R11FG11FB10F" format3="RED8" format4="R11FG11FB10F" format5="RED16F" 
        pointSampleColBuf4="true" pointSampleColBuf5="true" scale="1.0"  applyDrs="true" shareTarget0="REFR_COLOUR" shareBuffer0="0" shareTarget1="REFR_ALPHA" shareBuffer1="0" 
        shareTarget2="REFR_COLOUR_B" shareBuffer2="0" shareTarget3="REFR_ALPHA_B" shareBuffer3="0" shareTarget4="REFR_DIR" shareBuffer4="0" shareTarget5="REFR_DEPTH_REV_Z" shareBuffer5="0" />
      <RenderTarget id="REFR_COLOUR"      depthBuf="false" numColBufs="1" format="R11FG11FB10F"  scale="1.0"     applyDrs="true" pointSampleColBuf0="false"    shareBuffer0="0" />
      <RenderTarget id="REFR_ALPHA"       depthBuf="false" numColBufs="1" format="RED8"          scale="1.0"     applyDrs="true" pointSampleColBuf0="false"  shareTarget0="RED8_BUF_0"   shareBuffer0="0" />
      <RenderTarget id="REFR_COLOUR_B"    depthBuf="false" numColBufs="1" format="R11FG11FB10F"  scale="1.0"     applyDrs="true" pointSampleColBuf0="false"  shareBuffer0="0" />
      <RenderTarget id="REFR_ALPHA_B"     depthBuf="false" numColBufs="1" format="RED8"          scale="1.0"     applyDrs="true" pointSampleColBuf0="false"  shareTarget0="RED8_BUF_1"   shareBuffer0="0" />
      <RenderTarget id="REFR_DIR"         depthBuf="false" numColBufs="1" format="R11FG11FB10F"  scale="1.0"     applyDrs="true" pointSampleColBuf0="true"   shareTarget0="HDRBUF_3"     shareBuffer0="0" />
      <RenderTarget id="REFR_DEPTH_REV_Z" depthBuf="false" numColBufs="1" format="RED16F"        scale="1.0"     applyDrs="true" pointSampleColBuf0="true"   />
      <RenderTarget id="RED8_BUF_1"       depthBuf="false" numColBufs="1" format="RED8"          scale="1.0"     applyDrs="true" />
    </RenderTargetGroup>
    
    <RenderTarget id="SUNOUT_0" depthBuf="false" numColBufs="2" format0="R11FG11FB10F" format1="R11FG11FB10F" scale="1.0" applyDrs="true"  shareTarget0="HDRBUF_0"  shareBuffer0="0"  shareTarget1="HDRBUF_1"   shareBuffer1="0" allowDcc0="true" allowDcc1="NEXT"  />

    <!--HDR Targets-->
    <RenderTarget id="HDRBUF_0" depthBuf="false" numColBufs="1" format="R11FG11FB10F" scale="1.0" applyDrs="true" />
    <RenderTarget id="HDRBUF_1" depthBuf="false" numColBufs="1" format="R11FG11FB10F" scale="1.0" applyDrs="true" />
    <!-- HDRBUF_2 is only used for refractions and SSR, skip it on iOS -->
    <RenderTarget id="HDRBUF_2" platforms="MACOS" depthBuf="false" numColBufs="1" format="R11FG11FB10F" scale="1.0" applyDrs="true" />
    <RenderTarget id="HDRBUF_DOWN_0" depthBuf="false" numColBufs="1" format="R11FG11FB10F" scale="0.5" applyDrs="true" />
    <RenderTarget id="HDRBUF_DOWN_1" depthBuf="false" numColBufs="1" format="R11FG11FB10F" scale="0.5" applyDrs="true" />
    <RenderTarget id="HDRBUF_16_0" depthBuf="false" numColBufs="1" format="RGBA16F" scale="1.0" applyDrs="true" />
    <RenderTarget id="HDRBUF_DOWN_16_0" depthBuf="false" numColBufs="1" format="RGBA16F" scale="0.5" applyDrs="true" />
    <RenderTarget id="HDRBUF_DOWN_16_1" depthBuf="false" numColBufs="1" format="RGBA16F" scale="0.5" applyDrs="true" />

    <RenderTarget id="UPSCALE_OUT_A_0" depthBuf="false" numColBufs="1" format="R11FG11FB10F" scale="1.0" applyDrs="false" unorderedAccess="true" heapID="1" postUpscale="1"/>
    <RenderTarget id="UPS_OUT_B_0" depthBuf="false" numColBufs="1" format="RGB10A2" scale="1.0" applyDrs="false" heapID="2" postUpscale="1"/>

    <!--RGBA8 Targets-->
    <RenderTarget id="RGBA8_BUF_T1_0" depthBuf="false" numColBufs="1" format="RGBA8" scale="1.0" applyDrs="true" />
    <!--R16G16 Targets-->
    <RenderTarget id="R16G16_0" depthBuf="false" numColBufs="1" format="RG16F" scale="1.0" applyDrs="true" />

    <!--Depth  Targets-->
    <RenderTarget id="DEPTH" depthBuf="true" numColBufs="0" format="RGBA8" scale="1.0"
      applyDrs="true" stencilBuf="true" depthFormat="DEPTH24" depthBufUsesBB="false"
      pointSampleColBuf0="true" crossPipeShareId="DEPTH_SHARED" />
    <RenderTarget id="DEPTH_BACK" depthBuf="true" numColBufs="0" format="RGBA8" scale="1.0"
      applyDrs="true" stencilBuf="true" depthFormat="DEPTH24" depthBufUsesBB="false"
      pointSampleColBuf0="true" />
    <RenderTarget id="DEPTH_DOWN_REV_Z" depthBuf="true" numColBufs="0" format="RGBA8" scale="0.5"
      applyDrs="true" stencilBuf="true" depthFormat="DEPTH24" depthBufUsesBB="false"
      pointSampleColBuf0="true" />
    <RenderTarget id="DEPTH_DOWN" depthBuf="false" numColBufs="1" format="RED32F" scale="0.5" applyDrs="true" pointSampleColBuf0="true" crossPipeShareId="DEPTHD_SHARED" />
    <RenderTarget id="DEPTH_PART" depthBuf="false" numColBufs="1" format="RED32F" scale="0.5" applyDrs="true" pointSampleColBuf0="true" />
    <RenderTarget id="DEPTH_LINEAR" depthBuf="false" numColBufs="1" format="RED32F" scale="1.0" applyDrs="true" pointSampleColBuf0="true" crossPipeShareId="DEPTH_LINEAR_SHARED" />
  </Setup>

  <!-- Scene rendering -->
  <CommandQueue>

    <Stage id="InstanceCulling">
      <PrepareInstanceCulling />
      <IssueInstanceCulling viewCount="4" />
    </Stage>    

    <Stage id="Shadow_All_Clear">
    </Stage>
    
    <Stage id="Shadow_0_Clear">
    </Stage>

    <Stage id="ClearOnDRSChange">
      <BeginTarget target="CLOUDS_HISTORY" frameIdx="prev"/>
        <ColourMask channels="RGBA" />
        <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/-1" LoadActionOnDRSChange="true" />
      <EndTarget flushCB="true" flushDB="true" />

      <BeginTarget target="CLOUDS_HISTORY"/>
        <ColourMask channels="RGBA" />
        <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/-1" LoadActionOnDRSChange="true" />
      <EndTarget flushCB="true" flushDB="true" />
      
      <BeginTarget target="GTAO_BUFF_0" depthTarget="DEPTH_BACK" frameIdx="prev"/>
        <ColourMask channels="RGBA" />
        <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" ClearDepthStencil="0/0" DepthAction="Clear/Store" LoadActionOnDRSChange="true" />
      <EndTarget flushCB="true" flushDB="true" />
      
      
      <BeginTarget target="GTAO_BUFF_0" depthTarget="DEPTH" frameIdx="prev"/>
        <ColourMask channels="RGBA" />
        <RenderPass ColorAction0="DontCare/DontCare" ClearDepthStencil="0/0" DepthAction="Clear/Store" LoadActionOnDRSChange="true" />
      <EndTarget flushCB="true" flushDB="true" />

      <BeginTarget target="RGBA8_BUF_T1_0" />
        <ColourMask channels="RGBA" />
        <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" LoadActionOnDRSChange="true" />
      <EndTarget flushCB="true" flushDB="true" />
    </Stage>

    <Stage id="Shadow_0">

      <BeginTarget target="SHADOWBUF" />

      <UpdateShadowMap />
      <ColourMask channels="RGBA" />

      <SetShadowMap index="0" />
      <RenderPass ClearDepthStencil="0/0" DepthAction="Clear/Store" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Mesh"         class="Glow"              context="SHADOW_FADE"          order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="Opaque"            context="SHADOW_FADE"          order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="OpaqueBeforeUI"    context="SHADOW_FADE"          order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="Cutout"            context="SHADOW_FADE"          order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="Highlight"         context="SHADOW_FADE"          order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="HighlightOccluded" context="SHADOW_FADE"          order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="ShadowOnly"        context="SHADOW_FADE"          order="STATECHANGES" />
      <DrawShadowGeometry type="InstanceMesh" class="Opaque"            context="SHADOW_INSTANCE_FADE" order="BACK_TO_FRONT" />
      <DrawShadowGeometry type="InstanceMesh" class="Cutout"            context="SHADOW_INSTANCE_FADE" order="BACK_TO_FRONT" />
      <DrawShadowGeometry type="InstanceMesh" class="Glow"              context="SHADOW_INSTANCE_FADE" order="BACK_TO_FRONT" />

      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Mesh"         class ="DoubleSided"         context="SHADOW_FADE" order="STATECHANGES" />
      <DrawShadowGeometry type="InstanceMesh" class="DoubleSided"          context="SHADOW_INSTANCE_FADE" order="BACK_TO_FRONT" />
      <DrawShadowGeometry type="Mesh"         class="HighlightDoubleSided" context="SHADOW_FADE" order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" />
      <DrawShadowGeometry type="Terrain" class="LOD0" context="SHADOW_FADE" order="BACK_TO_FRONT" />
      <DrawShadowGeometry type="Terrain" class="LOD1" context="SHADOW_FADE" order="BACK_TO_FRONT" />
      <DrawShadowGeometry type="Terrain" class="LOD2" context="SHADOW_FADE" order="BACK_TO_FRONT" />

      <SetShadowMap index="1" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="1" />
      <DrawShadowGeometry type="Mesh"         class="Glow"              context="SHADOW_FADE"          order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="Opaque"            context="SHADOW_FADE"          order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="Cutout"            context="SHADOW_FADE"          order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="Highlight"         context="SHADOW_FADE"          order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="HighlightOccluded" context="SHADOW_FADE"          order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="ShadowOnly"        context="SHADOW_FADE"          order="STATECHANGES" />
      <DrawShadowGeometry type="InstanceMesh" class="Opaque"            context="SHADOW_INSTANCE_FADE" order="BACK_TO_FRONT" />
      <DrawShadowGeometry type="InstanceMesh" class="Cutout"            context="SHADOW_INSTANCE_FADE" order="BACK_TO_FRONT" />
      <DrawShadowGeometry type="InstanceMesh" class="Glow"              context="SHADOW_INSTANCE_FADE" order="BACK_TO_FRONT" />

      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="1" />
      <DrawShadowGeometry type="Mesh"         class="DoubleSided"          context="SHADOW_FADE"          order="STATECHANGES" />
      <DrawShadowGeometry type="InstanceMesh" class="DoubleSided"          context="SHADOW_INSTANCE_FADE" order="BACK_TO_FRONT" />
      <DrawShadowGeometry type="Mesh"         class="HighlightDoubleSided" context="SHADOW_FADE"          order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="1" />
      <DrawShadowGeometry type="Terrain" class="LOD0" context="SHADOW_FADE" order="FRONT_TO_BACK" />
      <DrawShadowGeometry type="Terrain" class="LOD1" context="SHADOW_FADE" order="FRONT_TO_BACK" />
      <DrawShadowGeometry type="Terrain" class="LOD2" context="SHADOW_FADE" order="FRONT_TO_BACK" />

      <SetShadowMap index="2" />
      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="2" />
      <DrawShadowGeometry type="Mesh"         class="Glow"              context="SHADOW_FADE" order="STATECHANGES" /> 
      <DrawShadowGeometry type="Mesh"         class="Opaque"            context="SHADOW_FADE" order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="OpaqueBeforeUI"    context="SHADOW_FADE" order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="Cutout"            context="SHADOW_FADE" order="STATECHANGES" />
      <DrawShadowGeometry type="Mesh"         class="Highlight"         context="SHADOW_FADE" order="STATECHANGES"/> 
      <DrawShadowGeometry type="Mesh"         class="HighlightOccluded" context="SHADOW_FADE" order="STATECHANGES"/>
      <DrawShadowGeometry type="Mesh"         class="ShadowOnly"        context="SHADOW_FADE" order="STATECHANGES"/> 
      <DrawShadowGeometry type="InstanceMesh" class="Opaque"            context="SHADOW_INSTANCE_FADE" order="BACK_TO_FRONT" />
      <DrawShadowGeometry type="InstanceMesh" class="Cutout"            context="SHADOW_INSTANCE_FADE" order="BACK_TO_FRONT" />
      <DrawShadowGeometry type="InstanceMesh" class="Glow"              context="SHADOW_INSTANCE_FADE" order="BACK_TO_FRONT" />

      <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="2" />
      <DrawShadowGeometry type="Mesh"         class="DoubleSided"          context="SHADOW_FADE"          order="STATECHANGES" /> 
      <DrawShadowGeometry type="InstanceMesh" class="DoubleSided"          context="SHADOW_INSTANCE_FADE" order="BACK_TO_FRONT" />
      <DrawShadowGeometry type="Mesh"         class="HighlightDoubleSided" context="SHADOW_FADE"          order="STATECHANGES" /> 

      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="lessEqual" UniformBufferIndex="2" />
      <DrawShadowGeometry type="Terrain" class="LOD0" context="SHADOW_FADE" order="FRONT_TO_BACK"/>
      <DrawShadowGeometry type="Terrain" class="LOD1" context="SHADOW_FADE" order="FRONT_TO_BACK"/>
      <DrawShadowGeometry type="Terrain" class="LOD2" context="SHADOW_FADE" order="FRONT_TO_BACK"/>

      <EndTarget flushCB="false" flushDB="false" />
    </Stage>
    
    <Stage id="Shadow_1_Clear" enabled="false">
    </Stage>
    <Stage id="Shadow_1" enabled="false">
    </Stage>
    <Stage id="Shadow_2_Clear" enabled="false">
    </Stage>
    <Stage id="Shadow_2" enabled="false">
    </Stage>

    <Stage id="Shadow_End">
      <BeginTarget target="SHADOWBUF" />
      <SetShadowMap index="-1" />
      <RenderPass ColorAction0="DontCare/DontCare" ClearColor="0/0/0/0" DepthAction="DontCare/DontCare" />

      <SetDepthBufferControl allowCompression="true" />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>
    

    <Stage id="SpotlightsTiled" enabled="false">
      <BeginTarget target="LIGHTS_TILEBUF" />
      <ColourMask channels="RGBA" />
      <ClearTarget depthBuf="false" colBuf0="true" col_R="0.0" col_G="0.0" col_B="0.0" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />
      <EndTarget flushCB="true" flushDB="false" flushForCompute="true" />

      <BeginTarget target="LIGHTS_DUMMY" />

      <BindBuffer sampler="gLightCluster" sourceRT="LIGHTS_TILEBUF" bufIndex="0" bindAsRwImage="true" />
      <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="replace"
        depthTest="always" />
      <DoDeferredLightLoop context="SPOT_INNER_LIST" inner="true" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace"
        depthTest="always" />
      <DoDeferredLightLoop context="SPOT_OUTER_LIST" inner="false" />

      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Shadow_DS">
      <If conditionType="variable" id="LightShaftsEnabled" />  
        <BeginTarget target="SHADOWBUF_DS" />
        <ColourMask channels="RGBA"/>
        <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Clear/Store" ClearDepthStencil="0/0" />
        <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
        <BindBuffer sampler="gBufferMap"  sourceRT="SHADOWBUF" bufIndex="32" shadowCompare="false" />
        <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY_DEPTH" />
        <UnbindBuffers />
        <EndTarget flushCB="false" flushDB="true" />
      <EndIf/>        
    </Stage>

    <Stage id="MeshWaterComputeDispatch">
      <If>
        <Conditions operation="and">
          <Condition type="variable" id="WaterRenderer" test="notEqual" sourceType="variable" source="WaterRenderer_RayTraced" />
          <Condition type="variable" id="WaterState" test="notEqual" sourceType="variable" source="WaterState_NoWater" />
        </Conditions>
      </If>
      <DoForwardLightLoop type="Water" class="MeshWater" context="CASCADE_WAVE_GERSTNER" order="" />
      <EndIf />
    </Stage>

    <Stage id="AttributesNG" enabled="false">
    </Stage>

    <Stage id="Attributes">
      <BeginTarget target="GBUFFER" depthTarget="DEPTH" enableMotionVectors="true" />
      <RenderPass ColorAction0="Clear/Store" ColorAction1="Clear/Store" ClearColor="1/1/1/1"
        ClearDepthStencil="0/0" DepthAction="Clear/Store" StencilAction="Clear/Store" splitEncoder="true"/>
      <ColourMask channels="RGBA" />
      <!-- Clear targets, colbuf1 is cleared separately to max depth -->
      <DiscardTargetContents colBuf2="true" colBuf3="true" />
      <ClearTarget colBuf0="true" colBuf1="false" colBuf2="false" colBuf3="false" colBuf4="false"
        depthBuf="true" stencilBuf="true" col_R="0.0" col_G="0.0" col_B="0.0" col_A="0.0" />
      <ClearTarget colBuf0="false" colBuf1="true" colBuf2="false" colBuf3="false" colBuf4="false"
        depthBuf="false" stencilBuf="false" col_R="1.0" col_G="1.0" col_B="1.0" col_A="1.0" />

      <ColourMask channels="RGBA" />

      <!-- Opaques-->
      <PushMarker id="Opaques" />

      <ColourMask channels="RGBA" /> <!--Enable
      all attached RTs, since ClearTarget only (re-)enables RT0 on PS4-->

      <CountDrawSamples subCommand="startChecking" index="0" />
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1"/>
      <DrawGeometry type="Mesh" class="Highlight" context="LIT_DEFER" order="STATECHANGES" />
      <DrawGeometry type="Mesh" class="HighlightOccluded" context="LIT_DEFER" order="STATECHANGES" />
      <DrawGeometry type="Mesh" class="Cutout" context="LIT_DEFER" order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1"/>
      <DrawGeometry type="Mesh" class="DoubleSided" context="LIT_DEFER" order="STATECHANGES" />
      <DrawGeometry type="Mesh" class="HighlightDoubleSided" context="LIT_DEFER"
        order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1"/>
      <DrawGeometry type="Mesh" class="Glow" context="LIT_DEFER" order="STATECHANGES" />
      <CountDrawSamples subCommand="stopChecking" index="0" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1" />
      <DrawGeometry type="InstanceMesh" class="Glow" context="LIT_DEFER_INSTANCE" order="MESH" />

      <CountDrawSamples subCommand="startChecking" index="1" />
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="65" stencilMask="65"/>
      <DrawGeometry type="Mesh" class="ScreenSpaceReflections" context="LIT_DEFER"
        order="STATECHANGES"   />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1"/>
      <DrawGeometry type="Mesh" class="OpaqueBeforeUI" context="LIT_DEFER" order="STATECHANGES" />
      <DrawGeometry type="Mesh" class="Opaque" context="LIT_DEFER" order="STATECHANGES" />
      <CountDrawSamples subCommand="stopChecking" index="1" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1"/>
      <DrawGeometry type="InstanceMesh" class="Cutout" context="LIT_DEFER_INSTANCE" order="MESH" />
      <DrawGeometry type="InstanceMesh" class="Opaque" context="LIT_DEFER_INSTANCE" order="MESH" />
      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="1"/>
      <DrawGeometry type="InstanceMesh" class="DoubleSided" context="LIT_DEFER_INSTANCE"
        order="MESH" />

      <PopMarker />

      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="AttributesBelowHeight">
      <BeginTarget target="GBUFFER" depthTarget="DEPTH" />
      <ColourMask channels="RGBA" />

      <PushMarker id="Terrain" />
      <CountDrawSamples subCommand="startChecking" index="1" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="9" />

      <If conditionType="variable" id="RunningOnMac" /> 
        <DrawGeometry type="Terrain" class="LOD0" context="LIT_DEF_F_STC_T_SPLIT" order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain" class="LOD1" context="LIT_DEF_F_STC_T_SPLIT" order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain" class="LOD2" context="LIT_DEF_F_STC_T_SPLIT" order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain" class="LOD0" context="LIT_DEFER_N_FACING" order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain" class="LOD1" context="LIT_DEFER_N_FACING" order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain" class="LOD2" context="LIT_DEFER_N_FACING" order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain" class="LOD3" context="LIT_DEF_F_STC_T_SPLIT" order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain" class="LOD3" context="LIT_DEFER"             order="FRONT_TO_BACK" />
      <Else />
        <DrawGeometry type="Terrain" class="LOD0" context="LIT_DEFER_STL_T_SPLIT" order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain" class="LOD1" context="LIT_DEFER_STL_T_SPLIT" order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain" class="LOD2" context="LIT_DEFER_STL_T_SPLIT" order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain" class="LOD0" context="LIT_DEFER_STL_N_FACING" order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain" class="LOD1" context="LIT_DEFER_STL_N_FACING" order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain" class="LOD2" context="LIT_DEFER_STL_N_FACING" order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain" class="LOD3" context="LIT_DEF_F_STL_T_SPLIT" order="FRONT_TO_BACK" />
        <DrawGeometry type="Terrain" class="LOD3" context="LIT_DEF_F_STL_N_FACING" order="FRONT_TO_BACK" />
      <EndIf />
      
      <CountDrawSamples subCommand="stopChecking" index="1" />
      <CountDrawSamples subCommand="end" />
      <PopMarker />

      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

  <Stage id="AttributesFromHeight" enabled="false">
      <BeginTarget target="GBUFFER" depthTarget="DEPTH" />
      <ColourMask channels="RGBA" />
      <PushMarker id="Terrain" />
      <CountDrawSamples subCommand="startChecking" index="1" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="9" />
      <DrawGeometry type="Terrain" class="LOD0" context="LIT_DEFER_STH_T_SPLIT" order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain" class="LOD1" context="LIT_DEFER_STH_T_SPLIT" order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain" class="LOD2" context="LIT_DEFER_STH_T_SPLIT" order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain" class="LOD0" context="LIT_DEFER_STH_N_FACING" order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain" class="LOD1" context="LIT_DEFER_STH_N_FACING" order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain" class="LOD2" context="LIT_DEFER_STH_N_FACING" order="FRONT_TO_BACK" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="9" />
      <DrawGeometry type="Terrain" class="LOD3" context="LIT_DEF_F_STH_T_SPLIT" order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain" class="LOD3" context="LIT_DEF_F_STH_N_FACING" order="FRONT_TO_BACK" />

      <CountDrawSamples subCommand="stopChecking" index="1" />
      <CountDrawSamples subCommand="end" />
      <PopMarker />

      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="AttributesPostTerrain">
      <BeginTarget target="GBUFFER" depthTarget="DEPTH" />
      <ColourMask channels="RGBA" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="9" />
      <DrawGeometry type="Terrain" class="PLANET" context="LIT_DEFER_LOW" order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain" class="ASTEROID" context="LIT_DEFER_ASTEROID" order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskReadWriteInvert" stencilRef="0" stencilMaskRead="1" stencilMaskWrite="9" />
      <DrawGeometry type="Mesh" class="AtmosphereNear" context="PLANET_NEAR" order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="less" stencilMode="maskWrite" stencilRef="9" />
      <DrawGeometry type="Mesh" class="Atmosphere" context="PLANET" order="STATECHANGES" />
      
      <DrawGeometry type="Mesh" class="AtmosphereGasGiant" context="PLANET_GASGIANT" order="STATECHANGES" />

      <SetContext zwrite="true" colourWrite="false" cullMode="back" blendMode="replace" depthTest="always" />
      <DrawGeometry type="Mesh" class="GunOpaque" context="DEPTH_CLEAR" order="STATECHANGES" />
      <DrawGeometry type="Mesh" class="GunGlow" context="DEPTH_CLEAR" order="STATECHANGES" />
      <DrawGeometry type="Mesh" class="GunDecal" context="DEPTH_CLEAR" order="STATECHANGES" />

      <!-- These aren't real decals, they are just meshes with 2 UV sets which is why they are still
      rendered here. -->
      <!-- <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace"
        depthTest="less" />
      <DrawGeometry type="Mesh" class="GunOpaque" context="LIT_DEFER" order="STATECHANGES" />
      <DrawGeometry type="Mesh" class="GunGlow" context="LIT_DEFER" order="STATECHANGES" />
      <DrawGeometry type="Mesh" class="GunDecal" context="LIT_DEFER" order="STATECHANGES" /> -->

      <EndTarget flushCB="true" flushDB="true" saveZCull="true" />
    </Stage>

    <Stage id="CopyDepth">
      <BeginTarget target="DEPTH_LINEAR"/>
      <RenderPass ColorAction0="DontCare/Store" />
      <ColourMask channels="RGBA" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace"
        depthTest="always" alphaToCoverage="false" />
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH" bufIndex="32" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_REV2LIN" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Decals">
      <BeginTarget target="GBUFFER" depthTarget="DEPTH" readOnlyDepth="true" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_LINEAR" bufIndex="0" />

      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend"
        depthTest="less" />
      <DrawGeometry type="InstanceMesh" class="Decal" context="LIT_DEFER_INSTANCE" order="MESH" />
      <DrawGeometry type="Mesh" class="Decal" context="LIT_DEFER" order="STATECHANGES" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend"
        depthTest="less" stencilMode="maskRead" stencilRef="8" stencilMask="8" />
      <DrawGeometry type="InstanceMesh" class="DecalTerrain" context="LIT_DEFER_INSTANCE"
        order="MESH" />
      <DrawGeometry type="Mesh" class="DecalTerrain" context="LIT_DEFER" order="STATECHANGES" />

      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />

      <SetShadowMap index="-1" />
      <UpdateShadowMap />
    </Stage>

    <Stage id="GTAOPack" enabled="false">
      <If conditionType="variable" id="RunningOnMac" /> 
        <BeginTarget target="GTAO_PACK" />
        <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0"/>
        <ColourMask channels="R" />
        <BindBuffer sampler="gBuffer0Map"   sourceRT="DEPTH"    bufIndex="32" />
        <BindBuffer sampler="gBuffer1Map"   sourceRT="GBUFFER"  bufIndex="3" />
        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_PACK_PARAMS" compute="async_exceptPS4" />
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />
      <EndIf/>
    </Stage>

    <Stage id="GTAOGen" enabled="false">
      <If conditionType="variable" id="RunningOnMac" /> 
      <UpdateVariable id="GTAO_BentNormals" operation="set" value="1" />

      <BeginTarget target="GTAO_BUFF_2" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0"/>
      <ColourMask channels="R"/>
      <BindBuffer sampler="gBuffer0uMap" sourceRT="GTAO_PACK" bufIndex="0" />
      <BindBuffer sampler="gBuffer0Map"  sourceRT="GBUFFER"   bufIndex="2" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" />
      <If conditionType="variable" id="EnableGgx" />
        <If conditionType="variable" id="GTAO_BentNormals" test="equal" value="0" />
          <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Low" />
          <DrawQuad material="materials/AO.material.mbin" context="GTAO_GEN_LOW"       compute="async_exceptPS4" />
          <EndIf/>
          <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Medium" />
          <DrawQuad material="materials/AO.material.mbin" context="GTAO_GEN_MEDIUM"    compute="async_exceptPS4" />
          <EndIf/>
          <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="High" />
          <DrawQuad material="materials/AO.material.mbin" context="GTAO_GEN_HIGH"      compute="async_exceptPS4" />
          <EndIf/>
          <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Ultra" />
          <DrawQuad material="materials/AO.material.mbin" context="GTAO_GEN_ULTRA"     compute="async_exceptPS4" />
          <EndIf/>
        <Else/>
          <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Low" />
          <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_GEN_LOW"    compute="async_exceptPS4" />
          <EndIf/>
          <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Medium" />
          <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_GEN_MEDIUM" compute="async_exceptPS4" />
          <EndIf/>
          <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="High" />
          <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_GEN_HIGH"   compute="async_exceptPS4" />
          <EndIf/>
          <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Ultra" />
          <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_GEN_ULTRA"  compute="async_exceptPS4" />
          <EndIf/>
        <EndIf/>
      <Else/>
        <If conditionType="variable" id="GTAO_BentNormals" test="equal" value="0" />
          <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Low" />
          <DrawQuad material="materials/AO.material.mbin" context="GTAO_GEN_L_L" compute="async_exceptPS4" />
          <EndIf/>
          <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Medium" />
          <DrawQuad material="materials/AO.material.mbin" context="GTAO_GEN_M_L" compute="async_exceptPS4" />
          <EndIf/>
          <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="High" />
          <DrawQuad material="materials/AO.material.mbin" context="GTAO_GEN_H_L" compute="async_exceptPS4" />
          <EndIf/>
          <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Ultra" />
          <DrawQuad material="materials/AO.material.mbin" context="GTAO_GEN_U_L" compute="async_exceptPS4" />
          <EndIf/>
        <Else/>
          <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Low" />
          <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_G_L_L"     compute="async_exceptPS4" />
          <EndIf/>
          <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Medium" />
          <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_G_M_L"     compute="async_exceptPS4" />
          <EndIf/>
          <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="High" />
          <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_G_H_L"     compute="async_exceptPS4" />
          <EndIf/>
          <If conditionType="engineSetting" id="AmbientOcclusion" test="equal" value="Ultra" />
          <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_G_U_L"     compute="async_exceptPS4" />
          <EndIf/>
        <EndIf/>
      <EndIf/>
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>
    
    <Stage id="GTAOSpatial" enabled="false">
      <If conditionType="variable" id="RunningOnMac" />     
        <BeginTarget target="GTAO_BUFF_1" />
        <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0"/>
        <ColourMask channels="R" />
        <BindBuffer sampler="gBuffer0uMap"  sourceRT="GTAO_BUFF_2"  bufIndex="0" />
        <BindBuffer sampler="gBuffer0Map"   sourceRT="DEPTH_LINEAR" bufIndex="0" />
        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" />
        <If conditionType="variable" id="GTAO_BentNormals" test="equal" value="0" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_SPATIAL_H_DENOISE" compute="async_exceptPS4" />
        <Else/>
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_SPTL_H_DENOISE" compute="async_exceptPS4" />
        <EndIf/>
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />

        <BeginTarget target="GTAO_BUFF_2" />
        <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0"/>
        <ColourMask channels="R" />
        <BindBuffer sampler="gBuffer0uMap"  sourceRT="GTAO_BUFF_1"  bufIndex="0" />
        <BindBuffer sampler="gBuffer0Map"   sourceRT="DEPTH_LINEAR" bufIndex="0" />
        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" />
        <If conditionType="variable" id="GTAO_BentNormals" test="equal" value="0" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_SPATIAL_V_DENOISE" compute="async_exceptPS4" />
        <Else/>
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_SPTL_V_DENOISE" compute="async_exceptPS4" />
        <EndIf/>
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>
    
    <Stage id="GTAOOff" enabled="false">
    </Stage>

    <Stage id="DepthDown">
      <BeginTarget target="DEPTH_DOWN" />
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0"/>
      <ColourMask channels="RGBA"/>

      <BindBuffer sampler="gBufferMap"   sourceRT="DEPTH_LINEAR"    bufIndex="0"   />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE_GBUFFERDEPTH" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />    

      

      <If conditionType="variable" id="RunningOnMac" />
        <If conditionType="stage" id="ScreenSpaceShadows" enabled="True" />
          <BeginTarget target="DEPTH_SSS_REV_Z" mipLevel="0" />
          <RenderPass ColorAction0="DontCare/Store" />
          <ColourMask channels="R"/>
          <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH" bufIndex="32" />
          <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="0"/>
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" />
          <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_Z" compute="async" />
          <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="false" />
        <EndIf />
      <EndIf />
    </Stage>

    <Stage id="ScreenSpaceShadows" enabled="false">
      <If conditionType="variable" id="RunningOnMac" />
        <PushMarker id="SSS_March"/>
        <BeginTarget target="SSS_TEMP_A"/>
        <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" />
        <ColourMask channels="R"/>

        <BindBuffer sampler="gBufferMap"        sourceRT="DEPTH_SSS_REV_Z"   bufIndex="0"  />
        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always"/>
        <DrawQuadMT material="materials/Light.material.mbin" context="SSS_MARCH_HIGH" compute="async" />
        <EndTarget flushCB="true" flushDB="false" />
        <PopMarker/>

        <PushMarker id="SSS_Spatial_Filter"/>
        <BeginTarget target="SSS_TEMP_B" />
        <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" />
        <ColourMask channels="R"/>

        <BindBuffer sampler="gBufferMap"  sourceRT="SSS_TEMP_A"   bufIndex="0"   />
        <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN"   bufIndex="0"   />
        <SetContext zwrite="false" blendMode="replace" colourWrite="true" depthTest="always" />
        <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWALT_H_GUASS"  compute="async" />
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />

        <BeginTarget target="SSS_TEMP_A" />
        <ColourMask channels="R"/>
        <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" />

        <BindBuffer sampler="gBufferMap"  sourceRT="SSS_TEMP_B"   bufIndex="0"   />
        <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN"   bufIndex="0"   />
        <SetContext zwrite="false" blendMode="replace" colourWrite="true" depthTest="always" />
        <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWALT_V_GUASS"  compute="async" />
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />
        <PopMarker/>
      <EndIf />
    </Stage> 

    <Stage id="NewCloudsShadows" enabled="false">
      <BeginTarget target="CLOUDSHADOWS" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" />
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace"
        depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="Materials/NewCloud.material.mbin" context="CLOUD_SHADOWS" width="1.0" height="1.0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>
    
    <Stage id="MOTIONRESOLVE">
      <BeginTarget target="MOTIONRESOLVE"  depthTarget="DEPTH" readOnlyDepth="true"  />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" />
      <DiscardTargetContents colBuf0="true" />
      
      <ColourMask channels="RGBA"/>
      
      <BindBuffer sampler="gBufferMap"  sourceRT="GBUFFER"      bufIndex="1" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="GBUFFER"      bufIndex="2" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MOTIONRESOLVE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

    </Stage>

    <Stage id="MOTIONDILATE">
      <SyncGraphicsToCompute compute="async" />
      <BeginTarget target="MOTION_MAXBUF_H" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0"/>
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="MOTIONRESOLVE"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR"   bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MOTIONDILATE_H" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="MOTION_MAXBUF_0" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0"/>
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="MOTION_MAXBUF_H"  bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR"     bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MOTIONDILATE_V" compute="async" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>    
    
    <Stage id="SkyClear" enabled="false">
       <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" readOnlyDepth="true" />
       <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />
       <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Sky">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" readOnlyDepth="true" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />
      <ColourMask channels="RGBA" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0"
        b="0.0" c="0.0" d="0.0" />
      <SetContext zwrite="false" colourWrite="true" blendMode="replace" depthTest="always"
        />
      <DrawQuad material="materials/PostProcess.material.mbin" context="CLEAR" />

      <!-- Space/Night Sky -->
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace"
        depthTest="always" stencilMode="maskRead" stencilRef="0" />
      <BindBuffer sampler="gBufferMap" sourceRT="GBUFFER" bufIndex="2" />
      <DoForwardLightLoop type="Mesh" class="Sky" context="LIGHTING" order="BACK_TO_FRONT" />
      <UnbindBuffers />

      <!-- Starfield -->
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add"
        depthTest="always" stencilMode="maskRead" stencilRef="0" />
      <DrawGeometry type="PStream" class="Opaque" context="PSTREAM_SYSTEM" order="STATECHANGES" />

      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="SunlightShadowed">
      <If>
        <Conditions operation="or">
          <Condition type="variable" id="RunningOnMac" test="equal" value="0" />
          <Condition type="variable" id="LowEnd" test="equal" value="1" />
        </Conditions>
      </If>
        <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />
        <ColourMask channels="RGB" />
        <BindBuffer sampler="gBufferMap" sourceRT="GBUFFER" bufIndex="0" />
        <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
        <BindBuffer sampler="gBuffer2Map" sourceRT="GBUFFER" bufIndex="2" />
        <BindBuffer sampler="gBuffer3Map" sourceRT="GBUFFER" bufIndex="3" />
        <BindBuffer sampler="gShadowMap" sourceRT="SHADOWBUF" bufIndex="32" />
        <BindBuffer sampler="gCloudShadowMap" sourceRT="CLOUDSHADOWS" bufIndex="0" />

        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace"
          depthTest="always" stencilMode="maskReadInvert" stencilMask="9" stencilRef="0" />
        <If conditionType="uniform" material="materials/Light.material.mbin" id="gScanParamsCfg1Vec4"
          index="3" test="equal" value="0" />
        <DrawQuad material="materials/Light.material.mbin" context="SUNLIGHT_SHADOW" />
        <Else />
        <DrawQuad material="materials/Light.material.mbin" context="SUNLIGHT_SHD_SCAN" />
        <EndIf />

        <UnbindBuffers />
        <EndTarget flushCB="false" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="MeshWaterMask">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_MeshedDeferred" />
        <If conditionType="variable" id="WaterState" test="notEqual" sourceType="variable" source="WaterState_NoWater" />
          <BeginTarget target="DEPTH_WATER" />
          <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Clear/Store" StencilAction="Clear/Store" ClearDepthStencil="0/0" />
          <!-- non-depth-tested water external exclusion meshes (always closed surfaces), let's us know
          if we are inside our outside of a proxy mesh (can only be 1 if inside, due to them all being
          closed surfaces) -->
          <SetContext zwrite="true" colourWrite="false" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="false"  stencilMode="maskReadWriteInvertAlways" stencilMaskRead="0" stencilMaskWrite="4" stencilRef="0" />
          <DoForwardLightLoop type="Mesh" class="WaterVolumeProxy" context="DEPTHONLY_FRWRD" order="" />

          <!-- non-depth-tested water internal exclusion meshes (always closed surfaces), let's us know if we are inside our outside of a proxy mesh (can only be 1 if inside, due to them all being closed surfaces) -->
          <SetContext zwrite="false" colourWrite="false" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"  stencilMode="maskReadWriteInvertAlways" stencilMaskRead="0" stencilMaskWrite="4" stencilRef="0" />
          <DoForwardLightLoop type="Mesh" class="WaterVolumeProxyInternal" context="DEPTHONLY_FRWRD" order="" />
          

          <EndTarget flushCB="false" flushDB="true" />

          <BeginTarget target="WATER_PROXY_DEPTH" depthTarget="DEPTH_WATER" readOnlyDepth="true" />
          <ColourMask channels="RGBA" />
          <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"  stencilMode="maskRead" stencilMask="4" stencilRef="4" />          
          <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_WATER" bufIndex="32" />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_REV2LIN" />
          <UnbindBuffers />


          <EndTarget flushCB="true" flushDB="false" />

          <BeginTarget target="WATER_MASK" depthTarget="DEPTH_WATER" />
          <ColourMask channels="RGBA" />
          <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Clear/Store" StencilAction="Load/Store" ClearDepthStencil="0/0" />
          <BindBuffer sampler="gDepthMap" sourceRT="WATER_PROXY_DEPTH" bufIndex="0" />
          <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="false" stencilMode="maskWrite" stencilMask="3" stencilRefFront="1" stencilRefBack="2" />
          <DoForwardLightLoop type="Water" class="MeshWater" context="MESH_WATER_MASK" order="" />
          <UnbindBuffers />

          <!-- depth-tested water exclusion meshes (always closed surfaces), let's us know the number of
          boundaries we pass-through before we "hit" the water surface -->
          <SetContext zwrite="false" colourWrite="false" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="false"  stencilMode="maskReadWriteInvert" stencilMaskRead="0" stencilMaskWrite="8" stencilRef="0" />
          <DoForwardLightLoop type="Mesh" class="WaterVolumeProxy" context="DEPTHONLY_FRWRD" order="" />
          <DoForwardLightLoop type="Mesh" class="WaterVolumeProxyInternal" context="DEPTHONLY_FRWRD" order="" />

          <!-- don't draw water where we are outside of a proxy mesh, but have an odd number of
          depth-tested "hits" -->
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskReadWrite" stencilMaskRead="12" stencilMaskWrite="2" stencilRef="8" />
          <DrawQuadMT material="materials/MeshWater.material.mbin" context="MESH_WATER_ERASE" />

          <!-- don't draw water where we are inside of a proxy mesh, but have an even number of
          depth-tested "hits" -->
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskReadWrite" stencilMaskRead="12" stencilMaskWrite="2" stencilRef="4" />
          <DrawQuadMT material="materials/MeshWater.material.mbin" context="MESH_WATER_ERASE" />

          <EndTarget flushCB="true" flushDB="true" />
        <Else/>
          <BeginTarget target="WATER_MASK" depthTarget="DEPTH_WATER" />
          <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Clear/Store" StencilAction="Load/Store" ClearDepthStencil="0/0" />
          <EndTarget flushCB="true" flushDB="true" />
        <EndIf />
      <EndIf />
    </Stage>

    <Stage id="MeshWaterDepthCopyFrontForVolumetrics">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_MeshedDeferred" />
      <If>
        <Conditions operation="or">
          <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_AboveWater" />
          <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_NearWaterSurface" />
        </Conditions>
      </If>
        <BeginTarget target="DEPTH_WATER_LINEAR" />
        <ColourMask channels="RGBA" />
        <RenderPass ColorAction0="DontCare/Store" />
        <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
        <BindBuffer sampler="gBufferMap" sourceRT="DEPTH" bufIndex="32" />
        <BindBuffer sampler="gBuffer1Map" sourceRT="WATER_MASK" bufIndex="0" />
        <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_WATER" bufIndex="32" />
        <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_REV2LIN_WLESS" />
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />
      <Else />
        <BeginTarget target="DEPTH_WATER_LINEAR" />
        <RenderPass ColorAction0="DontCare/Store" />
        <ColourMask channels="RGBA"/>
        <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
        <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH"  bufIndex="32" />
        <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_REV2LIN" />
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />
      <EndIf />


      <BeginTarget target="DEPTH_WATER_DOWN" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="DontCare/Store" />
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_WATER_LINEAR" bufIndex="0" />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true"  depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE_GBUFFERDEPTH" />
      <UnbindBuffers />
      <EndTarget flushCB="true" />
      <EndIf />
    </Stage>
    

    <Stage id="GTAOTemporal" enabled="false">
      <If conditionType="variable" id="RunningOnMac" /> 
        <BeginTarget target="GTAO_MASK" />
        <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0"/>
        <ColourMask channels="R"/>
        <BindBuffer sampler="gBuffer0Map"  sourceRT="MOTIONRESOLVE"   bufIndex="0"  />
        <BindBuffer sampler="gBuffer1Map"  sourceRT="NORMALS"         bufIndex="0"  />
        <BindBuffer sampler="gBuffer2Map"  sourceRT="DEPTH"           bufIndex="32" />
        <BindBuffer sampler="gBuffer3Map"  sourceRT="DEPTH_BACK"      bufIndex="32" frameIdx="prev" />
        <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_TEMPORAL_MASK" />
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />

        <BeginTarget target="GTAO_BUFF_1" />
        <ColourMask channels="R" />
        <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0"/>
        <BindBuffer sampler="gBuffer0uMap"  sourceRT="GTAO_BUFF_2"      bufIndex="0" />
        <BindBuffer sampler="gBuffer1uMap"  sourceRT="GTAO_BUFF_0"      bufIndex="0" frameIdx="prev" />
        <BindBuffer sampler="gBuffer2uMap"  sourceRT="GTAO_MASK"        bufIndex="0" />
        <BindBuffer sampler="gBuffer0Map"   sourceRT="MOTIONRESOLVE"    bufIndex="0" />
        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" />
        <If conditionType="variable" id="GTAO_BentNormals" test="equal" value="0" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_TEMPORAL_FILTER"   />
        <Else/>
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_TEMPORAL_FILTER" />
        <EndIf/>
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="GTAOCopy" enabled="false">
      <If conditionType="variable" id="RunningOnMac" /> 
        <BeginTarget target="GTAO_BUFF_2" />
        <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0"/>
        <ColourMask channels="R" />
        <BindBuffer sampler="gBuffer0Map" sourceRT="MATERIAL" bufIndex="0" />
        <BindBuffer sampler="gBuffer1Map" sourceRT="BENT"     bufIndex="0" />
        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" />
        <If conditionType="variable" id="GTAO_BentNormals" test="equal" value="0" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_COPY_IN" />
        <Else/>
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_COPY_IN" />
        <EndIf/>
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />

        <BeginTarget target="MAT_BENT" />
        <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0"/>
        <ColourMask channels0="R" channels1="RG" />
        <BindBuffer sampler="gBuffer0uMap" sourceRT="GTAO_BUFF_1" bufIndex="0" />
        <BindBuffer sampler="gBuffer1uMap" sourceRT="GTAO_BUFF_2" bufIndex="0" />
        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" />
        <If conditionType="variable" id="GTAO_BentNormals" test="equal" value="0" />
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_COPY_OUT" />
        <Else/>
        <DrawQuad material="materials/AO.material.mbin" context="GTAO_BN_COPY_OUT" />
        <EndIf/>
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />

        <SwapTargets targetA="GTAO_BUFF_0" targetB="GTAO_BUFF_1" />
      <EndIf />
    </Stage>

    <Stage id="Sunlight">
      <If>
        <Conditions operation="and">
          <Condition type="variable" id="RunningOnMac" test="equal" value="1" />
          <Condition type="variable" id="LowEnd" test="equal" value="0" />
        </Conditions>
      </If>
      <BeginTarget target="SUNOUT_0" depthTarget="DEPTH" onlyStencil="true" />
      <RenderPass ColorAction0="Load/Store" ColorAction1="Load/Store" DepthAction="Load/DontCare" StencilAction="Load/DontCare" />
      <ColourMask channels="RGB" />

      <BindBuffer sampler="gBufferMap" sourceRT="GBUFFER" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="GBUFFER" bufIndex="2" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="GBUFFER" bufIndex="3" />
      <BindBuffer sampler="gBuffer4Map" sourceRT="GBUFFER" bufIndex="4"  />
      <BindBuffer sampler="gShadowMap"  sourceRT="SHADOWBUF" bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap" sourceRT="CLOUDSHADOWS"   bufIndex="0" addressMode="wrap"  />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace"
        depthTest="always" stencilMode="maskReadInvert" stencilMask="1" stencilRef="0" />
      <If conditionType="uniform" material="materials/Light.material.mbin" id="gScanParamsCfg1Vec4" index="3" test="equal" value="0" />
        <If conditionType="variable" id="EnableGgx" />
          <DrawQuadMT material="materials/Light.material.mbin" context="SUN_SPLIT_GGX" />
        <Else />
          <DrawQuad material="materials/Light.material.mbin" context="SUNLIGHT_SPLIT" />
        <EndIf />
      <Else />
        <If conditionType="variable" id="EnableGgx" />
          <DrawQuadMT material="materials/Light.material.mbin" context="SUN_SPLT_SCAN_GGX" />
        <Else />
          <DrawQuad material="materials/Light.material.mbin" context="SUNLIGHT_SPLIT_SCAN" />
        <EndIf />
      <EndIf />

      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
      <EndIf />

    </Stage>

    <Stage id="DepthMasks" enabled="false" >
      <If conditionType="variable" id="RunningOnMac" />
        <If conditionType="engineSetting" id="ShadowQuality" test="lessEqual" value="Medium" />
          <BeginTarget target="DEPTH_MASK_LITE_BUFF" />
        <Else/>
          <BeginTarget target="DEPTH_MASK_BUFF" />
        <EndIf/>
        <RenderPass ColorAction0="DontCare/Store" />
        <ColourMask channels="R"/>

        <BindBuffer sampler="gBufferMap"   sourceRT="MOTIONRESOLVE"   bufIndex="0"  />
        <BindBuffer sampler="gBuffer1Map"  sourceRT="GBUFFER"         bufIndex="2"  />
        <BindBuffer sampler="gBuffer2Map"  sourceRT="DEPTH"           bufIndex="32" />
        <BindBuffer sampler="gBuffer3Map"  sourceRT="DEPTH_DOWN"      bufIndex="0"  />
        <BindBuffer sampler="gBuffer4Map"  sourceRT="DEPTH_BACK"      bufIndex="32" frameIdx="prev" />
        <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" />
        <If conditionType="engineSetting" id="ShadowQuality" test="lessEqual" value="Medium" />
          <DrawQuad material="materials/PostProcess.material.mbin" context="DEPTH_MASK_LITE" />
        <Else/>
          <DrawQuad material="materials/PostProcess.material.mbin" context="DEPTH_MASK" />
        <EndIf/>
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="ScreenSpaceShadowsTemporal" enabled="false">
      <If conditionType="variable" id="RunningOnMac" />
        <SwapTargets targetA="SSS_HISTORY" targetB="SSS_FINAL" />
        <PushMarker id="SSS_Temporal_Filter"/>
        <BeginTarget target="SSS_FINAL" depthTarget="DEPTH" onlyStencil="true" />
        <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" StencilAction="Load/Store" />
        <ColourMask channels="R"/>

        <BindBuffer sampler="gBufferMap"    sourceRT="SSS_TEMP_A"           bufIndex="0"   />
        <BindBuffer sampler="gBuffer1Map"   sourceRT="SSS_HISTORY"          bufIndex="0" frameIdx="prev"  />
        <BindBuffer sampler="gBuffer2Map"   sourceRT="MOTIONRESOLVE"        bufIndex="0"   />
        <If conditionType="engineSetting" id="ShadowQuality" test="lessEqual" value="Medium" />
        <BindBuffer sampler="gBuffer0uMap"  sourceRT="DEPTH_MASK_LITE_BUFF" bufIndex="0"   />
        <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="maskReadInvert" depthTest="always" stencilRef="0" />
        <DrawQuadMT material="materials/Light.material.mbin" context="SSS_TEMPORAL_LITE" />
        <Else/>
        <BindBuffer sampler="gBuffer0uMap"  sourceRT="DEPTH_MASK_BUFF"      bufIndex="0"   />
        <SetContext zwrite="false" blendMode="replace" colourWrite="true" stencilMode="maskReadInvert" depthTest="always" stencilRef="0" />
        <DrawQuadMT material="materials/Light.material.mbin" context="SSS_TEMPORAL" />
        <EndIf/>
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />

        <PopMarker/>
      <EndIf />
    </Stage>

    <Stage id="ShadowApply" >
      <If conditionType="variable" id="RunningOnMac" />
      <If conditionType="variable" id="LowEnd" test="equal" value="0" />
        <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" onlyStencil="true" />
        <ColourMask channels="RGB"  colBuf1="false"  colBuf2="false"  />
        <RenderPass ColorAction0="Load/Store" DepthAction="Load/Store" StencilAction="Load/DontCare" />

        <BindBuffer sampler="gBufferMap"        sourceRT="SUNOUT_0"       bufIndex="1"  />
        <BindBuffer sampler="gBuffer1Map"       sourceRT="DEPTH_LINEAR"   bufIndex="0"  />
        <BindBuffer sampler="gBuffer2Map"       sourceRT="GBUFFER"        bufIndex="2"  />
        <BindBuffer sampler="gBuffer3Map"       sourceRT="GBUFFER"        bufIndex="0"  />
        <BindBuffer sampler="gBuffer4Map"       sourceRT="MATERIAL"       bufIndex="0"  />
        <BindBuffer sampler="gBuffer5Map"       sourceRT="NORMALS"        bufIndex="0"  />
        <BindBuffer sampler="gShadowMap"        sourceRT="SHADOWBUF"      bufIndex="32" />
        <If conditionType="stage" id="ScreenSpaceShadows" enabled="true"/>
          <BindBuffer sampler="gBuffer6Map"       sourceRT="SSS_FINAL"      bufIndex="0"  />
        <EndIf/>
        <BindBuffer sampler="gCloudShadowMap"   sourceRT="CLOUDSHADOWS"   bufIndex="0" addressMode="wrap" />
        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="always" stencilMode="maskReadInvert" stencilMask="1" stencilRef="0"/>

        <If conditionType="variable" id="EnableGgx" />
          <If conditionType="stage" id="ScreenSpaceShadows" enabled="true"/>
            <DrawQuadMT material="materials/Light.material.mbin" context="SH_APPLY_SSS_GGX" />
          <Else/>
            <DrawQuadMT material="materials/Light.material.mbin" context="SH_APPLY_GGX"/>
          <EndIf/>
        <Else/>
          <If conditionType="stage" id="ScreenSpaceShadows" enabled="true"/>
            <DrawQuadMT material="materials/Light.material.mbin" context="SHADOW_APPLY_SSS" />
          <Else/>
            <DrawQuadMT material="materials/Light.material.mbin" context="SHADOW_APPLY"/>
          <EndIf/>
        <EndIf/>

        <UnbindBuffers />
        <EndTarget flushCB="false" flushDB="true" />
      <EndIf />
      <EndIf />
    </Stage>

    <Stage id="Spotlights">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />

      <ColourMask channels="RGB" colBuf1="false" colBuf2="false" />
      <RenderPass ColorAction0="Load/Store" DepthAction="Load/DontCare" StencilAction="Load/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="GBUFFER" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="GBUFFER" bufIndex="2" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="GBUFFER" bufIndex="3" />

      <BindBuffer sampler="gShadowMap" sourceRT="SHADOWBUF" bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap" sourceRT="CLOUDSHADOWS" bufIndex="0" />
      <BeginTiling />
      <If conditionType="variable" id="EnableGgx" />
        <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="add"
        stencilMode="maskReadInvert" stencilMask="9" stencilRef="0" depthTest="greaterEqual" />
        <DoDeferredLightLoop context="SPOT_INNER_GGX"  inner="true"/>

        <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add"
        stencilMode="maskReadInvert" stencilMask="9" stencilRef="0" depthTest="less" />
        <DoDeferredLightLoop context="SPOT_OUTER_GGX"  inner="false"/>
      <Else />
      <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="add"
        stencilMode="maskReadInvert" stencilMask="9" stencilRef="0" depthTest="greaterEqual" />
        <DoDeferredLightLoop context="SPOTLIGHT_INNER" inner="true"/>

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add"
        stencilMode="maskReadInvert" stencilMask="9" stencilRef="0" depthTest="less" />
        <DoDeferredLightLoop context="SPOTLIGHT_OUTER" inner="false"/>
      <EndIf />
      <EndTiling />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="SpotlightsSplit" enabled="false">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" readOnlyDepth="true" />

      <ColourMask channels="RGB" colBuf1="false" colBuf2="false" />
      <RenderPass ColorAction0="Load/Store" DepthAction="Load/DontCare" StencilAction="Load/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="GBUFFER" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH" bufIndex="32" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="GBUFFER" bufIndex="2" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="GBUFFER" bufIndex="3" />
      <BindBuffer sampler="gShadowMap" sourceRT="SHADOWBUF" bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap" sourceRT="CLOUDSHADOWS" bufIndex="0" />
      <BeginTiling />
      <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="add" stencilMode="maskReadInvert" stencilMask="9" stencilRef="0" depthTest="greaterEqual" />
      
      <PushMarker id="SpotLightsInner" />
      <DoDeferredLightLoop context="SPOT_K_IN" selective="true" volumetric="false" inner="true" spot="true" constant="true" cookie="false" />
      <DoDeferredLightLoop context="SPOT_L_IN" selective="true" volumetric="false" inner="true" spot="true" linear="true" cookie="false" />
      <DoDeferredLightLoop context="SPOT_R_IN" selective="true" volumetric="false" inner="true" spot="true" linear_sqrt="true" cookie="false" />
      <DoDeferredLightLoop context="SPOT_Q_IN" selective="true" volumetric="false" inner="true" spot="true" quadratic="true" cookie="false" />
      <DoDeferredLightLoop context="SPOT_C_IN" selective="true" volumetric="false" inner="true" spot="true" cubic="true" cookie="false" />
      <DoDeferredLightLoop context="SPOT_E_IN" selective="true" volumetric="false" inner="true" spot="true" custom="true" cookie="false" />
      <PopMarker />

      <PushMarker id="SpotLightsInnerCookie" />
      <DoDeferredLightLoop context="SPOT_K_CK_IN" selective="true" volumetric="false" inner="true" spot="true" constant="true" cookie="true" />
      <DoDeferredLightLoop context="SPOT_L_CK_IN" selective="true" volumetric="false" inner="true" spot="true" linear="true" cookie="true" />
      <DoDeferredLightLoop context="SPOT_R_CK_IN" selective="true" volumetric="false" inner="true" spot="true" linear_sqrt="true" cookie="true" />
      <DoDeferredLightLoop context="SPOT_Q_CK_IN" selective="true" volumetric="false" inner="true" spot="true" quadratic="true" cookie="true" />
      <DoDeferredLightLoop context="SPOT_C_CK_IN" selective="true" volumetric="false" inner="true" spot="true" cubic="true" cookie="true" />
      <DoDeferredLightLoop context="SPOT_E_CK_IN" selective="true" volumetric="false" inner="true" spot="true" custom="true" cookie="true" />
      <PopMarker />

      <PushMarker id="PointLightsInner" />
      <DoDeferredLightLoop context="POINT_K_IN" selective="true" volumetric="false" inner="true" point="true" constant="true" />
      <DoDeferredLightLoop context="POINT_L_IN" selective="true" volumetric="false" inner="true" point="true" linear="true" />
      <DoDeferredLightLoop context="POINT_R_IN" selective="true" volumetric="false" inner="true" point="true" linear_sqrt="true" />
      <DoDeferredLightLoop context="POINT_Q_IN" selective="true" volumetric="false" inner="true" point="true" quadratic="true" />
      <DoDeferredLightLoop context="POINT_C_IN" selective="true" volumetric="false" inner="true" point="true" cubic="true" />
      <DoDeferredLightLoop context="POINT_E_IN" selective="true" volumetric="false" inner="true" point="true" custom="true" />
      <PopMarker />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" stencilMode="maskReadInvert" stencilMask="9" stencilRef="0" depthTest="less" />
      <PushMarker id="SpotLightsOuter" />
      <DoDeferredLightLoop context="SPOT_K_OUT" selective="true" volumetric="false" inner="false" spot="true" constant="true" cookie="false" />
      <DoDeferredLightLoop context="SPOT_L_OUT" selective="true" volumetric="false" inner="false" spot="true" linear="true" cookie="false" />
      <DoDeferredLightLoop context="SPOT_R_OUT" selective="true" volumetric="false" inner="false" spot="true" linear_sqrt="true" cookie="false" />
      <DoDeferredLightLoop context="SPOT_Q_OUT" selective="true" volumetric="false" inner="false" spot="true" quadratic="true" cookie="false" />
      <DoDeferredLightLoop context="SPOT_C_OUT" selective="true" volumetric="false" inner="false" spot="true" cubic="true" cookie="false" />
      <DoDeferredLightLoop context="SPOT_E_OUT" selective="true" volumetric="false" inner="false" spot="true" custom="true" cookie="false" />
      <PopMarker />

      <PushMarker id="SpotLightsOuterCookie" />
      <DoDeferredLightLoop context="SPOT_K_CK_OUT" selective="true" volumetric="false" inner="false" spot="true" constant="true" cookie="true" />
      <DoDeferredLightLoop context="SPOT_L_CK_OUT" selective="true" volumetric="false" inner="false" spot="true" linear="true" cookie="true" />
      <DoDeferredLightLoop context="SPOT_R_CK_OUT" selective="true" volumetric="false" inner="false" spot="true" linear_sqrt="true" cookie="true" />
      <DoDeferredLightLoop context="SPOT_Q_CK_OUT" selective="true" volumetric="false" inner="false" spot="true" quadratic="true" cookie="true" />
      <DoDeferredLightLoop context="SPOT_C_CK_OUT" selective="true" volumetric="false" inner="false" spot="true" cubic="true" cookie="true" />
      <DoDeferredLightLoop context="SPOT_E_CK_OUT" selective="true" volumetric="false" inner="false" spot="true" custom="true" cookie="true" />
      <PopMarker />

      <PushMarker id="PointLightsOuter" />
      <DoDeferredLightLoop context="POINT_K_OUT" selective="true" volumetric="false" inner="false" point="true" constant="true" />
      <DoDeferredLightLoop context="POINT_L_OUT" selective="true" volumetric="false" inner="false" point="true" linear="true" />
      <DoDeferredLightLoop context="POINT_R_OUT" selective="true" volumetric="false" inner="false" point="true" linear_sqrt="true" />
      <DoDeferredLightLoop context="POINT_Q_OUT" selective="true" volumetric="false" inner="false" point="true" quadratic="true" />
      <DoDeferredLightLoop context="POINT_C_OUT" selective="true" volumetric="false" inner="false" point="true" cubic="true" />
      <DoDeferredLightLoop context="POINT_E_OUT" selective="true" volumetric="false" inner="false" point="true" custom="true" />
      <PopMarker />

      <EndTiling />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="SpotlightsTiledFS" enabled="false">

      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />
      <ColourMask channels="RGB" colBuf1="false" colBuf2="false" />
      <RenderPass ColorAction0="Load/Store" DepthAction="Load/DontCare" StencilAction="Load/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="GBUFFER" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="GBUFFER" bufIndex="2" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="GBUFFER" bufIndex="3" />
      <BindBuffer sampler="gLightCluster" sourceRT="LIGHTS_TILEBUF" bufIndex="0" bindAsRwImage="true" />
      <BindBuffer sampler="gShadowMap" sourceRT="SHADOWBUF" bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap" sourceRT="CLOUDSHADOWS" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" />
      <If conditionType="variable" id="EnableGgx" />
        <DoDeferredLightLoopMulti context="SPOT_MULTI_GGX"  inner="true"/>
      <Else />
        <DoDeferredLightLoopMulti context="SPOT_MULTI"      inner="true"/>
      <EndIf />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="MeshWaterWireframe">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable"
        source="WaterRenderer_MeshedWireframe" />
      <If conditionType="variable" id="WaterState" test="notEqual" sourceType="variable"
        source="WaterState_NoWater" />
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace"
        depthTest="less" alphaToCoverage="false" fillMode="wireframe" />

      <DoForwardLightLoop type="Water" class="MeshWater" context="MESH_WATER" order="BACK_TO_FRONT" />

      <UnbindBuffers />

      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
      <EndIf />
    </Stage>

    <Stage id="VolumetricPlanetRings">
      <BeginTarget target="RINGS_BUFF" depthTarget="DEPTH" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_WATER_LINEAR" bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="front" depthTest="lessEqual" blendMode="add" />
      <DoForwardLightLoop type="Mesh" class="Atmosphere" context="SCATTERING" order="FRONT_TO_BACK" />

      <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="blend" depthTest="less" />
      <DoForwardLightLoop type="Mesh"    class="RingsBelow"         context="RINGS_BELOW"  order="BACK_TO_FRONT" />
      <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="blend" depthTest="always" />
      <DoForwardLightLoop type="Mesh"    class="RingsAmid"          context="RINGS_AMID"   order="BACK_TO_FRONT" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="blend" depthTest="less"  />
      <DoForwardLightLoop type="Mesh"    class="RingsAbove"         context="RINGS_ABOVE"  order="BACK_TO_FRONT" />

      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="VolumetricsForWorlds" deferrable="true">
      <BeginTarget target="VOLUME" />
      <ColourMask channels="RGBA" colBuf1="false" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" />

      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />
      <BindBuffer sampler="gShadowMap" sourceRT="SHADOWBUF_DS"     bufIndex="32" />

      <SetContext zwrite="false" colourWrite="true" cullMode="front" depthTest="always" blendMode="add" />
      <DoForwardLightLoop type="Mesh" class="AtmosphereNear" context="SCATTER_MASK" order="FRONT_TO_BACK" />
      
      <SetContext zwrite="false" colourWrite="true" depthTest="always" blendMode="add" />
      <If conditionType="variable" id="LightShaftsEnabled" />              
        <DrawQuadMT material="materials/Light.material.mbin" context="SCATTERING"  />
      <Else />
        <DrawQuadMT material="materials/Light.material.mbin" context="SCATTERING_NOGR" />        
      <EndIf />      
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLUR1" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" />
      <BindBuffer sampler="gBufferMap" sourceRT="VOLUME" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_H_GUASS" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="VOLUME" />
      <RenderPass ColorAction0="Load/Store" ColorAction1="DontCare/DontCare" ClearColor="0/0/0/0" />
      <ColourMask channels="RGBA" colBuf1="false" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLUR1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_V_GUASS" />
      
      <BindBuffer sampler="gBufferMap" sourceRT="RINGS_BUFF" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="front" blendMode="Blend_PostMultAlpha" depthTest="always" />
      <DrawQuad material="Materials/PostProcess.material.mbin" context="DOWN_8TAP_W" width ="1.0" height="1.0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="SCATTERING_DUMMY" />
      <RenderPass ColorAction0="DontCare/DontCare" />
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" bindAsRwImage="true" />
      <SetContext zwrite="false" colourWrite="false" blendMode="replace" depthTest="always" />
      <DrawQuadMT material="materials/Light.material.mbin" context="SCATTERING_VOLUME" />
      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="PlanetCloud">

      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" />

      <!--Cloud sphere around planets-->
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="lessEqual" />
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <DoForwardLightLoop type="Mesh" class="Atmosphere" context="CLOUDSHADOW" order="BACK_TO_FRONT" />

      <ColourMask channels="RGB" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="lessEqual" />
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <DoForwardLightLoop type="Mesh" class="Atmosphere" context="CLOUD" order="BACK_TO_FRONT" />

      <EndTarget flushCB="false" flushDB="false" />

    </Stage>

    <Stage id="CloudsForWorlds" enabled="false">
      <!-- Depth Downsample - note we can't use the current down-sample, since Water
      may have written to the real Depth Buffer -->

      <PushMarker id="March" />
      <BeginTarget target="CLOUDS_MRT" depthTarget="DEPTH_DOWN_REV_Z" onlyStencil="true" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/-1" DepthAction="Load/DontCare" StencilAction="Clear/Store" ClearDepthStencil="0/0" />
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace"
        depthTest="always" stencilMode="maskWrite" stencilRef="32" stencilMask="32" />
      <If conditionType="variable" id="CloudQuality" test="equal" sourceType="variable"
        source="CloudQuality_Low" />
      <DrawQuad material="Materials/NewCloud.material.mbin" context="LOW_QUALITY_CLOUDS" width ="1.0" height="1.0"/>
      <Else />
      <If conditionType="variable" id="CloudQuality" test="equal" sourceType="variable"
        source="CloudQuality_Mid" />
      <DrawQuad material="Materials/NewCloud.material.mbin" context="MID_QUALITY_CLOUDS" width ="1.0" height="1.0"/>
      <Else />
      <DrawQuad material="Materials/NewCloud.material.mbin" context="HIGH_QUALITY_CLOUDS" width ="1.0" height="1.0"/>
      <EndIf />
      <EndIf />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <PopMarker />

      <PushMarker id="Filters" />
      <SwapTargets targetA="CLOUDS_FINAL" targetB="CLOUDS_HISTORY" />

      <BeginTarget target="CLOUDS_FINAL" depthTarget="DEPTH_DOWN_REV_Z" onlyStencil="true" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/-1" DepthAction="Load/DontCare" StencilAction="Load/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="CLOUDS_DEPTH" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="CLOUDS_COLOUR" bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="CLOUDS_HISTORY" bufIndex="0" frameIdx="prev" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="32" stencilMask="32" />
      <DrawQuad material="Materials/NewCloud.material.mbin" context="CLOUDS_TEMPORAL" width="1.0" height="1.0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="CLOUDS_COLOUR" depthTarget="DEPTH_DOWN_REV_Z" onlyStencil="true" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" StencilAction="Load/DontCare"  />
      <BindBuffer sampler="gBufferMap" sourceRT="CLOUDS_FINAL" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="32" stencilMask="32" />
      <DrawQuad material="Materials/NewCloud.material.mbin" context="CLOUDS_BLUR_V" width="1.0" height="1.0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="CLOUDS_FINAL" depthTarget="DEPTH_DOWN_REV_Z" onlyStencil="true" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" StencilAction="Load/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="CLOUDS_COLOUR" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="32" stencilMask="32" />
      <DrawQuad material="Materials/NewCloud.material.mbin" context="CLOUDS_BLUR_H" width="1.0" height="1.0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <PopMarker />

      <BeginTarget target="SCATTER" depthTarget="DEPTH_DOWN_REV_Z" onlyStencil="true" />

      <PushMarker id="Cirrus" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="Load/Store" DepthAction="Load/DontCare" StencilAction="Load/DontCare" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="Blend_PostMultAlpha" depthTest="always" alphaToCoverage="false" />
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />
      <DrawQuad material="Materials/NewCloud.material.mbin" context="CIRRUS_CLOUDS" width ="1.0" height="1.0" />
      <PopMarker />

      <PushMarker id="Copy" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="Blend_PostMultAlpha" depthTest="always" stencilMode="maskRead" stencilRef="32" stencilMask="32" />
      <BindBuffer sampler="gBufferMap" sourceRT="CLOUDS_FINAL" bufIndex="0" />
      <DrawQuad material="Materials/NewCloud.material.mbin" context="CLOUDS_COPY" width ="1.0" height="1.0" />
      <UnbindBuffers />

      <ColourMask channels="A" />
      <BindBuffer sampler="gBufferMap" sourceRT="CLOUDS_FINAL" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="max" depthTest="always" stencilMode="maskRead" stencilRef="32" stencilMask="32" />
      <DrawQuad material="materials/NewCloud.material.mbin" context="CLOUDS_COPY" width ="1.0" height="1.0" />
      <UnbindBuffers />
      <PopMarker />

      <PushMarker id="Rainbow" />
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gShadowMap" sourceRT="SHADOWBUF" bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap" sourceRT="CLOUDSHADOWS" bufIndex="0" addressMode="wrap" />
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="Blend_PostMultAlpha" depthTest="always" />
      <DoForwardLightLoop type="Mesh" class="Rainbow" context="RAINBOW" order="BACK_TO_FRONT" />
      <UnbindBuffers />
      <PopMarker />

      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="BlackHole">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" />
      <BindBuffer sampler="gShadowMap" sourceRT="SHADOWBUF" bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap" sourceRT="CLOUDSHADOWS" bufIndex="0" addressMode="wrap" />
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" />
      <DoForwardLightLoop type="Mesh" class="BlackHoleBack" context="LIT_FORWARD" order="STATECHANGES" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="TerrainEdits" enabled="false">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />
      <ColourMask channels="RGBA" />
      <!-- Terrain Edits -->
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DrawGeometry type="Terrain" class="LOD0" context="EDITS" order="FRONT_TO_BACK" />
      <!--
      <DrawGeometry type="Terrain"      class="LOD0"      context="EDITS_CACHE_FB"  order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="EDITS_TESS_FB"   order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="EDITS_CACHE"     order="FRONT_TO_BACK" />
      <DrawGeometry type="Terrain"      class="LOD0"      context="EDITS_TESS"      order="FRONT_TO_BACK" />
      -->
      <DrawGeometry type="Terrain" class="LOD1" context="EDITS" order="FRONT_TO_BACK" />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="MeshWaterStencil">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable"
        source="WaterRenderer_MeshedDeferred" />
      <If conditionType="variable" id="WaterState" test="notEqual" sourceType="variable"
        source="WaterState_NoWater" />
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" onlyStencil="true" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" StencilAction="Load/Store" />
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gDepthMap" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <BindBuffer sampler="gWaterDepth" sourceRT="DEPTH_WATER" bufIndex="32" />
      <BindBuffer sampler="gWaterMask" sourceRT="WATER_MASK" bufIndex="0" />

      <!-- exists to prevent volumetrics from being applied until after we have rendered water -->
      <If>
        <Conditions operation="or">
          <Condition type="variable" id="WaterState" test="equal" sourceType="variable"
            source="WaterState_AboveWater" />
          <Condition type="variable" id="WaterState" test="equal" sourceType="variable"
            source="WaterState_NearWaterSurface" />
        </Conditions>
      </If>
      <SetContext zwrite="false" colourWrite="false" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskWrite" stencilMask="1" stencilRef="1" />
      <DrawQuadMT material="materials/MeshWater.material.mbin" context="MESH_WATER_ST_FRONT" />
      <EndIf />

      <!-- exists to prevent refractive transparencies from being applied where we have an
      underwater mesh... a bit of a gross hack, ideally we replace this with a unified WATER & MAIN
      DEPTH depth target , and volumetrics being delayed for opaques-->
      <If>
        <Conditions operation="or">
          <Condition type="variable" id="WaterState" test="equal" sourceType="variable"
            source="WaterState_BelowWater" />
          <Condition type="variable" id="WaterState" test="equal" sourceType="variable"
            source="WaterState_NearWaterSurface" />
        </Conditions>
      </If>
      <SetContext zwrite="false" colourWrite="false" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskWrite" stencilMask="21" stencilRef="0" />
      <DrawQuadMT material="materials/MeshWater.material.mbin" context="MESH_WATER_ST_BACK" />
      <EndIf />

      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
      <EndIf />
    </Stage>

    <Stage id="LightShafts">
      <If conditionType="variable" id="LightShaftsEnabled" />
      <BeginTarget target="LIGHTSHAFT" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" StencilAction="DontCare/DontCare" />
      <ColourMask channels="R" />
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />
      <BindBuffer sampler="gShadowMap" sourceRT="SHADOWBUF_DS" bufIndex="32" />
      <SetContext zwrite="false" colourWrite="true"  depthTest="always"
        blendMode="replace" />
      <DrawQuadMT material="materials/Light.material.mbin" context="RAYMARCH" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="LightShaftsBlur">
      <If conditionType="variable" id="LightShaftsBlurEnabled" />
      <BeginTarget target="BLUR1_REDONLY" />
      <RenderPass ColorAction0="DontCare/Store" />
      <DiscardTargetContents colBuf0="true" />
      <ColourMask channels="R" />
      <BindBuffer sampler="gBufferMap" sourceRT="LIGHTSHAFT" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />
      <SetContext zwrite="false" blendMode="replace" colourWrite="true" 
        depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin"
        context="DEPTH_AWARE_H_REDONLY_GUASS" />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="VOLUME" />
      <RenderPass ColorAction0="Load/Store" />
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLUR1_REDONLY" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN" bufIndex="0" />
      <!-- This is a very weird one... lightshafts were originally additively blended in a bespoke
      pass onto the main scene *after* the
           the volumetrics had already been applied. However - as a performance saving it makes sense to write
      the light shafts directly into
           the volumetrics buffer and blend them both into the main scene together. However - the volumetrics
      were previously done through a normal
           alpha blend. To resolve this - when blending the light shafts into the volumetrics buffer, we
      pre-multiply the volumetrics colour values
           by their own alpha (whilst still preserving that alpha value) - we then additively blend the light
      shafts into the VOLUME target.
           When blending the VOLUME target into the main scene - we do an additive blend of the VOLUME into
      HDRBUF0, where the dst has (1 - srcAlpha)
           applied -->
      <SetContext zwrite="false" blendMode="Blend_AddPremulDst" colourWrite="true" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin"
        context="DEPTH_AWARE_VGAUSS_SHAFT_APPLY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="MeshWaterPostProcessAbove">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_MeshedDeferred" />
      <If>
        <Conditions operation="or">
          <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_AboveWater" />
          <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_NearWaterSurface" />
        </Conditions>
      </If>

      <If conditionType="variable" id="RunningOnMac" />
        <If conditionType="variable" id="WaterReflections" test="notEqual" sourceType="variable" source="WaterReflections_Disabled" />
          <BeginTarget target="WATER_REFL" depthTarget="DEPTH_WATER" onlyStencil="true" readOnlyDepth="true" />
          <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" StencilAction="Load/DontCare" />
          <ColourMask channels="RGB" />
          
          <BindBuffer sampler="gReflectionMap"        sourceRT="WATER_PLANAR_REFL_COL" bufIndex="0"/>
          <BindBuffer sampler="gReflectionDepthMap"   sourceRT="WATER_PLANAR_REFL_DEPTH" bufIndex="32"/>
          <BindBuffer sampler="gScatteringVolume3D"   sourceRT="SCATTERING_VOLUME" bufIndex="0" />
          <BindBuffer sampler="gDepthMap"             sourceRT="DEPTH_LINEAR"   bufIndex="0"  />
          <BindBuffer sampler="gWaterDepth"           sourceRT="DEPTH_WATER"    bufIndex="32" />
          <BindBuffer sampler="gBufferMap"            sourceRT="HDRBUF_0"       bufIndex="0" />
          <BindBuffer sampler="gWaterMask"            sourceRT="WATER_MASK"     bufIndex="0"  />
          <BindBuffer sampler="gWaterPlanePosition"   sourceRT="WATER_MASK"     bufIndex="1"  />
          <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="1" stencilMask="1" />
          <DrawQuadMT material="materials/MeshWater.material.mbin" context="M_WATER_REFL" />
          <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="false" />

          <If conditionType="variable" id="WaterReflections" test="equal" sourceType="variable" source="WaterReflections_FullSSR" />
            <BeginTarget target="WATER_REFL_FRONT" depthTarget="DEPTH_WATER" onlyStencil="true" readOnlyDepth="true" />
            <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" StencilAction="Load/DontCare" />
            <ColourMask channels="RGB" />
            <BindBuffer sampler="gReflBlendedMap"       sourceRT="WATER_REFL"       bufIndex="0"  />
            <BindBuffer sampler="gReflBlendedPrevMap"   sourceRT="WATER_REFL_BACK"  bufIndex="0"  frameIdx="prev" />
            <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />
            <BindBuffer sampler="gWaterDepth"           sourceRT="DEPTH_WATER"      bufIndex="32" />
            <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="1" stencilMask="1" />
            <DrawQuad material="materials/MeshWater.material.mbin" context="M_WATER_REFL_TEMP" />
            <EndTarget flushCB="true" flushDB="false" />

            <BeginTarget target="WATER_REFL_BACK" depthTarget="DEPTH_WATER" onlyStencil="true" readOnlyDepth="true" />
            <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" StencilAction="Load/DontCare" />
            <ColourMask channels="RGB" />
            <BindBuffer sampler="gReflBlendedMap"       sourceRT="WATER_REFL_FRONT" bufIndex="0"  />
            <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="1" stencilMask="1" />
            <DrawQuad material="materials/MeshWater.material.mbin" context="M_WATER_REFL_COPY" />
            <EndTarget flushCB="true" flushDB="false" />
          <EndIf />
        <EndIf />
      <EndIf />

      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH_WATER" onlyStencil="true" readOnlyDepth="true" />
      <ColourMask channels="RGB" />
      <RenderPass ColorAction0="Load/Store" DepthAction="Load/Store" StencilAction="Load/DontCare" />

      <BindBuffer sampler="gDepthMap" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_0" bufIndex="0" />
      <BindBuffer sampler="gReflectionMap"        sourceRT="WATER_PLANAR_REFL_COL" bufIndex="0"/>
      <BindBuffer sampler="gReflectionDepthMap"   sourceRT="WATER_PLANAR_REFL_DEPTH" bufIndex="32"/>
      <If conditionType="variable" id="WaterReflections" test="equal" sourceType="variable" source="WaterReflections_FullSSR" />
        <BindBuffer sampler="gReflBlendedMap"       sourceRT="WATER_REFL_FRONT" bufIndex="0" />
      <EndIf />
      <If conditionType="variable" id="WaterReflections" test="equal" sourceType="variable" source="WaterReflections_PlanarSSR" />
        <BindBuffer sampler="gReflBlendedMap"       sourceRT="WATER_REFL" bufIndex="0" />
      <EndIf />
      <BindBuffer sampler="gShadowMap" sourceRT="SHADOWBUF" bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap" sourceRT="CLOUDSHADOWS" bufIndex="0" addressMode="wrap" />
      <BindBuffer sampler="gWaterDepth" sourceRT="DEPTH_WATER" bufIndex="32" />
      <BindBuffer sampler="gWaterMask" sourceRT="WATER_MASK" bufIndex="0" />
      <BindBuffer sampler="gWaterPlanePosition" sourceRT="WATER_MASK" bufIndex="1" />
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="1" stencilMask="1" />
      <DrawQuadMT material="materials/MeshWater.material.mbin" context="M_ABOVE_WATER" />

      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH_WATER" onlyStencil="true" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_1" bufIndex="0" />
      <SetContext zwrite="false" blendMode="blend" colourWrite="true" depthTest="always"
        stencilMode="maskRead" stencilRef="1" stencilMask="1" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY_NONZERO" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      
      <EndIf />
      <EndIf />
    </Stage>

    <Stage id="VolumetricsUPS">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />
      <RenderPass ColorAction0="Load/Store" DepthAction="Load/DontCare" StencilAction="Load/DontCare" />
      <!-- upsample Volumetrics -->
      <BindBuffer sampler="gBufferMap"  sourceRT="VOLUME"        bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_WATER_DOWN"    bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_WATER_LINEAR"  bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="WATER_MASK"          bufIndex="0" />
      <BindBuffer sampler="gBuffer4Map" sourceRT="DEPTH_WATER"    bufIndex="32"  />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.25" /> 
      <If>
        <Conditions operation="or">
            <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_BelowWater" />
            <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_NearWaterSurface" />
        </Conditions>
      </If>
        <!-- the difference between these is the blend mode - whether we do a normal blend or rely on the fact that if light shafts blur is enabled, we rely on that pre-mulitplying the volumetrics by its own alpha -->
        <If conditionType="variable" id="LightShaftsBlurEnabled" />
            <SetContext zwrite="false" blendMode="Blend_AddBlendDst" colourWrite="true" />
            <DrawQuad material="materials/PostProcess.material.mbin" context="WTR_BLTRL_DST_BLND_UPSMPL"  />
        <Else />
            <SetContext zwrite="false" blendMode="blend" colourWrite="true" />
            <DrawQuad material="materials/PostProcess.material.mbin" context="WTR_BLTRL_UPSMPL_BLND"  />
        <EndIf />
      <Else />
        <!-- the difference between these is the blend mode - whether we do a normal blend or rely on the fact that if light shafts blur is enabled, we rely on that pre-mulitplying the volumetrics by its own alpha -->
        <If conditionType="variable" id="LightShaftsBlurEnabled" />
            <SetContext zwrite="false" blendMode="Blend_AddBlendDst" colourWrite="true" />
            <DrawQuad material="materials/PostProcess.material.mbin" context="BLTRL_UPS_BL"  />
        <Else />
            <SetContext zwrite="false" blendMode="blend" colourWrite="true" />
            <DrawQuad material="materials/PostProcess.material.mbin" context="BILATERAL_BLEND_UPSAMPLE"  />
        <EndIf />
      <EndIf />
      <UnbindBuffers />

      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="MeshWaterPostProcessBelow">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_MeshedDeferred" />
         <If>
          <Conditions operation="or">
            <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_BelowWater" />
            <Condition type="variable" id="WaterState" test="equal" sourceType="variable" source="WaterState_NearWaterSurface" />
          </Conditions>
        </If>

      <If conditionType="variable" id="WaterGodRaysEnabled" />
        <BeginTarget target="WATER_SCATTER_DEPTH" />
          <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" />
          <ColourMask channels="RGBA"/>
          <BindBuffer sampler="gBufferMap"    sourceRT="DEPTH"       bufIndex="32"   />
          <BindBuffer sampler="gBuffer1Map"   sourceRT="DEPTH_WATER" bufIndex="32"  />
          <SetContext zwrite="true" blendMode="replace" colourWrite="true" depthTest="always" />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE_DPTH_WTR" />
          <UnbindBuffers />
        <EndTarget flushCB="true" />

        <BeginTarget target="WATER_SCATTER_ADD" />
          <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" />
          <ColourMask channels="RGB"  />
          <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always"  />
          <BindBuffer sampler="gWaterMask"            sourceRT="WATER_MASK"     bufIndex="0"  />
          <BindBuffer sampler="gReflectionDepthMap"   sourceRT="WATER_PROXY_DEPTH" bufIndex="0" />
          <BindBuffer sampler="gDepthMap"             sourceRT="WATER_SCATTER_DEPTH"   bufIndex="0"  />
          <DrawQuadMT material="materials/MeshWater.material.mbin" context="M_GD_SCTTR_ADD" />
          <UnbindBuffers />
        <EndTarget flushCB="true" />

        <PushMarker id="WaterGodRaysSpatialFilter"/>
          <BeginTarget target="WATER_SCATTER_ADD_B" />
          <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" />
          <ColourMask channels="RGB"/>
          <BindBuffer sampler="gBufferMap"  sourceRT="WATER_SCATTER_ADD"   bufIndex="0"   />
          <BindBuffer sampler="gBuffer1Map" sourceRT="WATER_SCATTER_DEPTH"   bufIndex="0"   />
          <SetContext zwrite="false" blendMode="replace" colourWrite="true" depthTest="always" />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="DPTH_AWRE_H_GSS_INV" />
          <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="false" />

          <BeginTarget target="WATER_SCATTER_ADD" />
          <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" />
          <ColourMask channels="RGB"/>
          <BindBuffer sampler="gBufferMap"  sourceRT="WATER_SCATTER_ADD_B"   bufIndex="0"   />
          <BindBuffer sampler="gBuffer1Map" sourceRT="WATER_SCATTER_DEPTH"   bufIndex="0"   />
          <SetContext zwrite="false" blendMode="replace" colourWrite="true" depthTest="always" />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="DPTH_AWRE_V_GSS_INV" />
          <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="false" />
        <PopMarker/>
      <EndIf />

      <BeginTarget target="HDRBUF_1" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_0" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always"  />
      <ColourMask channels="RGB" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
      <EndTarget flushCB="true" flushDB="false" />


      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH_WATER" onlyStencil="true"
        readOnlyDepth="true" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" StencilAction="Load/DontCare"/>

      <ColourMask channels="RGB" />
      <BindBuffer sampler="gDepthMap" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <BindBuffer sampler="gReflectionMap"      sourceRT="WATER_PLANAR_REFL_COL" bufIndex="0"/>
      <BindBuffer sampler="gReflectionDepthMap" sourceRT="WATER_PROXY_DEPTH" bufIndex="0" />
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_1" bufIndex="0" />
      <BindBuffer sampler="gShadowMap" sourceRT="SHADOWBUF" bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap" sourceRT="CLOUDSHADOWS" bufIndex="0" addressMode="wrap" />
      <BindBuffer sampler="gWaterDepth" sourceRT="DEPTH_WATER" bufIndex="32" />
      <BindBuffer sampler="gWaterMask" sourceRT="WATER_MASK" bufIndex="0" />
      <BindBuffer sampler="gWaterPlanePosition" sourceRT="WATER_MASK" bufIndex="1" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="always" stencilMode="maskRead" stencilRef="2" stencilMask="2" />
      <If conditionType="variable" id="WaterGodRaysEnabled" />
        <BindBuffer sampler="gMeshWaterScatterAdd"      sourceRT="WATER_SCATTER_ADD" bufIndex="0" />
        <BindBuffer sampler="gMeshWaterScatterAddDepth" sourceRT="WATER_SCATTER_DEPTH" bufIndex="0" />        
        <DrawQuadMT material="materials/MeshWater.material.mbin" context="M_BLW_WTR_SMPL" />
      <Else />
        <DrawQuadMT material="materials/MeshWater.material.mbin" context="M_BELOW_WATER" />
      <EndIf />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="always" stencilMode="maskRead" stencilMask="1" stencilRef="0" />
      <If conditionType="variable" id="WaterGodRaysEnabled" />
        <DrawQuadMT material="materials/MeshWater.material.mbin" context="M_SCTTR_SMPL" />
      <Else />
        <DrawQuadMT material="materials/MeshWater.material.mbin" context="M_SCATTER" />
      <EndIf />

      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />

      <EndIf />
      <EndIf />
    </Stage>

    <Stage id="BlendedAbovePreRefractions">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />
      <!-- <ClearTarget colBuf0="true" colBuf1="true" col_A="1.0" /> -->
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/1" DepthAction="Load/Store" />
      <ColourMask channels="RGBA" colBuf1="true" />
      <BindBuffer sampler="gShadowMap" sourceRT="SHADOWBUF" bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap" sourceRT="CLOUDSHADOWS" bufIndex="0" addressMode="wrap" />
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_LINEAR" bufIndex="0" />

      <!-- Quads -->
      <SetContext zwrite="true" colourWrite="true" cullMode="front"
        blendMode="blend" depthTest="less" stencilMode="maskWrite"
        stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="QUAD" class="Opaque" context="LIGHTING" order="STATECHANGES" />
      <SetContext zwrite="true" colourWrite="true" cullMode="back"
        blendMode="blend" depthTest="less" stencilMode="maskWrite"
        stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="QUAD" class="Opaque" context="LIGHTING" order="STATECHANGES" />

      <!-- Lines -->
      <!--a
      = alpha offset, b = noise threshold, c = is underground, d = alpha noise factor-->
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add"
        depthTest="always" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="LINE" class="Opaque" context="SUBSTANCES" order="STATECHANGES" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add"
        depthTest="greater" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DrawGeometry type="Mesh" class="TeleportTravelMarker" context="LIT_FORWARD"
        order="STATECHANGES" />

      <!-- player gun additive. has to be rendered before the laser so it can lay down the
      stencil.-->
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="less"
        stencilMode="maskWrite" stencilRef="71" stencilMask="71" />
      <DrawGeometry type="Mesh" class="GunAdditive" context="LIT_FORWARD" order="STATECHANGES" />

      <!-- Transparent Objects -->
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="less"
        stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="Mesh" class="Additive" context="LIT_FORWARD" order="BACK_TO_FRONT" />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <!-- Refraction passes -->
    <Stage id="TranslucentNormal" enabled="true" >
      <If conditionType="variable" id="RefractionsEnabled" test="equal" source="0" />
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" onlyStencil="true" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />

      <RenderPass ColorAction0="Load/Store" DepthAction="Load/DontCare" StencilAction="Load/Store" />
      <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />
      <BindBuffer sampler="gDepthBuffer"     sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />
      
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less"  stencilMode="maskWrite" stencilRef="4" stencilMask="4"/>
      <DoForwardLightLoop type="Mesh"     class="Translucent" context="LIT_FORWARD" order="BACK_TO_FRONT" />

      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" /> 
      <EndIf />
    </Stage>

    <Stage id="RefractionsPrePass" >
      <If conditionType="variable" id="RefractionsEnabled" />
      <BeginTarget target="REFR_BUF" depthTarget="DEPTH" readOnlyDepth="true" onlyStencil="true" />
      <ColourMask channels="RGBA" />
      <RenderPass ClearColor="0/0/0/0" ColorAction0="Clear/Store" ColorAction1="Clear/Store" ColorAction2="Clear/Store" ColorAction3="Clear/Store" ColorAction4="Clear/Store" 
                  ColorAction5="Clear/Store" DepthAction="Load/DontCare" StencilAction="Load/Store" />

      <BindBuffer sampler="gShadowMap"       sourceRT="SHADOWBUF"       bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap"  sourceRT="CLOUDSHADOWS"    bufIndex="0" addressMode="wrap" />
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less"   stencilMode="maskWrite" stencilRef="32"  stencilMask="32"/>
      <DoForwardLightLoop type="Mesh"     class="Translucent" context="LIT_FRWD_REFR_H" order="BACK_TO_FRONT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="RefractionsBehind" >
      <If conditionType="variable" id="RefractionsEnabled" />
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" onlyStencil="true" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="Load/Store" DepthAction="Load/DontCare" StencilAction="Load/DontCare" />
      
      <BindBuffer sampler="gBufferMap"  sourceRT="REFR_COLOUR"      bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map" sourceRT="REFR_ALPHA"       bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map" sourceRT="REFR_COLOUR_B"    bufIndex="0"  />
      <BindBuffer sampler="gBuffer3Map" sourceRT="REFR_ALPHA_B"     bufIndex="0"  />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="always"  stencilMode="maskRead" stencilRef="32"  stencilMask="32"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="REFRACT_BEHIND" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="RefractionsApply" >
      <If conditionType="variable" id="RefractionsEnabled" />

      <BeginTarget target="REFR_DIST_BUF" depthTarget="DEPTH" onlyStencil="true" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="Load/Store" DepthAction="Load/DontCare" StencilAction="Load/DontCare" />

      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_0"         bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map" sourceRT="REFR_ALPHA"       bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map" sourceRT="REFR_DIR"         bufIndex="0"  />
      <BindBuffer sampler="gBuffer3Map" sourceRT="REFR_DEPTH_REV_Z" bufIndex="0"  />
      <BindBuffer sampler="gBuffer4Map" sourceRT="DEPTH"            bufIndex="32" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="always"  stencilMode="maskRead" stencilRef="32"  stencilMask="32"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="REFRACT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>    

    <Stage id="TranslucentRefractive">
      <If conditionType="variable" id="RefractionsEnabled" />
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />
      <ColourMask channels="RGBA" />

      <RenderPass ColorAction0="Load/Store" DepthAction="Load/DontCare" StencilAction="Load/DontCare" />
      <BindBuffer sampler="gBufferMap"  sourceRT="REFR_COLOUR"      bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always"  stencilMode="maskRead" stencilRef="32" stencilMask="32" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />
      <EndIf />
    </Stage>

    <!-- Screen Space Reflections -->
    <Stage id="GeometryNormals">
      <If conditionType="stage" id="SSR_Params" enabled="true" />
      <BeginTarget target="GEO_NORMALS"/>
      <ColourMask channels="RGBA"/>
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" />

      <BindBuffer sampler="gBufferMap"    sourceRT="DEPTH"  bufIndex="32" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="NFD_EDGE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="SSR_Params" enabled="false">
      <BeginTarget target="SSR_DEPTH_DOWN"/>
      <ColourMask channels="RGBA"/>
      <RenderPass ColorAction0="DontCare/Store" />

      <BindBuffer sampler="gBufferMap"    sourceRT="DEPTH"        bufIndex="32" />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="GEO_NORMALS"  bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="NORMALS"      bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always"/>
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_DEPTH_DOWN" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="SSR_PARAMS" depthTarget="DEPTH_DOWN_REV_Z" onlyStencil="true" />
      <ColourMask channels="RGBA"/>
      <RenderPass ClearColor="0/0/0/0" ClearDepthStencil="0/0" ColorAction0="Clear/Store" ColorAction1="Clear/Store" ColorAction2="Clear/Store" StencilAction="Clear/Store" DepthAction="Load/DontCare" StencilAction="Clear/Store" />

      <BindBuffer sampler="gBuffer0iMap"  sourceRT="SSR_SMP_IDX"    bufIndex="0" />
      <BindBuffer sampler="gBufferMap"    sourceRT="DEPTH_HI_LOW_Z" bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="GEO_NORMALS"    bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="NORMALS"        bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map"   sourceRT="MATERIAL"       bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskWrite" stencilRef="64"  stencilMask="64" />
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_PARAMS" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="SSR_HighZMips" enabled="false">
      <!-- <If conditionType="variable" id="SSRGeometryDrawCount" /> -->
      <If conditionType="true" />

      <!-- Replace with proper flush command -->
      <BeginTarget target="DEPTH_HI_LOW_Z" mipLevel="1" />
      <RenderPass ColorAction0="DontCare/Store" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_HI_LOW_Z" bufIndex="0" mipLevel="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_Z" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_HI_LOW_Z" mipLevel="2" />
      <RenderPass ColorAction0="DontCare/Store" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_HI_LOW_Z" bufIndex="0" mipLevel="1" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_Z" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_HI_LOW_Z" mipLevel="3" />
      <RenderPass ColorAction0="DontCare/Store" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_HI_LOW_Z" bufIndex="0" mipLevel="2" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_Z"/>
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_HI_LOW_Z" mipLevel="4" />
      <RenderPass ColorAction0="DontCare/Store" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_HI_LOW_Z" bufIndex="0" mipLevel="3" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_Z" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_HI_LOW_Z" mipLevel="5" />
      <RenderPass ColorAction0="DontCare/Store" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_HI_LOW_Z" bufIndex="0" mipLevel="4" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_Z" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_HI_LOW_Z" mipLevel="6" />
      <RenderPass ColorAction0="DontCare/Store" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_HI_LOW_Z" bufIndex="0" mipLevel="5" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_Z" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="DEPTH_HI_LOW_Z" mipLevel="7" />
      <RenderPass ColorAction0="DontCare/Store" />
      <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_HI_LOW_Z" bufIndex="0" mipLevel="6" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuad material="materials/PostProcess.material.mbin" context="HIGH_Z" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>
    
    <Stage id="SSR_ColourMips" enabled="false">
      <!-- <If conditionType="variable" id="SSRGeometryDrawCount" /> -->
      <If conditionType="true" />
        <BeginTarget target="SSR_REFL"/>
        <ColourMask channels="RGB"/>
        <RenderPass ColorAction0="DontCare/Store" />
        <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" />
        <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_0"   bufIndex="0" />
        <DrawQuad material="materials/PostProcess.material.mbin" context="UPS_4TAP_BIC_DJ" />
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="true" />

        <BeginTarget target="SSR_REFL_TMP" />
        <RenderPass ColorAction0="DontCare/Store" />
        <BindBuffer sampler="gBufferMap"  sourceRT="SSR_REFL"    bufIndex="0" />
        <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN"  bufIndex="0" />
        <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
        <DrawQuad material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_V_GUASS" />
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />

        <BeginTarget target="SSR_REFL" />
        <RenderPass ColorAction0="DontCare/Store" />
        <BindBuffer sampler="gBufferMap"  sourceRT="SSR_REFL_TMP"  bufIndex="0" />
        <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN"    bufIndex="0" />
        <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
        <DrawQuad material="materials/PostProcess.material.mbin" context="DEPTH_AWARE_H_GUASS" />
        <UnbindBuffers />
        <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="SSR_March" enabled="false">
      <!-- <If conditionType="variable" id="SSRGeometryDrawCount" /> -->
      <If conditionType="true" />
      <BeginTarget target="SSR_HIT_DATA" depthTarget="DEPTH_DOWN_REV_Z" onlyStencil="true" readOnlyDepth="true" />
      <ColourMask channels="RGBA"/>
      <RenderPass ColorAction0="Clear/Store" ColorAction1="DontCare/Store" ClearColor="0/0/0/0" StencilAction="Load/DontCare" DepthAction="Load/DontCare" />
      <BindBuffer sampler="gBuffer0iMap"  sourceRT="SSR_SMP_IDX"      bufIndex="0" />
      <BindBuffer sampler="gBufferMap"    sourceRT="DEPTH_HI_LOW_Z"   bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="SSR_RAY_DIR"      bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="SSR_RAY_PDF"      bufIndex="0"  />
      <BindBuffer sampler="gBuffer3Map"   sourceRT="SSR_REFL"         bufIndex="0"  />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="64" stencilMask="64"/>
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_MARCH" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="SSR_Resolve" enabled="false">
      <!-- <If conditionType="variable" id="SSRGeometryDrawCount" /> -->
      <BeginTarget target="SSR_DUMMY" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" />
      <EndTarget flushCB="true" flushDB="false" flushForCompute="true" />

      <!--
      <FlushBuffer  flushFor="readWrite"  sourceRT="SSR_RESOLVE"  bufIndex="0" />
      -->
      <BeginTarget target="SSR_HIT_LENGTH" depthTarget="DEPTH_DOWN_REV_Z" onlyStencil="true" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="Clear/Store" ColorAction1="Clear/Store" ClearColor="0/0/0/0" StencilAction="Load/DontCare" DepthAction="Load/DontCare" />

      <BindBuffer sampler="gBufferMap"    sourceRT="GBUFFER"          bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="GBUFFER"          bufIndex="2"  />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="GBUFFER"          bufIndex="3"  />
      <BindBuffer sampler="gBuffer3Map"   sourceRT="DEPTH"            bufIndex="32" />
      <BindBuffer sampler="gBuffer4Map"   sourceRT="SSR_RAY_PDF"      bufIndex="0"  />
      <BindBuffer sampler="gBuffer5Map"   sourceRT="SSR_HIT_DATA"     bufIndex="0"  />
      <BindBuffer sampler="gBuffer6Map"   sourceRT="SSR_HIT_DATA"     bufIndex="1"  />
      <BindBuffer sampler="gResolveOut"   sourceRT="SSR_RESOLVE"      bufIndex="0"  bindAsRwImage="true" />
      <SetContext zwrite="false" colourWrite="true"  cullMode="none" blendMode="add" depthTest="always" stencilMode="maskRead" stencilRef="64"   stencilMask="64" />
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_REUSE_0" />
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_REUSE_1" />
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_REUSE_2" />
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_REUSE_3" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <FlushBuffer  flushFor="read" sourceRT="SSR_RESOLVE"  bufIndex="0" />
    </Stage>

    <Stage id="SSR_Temporal" enabled="false">
      <!-- <If conditionType="variable" id="SSRGeometryDrawCount" /> -->
      <If conditionType="true" />

      <BeginTarget target="SSR_TEMPORAL_F" depthTarget="DEPTH" onlyStencil="true" readOnlyDepth="true" />
      <RenderPass ColorAction0="DontCare/Store" ColorAction1="DontCare/Store" StencilAction="Load/DontCare" DepthAction="Load/DontCare" />
      <ColourMask channels="RGB" />

      <BindBuffer sampler="gBufferMap"    sourceRT="SSR_HIT_LENGTH"     bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="SSR_RESOLVE"        bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="SSR_RADIANCE"       bufIndex="0" frameIdx="prev" />
      <BindBuffer sampler="gBuffer3Map"   sourceRT="SSR_CONF_ACC_T_H"   bufIndex="0" frameIdx="prev" />
      <BindBuffer sampler="gBuffer4Map"   sourceRT="MATERIAL"           bufIndex="0" />
      <BindBuffer sampler="gBuffer5Map"   sourceRT="MATERIAL_BACK"      bufIndex="0" frameIdx="prev" />
      <BindBuffer sampler="gBuffer6Map"   sourceRT="NORMALS"            bufIndex="0" />
      <BindBuffer sampler="gBuffer7Map"   sourceRT="NORMALS_BACK"       bufIndex="0" frameIdx="prev" />
      <BindBuffer sampler="gBuffer8Map"   sourceRT="DEPTH"              bufIndex="32" />
      <BindBuffer sampler="gBuffer9Map"   sourceRT="DEPTH_BACK"         bufIndex="32" frameIdx="prev" />
      <BindBuffer sampler="gBuffer10Map"  sourceRT="MOTIONRESOLVE"      bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="64" stencilMask="64" />
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_TEMPORAL" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="0"  stencilMask="64" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="CLEAR_ZERO" />        
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="SSR_CONF_ACC_T_F" depthTarget="DEPTH" onlyStencil="true" readOnlyDepth="true" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="1/1/1/1" StencilAction="Load/DontCare" DepthAction="Load/DontCare" />
      <ColourMask channels="RGBA" />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="SSR_RADIANCE" depthTarget="DEPTH" onlyStencil="true" readOnlyDepth="true" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" StencilAction="Load/DontCare" DepthAction="Load/DontCare" />
      <ColourMask channels="RGB" />

      <BindBuffer sampler="gBufferMap"  sourceRT="SSR_TEMPORAL_F"     bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="64" stencilMask="64" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="RCRS" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" stencilMode="maskRead" stencilRef="0"  stencilMask="64" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="CLEAR_ZERO" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="SSR_ParamsRefine" enabled="false">
    </Stage>

    <Stage id="SSR_Apply" enabled="false">
      <!-- <If conditionType="variable" id="SSRGeometryDrawCount" /> -->
      <If conditionType="true" />

      <!-- Copy it back into the scene -->
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" onlyStencil="true" readOnlyDepth="true" />
      <ColourMask channels="RGB" />
      <RenderPass ColorAction0="Load/Store" StencilAction="Load/DontCare" DepthAction="Load/DontCare" />

      <BindBuffer sampler="gBufferMap"    sourceRT="GBUFFER"          bufIndex="0"  />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="NORMALS"          bufIndex="0"  />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="MATERIAL"         bufIndex="0"  />
      <BindBuffer sampler="gBuffer3Map"   sourceRT="DEPTH"            bufIndex="32" />
      <BindBuffer sampler="gBuffer4Map"   sourceRT="SSR_RADIANCE"     bufIndex="0"  />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" stencilMode="maskRead" stencilRef="64" stencilMask="64" />
      <DrawQuad material="materials/SSR.material.mbin" context="SSR_APPLY"  />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <SwapTargets targetA="SSR_TEMPORAL_F"     targetB="SSR_TEMPORAL_H"    />
      <SwapTargets targetA="SSR_CONF_ACC_T_F"   targetB="SSR_CONF_ACC_T_H"  />
      <EndIf />
      
      <EndTarget flushCB="true" flushDB="true" />
    </Stage>

    <Stage id="GeometryCopy">
      <!--need to replace these copies with a swap-->
      <If conditionType="stage" id="SSR_Params" enabled="true" />
      <BeginTarget target="NORMALS_BACK" />
      <ColourMask channels="RGBA"/>
      <RenderPass ColorAction0="DontCare/Store" />

      <BindBuffer sampler="gBufferMap"  sourceRT="NORMALS" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="MATERIAL_BACK" />
      <ColourMask channels="RGBA"/>
      <RenderPass ColorAction0="DontCare/Store" />

      <BindBuffer sampler="gBufferMap"  sourceRT="MATERIAL" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <SwapTargets targetA="GEO_NORMALS"     targetB="GN_SWAP_DUMMY"  />
      <EndIf/>
    </Stage>

    <Stage id="RefractionsCleanup" >
      <If conditionType="variable" id="RefractionsEnabled" />
      <BeginTarget target="REFR_ALPHA_B" depthTarget="DEPTH" onlyStencil="true" />
      <RenderPass ColorAction0="Looad/Store" DepthAction="Load/DontCare" StencilAction="Load/Store" />
      <ColourMask channels="R" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="0.0" c="0.0" d="0.0"/>
      <SetContext zwrite="false" colourWrite="true" blendMode="replace" depthTest="always" stencilMode="maskReadWriteNotEqual" stencilRef="0" stencilMaskRead="16" stencilMaskWrite="16" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="CLEAR" />
      <EndTarget flushCB="true" flushDB="true" />
      <EndIf />
    </Stage>

    <Stage id="BlendedAbovePostRefractions">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />

      <!-- Transparent Objects -->
      <RenderPass ColorAction0="Load/Store" DepthAction="Load/DontCare" StencilAction="Load/DontCare" />
      <ColourMask channels="RGBA" colBuf1="false" />
      <BindBuffer sampler="gShadowMap" sourceRT="SHADOWBUF" bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap" sourceRT="CLOUDSHADOWS" bufIndex="0" addressMode="wrap" />
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="Mesh" class="WarpInShip" context="LIT_FORWARD" order="BACK_TO_FRONT" />

      <!-- PlaneSpotlight Object -->
      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="less" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="Mesh" class="PlaneSpot" context="LIT_FORWARD" contextVariant="1" order="BACK_TO_FRONT" />

      <ColourMask channels="RGB" colBuf1="true" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="36" stencilMask="36" />
      <DoForwardLightLoop type="Mesh" class="Highlight" context="LIT_FORWARD_WITH_MASK" order="BACK_TO_FRONT" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="36" stencilMask="36" />
      <DoForwardLightLoop type="Mesh" class="HighlightOccluded" context="LIT_FORWARD_WITH_MASK" order="BACK_TO_FRONT" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="36" stencilMask="36" />
      <DoForwardLightLoop type="Mesh" class="HighlightDoubleSided" context="LIT_FORWARD_WITH_MASK" order="BACK_TO_FRONT" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="36" stencilMask="36" />
      <DoForwardLightLoop type="Mesh" class="HighlightTrans" context="LIT_FORWARD_WITH_MASK" order="BACK_TO_FRONT" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="36" stencilMask="36" />
      <DoForwardLightLoop type="Mesh" class="HighlightTransOccluded" context="LIT_FORWARD_WITH_MASK" order="BACK_TO_FRONT" />

      <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="blend" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="36" stencilMask="36" />
      <DoForwardLightLoop type="Mesh" class="HighlightTransDoubleSided" context="LIT_FORWARD_WITH_MASK" order="BACK_TO_FRONT" />
      <If conditionType="legacy" enabled="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="always" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="Mesh" class="HighlightOverlay" context="LIT_FORWARD_WITH_MASK" order="BACK_TO_FRONT" />
      <SetContext  />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="always" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="Mesh" class="HighlightOverlayDoubleSided" context="LIT_FORWARD_WITH_MASK" order="BACK_TO_FRONT" />
      <SetContext  />

      <ColourMask channels="RGB" colBuf1="false" />
      <EndIf />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="greater" stencilMode="maskWrite" stencilRef="36" stencilMask="36" />
      <DoForwardLightLoop type="Mesh" class="HighlightOccluded" context="LIT_FRWD_OCCLUDED" order="BACK_TO_FRONT" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="greater" stencilMode="maskWrite" stencilRef="36" stencilMask="36" />
      <DoForwardLightLoop type="Mesh" class="HighlightTransOccluded" context="LIT_FRWD_OCCLUDED" order="BACK_TO_FRONT" />

      <!-- Trails -->
      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="less" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="Trail" class="Translucent" context="LIGHTING" order="STATECHANGES" />

      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="less" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="Trail" class="Additive" context="LIGHTING" order="STATECHANGES" />

      <!--Single Lines-->
      <ColourMask channels="RGBA" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="blend" depthTest="less" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="SingleLine" class="Opaque" context="LIGHTING" order="STATECHANGES" />

      <!--Single Lines-->
      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="less" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="SingleLine" class="Additive" context="LIGHTING" order="STATECHANGES" />

      <!-- Markers -->
      <ColourMask channels="RGBA" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="Mesh" class="Map" context="SCREEN_MAP" order="BACK_TO_FRONT" />

      <!-- Glow Translucent RGB -->
      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="Mesh" class="GlowTranslucent" context="LIT_FORWARD"
        order="BACK_TO_FRONT" />

      <SetContext zwrite="false" colourWrite="false" cullMode="none" blendMode="add" depthTest="less" stencilMode="maskWrite" stencilRef="4" stencilMask="7" />

      <!-- render the player laser stencil-only, to mask it in the TAA -->
      <!-- results in some overzealous clipping in AA but should be hard to see, the gun moves a lot -->
      <DoForwardLightLoop type="SingleLine" class="PlayerGunLaser" context="LIGHTING" order="STATECHANGES" />
      <DoForwardLightLoop type="SingleLine" class="PlayerGunLaserCore" context="LIGHTING" order="STATECHANGES" />

      <ColourMask channels="RGB" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="less" stencilMode="maskReadInvert" stencilRef="3" stencilMask="7" />

      <!-- player laser. actual colour rendering masked by the gun -->
      <DoForwardLightLoop type="SingleLine" class="PlayerGunLaser" context="LIGHTING" order="STATECHANGES" />
      <DoForwardLightLoop type="SingleLine" class="PlayerGunLaserCore" context="LIGHTING" order="STATECHANGES" />

      <ColourMask channels="RGBA" colBuf1="false" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="always" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="Mesh" class="WarpOnFoot" context="LIT_FORWARD" order="BACK_TO_FRONT" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="invSourceAlpha" depthTest="lessEqual" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DoForwardLightLoop type="Mesh" class="UIScreen" context="LIT_FORWARD" order="BACK_TO_FRONT" />

      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="true" />

      <!-- Glow Translucent Alpha -->
      <BeginTarget target="GBUFFER" depthTarget="DEPTH" />
      <ColourMask channels="A" colBuf1="false" colBuf2="false" colBuf3="false" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />
      <BindBuffer sampler="gShadowMap" sourceRT="SHADOWBUF" bufIndex="32" />
      <BindBuffer sampler="gCloudShadowMap" sourceRT="CLOUDSHADOWS" bufIndex="0" addressMode="wrap" />
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="Blend_OutputAlpha" depthTest="less" />
      <DoForwardLightLoop type="Mesh" class="GlowTranslucent" context="LIT_FORWARD" order="BACK_TO_FRONT" />
      <DoForwardLightLoop type="Trail" class="Translucent" context="LIGHTING_GLOW" order="STATECHANGES" />
      <DoForwardLightLoop type="Trail" class="Additive" context="LIGHTING_GLOW" order="BACK_TO_FRONT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="3dLines">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" StencilAction="Load/Store" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="blend" depthTest="less" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
      <DrawGeometry type="LINERENDERER" class="Opaque" context="LINE3D" order="STATECHANGES" />
      <EndTarget flushCB="true" flushDB="true" saveZCull="true" />
    </Stage>

    <Stage id="LUTMaskClear" enabled="false">
    </Stage>

    <Stage id="TAA_NONE" enabled="false">
      <SwapTargets targetA="HDRBUF_0" targetB="HDRBUF_1" />
    </Stage>

    <Stage id="TAA_APPLY" enabled="false">
    </Stage>

    <Stage id="TAA_APPLY_CLIP" enabled="false">
    </Stage>

    <Stage id="TAA_APPLY_TEST" enabled="false">
    </Stage>

    <Stage id="TAA_SWAP" enabled="false">
    </Stage>

    <Stage id="ProbeReflections" enabled="false">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" onlyStencil="true" readOnlyDepth="true" />
      <RenderPass ColorAction0="Load/Store" DepthAction="Load/DontCare" StencilAction="Load/DontCare" />
      <ColourMask channels="RGB" />
      <BindBuffer sampler="gBufferMap"    sourceRT="DEPTH"    bufIndex="32" />
      <BindBuffer sampler="gBuffer1Map"   sourceRT="GBUFFER"  bufIndex="2"  />
      <BindBuffer sampler="gBuffer2Map"   sourceRT="GBUFFER"  bufIndex="3"  />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" stencilMode="maskRead" stencilRef="64" stencilMask="64"  />
      <DrawQuad material="materials/SSR.material.mbin" context="PROBE_REFLECTIONS" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="MeshWaterDepthCopy">
      <If conditionType="variable" id="WaterRenderer" test="equal" sourceType="variable" source="WaterRenderer_MeshedDeferred" />
        <If conditionType="variable" id="WaterState"  test="notEqual" sourceType="variable" source="WaterState_NoWater" />
          <BeginTarget target="DEPTH_LINEAR" depthTarget="DEPTH" />
          <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />

          <ColourMask channels="RGBA"/>
          <SetContext zwrite="true" colourWrite="true" cullMode="none" blendMode="replace" depthTest="less" alphaToCoverage="false" stencilMode="maskWrite" stencilRef="4" stencilMask="4" />
          <BindBuffer sampler="gBufferMap"  sourceRT="DEPTH_WATER" bufIndex="32" />
          <DrawQuadMT material="materials/PostProcess.material.mbin" context="DEPTH_REV2LIN_LESS" />
          <UnbindBuffers />
          <EndTarget flushCB="true" flushDB="true" />
        <EndIf />
      <EndIf />
    </Stage>


    <Stage id="Particles">
      <!-- Downsample now to include changes due to MeshWater -->
      <BeginTarget target="DEPTH_PART" depthTarget="DEPTH_DOWN_REV_Z" />
      <RenderPass ColorAction0="DontCare/Store" DepthAction="DontCare/Store" StencilAction="DontCare/Store" />
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gBufferMap" sourceRT="DEPTH" bufIndex="32" />
      <SetContext zwrite="true" blendMode="replace" colourWrite="true" depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE_DEPTH" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />
      
      <BeginTarget target="PARTICLES" depthTarget="DEPTH_DOWN_REV_Z" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/1" DepthAction="Load/DontCare" StencilAction="Load/DontCare" />
      <ColourMask channels="RGBA" />
      <!-- <SetContext zwrite="false" blendMode="replace" colourWrite="true" 
      depthTest="always" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="PARTICLE_CLEAR" /> -->

      <!--PS4: default setting after ClearTarget equals RT0-RGBA, so no need to call ColourMask again-->
      <BindBuffer sampler="gDepthBuffer" sourceRT="DEPTH_PART" bufIndex="0" />
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_0" bufIndex="0" />
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="Blend_OutputOneMinusAlpha" depthTest="less" />

      <DoForwardLightLoop type="EMITTER" class="Translucent" context="TRANSLUCENT_SOFT" order="BACK_TO_FRONT" />
      <DoForwardLightLoop type="HEAVYAIR" class="Translucent" context="HEAVYAIR_SOFT" order="BACK_TO_FRONT" />
      <UnbindBuffers />

      <!-- Uncomment this to simulate how particles behave on Switch (acommend out additive
      particles below!) -->
      <!-- <BindBuffer sampler="gDepthBuffer" sourceRT="DEPTH_PART" bufIndex="0" />
      <ColourMask channels="RGB" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="less"
        />
      <DoForwardLightLoop  type="EMITTER"  class="Additive" context="LQ_TRNSLCNT_ADDITIVE"
      order="BACK_TO_FRONT" />
      <DoForwardLightLoop  type="HEAVYAIR" class="Additive" context="LQ_HVR_ADDITIVE"
      order="BACK_TO_FRONT"  />
      <UnbindBuffers /> -->

      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="DontCare/DontCare" StencilAction="DontCare/DontCare" />
      <ColourMask channels="RGB" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="invSourceAlpha"
        depthTest="always" />

      <BindBuffer sampler="gBufferMap" sourceRT="PARTICLES" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_DOWN_REV_Z" bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="PART_UPSAMPLE" />
      <UnbindBuffers />

      <BindBuffer sampler="gDepthBuffer" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <BindBuffer sampler="gScatteringVolume3D" sourceRT="SCATTERING_VOLUME" bufIndex="0" />
      <ColourMask channels="RGB" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="add" depthTest="less" />
      <DoForwardLightLoop type="EMITTER" class="Additive" context="TRNSLCNT_ADDITIVE" order="BACK_TO_FRONT" />
      <DoForwardLightLoop type="HEAVYAIR" class="Additive" context="HVR_ADDITIVE" order="BACK_TO_FRONT" />
      <DoForwardLightLoop type="EMITTER" class="AdditiveHighQuality" context="TRNSLCNT_ADDITIVE" order="BACK_TO_FRONT" />
      <DoForwardLightLoop type="HEAVYAIR" class="AdditiveHighQuality" context="HVR_ADDITIVE" order="BACK_TO_FRONT" />

      <UnbindBuffers />
      <EndTarget flushCB="false" flushDB="false" />
    </Stage>

    <Stage id="SpeedLines">
      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="Blend_OutputOneMinusAlpha" depthTest="less" />
      <DoForwardLightLoop type="SPEEDLINE" class="Opaque" context="LIGHTING" order="STATECHANGES" />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="ApplyPostTaa" enabled="true">
    </Stage>

    <Stage id="MotionblurNormal" enabled="false">
      <BeginTarget target="VOLUME" />
      <RenderPass ColorAction0="DontCare/Store" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_0"          bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_LINEAR"      bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"  />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_LOW" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
      
      <BeginTarget target="BLUR1" />
      <RenderPass ColorAction0="DontCare/Store" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="VOLUME"         bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_LINEAR"      bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"  />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_LOW_PASS2" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="HDRBUF_0" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap" sourceRT="BLUR1" bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="invSourceAlpha" depthTest="always" alphaToCoverage="false"  />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Motionblur" enabled="false">
      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH" onlyStencil="true" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" StencilAction="Load/Store" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_0"          bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_LINEAR"      bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskWrite" stencilRef="16" stencilMask="16"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_HIGH"  compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" onlyStencil="true" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" StencilAction="Load/Store" />
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_1"         bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_LINEAR"      bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskRead" stencilRef="16" stencilMask="16"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_HIGH_PASS2" compute="async_next"  />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="MotionblurUltra" enabled="false">
      <BeginTarget target="HDRBUF_1" depthTarget="DEPTH" onlyStencil="true" />
      <RenderPass ColorAction0="Load/Store" DepthAction="Load/DontCare" StencilAction="Load/Store" ClearColor="0/0/0/0"/>
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_0"         bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_LINEAR"      bufIndex="0" />
      
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskWrite" stencilRef="16" stencilMask="16"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_ULT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="HDRBUF_0" depthTarget="DEPTH" onlyStencil="true" />
      <RenderPass ColorAction0="Load/Store" DepthAction="Load/DontCare" StencilAction="Load/DontCare" ClearColor="0/0/0/0"/>
      <ColourMask channels="RGB"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_1"         bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="MOTION_MAXBUF_0"  bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE"    bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_LINEAR"      bufIndex="0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" stencilMode="maskRead" stencilRef="16" stencilMask="16"/>
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="MBLUR_ULT_PASS2" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="true" />   
    </Stage>

    <Stage id="DepthOfFieldBokeh">
    </Stage>

    <Stage id="DepthOfFieldBokehNew">
      <BeginTarget target="DOF_DOWNSAMPLE" />
      <RenderPass ColorAction0="DontCare/Store" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="HDRBUF_0" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>     
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />          

      <!--
      Re-enable this (and a corresponding shader section) for nicer bokeh
      <BeginTarget target="BLOOM_BLURBUF_4A" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DOF_DOWNSAMPLE" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_ASYNC" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>     
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="DOWNSAMPLE" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />       
      -->   

      <BeginTarget target="DOF_MAXBUF_H" />
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DOF_DOWNSAMPLE" bufIndex="1" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="DILATE_HOR" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="DOF_MAXBUF" />
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" />
      <ColourMask channels="RGBA"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="DOF_MAXBUF_H" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="DILATE_VER" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   

      <BeginTarget target="DOF_BLURBUF1" />
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" />
      <ColourMask channels="RGBA" />
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_DOWNSAMPLE" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DOF_DOWNSAMPLE" bufIndex="1" />    
      <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />    
      <BindBuffer sampler="gBuffer3Map" sourceRT="DOF_MAXBUF" bufIndex="0" />    
      <BindBuffer sampler="gBuffer4Map" sourceRT="BLOOM_BLURBUF_4A" bufIndex="0" />   
      <SetUniform material="materials/DepthOfField.material.mbin" uniform="gBlurParamsVec4" a="8.0" b="8.0" c="8.0" />
      <DrawQuad material="materials/DepthOfField.material.mbin" context="POISSON_NEW" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />   
     
      <BeginTarget target="HDRBUF_0" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" />
      <BindBuffer sampler="gBufferMap" sourceRT="DOF_BLURBUF1" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DOF_BLURBUF1" bufIndex="1" />        
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="invSourceAlpha" depthTest="always" alphaToCoverage="false"/>         
      <DrawQuadMT material="materials/DepthOfField.material.mbin" context="BLEND_INVSRCA" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="DepthOfFieldBlur_ToneMap" enabled="false">
    </Stage>

    <Stage id="DepthOfFieldBlur_ToneMap_4x" enabled="false">
    </Stage>

    <Stage id="DepthOfFieldBlur_ToneMap_16x" enabled="false">
    </Stage>

    <Stage id="DepthOfFieldBlur">
    </Stage>

    <Stage id="NewBloomBright" enabled="true">
      <BeginTarget target="BLOOM_BLURBUF_2B" />
      <ColourMask channels="RGB" />
      <RenderPass ColorAction0="DontCare/Store" DepthAction="DontCare/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_0" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="RGBA8_BUF_T1_0" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="BRIGHTPASS_NEW" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_2A" />
      <ColourMask channels="RGB" />
      <RenderPass ColorAction0="DontCare/Store" DepthAction="DontCare/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_2B" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="BLOOM_BLURBUF_2T" bufIndex="0" frameIdx="prev" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="MOTIONRESOLVE" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="BRIGHTPASS_TEMPORAL" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_2T" />
      <ColourMask channels="RGB" />
      <RenderPass ColorAction0="DontCare/Store" DepthAction="DontCare/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_2A" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COPY" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Effects" enabled="false">
    </Stage>

    <Stage id="SpotlightsVolumetric" enabled="false">
    </Stage>

    <Stage id="PointlightsVolumetric" enabled="false">
    </Stage>

    <Stage id="NewBloom" enabled="true">
      <BeginTarget target="BLOOM_BLURBUF_2B" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_2A" bufIndex="0" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="DontCare/DontCare" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="3.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_7_HALF" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_2A" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_2B" bufIndex="0" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="DontCare/DontCare" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="3.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_7_HALF" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_4B" />
      <ColourMask channels="RGB" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="DontCare/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_2A" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="3.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_7" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_4A" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="DontCare/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_4B" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="3.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_7_HALF" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_8B" />
      <ColourMask channels="RGB" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="DontCare/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_4A" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="0.0" b="1.0" c="3.0" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_7" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_8A" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="DontCare/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_8B" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="3.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_7_HALF" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_16" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="DontCare/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_8A" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="3.0" d="1.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_7_SQR" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_32" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="DontCare/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_16" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="0.0" c="2.0" d="1.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_SQR" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_16" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="DontCare/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_32" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="1.0" c="1.5" d="2.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="add" depthTest="always" alphaToCoverage="false" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_SQR_ADD" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="NewBloomResolve" enabled="true">
      <BeginTarget target="BLOOM_FINALBUF" />
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" DepthAction="DontCare/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_4A" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="BLOOM_BLURBUF_8A" bufIndex="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="BLOOM_BLURBUF_16" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="11.0" b="9.0" c="7.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="BLOOM_RESOLVE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_4B" />
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" DepthAction="DontCare/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_FINALBUF" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="1.0" c="2.5" d="1.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_FINALBUF" />
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" DepthAction="DontCare/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_4B" bufIndex="0" />
      <SetUniform material="materials/PostProcess.material.mbin" uniform="gBlurParamsVec4" a="1.0" b="1.0" c="2.5" d="1.0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="GUASS_5_HALF" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="NewBloomExposure" enabled="true">
      <BeginTarget target="BLOOM_EXPBUF_B" />
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" DepthAction="DontCare/DontCare" />
      <BindBuffer sampler="gBufferMap" sourceRT="BLOOM_BLURBUF_32" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="BLOOM_EXPBUF_A" bufIndex="0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <DrawQuad material="materials/PostProcess.material.mbin" context="BLOOM_EXPOSURE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />

      <SwapTargets targetA="BLOOM_EXPBUF_A" targetB="BLOOM_EXPBUF_B" />
    </Stage>

    <Stage id="NewBloomApply" enabled="false">
    </Stage>

    <Stage id="PostProcessResolve">
      <BeginTarget target="FX_COMBINE_OUT" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always"  />
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_0" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="BLOOM_FINALBUF" bufIndex="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <BindBuffer sampler="gBuffer5Map" sourceRT="BLOOM_EXPBUF_A" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="FX_COMBINE_LITE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <!-- Enable this stage when you disable bloom stages, to clear the bloom buffers -->
    <Stage id="NoBloom" enabled="false">
      <BeginTarget target="BLOOM_BLURBUF_2B" />
      <ClearTarget colBuf0="true" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_4A" />
      <ClearTarget colBuf0="true" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_8A" />
      <ClearTarget colBuf0="true" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_8B" />
      <ClearTarget colBuf0="true" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_16" />
      <ClearTarget colBuf0="true" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_BLURBUF_32" />
      <ClearTarget colBuf0="true" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />
      <EndTarget flushCB="true" flushDB="false" />

      <BeginTarget target="BLOOM_FINALBUF" />
      <ClearTarget colBuf0="true" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="BloomSwap">
      <SwapTargets targetA="BLOOM_BLURBUF_2A" targetB="BLOOM_BLURBUF_2A_B" />
      <SwapTargets targetA="BLOOM_BLURBUF_2B" targetB="BLOOM_BLURBUF_2B_B" />
      <SwapTargets targetA="BLOOM_BLURBUF_4A" targetB="BLOOM_BLURBUF_4A_B" />
      <SwapTargets targetA="BLOOM_BLURBUF_4B" targetB="BLOOM_BLURBUF_4B_B" />
      <SwapTargets targetA="BLOOM_BLURBUF_8A" targetB="BLOOM_BLURBUF_8A_B" />
      <SwapTargets targetA="BLOOM_BLURBUF_8B" targetB="BLOOM_BLURBUF_8B_B" />
      <SwapTargets targetA="BLOOM_FINALBUF" targetB="BLOOM_FINALBUF_B" />
    </Stage>

    <Stage id="LensFlare">
    </Stage>

    <Stage id="UpsampleBicubic" enabled="false">
    </Stage>

    <Stage id="MotionUvToScreen">
    </Stage>

    <Stage id="METALFX_SPATIAL_APPLY" enabled="false" deferrable="false">
      <BeginTarget target="UPSCALE_OUT_A_0" />
      <RenderPass ColorAction0="DontCare/Store" DepthAction="DontCare/DontCare" StencilAction="DontCare/DontCare" />
      <ApplyMetalFXSpatial inputRT="FX_COMBINE_OUT" outputRT="UPSCALE_OUT_A_0" />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="METALFX_TEMPORAL_APPLY" enabled="false" deferrable="false">
      <BeginTarget target="UPSCALE_OUT_A_0" />
      <RenderPass ColorAction0="Clear/Store" ClearColor="0/0/0/0" DepthAction="DontCare/DontCare"
        StencilAction="DontCare/DontCare" />
      <ApplyMetalFXTemporal inputRT="FX_COMBINE_OUT" inputRTIdx="0" outputRT="UPSCALE_OUT_A_0" depthRT="DEPTH"
        motionRT="MOTIONRESOLVE" motionRTIdx="0" />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="ScreenEffect">
      <ColourMask channels="RGBA" />
      <BeginTarget target="UPS_OUT_B_0" />
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <BindBuffer sampler="gBufferMap" sourceRT="FX_COMBINE_OUT" bufIndex="0" />
      <DrawQuadMT material="Materials/UI.material.mbin" context="SCREENEFFECT" width="1.0" height="1.0" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="ScreenEffect_Upscaled" enabled="false">
      <ColourMask channels="RGBA" />
      <BeginTarget target="UPS_OUT_B_0" />
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <BindBuffer sampler="gBufferMap" sourceRT="UPSCALE_OUT_A_0" bufIndex="0" />
      <DrawQuadMT material="Materials/UI.material.mbin" context="SCREENEFFECT" width="1.0" height="1.0" compute="async_next" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="ScreenEffect_Upscaled_Async" enabled="false">
    </Stage>      

    <Stage id="Combine_NoFXAA" enabled="false">
      <BeginTarget target="" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" ClearDepthStencil="0/0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <BindBuffer sampler="gBufferMap" sourceRT="UPS_OUT_B_0" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINE_NO_LUM" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>


    <Stage id="Combine_NoFXAA_Async" enabled="false">
      <BeginTarget target="" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <BindBuffer sampler="gBufferMap" sourceRT="UPS_OUT_B_0" bufIndex="0" frameIdx="prev" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINE_NO_LUM" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Combine_NoFXAA_HDR"  enabled="false">
      <BeginTarget target="" readOnlyDepth="true" />
      <ColourMask channels="RGBA"/>
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back"  blendMode="replace" depthTest="always" alphaToCoverage="false"/>
      <BindBuffer sampler="gBufferMap"  sourceRT="SCREEN"       bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINEHDR" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Combine_NoFXAA_HDR_Async" enabled="false">
      <BeginTarget target="" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <BindBuffer sampler="gBufferMap" sourceRT="UPS_OUT_B_0" bufIndex="0" frameIdx="prev" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINEHDR" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Combine_Upscaled_Async" enabled="false">
      <BeginTarget target="" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" />
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <BindBuffer sampler="gBufferMap" sourceRT="UPS_OUT_B_0" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Combine_Upscaled" enabled="false">
      <BeginTarget target="" readOnlyDepth="true" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <BindBuffer sampler="gBufferMap" sourceRT="UPS_OUT_B_0" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINE_NO_LUM" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="Combine" enabled="false">
      <BeginTarget target="FINAL" />
      <ColourMask channels="RGBA" />
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" alphaToCoverage="false" />
      <BindBuffer sampler="gBufferMap" sourceRT="UPS_OUT_B_0" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="DEPTH_LINEAR" bufIndex="0" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="COMBINE" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="FXAA" enabled="false">
      <ColourMask channels="RGBA" />
      <BeginTarget target="" readOnlyDepth="true" />
      <RenderPass ColorAction0="DontCare/Store" ClearColor="0/0/0/0" DepthAction="Load/DontCare" />
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" />

      <BindBuffer sampler="gBufferMap" sourceRT="FINAL" bufIndex="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="FINAL" bufIndex="1" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="DEPTH" bufIndex="32" />
      <DrawQuadMT material="materials/PostProcess.material.mbin" context="FXAA" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="UI">
      <ColourMask channels="RGBA" />
      <BeginTarget target="" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="Clear/DontCare" ClearDepthStencil="0/0" />
      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="sourceAlpha" depthTest="always" alphaToCoverage="false" />
      <DrawQuadMT material="Materials/UI.material.mbin" context="UI" width="1.0" height="1.0" />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="SwapDepth">
      <SwapTargets targetA="DEPTH" targetB="DEPTH_BACK" />
    </Stage>

    <Stage id="Debug" enabled="false">
      <ColourMask channels="RGBA" />
      <BeginTarget target="" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />

      <ClearTarget depthBuf="false" colBuf0="false" col_R="0.0" col_G="0.0" col_B="0.0" col_A="1.0" />
      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" />

      <SetContext zwrite="true" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" />
      <BindBuffer sampler="gBufferMap" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />

      <BindBuffer sampler="gBuffer1Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer4Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer5Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer6Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer7Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer8Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer9Map" sourceRT="CLOUDS_HIGH" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer10Map" sourceRT="CLOUDSHADOWS" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer11Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer12Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer13Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer14Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />

      <DrawQuadMT material="materials/Debug.material.mbin" context="HEX_SPLIT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="DebugQuad" enabled="false">
      <ColourMask channels="RGBA" />
      <BeginTarget target="" />
      <ClearTarget depthBuf="false" colBuf0="false" col_R="0.0" col_G="0.0" col_B="0.0" col_A="1.0" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />

      <!--a,
      b, c, d == 0.0             -> full    screen buffer       -->
      <!--a,
      b, c, d == 1.0             -> default main   quad   split -->
      <!--a
      == 2.0             -> top     left   inner  split -->
      <!--b
      == 2.0             -> top     right  inner  split -->
      <!--c
      == 2.0             -> bottom  left   inner  split -->
      <!--d
      == 2.0             -> bottom  right  inner  split -->
      <SetUniform material="materials/DebugQuadSplit.material.mbin" uniform="gDebugSplitVec4"
        a="0.0" b="1.0" c="1.0" d="1.0" />

      <!--a
      -> zoom index                                   -->
      <!--a
      == [0.0,   3.0]    -> zoom respective main buffer                  -->
      <!--a
      == [0.000, 0.303]  -> zoom respective inner split buffer           -->
      <!--a
      == 42.0            -> zoom all buffers                             -->
      <!--b
      -> zoom scale                                   -->
      <!--b
      == [0.0, n)        -> zoom buffer with index 'a' by a factor of 'b'-->
      <!--c,
      d                          -> zoom offset                                  -->
      <!--c,
      d       == [0.0, 1.0]      -> offset uvs of buffer 'a' by vec2(c,d)        -->
      <SetUniform material="materials/DebugQuadSplit.material.mbin" uniform="gDebugZoomVec4" a="0.0" b="1.0" c="0.0" d="0.0" />

      <SetContext zwrite="false" colourWrite="true" cullMode="none" blendMode="replace" depthTest="always" />

      <!--MAIN SPLIT -->
      <BindBuffer sampler="gBuffer0Map" sourceRT="REACT_TEMPORAL_1" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer1Map" sourceRT="REACT_LUM_1" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer2Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer3Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />

      <!--A SPLIT - TOP LEFT -->
      <BindBuffer sampler="gBuffer000Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer001Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer002Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer003Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <!--B SPLIT - TOP RIGHT -->
      <BindBuffer sampler="gBuffer100Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer101Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer102Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer103Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <!--C SPLIT - BOTTOM LEFT -->
      <BindBuffer sampler="gBuffer200Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer201Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer202Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer203Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <!--D SPLIT - BOTTOM RIGHT -->
      <BindBuffer sampler="gBuffer300Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer301Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer302Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />
      <BindBuffer sampler="gBuffer303Map" sourceRT="HDRBUF_0" bufIndex="0" sRGBRead="0" />

      <DrawQuadMT material="materials/DebugQuadSplit.material.mbin" context="QUAD_SPLIT" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
    </Stage>

    <Stage id="MeshWaterDebugOverlay">
      <If conditionType="variable" id="WaterDebugOverlayEnabled" />
      <ColourMask channels="RGBA" />
      <BeginTarget target="" />
      <RenderPass ColorAction0="Load/Store" ClearColor="0/0/0/0" DepthAction="Load/Store" />

      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="Blend_OutputAlpha" depthTest="always" />
      <BindBuffer sampler="gBufferMap" sourceRT="GBUFFER" bufIndex="0" />

      <DrawQuadMT material="materials/Debug.material.mbin" context="MESH_WATER" width="1.0" height="1.0" />
      <UnbindBuffers />
      <EndTarget flushCB="true" flushDB="false" />
      <EndIf />
    </Stage>

    <Stage id="TAA_NONE_RESET" enabled="false">
      <SwapTargets targetA="HDRBUF_0" targetB="HDRBUF_1" />
    </Stage>

    <Stage id="Reset States">
      <SetContext zwrite="false" colourWrite="true" cullMode="back" blendMode="replace" depthTest="always" />
      <ColourMask channels="RGBA" />
    </Stage>

  </CommandQueue>

</Pipeline>